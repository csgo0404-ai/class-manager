<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ« ìš°ë¦¬ë°˜ ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Quantico:wght@400;700&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300;400;700&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>



<style>
       /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; user-select: none; overflow: hidden; height: 100vh; }
        [v-cloak] { display: none !important; }

.rock-avatar-img {
    width: 110px;
    height: 110px;
    object-fit: contain;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
    transition: transform 0.2s;
    margin-bottom: -10px;
}

/* [ìˆ˜ì •] ê²Œì„ ì œëª© ê¸€ì”¨ì²´ ë³µêµ¬ (ëŒë ˆì´ìŠ¤, ëª¨ë‘ ë‹¬ë¦¬ê¸° ë“±) */
.game-font, .text-2xl, h2 {
    font-family: 'Jua', 'Pretendard', sans-serif !important;
}

/* [ì¤‘ìš”] ì•„ì´ì½˜(FontAwesome)ì€ í°íŠ¸ ë³€ê²½ ê¸ˆì§€ (ê¹¨ì§ ë°©ì§€) */
i, .fa, .fas, .fa-solid, .fa-regular {
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
}

/* [ìˆ˜ì •] 1ë²ˆ: í™©ê¸ˆìƒ‰ ì•„ìš°ë¼ (íšŒì „X, ì»¤ì¡Œë‹¤ ì‘ì•„ì§€ëŠ” ë§¥ë°• íš¨ê³¼) */
.god-rays {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px; /* ì•„ìš°ë¼ í¬ê¸° */
    height: 600px;
    background: radial-gradient(
        circle, 
        rgba(251, 191, 36, 0.6) 0%, 
        rgba(251, 191, 36, 0.2) 40%, 
        transparent 70%
    );
    border-radius: 50%;
    z-index: -1; /* íŠ¸ë¡œí”¼ì™€ ì´ë¦„í‘œ ë’¤ë¡œ ë°°ì¹˜ */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
    filter: blur(10px);
}

/* ìš°ìŠ¹ì í™•ì • ì‹œ (.active í´ë˜ìŠ¤ê°€ ë¶™ì„ ë•Œ) ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ */
.god-rays.active {
    opacity: 1;
    animation: aura-pulse 2s infinite ease-in-out;
}

@keyframes aura-pulse {
    0% { 
        transform: translate(-50%, -50%) scale(0.8); 
        opacity: 0.5; 
    }
    50% { 
        transform: translate(-50%, -50%) scale(1.2); /* ë°–ìœ¼ë¡œ í¼ì§ */
        opacity: 1; 
    }
    100% { 
        transform: translate(-50%, -50%) scale(0.8); 
        opacity: 0.5; 
    }
}

/* [ìˆ˜ì •] ëŒ€ì§„í‘œê°€ ë“¤ì–´ê°€ëŠ” í•˜ì–€ìƒ‰ íƒ­ ë‚´ë¶€ ì˜ì—­ */
.flex-1.overflow-y-auto.bg-slate-50.p-8 {
    padding: 0 !important; /* â˜… ê¸°ì¡´ì˜ 8ë‹¨ìœ„(32px) íŒ¨ë”©ì„ ì œê±°í•˜ì—¬ ê½‰ ì±„ì›€ */
    background-color: #fff; /* ì™„ì „í•œ í•˜ì–€ ë°°ê²½ */
    display: flex;
    flex-direction: column;
}


/* [ì¶”ê°€] ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (í•˜ì–€ ë°°ê²½ ì˜ì—­) */
.flex-1.overflow-y-auto::-webkit-scrollbar {
    width: 10px;
}
.flex-1.overflow-y-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
    border: 2px solid #fff;
}

/* [ìˆ˜ì •] ëŒ€ì§„í‘œê°€ ìœ„ì¹˜í•˜ëŠ” ìµœìƒìœ„ íƒ­ ì»¨í…Œì´ë„ˆ */
.picker-tab-content-tournament {
    flex: 1;
    width: 100%;
    height: 100%;
    background-color: #fff; /* í•˜ì–€ ë°°ê²½ */
    position: relative;
    /* â˜… í•µì‹¬: ì´ ì˜ì—­ì„ ë²—ì–´ë‚˜ëŠ” í™•ëŒ€ ë‚´ìš©ë¬¼ì€ ìˆ¨ê¹€ (ìƒë‹¨ë°” ì¹¨ë²” ë°©ì§€) */
    overflow: hidden; 
    display: flex;
    flex-direction: column;
}

/* [ìˆ˜ì •] ì‹¤ì œ ëŒ€ì§„í‘œê°€ ê·¸ë ¤ì§€ëŠ” ë‚´ë¶€ ë˜í¼ */
.bracket-wrapper {
    display: flex;
    flex-direction: row;
    
    /* â˜… í•µì‹¬: í¬ê¸° ê°•ì œ ë³€í™˜ ì œê±° */
    /* transform: scale(...)  <-- ì‚­ì œë¨ */
    /* width/height ê³„ì‚° ë¡œì§ <-- ì‚­ì œë¨ */
    
    /* ë‚´ìš©ë¬¼ì— ë§ì¶°ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ëŠ˜ì–´ë‚˜ë„ë¡ í•¨ */
    width: max-content;
    height: max-content;
    
    /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ì˜ í•µì‹¬ (margin: auto) */
    margin: auto; 
    
    padding: 40px; 
    box-sizing: border-box;
    align-items: center;
    justify-content: center;
}
.flex-1.relative.overflow-auto.custom-scrollbar.bg-slate-900 {
    display: flex; /* Flexbox í™œì„±í™” */
    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ */
    justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ */
}
.picker-tab-content {
    overflow: auto !important;
}

/* 1. ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (í‰ì†Œì—” ìˆ¨ê¹€, í•„ìš”í•  ë•Œ ì˜ˆì˜ê²Œ ë“±ì¥) */
.bracket-wrapper::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
.bracket-wrapper::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.3); /* ë°°ê²½ ì–´ë‘¡ê²Œ */
    border-radius: 4px;
}
.bracket-wrapper::-webkit-scrollbar-thumb {
    background: #475569; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
    border-radius: 4px;
}
.bracket-wrapper::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* ì¢Œ/ìš° íŒ¨ë„ */
.side-bracket { display: flex; flex: 1; height: 100%; align-items: center; min-width: max-content; }
.side-bracket.left { justify-content: flex-end; padding-right: 20px; }
.side-bracket.right { flex-direction: row-reverse; justify-content: flex-end; padding-left: 20px; }

.round-column {
    display: flex;
    flex-direction: column;
    
    /* â˜… ìˆ˜ì •: ë†’ì´ë¥¼ 100%ë¡œ ê°•ì œí•˜ì—¬ ìœ„ì•„ë˜ë¡œ ì­‰ ëŠ˜ë¦¼ */
    align-self: stretch; 
    height: auto;
    
    min-width: 140px; 
    margin: 0 15px;
    position: relative;
    justify-content: space-around; /* ë‚´ë¶€ ì•„ì´í…œ ê· ë“± ë¶„ë°° */
}

.match-pair {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; /* ë°•ìŠ¤ë“¤ì„ ì¤‘ì•™ìœ¼ë¡œ ëª¨ìŒ */
    align-items: center;
    width: 100%;
    position: relative;
}
/* â˜… ì—°ê²°ì„  (ã„·ì ëª¨ì–‘) â˜… */
.bracket-line {
    position: absolute;
    width: 25px;
    top: 25%;
    bottom: 25%;
    height: auto !important;
    border: 2px solid rgba(251, 191, 36, 0.4);
    pointer-events: none;
    z-index: 0;
    transform: none !important;
}
/* space-aroundì¼ ë•Œ ì•„ì´í…œ ì¤‘ì‹¬ì€ 25%ì™€ 75%ì— ìœ„ì¹˜í•¨ */
.bracket-line.auto-align {
    top: 25%;
    bottom: 25%;
    height: auto !important; 
    transform: none !important;
}
.side-bracket.left .bracket-line { right: -25px; border-left: none; border-radius: 0 10px 10px 0; }
.side-bracket.right .bracket-line { left: -25px; border-right: none; border-radius: 10px 0 0 10px; }

/* ê°œë³„ ì„ ìˆ˜ ë°•ìŠ¤ */
.match-box {
    width: 100%;
    height: var(--box-h); /* ìœ„ JSì—ì„œ ì„¤ì •í•œ ë†’ì´ ì ìš© */
    margin: var(--gap-s) 0; /* ê°•ìˆ˜ë³„ë¡œ ë‹¤ë¥¸ ê°„ê²© ì ìš© */
    font-size: var(--font-s);

    background: linear-gradient(to bottom, #fbbf24, #f59e0b);
    border: 2px solid #fcd34d;
    color: #1e3a8a;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    
    /* â˜… ë“œë˜ê·¸ í•µì‹¬ ì„¤ì • */
    cursor: grab; 
    user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
    position: relative;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.2s;
}

/* â˜… ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•„ìˆ˜: ë‚´ë¶€ ê¸€ì/ì•„ì´ì½˜ì´ ë“œë˜ê·¸ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì • */
.match-box > * { pointer-events: none; }
.match-box:active { cursor: grabbing; transform: scale(0.95); }

.match-box:hover {
    transform: scale(1.05);
    filter: brightness(1.1); /* ë°ê¸°ë§Œ ì¡°ì ˆ */
    z-index: 20;
    /* ë°°ê²½ìƒ‰ ë³€ê²½ ì½”ë“œê°€ ìˆë‹¤ë©´ ì‚­ì œí•˜ê±°ë‚˜ ì•„ë˜ì²˜ëŸ¼ ë®ì–´ì“°ê¸° */
    background: linear-gradient(to bottom, #fbbf24, #f59e0b) !important;
    border: 2px solid #fcd34d !important;
    color: #1e3a8a !important;
}
.match-box:focus, 
.match-box:active, 
.finalist-card:focus, 
.finalist-card:active {
    outline: none !important;        /* íŒŒë€ í…Œë‘ë¦¬ ì‚­ì œ */
    box-shadow: none !important;     /* í˜¹ì‹œ ëª¨ë¥¼ íŒŒë€ ê·¸ë¦¼ì ì‚­ì œ */
    border: 2px solid #fcd34d !important; /* ì›ë˜ì˜ í™©ê¸ˆìƒ‰ í…Œë‘ë¦¬ ê°•ì œ ìœ ì§€ */
}
.name-button:focus {
    outline: none;
}

/* íƒˆë½/íŒ¨ë°° ìŠ¤íƒ€ì¼ */
.match-box.eliminated, .finalist-card.eliminated { 
    background: #475569; border-color: #334155; color: #94a3b8;
    opacity: 0.8; box-shadow: none; filter: grayscale(1);
}

/* ì¤‘ì•™ ê²°ìŠ¹ì „ ì˜ì—­ */
.final-stage-wrapper {
    flex: 0 0 360px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 20; padding: 0 20px; height: 100%; min-width: 360px;
}
.trophy-section { text-align: center; margin-bottom: 25px; position: relative; display: flex; flex-direction: column; align-items: center; }
.trophy-icon { font-size: 8.5rem; color: #fbbf24; filter: drop-shadow(0 0 25px rgba(251, 191, 36, 0.6)); animation: float 3s ease-in-out infinite; }
.champion-display {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    padding: 15px 50px; border-radius: 60px; border: 5px solid white;
    color: white; font-weight: 900; font-size: 2.2rem;
    box-shadow: 0 10px 40px rgba(251, 191, 36, 0.6);
    min-width: 280px; text-align: center; margin-top: 20px;
    animation: pulse-gold 2s infinite alternate;
}
.final-match-row { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-top: 30px; padding-bottom: 20px; }
.finalist-card {
    width: 110px; height: 50px; font-size: 0.95rem;
    background: linear-gradient(to bottom, #fbbf24, #f59e0b);
    border: 2px solid #fcd34d; color: #1e3a8a; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; cursor: pointer; transition: all 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
.finalist-card > * { pointer-events: none; } /* ê²°ìŠ¹ ì¹´ë“œë„ ë“œë˜ê·¸ ê°€ëŠ¥ì„± ê³ ë ¤ */
.vs-container { font-family: 'Impact', sans-serif; font-size: 2.5rem; color: #fbbf24; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); } /* ìœ„ë¡œ 15px ê»‘ì¶© */
}

/* ìš°ìŠ¹ìê°€ ë“¤ì–´ì˜¤ëŠ” ì±”í”¼ì–¸ ë°•ìŠ¤ */
.champion-box.has-winner {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.8);
    transform: scale(1.1);
}

/* ê²°ìŠ¹ì „ ëŒ€ê²° ì¹´ë“œ */
.final-match-row { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 20px; 
    width: 100%; 
    margin-top: 30px; 
    padding-bottom: 20px; /* í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
}

.finalist-card {
    width: 110px;    /* 130px -> 110px */
    height: 50px;    /* 60px -> 50px */
    font-size: 0.95rem; /* ê¸€ì í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
    
    background: linear-gradient(to bottom, #fbbf24, #f59e0b);
    border: 2px solid #fcd34d;
    color: #1e3a8a;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}

@keyframes pulse-gold {
    0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
    70% { box-shadow: 0 0 0 25px rgba(251, 191, 36, 0); }
    100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
}

.finalist-card.winner { background: #fbbf24; color: #1e3a8a; border-color: #fff; box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }

.tabular-nums {
    font-variant-numeric: tabular-nums !important;  /* ëª¨ë“  ìˆ«ì í­ì„ ë˜‘ê°™ì´ ë§Œë“¦ */
}

.digital-font {
    font-family: 'Quantico', monospace !important;
    letter-spacing: 0.1em;
    font-weight: 700;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.7); /* ë¹›ë‚˜ëŠ” íš¨ê³¼ */
    color: #ffffff;
font-variant-numeric: tabular-nums !important;
}
.digital-font span {
    font-family: inherit;
    letter-spacing: inherit;
}
.blink-colon {
    animation: blink 1s step-end infinite;
    display: inline-block;
}

@keyframes blink {
    from, to { opacity: 1; }
    50%      { opacity: 0; }
} 
       /* [ê³µí†µ ìœ í‹¸] */
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; cursor: nwse-resize; background: linear-gradient(135deg, transparent 50%, #94a3b8 50%); z-index: 100; border-bottom-right-radius: 1rem; }
.animate-fade-in {
    animation: toolbar-pop 0.2s ease-out;
}
@keyframes toolbar-pop {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop-bounce { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }

/* ìº¡ìŠ ë½‘ê¸° flip ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .capsule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 20px;
        padding: 20px;
        max-width: 100%;
        position: relative;
    }
    .capsule-wrapper {
        perspective: 1000px;
        height: 160px;
        position: relative;
    }
 .capsule-card {
    transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
}
    


/* [ìˆ˜ì •] ìº¡ìŠ ë’·ë©´ (ëª¬ìŠ¤í„°ë³¼ ìŠ¤íƒ€ì¼) */
.capsule-back.ball-style {
    /* â˜… í•µì‹¬ ìˆ˜ì •: absoluteë¡œ ë³€ê²½í•˜ì—¬ ì•ë©´ê³¼ ì™„ë²½í•˜ê²Œ ê²¹ì¹˜ê²Œ í•¨ */
    position: absolute !important; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    /* ë’·ë©´ì´ ì•ë©´ì„ ëš«ê³  ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
    backface-visibility: hidden !important;
    -webkit-backface-visibility: hidden !important;
    
    /* ëª¬ìŠ¤í„°ë³¼ ë””ìì¸ */
    background: transparent !important; /* ë°°ê²½ íˆ¬ëª… (ê³µ ëª¨ì–‘ë§Œ ë³´ì´ê²Œ) */
    border: none !important;
    box-shadow: none !important;
    border-radius: 50%;
    overflow: hidden;
    
    display: block;
    filter: drop-shadow(0 8px 12px rgba(0,0,0,0.3));
    transform: rotateY(180deg); /* 180ë„ ëŒì•„ê°„ ìƒíƒœë¡œ ì‹œì‘ */
    z-index: 1; /* ì•ë©´ë³´ë‹¤ ë’¤ì— ë°°ì¹˜ */
}

/* (í˜¹ì‹œ ì•ë©´ ë°°ê²½ì´ ì‚¬ë¼ì¡Œë‹¤ë©´ ë³µêµ¬) */
.capsule-front {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden !important;
    -webkit-backface-visibility: hidden !important;
    background: linear-gradient(135deg, #a855f7, #7c3aed); /* ë³´ë¼ìƒ‰ ë°°ê²½ ë³µêµ¬ */
    color: white;
    z-index: 2; /* ë’·ë©´ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ */
}

/* --- [1ë©´] ì•ë©´: ëª¬ìŠ¤í„°ë³¼ ìŠ¤íƒ€ì¼ --- */
.capsule-front.ball-style {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    border-radius: 50%;
    overflow: hidden;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
    z-index: 2;
}

/* ìƒë‹¨/í•˜ë‹¨/ë  ë””ìì¸ (ê¸°ì¡´ ìœ ì§€) */
.ball-top {
    position: absolute; top: 0; left: 0; right: 0; height: 50%;
    background: linear-gradient(to bottom, #ef4444, #dc2626); border-bottom: 6px solid #1e293b;
}
.ball-bottom {
    position: absolute; bottom: 0; left: 0; right: 0; height: 50%;
    background: #ffffff; border-top: 6px solid #1e293b;
}
.ball-highlight {
    position: absolute; top: 15px; left: 20px; width: 25px; height: 12px;
    background: rgba(255,255,255,0.4); border-radius: 50%; transform: rotate(-45deg);
}
.ball-band {
    position: absolute; top: 50%; left: 0; right: 0; height: 0; z-index: 10;
    display: flex; justify-content: center; align-items: center;
}
.ball-button {
    border-radius: 50%; position: relative; top: -3px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s ease; z-index: 20; width: 44px; height: 44px;
}

/* [Type 1] ì„±ë³„ í‘œì‹œ (ë‚¨/ì—¬): í°ìƒ‰ ë°°ê²½ + ê²€ì€ í…Œë‘ë¦¬ + ê²€ì€ ê¸€ì”¨ */
.ball-button.btn-gender {
    background-color: #ffffff; border: 4px solid #1e293b;
}

/* [Type 2] ëœë¤/íŒíŠ¸ì—†ìŒ: ì‘ì€ ê²€ì€ìƒ‰ ì› (ì²¨ë¶€íŒŒì¼ ì°¸ê³ ) */
.ball-button.btn-random {
    background-color: #ffffff; border: 4px solid #1e293b;
}
/* [ìˆ˜ì •] ëœë¤ ë‚´ë¶€ ì  í¬ê¸° 2ë°° í™•ëŒ€ (10px -> 20px) */
.random-dot {
    width: 20px !important; height: 20px !important;
    background-color: #1e293b; border-radius: 50%;
}
.ball-button.btn-gender, .ball-button.btn-random {
    background-color: #ffffff; border: 4px solid #1e293b;
}
.gender-text {
    font-family: 'Dongle', sans-serif; font-size: 2.3rem; font-weight: 700; color: #1e293b; margin-top: 4px;
}
/* --- [2ë©´] ë’·ë©´ ìˆ˜ì •: ë¹¨ê°• ë°°ê²½ + ì–‡ì€ ê²€ì€ í…Œë‘ë¦¬ --- */
.red-circle-style {
    z-index: 1;
    transform: rotateY(180deg); /* ë¯¸ë¦¬ ë’¤ì§‘ì–´ ë†“ê¸° */
    
    background: linear-gradient(to bottom,
        #ef4444 0%, #ef4444 46%,  /* ìœ„ìª½: ë¹¨ê°• */
        #1e293b 46%, #1e293b 54%, /* ì¤‘ê°„: ê²€ì€ ë  (ë‘ê»˜ ì¡°ì ˆ ê°€ëŠ¥) */
        #ffffff 54%, #ffffff 100% /* ì•„ë˜ìª½: í•˜ì–‘ */
    ) !important;

    /* í…Œë‘ë¦¬: ì•ë©´ê³¼ ë™ì¼í•œ ê²€ì€ìƒ‰ ê³„ì—´ë¡œ ë³€ê²½ */
    border: 5px solid #1e293b !important;

    border-radius: 50%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.15); /* ì‚´ì§ ì…ì²´ê° */
}

/* ë’·ë©´ ì´ë¦„ (í°ìƒ‰) */
.student-name-back {
    color: #ffffff !important; /* í°ìƒ‰ ê¸€ì”¨ */
    font-family: 'Dongle', sans-serif !important;
    font-weight: 700;
    text-align: center;
    line-height: 1.0;
    width: 90%;
    word-break: keep-all;
    position: relative;
    z-index: 10;

    /* â˜… ê¸€ì”¨ í…Œë‘ë¦¬ íš¨ê³¼ (ê²€ì€ìƒ‰ ê·¸ë¦¼ìë¥¼ ê²¹ì³ì„œ ë§Œë“¦) */
    text-shadow: 
        3px 0 0 #000, -3px 0 0 #000, 0 3px 0 #000, 0 -3px 0 #000,
        2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000,
        0 5px 10px rgba(0,0,0,0.5) !important;
}
/* [í•„ìˆ˜] 3D íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
.perspective { perspective: 1000px; }
.transform-style-3d { transform-style: preserve-3d; }
.backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
.absolute.inset-0 { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

/* [ìˆ˜ì •] ì¹´ë“œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ (íŒ íš¨ê³¼ ì œê±°, íšŒì „ë§Œ ì ìš©) */
.capsule-card {
    transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1) !important;
}
/* ë’¤ì§‘íŒ ìƒíƒœ */
.capsule-card.revealed {
    transform: rotateY(180deg);
}

.ball-style {
    z-index: 2; border-radius: 50%; overflow: hidden;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
}


 /* ==========================================================================
   [í†µí•© ìˆ˜ì •] ë‹¤ì´ë„ˆë§ˆì´íŠ¸ íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ (vFinal)
   ========================================================================== */

/* 1. ë‹¤ì´ë„ˆë§ˆì´íŠ¸ ë³¸ì²´ */
.bomb-window {
    position: fixed;
    min-width: 300px; 
    min-height: 190px;
    background-image: url('https://lh3.googleusercontent.com/d/1nmqdppJ6eoQUxN45eYBpJZnUp-XagPCN') !important;
    background-size: 100% 100% !important; /* ë°°ê²½ ì´ë¯¸ì§€ê°€ ì°½ í¬ê¸°ì— ë”± ë§ê²Œ ì¡°ì ˆë¨ */
    background-repeat: no-repeat !important;
    background-position: center !important;
    background-color: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
will-change: width, height;
    z-index: 9000;
    overflow: visible !important;
    container-type: size; /* ë‚´ë¶€ cqw ë‹¨ìœ„ê°€ ì •ìƒ ì‘ë™í•˜ë„ë¡ í•¨ */
--glow-color: rgba(255, 0, 0, 0.5); /* ê¸°ë³¸ ë¹¨ê°• */
    transition: filter 0.5s ease, transform 0.5s ease;
}

/* ì‘ë™ ì¤‘ì¼ ë•Œë§Œ ë§¥ë°• ì• ë‹ˆë©”ì´ì…˜ í™œì„±í™” */
.bomb-running-beat {
    animation: heart-beat var(--beat-speed, 1s) infinite ease-in-out !important;
}

/* ìŠ¤í†±ì›Œì¹˜ ëª¨ë“œ íŠ¹ìœ ì˜ ìƒ‰ìƒ í…Œë§ˆ */
.stopwatch-mode {
    --glow-color: #a855f7; /* ê¸°ë³¸ ë³´ë¼ìƒ‰ */
}

.stopwatch-mode .timer-input, .stopwatch-mode .timer-colon {
    color: #e0e7ff !important;
    text-shadow: 0 0 10px var(--glow-color);
}

/* 2. LCD í™”ë©´ ìœ„ì¹˜ (49%ë¡œ ë‚´ë ¤ì„œ ìœ„ì¹˜ ì¡°ì •) */
.display-unit {
    position: absolute;
    top: 52%; /* ë°°ê²½ ì´ë¯¸ì§€ì˜ ê²€ì€ í™”ë©´ ìœ„ì¹˜ì— ë”°ë¼ 50% ~ 53% ì‚¬ì´ ì¡°ì ˆ */
    left: 50.6%;
    transform: translate(-50%, -50%);
    /* ì „ì²´ ë„ˆë¹„ë¥¼ ì¤„ì—¬ì„œ ê²€ì€ í™”ë©´ ì•ˆìœ¼ë¡œ ëª¨ìŒ (ê¸°ì¡´ 50% -> 40%) */
    width: 40% !important; 
    height: 30% !important;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9005;
}

/* ë¶„/ì´ˆ ê°œë³„ ê·¸ë£¹ */
.time-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 35% !important; /* ë„ˆë¹„ë¥¼ 38%ì—ì„œ 35%ë¡œ ì¤„ì—¬ ì¤‘ì•™ìœ¼ë¡œ ëª¨ìŒ */
    position: relative;
}


.time-group .time-adj-btn:first-child {
    /* ìŒìˆ˜ ê°’ì„ í‚¤ìš¸ìˆ˜ë¡ ìœ„ë¡œ ë” ì˜¬ë¼ê°‘ë‹ˆë‹¤ */
    margin-bottom: 0.5cqw; 
    position: relative;
    top: -0.7cqw; /* ìœ„ìª½ ì—¬ë°±ìœ¼ë¡œ ë°€ì–´ì˜¬ë¦¼ */
}

.time-group .time-adj-btn:last-child {
    position: relative;
    top: -0.4cqw; /* ì•„ë˜ìª½ìœ¼ë¡œ ì‚´ì§ ë‚´ë¦¼ */
}

/* íˆ¬ëª… ì¡°ì ˆ í™”ì‚´í‘œ ë²„íŠ¼ */
.time-adj-btn {
    background: transparent !important;
    border: none !important;
    color: rgba(255, 31, 31, 0.5) !important;  
    font-size: 3.5cqw !important;  
    cursor: pointer;
    transition: all 0.2s;
    padding: 0 !important;
    z-index: 9015;
    line-height: 1;
}

.time-adj-btn:hover {
    color: #ff1f1f !important;
    transform: scale(1.4); /* í˜¸ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ ê°•í™” */
    text-shadow: 0 0 8px #ff0000;
}

.bomb-window.fixed.inset-0 .time-adj-btn {
    font-size: 3.5vw !important;
}
.bomb-window.fixed.inset-0 .time-group .time-adj-btn:first-child {
    top: -0.5vw; /* ìµœëŒ€í™” ëª¨ë“œì—ì„œ ìœ„ í™”ì‚´í‘œ ë” ìœ„ë¡œ */
}
.bomb-window.fixed.inset-0 .time-group .time-adj-btn:last-child {
    top: -0.4vw !important;
}
/* 3. ë””ì§€í„¸ ìˆ«ì ìŠ¤íƒ€ì¼ & í™”ì‚´í‘œ ì œê±° */
.timer-input {
    font-family: 'Courier New', monospace;
    font-variant-numeric: tabular-nums; /* ìˆ«ì í­ ê³ ì • */
    font-size: 12cqw !important;
    color: #ff1f1f !important;
    background: transparent !important;
    border: none !important;
    text-shadow: 0 0 10px #ff0000;
    text-align: center;
    
    /* [í•µì‹¬ ìˆ˜ì •] ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì •í•˜ì—¬ ì˜ë¦¬ì§€ ì•Šê²Œ í•¨ */
    width: 100% !important; 
    outline: none;
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1; /* ì¤„ ê°„ê²© ì¢í˜ */
    -moz-appearance: textfield;
}

/* ìŠ¤í†±ì›Œì¹˜ ëª¨ë“œì¼ ë•Œ ê¸€ì í¬ê¸° ë³´ì • */
.stopwatch-mode .timer-input {
    font-size: 8.5cqw !important; /* ê¸€ì ìˆ˜ê°€ ë§ì•„ì§€ë¯€ë¡œ ê¸°ì¡´ 12cqwì—ì„œ ì•½ê°„ ì¶•ì†Œ */
    letter-spacing: -0.1em;     /* ê°„ê²©ì„ ì¢í˜€ í•œëˆˆì— ë“¤ì–´ì˜¤ê²Œ í•¨ */
}

/* ìµœëŒ€í™” ëª¨ë“œì¼ ë•Œ ë³´ì • */
.fixed.inset-0.stopwatch-mode .timer-input {
    font-size: 8vw !important;
}

/* í¬ë¡¬, ì‚¬íŒŒë¦¬, ì—£ì§€ í™”ì‚´í‘œ(ìŠ¤í•€ë²„íŠ¼) ì œê±° ì½”ë“œ */
.timer-input::-webkit-outer-spin-button,
.timer-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.timer-colon {
    font-size: 9cqw !important;
    color: #ff1f1f !important;
    text-shadow: 0 0 10px #ff0000;
margin: 0 0.5cqw !important;
    padding-bottom: 0.5cqw;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 4. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ì§„í•œ íšŒìƒ‰) */
.timer-ctrl-btn {
    position: absolute;
    width: 6cqw !important;
    height: 6cqw !important;
    font-size: 2cqw !important; /* ì•„ì´ì½˜ í¬ê¸° */
    border: 0.6cqw solid #4a5568 !important; /* í…Œë‘ë¦¬ ë‘ê»˜ */
    box-shadow: 0 1cqw 2cqw rgba(0,0,0,0.5); /* ê·¸ë¦¼ì í¬ê¸° */
    
    top: 68.5%; 
    background: #1a202c !important;
    border-radius: 50% !important;
    color: white !important;
    cursor: pointer;
    z-index: 9010;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease-in-out;
}

/* ë²„íŠ¼ ê°€ë¡œ ìœ„ì¹˜ */
.btn-pos-1 { left: 35.5%; }  /* ì´ˆê¸°í™” */
.btn-pos-2 { 
    left: 43.5%; 
    background: #b91c1c !important; 
    border: 0.6cqw solid #7f1d1d !important;
}

.btn-pos-2:hover {
    background: #dc2626 !important; /* ë” ë°ì€ ë¹¨ê°• */
    transform: translateY(-2px);
}
.btn-pos-2.timer-running {
    background: #ef4444 !important;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.7) !important;
    animation: pulse-red 1.5s infinite;
}
.btn-pos-3 { left: 51.5%; }  /* ìµœëŒ€í™” */
.btn-pos-4 { left: 59.5%; }  /* ë‹«ê¸° */

/* ë²„íŠ¼ ì¸í„°ë™ì…˜ */
.timer-ctrl-btn:not(.btn-pos-2):hover {
    background: #4a5568 !important;
    transform: translateY(-2px);
}
/* ë¹¨ê°„ ë²„íŠ¼ì„ ì œì™¸í•œ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ë§Œ í´ë¦­ ì‹œ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
.timer-ctrl-btn:not(.btn-pos-2):active {
    background: #000 !important;
}

/* ë¹¨ê°„ ë²„íŠ¼ì€ í´ë¦­ ì‹œì—ë„ ë¹¨ê°„ìƒ‰ ê³„ì—´ ìœ ì§€ */
.btn-pos-2:active {
    transform: scale(0.9);
    background: #991b1b !important; /* í´ë¦­ ì‹œ ì•½ê°„ ë” ì–´ë‘ìš´ ë¹¨ê°• */
}

/* ì¬ìƒ ì¤‘ì¼ ë•Œ ê°•ì¡° */
.btn-play-dark.timer-running {
    background: #9b1c1c !important;
    border-color: #7f1d1d !important;
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
}

/* 2. [ê¸°ëŠ¥ì„±] ìš°ì¸¡ í•˜ë‹¨ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì‚¼ê°í˜• */
.timer-resize-handle {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 0;
    height: 0;
    border-style: solid;
    /* ì‚¼ê°í˜• í¬ê¸° ì„¤ì • */
    border-width: 2.5cqw; 
    /* ìš°ì¸¡ í•˜ë‹¨ë§Œ í°ìƒ‰ìœ¼ë¡œ ì¹ í•´ ì§ê°ì‚¼ê°í˜• ìƒì„± */
    border-color: transparent white white transparent;
    cursor: se-resize; /* ëŒ€ê°ì„  í¬ê¸° ì¡°ì ˆ ì»¤ì„œ */
    z-index: 9020;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.timer-resize-handle:hover {
    opacity: 1; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë” ì„ ëª…í•˜ê²Œ */
}

/* 5. í­ë°œ ì• ë‹ˆë©”ì´ì…˜ */
.full-screen-explosion {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 15vw;
    font-weight: 900;
    opacity: 0;
    pointer-events: none;
    background: #ef4444;
}
.explode-active {
    animation: full-explode-anim 1.5s ease-out forwards !important;
}
/* íƒ€ì´ë¨¸ ì‘ë™ ì¤‘ ë°°ê²½ ê´‘ì±„ íš¨ê³¼ */
.bomb-active-glow {
    animation: bomb-heavy-pulse 1.2s infinite alternate !important;
}


/* 3. ìŠ¤í†±ì›Œì¹˜ ëª¨ë“œ (ë³´ë¼/íŒŒë‘ ì‹¬ë°•ìˆ˜ ë¹„íŠ¸) */
.stopwatch-running-beat {
animation: stopwatch-heart-beat 2s infinite ease-in-out !important;
    display: block !important; }

.stopwatch-mode .timer-input, 
.stopwatch-mode .timer-colon {
    color: #ffffff !important;
    text-shadow: 0 0 15px var(--glow-color);
}

.stopwatch-mode .timer-colon {
    /* ê¸°ì¡´ ì½œë¡ (:)ë³´ë‹¤ ì (.)ì´ ì‘ì•„ ë³´ì´ë¯€ë¡œ í¬ê¸°ë¥¼ í‚¤ìš°ê³  ìœ„ì¹˜ë¥¼ ì¡°ì ˆ */
    margin-top: 1.5cqw; 
    font-size: 8cqw !important;
    vertical-align: bottom; /* ì ì´ ë°”ë‹¥ì— ë¶™ë„ë¡ ì„¤ì • */
}

/* 10ì´ˆ ë¯¸ë§Œ ê¸´ê¸‰ ìƒí™© (í”ë“¤ë¦¼ ì¶”ê°€) */
/* [ê°•í™”] 10ì´ˆ ë¯¸ë§Œ ê¸´ê¸‰ ìƒí™© (ê´‘ì±„ ê°•í™” + í”ë“¤ë¦¼ + ë²ˆì©ì„) */
.bomb-warning {
    animation: bomb-emergency-shake 0.18s infinite, bomb-emergency-flash 0.4s infinite !important;
}

/* [ìœ ì§€] ìŠ¤í†±ì›Œì¹˜ìš© ì°¨ë¶„í•œ ë§¥ë°• ì• ë‹ˆë©”ì´ì…˜ */
@keyframes stopwatch-heart-beat {
    0% { transform: scale(1); filter: drop-shadow(0 0 12px var(--glow-color)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 35px var(--glow-color)); }
    100% { transform: scale(1); filter: drop-shadow(0 0 12px var(--glow-color)); }
}

/* ë¶€ë“œëŸ¬ìš´ ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes bomb-heavy-pulse {
    0% { filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.4)); }
    100% { filter: drop-shadow(0 0 35px rgba(255, 0, 0, 0.9)) drop-shadow(0 0 100px rgba(255, 0, 0, 0.5)); }
}

/* 10ì´ˆ ì´í•˜ì¼ ë•Œ: ê°•ë ¬í•œ ë¶‰ì€ ê´‘ì±„ ì„¬ê´‘ */
@keyframes bomb-emergency-flash {
    0% { filter: drop-shadow(0 0 40px rgba(255, 0, 0, 0.8)); }
    50% { filter: drop-shadow(0 0 50px rgba(255, 0, 0, 1)) drop-shadow(0 0 150px rgba(255, 0, 0, 0.8)); }
    100% { filter: drop-shadow(0 0 40px rgba(255, 0, 0, 0.8)); }
}

/* 10ì´ˆ ì´í•˜ì¼ ë•Œ: ë” ë¹ ë¥¸ í”ë“¤ë¦¼ */
@keyframes bomb-emergency-shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    25% { transform: translate(-1px, -1px) rotate(-1deg); }
    50% { transform: translate(-1.7px, 1px) rotate(1deg); }
    75% { transform: translate(1px, -1px) rotate(-0.7deg); }
    100% { transform: translate(1px, 1px) rotate(0deg); }
}

/* ì‹¬ë°•ìˆ˜(BPM) ë§¥ë°• ì• ë‹ˆë©”ì´ì…˜ */
@keyframes heart-beat {
    0% { transform: scale(1); filter: drop-shadow(0 0 12px var(--glow-color)); }
    50% { transform: scale(1.04); filter: drop-shadow(0 0 30px var(--glow-color)); }
    100% { transform: scale(1); filter: drop-shadow(0 0 12px var(--glow-color)); }
}

/* [ìµœëŒ€í™” ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼] */
.bomb-window.fixed.inset-0 {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    /* [ìˆ˜ì •] ë°°ê²½ì„ íˆ¬ëª…ìœ¼ë¡œ ë³€ê²½ (ë’¤ì— ê²€ì€ ë§‰ì´ ìˆìœ¼ë‹ˆê¹Œ) */
    background-color: transparent !important;
    
    /* [ì¶”ê°€] ê¸°ë³¸ ë¶‰ì€ ì•„ìš°ë¼ (í­íƒ„ ëª¨ì–‘ëŒ€ë¡œ ë¹›ë‚¨) */
    filter: drop-shadow(0 0 50px rgba(255, 0, 0, 0.6));
    
    background-size: 81% 80% auto !important; 
    width: 100vw !important;
    height: 100vh !important;
    top: 0 !important;
    left: 0 !important;
}

/* [ì¶”ê°€] 10ì´ˆ ì´í•˜ ê¸´ê¸‰ ìƒí™©ì¼ ë•Œ: ì•„ìš°ë¼ê°€ ë¯¸ì¹œë“¯ì´ ë²ˆì©ì„ */
.bomb-window.fixed.inset-0.bomb-warning {
    animation: 
        full-screen-shake 0.18s infinite,      /* ë¯¸ë‹ˆì°½ê³¼ ê°™ì€ 0.18ì´ˆë¡œ ë³€ê²½ */
        full-screen-aura-flash 0.5s infinite alternate !important; 
}

/* [ìƒˆë¡œ ì •ì˜] ì „ì²´ í™”ë©´ìš© í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes full-screen-shake {
    0% { transform: translate(2px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(0px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(2px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(2px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}

@keyframes full-screen-aura-flash {
   0% { 
        filter: drop-shadow(0 0 40px rgba(255, 0, 0, 0.5)); 
    }
    100% { 
        filter: drop-shadow(0 0 150px rgba(255, 0, 0, 1)); /* ê°•ë ¬í•œ ë¶‰ì€ ë¹› */
    }
}

/* ìµœëŒ€í™” ì‹œ ìˆ«ìì™€ ë²„íŠ¼ í¬ê¸° ëŒ€í­ í™•ëŒ€ */
.bomb-window.fixed.inset-0 .timer-input {
    font-size: 9.5vw !important; /* ê¸°ì¡´ 15vwì—ì„œ ì¶•ì†Œ */
    margin: 0 !important;
    width: auto !important;
    text-align: center;
}

.bomb-window.fixed.inset-0 .timer-colon {
    font-size: 9vw !important;  /* ê¸°ì¡´ 12vwì—ì„œ ì¶•ì†Œ */
    margin-bottom: 2%;
    margin-left: -0.5vw !important;
    margin-right: -0.5vw !important;
    position: relative;
    z-index: 10; /* ìˆ«ìë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
}

/* ìµœëŒ€í™” ì‹œ í•˜ë‹¨ ë²„íŠ¼ë“¤ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì • */
.bomb-window.fixed.inset-0 .timer-ctrl-btn {
    width: 95px !important;    /* ë²„íŠ¼ í¬ê¸° ì‚´ì§ ì¡°ì • */
    height: 95px !important;
    font-size: 2.2rem !important;
    top: 69% !important;       /* ê¸°ì¡´ 75%ì—ì„œ ìœ„ë¡œ ëŒ€í­ ìƒí–¥ */

/* ìµœëŒ€í™” ëª¨ë“œì¼ ë•Œ ë²„íŠ¼ ê°€ë¡œ ê°„ê²© ë¯¸ì„¸ ì¡°ì • (ì„ íƒ ì‚¬í•­) */
.bomb-window.fixed.inset-0 .btn-pos-1 { left: 52%; }
.bomb-window.fixed.inset-0 .btn-pos-2 { left: 56%; }
.bomb-window.fixed.inset-0 .btn-pos-3 { left: 60%; }
.bomb-window.fixed.inset-0 .btn-pos-4 { left: 64%; }

    /* ë²„íŠ¼ ì…ì²´ê° ìœ ì§€ */
    border: 4px solid #000000 !important;
    box-shadow: 0 5px 0px #000000, 0 8px 15px rgba(0,0,0,0.6) !important;
}      

  /* [ë©”ì¸ ì¢Œì„] */
        .menu-item { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center center; position: relative; }
        .menu-item:hover { transform: scale(1.03); z-index: 50; }
        .score-rainbow { border: 4px solid transparent !important; background-image: linear-gradient(#fff, #fff), linear-gradient(to right, #ff2400, #e8b21d, #1de840, #1ddde8, #2b1de8, #dd00f3) !important; background-origin: border-box !important; background-clip: padding-box, border-box !important; animation: rainbow-flow 2s linear infinite !important; }
        @keyframes rainbow-flow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .aura-gold { box-shadow: 0 0 20px #fbbf24, 0 0 40px #fbbf24 !important; border-color: #fbbf24 !important; animation: aura-blink 1s infinite alternate !important; z-index: 10 !important; }
@keyframes aura-blink {
    0% { transform: scale(1); }
    100% { transform: scale(1.03); } /* 1.05 -> 1.03 */
}        
       .winner-aura {
    border-color: #fbbf24 !important;
    box-shadow: 0 0 30px #fbbf24, 0 0 60px rgba(251, 191, 36, 0.5) !important;
    animation: aura-blink 1s infinite alternate !important;
}

/* [ì‹ ê·œ] ë©”ë‰´ë°”ìš© ë¯¸ë‹ˆ ìº¡ìŠ ì•„ì´ì½˜ (ìœ„ ë¹¨ê°•, ì•„ë˜ í•˜ì–‘) */
.capsule-mini-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid #334155;
    background: linear-gradient(to bottom, #ef4444 50%, #ffffff 50%);
    display: inline-block;
    vertical-align: middle;
    margin-right: 6px;
    position: relative;
}
.capsule-mini-icon::after {
    content: '';
    position: absolute;
    top: 50%; left: 0; right: 0;
    height: 2px; background: #334155;
    transform: translateY(-50%);
}
/* [ì¶”ê°€] ë³´ë¼ìƒ‰ START ë²„íŠ¼ í´ë¦­ ì‹œ ë°”ë‹¥ ë‘ê»˜ ì¡°ì ˆ */
.bg-purple-600.border-b-[10px]:active {
    border-bottom-width: 0px !important;
    transform: translateY(10px) !important;
}

/* í•„í„° ë©”ë‰´ê°€ ë¶€ë“œëŸ½ê²Œ ìœ„ë¡œ ì˜¬ë¼ì˜¤ëŠ” íš¨ê³¼ */
.animate-fade-in {
    animation: toolbar-pop 0.25s ease-out;
}

@keyframes toolbar-pop {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}
        @keyframes winner-pop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }
  
        .classroom-floor { background-color: #eaddca; background-image: radial-gradient(#d3c1a5 1px, transparent 1px); background-size: 20px 20px; border: 12px solid #a68b6d; border-radius: 4rem; padding: 4rem; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .empty-slot { border: 2px dashed #a68b6d !important; }
        .rotate-180 { transform: rotate(180deg); }
        .rotate-180 .content-reverse { transform: rotate(-180deg) !important; }
        .check-icon-wrapper { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 50; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-180 .check-icon-wrapper { top: auto; right: auto; bottom: 0.5rem; left: 0.5rem; transform: rotate(-180deg); }
        .dragging { border: 3px solid #3b82f6 !important; z-index: 100; }
        
        .card-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; transition: all 0.3s ease; }
        .memo-container { display: flex; justify-content: center; align-items: center; gap: 4px; width: 95%; margin-top: 4px; }
        .memo-input { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-size: 11px; width: 100%; text-align: center; outline: none; font-weight: 700; padding: 2px 0; color: black; }
        .memo-star-active { background-color: #ef4444 !important; border-color: #b91c1c !important; color: white !important; }
        
        .seat-card-item { transition: transform 0.3s ease; }
        .float-active { z-index: 9999 !important; box-shadow: 0 30px 60px rgba(0,0,0,0.4) !important; transform: scale(1.1); }
        .chaos-move { transition: transform 0.15s ease-in-out !important; }
        .landing { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) !important; }
        
        /* [ëŒ ë ˆì´ìŠ¤ ìŠ¤íƒ€ì¼] */
        .font-game { font-family: 'Jua', sans-serif; }
        .font-cute { font-family: 'Jua', cursive; font-weight: 700; }
        .rock-race-container { position: fixed; inset: 0; z-index: 9999; background: #fffbeb; display: flex; flex-direction: column; font-family: 'Noto Sans KR', sans-serif; }
        .game-layout { display: flex; width: 100%; height: 100%; }
        .canvas-wrapper { flex: 1; position: relative; background-color: #a7f3d0; overflow: hidden; }
        .rank-sidebar { width: 320px; background: #fff; border-left: 6px solid #10b981; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.1); z-index: 50; }
        .rank-item { background: white; border-bottom: 2px solid #f1f5f9; padding: 10px 14px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .rank-badge-race { 
    width: 28px; 
    height: 28px; 
    border-radius: 8px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    
    /* ìˆ«ì í°íŠ¸ ë³€ê²½ */
    font-family: 'Jua', sans-serif !important; 
    font-size: 1.2rem; 
    padding-top: 2px;
    
    color: white; 
}
        /* [ì¶”ê°€] ëŒ ë ˆì´ìŠ¤ ë­í‚¹ ë°°ì§€ ìƒ‰ìƒ */
        .rank-1 { background-color: #ef4444; box-shadow: 0 2px 0 #b91c1c; } /* 1ë“±: ë¹¨ê°• */
        .rank-2 { background-color: #f97316; box-shadow: 0 2px 0 #c2410c; } /* 2ë“±: ì£¼í™© */
        .rank-3 { background-color: #fbbf24; box-shadow: 0 2px 0 #b45309; text-shadow: 0 1px 0 rgba(0,0,0,0.2); } /* 3ë“±: ë…¸ë‘ */
        .rank-normal { background-color: #94a3b8; box-shadow: 0 2px 0 #64748b; } /* 4ë“±~: íšŒìƒ‰ */
        .countdown-overlay { 
    position: fixed; 
    inset: 0; 
    z-index: 20000 !important; /* ìµœìƒìœ„ ë…¸ì¶œ ë³´ì¥ */
    display: flex; 
    align-items: center; 
    justify-content: center; 
    background: rgba(0,0,0,0.85); /* ë°°ê²½ìƒ‰ ì§„í•˜ê²Œ í†µì¼ */
    backdrop-filter: blur(5px); 
    pointer-events: none; 
}
      .countdown-text-group { 
    font-size: 15rem; 
    font-family: 'Jua', sans-serif; 
    font-weight: 900;
    color: #facc15; /* ë…¸ë€ìƒ‰ í†µì¼ */
    text-shadow: 0 0 50px rgba(250, 204, 21, 0.8); /* ê´‘ì±„ íš¨ê³¼ í†µì¼ */
    /* ì• ë‹ˆë©”ì´ì…˜ë„ ë™ì¼í•˜ê²Œ ë³€ê²½ (countdown-pop ì‚¬ìš©) */
    animation: countdown-pop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
}
                .result-overlay-race { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fade-in 0.5s; }
        
        /* [ëŒë©©ì´ ì„ ë°œ ë¯¸ë‹ˆì°½] */
       .race-setup-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.race-setup-window { background: white; border-radius: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5); display: flex; flex-direction: column; border: 8px solid #34d399; overflow: hidden; position: relative; animation: pop-bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 500px; min-height: 400px; }
.card-grid-10 { 
    display: grid; 
    grid-template-columns: repeat(9, 1fr); /* 9ì—´ ê³ ì • */
    gap: 10px; 
    padding: 25px; 
    overflow-y: auto; 
    align-content: start; 
    background-color: #f0fdf4; 
}
.student-rock-wrapper { position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 195px; cursor: pointer; transition: transform 0.2s; background: transparent !important; border: none !important; user-select: none; }
        .student-rock-wrapper:hover { transform: scale(1.1); }
        .student-rock-wrapper.inactive { opacity: 0.3; filter: grayscale(100%); transform: scale(0.9); }
        .rock-avatar-text { font-size: 8.0rem; line-height: 1; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3)); position: relative; z-index: 1; }
        .rock-overlay-info {
    position: absolute;
    /* ëŒë©©ì´ ì´ë¯¸ì§€ì˜ ì •ì¤‘ì•™ì— ì˜¤ë„ë¡ ì„¤ì • */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); 
    
    z-index: 10;
    text-align: center;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    /* ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ ì´ë¯¸ì§€ê°€ ì„ íƒë˜ë„ë¡ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ (í•„ìš”ì‹œ) */
    pointer-events: none; 
}
        .rock-name {
    font-family: 'Dongle', sans-serif !important;
    font-size: 1.8rem;
    color: white;
    /* ì¤‘ì•™ì—ì„œ ê¸€ìê°€ ì˜ ë³´ì´ë„ë¡ í…Œë‘ë¦¬ íš¨ê³¼(Shadow) ì¶”ê°€ */
    text-shadow: 
        2px 2px 0 #000, 
        -2px -2px 0 #000, 
        2px -2px 0 #000, 
        -2px 2px 0 #000,
        0 0 8px rgba(0,0,0,0.5);
    line-height: 1.2;
    white-space: nowrap;
    margin-bottom: 2px;
}

.countdown-text-race { 
    font-size: 15rem; 
    font-family: 'Black Han Sans', sans-serif; /* í°íŠ¸ ìœ ì§€ */
    font-weight: 900;
    
    /* ìƒ‰ìƒ ë³µêµ¬ (í•˜ì–€ìƒ‰ ê¸€ì”¨ + ì…ì²´ê° ìˆëŠ” ì´ˆë¡ ê·¸ë¦¼ì) */
    color: #fff; 
    text-shadow: 0 10px 0 #059669, 0 20px 40px rgba(0,0,0,0.5); 
    
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ëŠ” ìœ ì§€ */
    animation: pop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
}
        .rock-count-num {
    font-family: 'Jua', sans-serif !important; /* ê·€ì—¬ìš´ í°íŠ¸ ì ìš© */
    font-size: 2rem; /* ìˆ«ìê°€ ì˜ ë³´ì´ë„ë¡ í¬ê¸° ì¡°ì • */
    font-weight: normal;
color: #374151 !important; 
    text-shadow: 
        -2px -2px 0 #fff,  
         2px -2px 0 #fff,
        -2px  2px 0 #fff,
         2px  2px 0 #fff,
         0px  3px 5px rgba(0,0,0,0.2); /* ì€ì€í•œ ê·¸ë¦¼ìë¡œ ì…ì²´ê° ì¶”ê°€ */
    margin: 0 5px;
    min-width: 35px;
    text-align: center;
    display: inline-block;
}
.rock-count-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: transparent !important; /* ë°°ê²½ì„ ì—†ì• ì„œ ëŒë©©ì´ ìœ„ì— ë°”ë¡œ ë– ìˆëŠ” ëŠë‚Œ ìœ ë„ */
    margin-top: 5px;
    pointer-events: auto; 
}     
   .arrow-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.7) !important; /* ë°˜íˆ¬ëª… í°ìƒ‰ */
    border-radius: 8px;
    border: 1px solid #d1d5db !important;
    color: #4b5563 !important;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.arrow-btn:hover {
    background: #fff !important;
    transform: scale(1.1);
}
  
        /* [ëª¨ë‘  ë‹¬ë¦¬ê¸° - ì—­ì „ & í•„ì‚´ê¸° íš¨ê³¼ ê°•í™”] */
        .race-track-container { background: #1e293b; border: 8px solid #334155; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .track-lane { border-bottom: 1px dashed rgba(255,255,255,0.1); height: 75px; position: relative; }
        .finish-line { position: absolute; right: 80px; top: 0; bottom: 0; width: 15px; background: repeating-linear-gradient(0deg, #fff 0px, #fff 10px, #000 10px, #000 20px); }
        .character-wrapper { transition: left 0.1s linear; position: absolute; display: flex; align-items: center; }
        .animal-icon { animation: running-bounce 0.4s infinite alternate; transition: transform 0.2s; }
        @keyframes running-bounce { 0% { transform: translateY(0) rotate(-5deg); } 100% { transform: translateY(-6px) rotate(5deg); } }
        
/* [ëª¨ë‘  ë‹¬ë¦¬ê¸° ìƒíƒœ ìŠ¤íƒ€ì¼] */
.status-sprint { 
    transform: scale(1.2) skewX(-15deg) !important; 
    z-index: 50; 
    transition: transform 0.2s; 
}
.status-tired { 
    transform: scale(0.95) rotate(10deg) !important; 
    filter: grayscale(0.6) opacity(0.8); 
    transition: transform 0.5s; 
}
/* [ì´í™íŠ¸] */
.effect-dust { position: absolute; right: 110%; top: 20%; font-size: 2.5rem; animation: shake 0.1s infinite; z-index: -1; pointer-events: none; }
.effect-sweat { position: absolute; left: 80%; top: -20%; font-size: 2rem; animation: drip 0.8s infinite; z-index: 60; pointer-events: none; }

@keyframes shake { 0% { transform: translateX(0); } 50% { transform: translateX(-3px); } 100% { transform: translateX(3px); } }
@keyframes drip { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(10px); opacity: 0; } }

        .countdown-text-group { font-size: 15rem; font-family: 'Black Han Sans', sans-serif; color: #fbbf24; text-shadow: 0 0 30px rgba(0,0,0,0.5), 0 0 10px white; animation: pop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
  
        /* [ëª¨ë‘  í¸ì„± ê²°ê³¼] */
        .slot-spinning span { display: inline-block; filter: blur(3px); transform: scale(0.9) skewX(-10deg); transition: all 0.05s; opacity: 0.8; }
        .slot-stopped { animation: slot-lock-impact 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; border: 4px solid #facc15 !important; background-color: #fffbeb !important; box-shadow: 0 0 30px rgba(250, 204, 21, 0.6) !important; z-index: 10; }
        @keyframes slot-lock-impact { 0% { transform: scale(1); } 40% { transform: scale(1.15) rotate(2deg); } 70% { transform: scale(0.95) rotate(-2deg); } 100% { transform: scale(1) rotate(0); } }
  
        /* [ëª…ì˜ˆì˜ ì „ë‹¹] */
        .rank-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e2e8f0; }
        .rank-table th { background-color: #f1f5f9; color: #334155; padding: 12px; position: sticky; top: 0; font-weight: 800; font-size: 0.9rem; cursor: pointer; border-bottom: 2px solid #e2e8f0; }
        .rank-table th:hover { background-color: #e2e8f0; }
        .rank-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; vertical-align: middle; background-color: white; color: #1e293b; }
        .rank-table tr:hover td { background-color: #f8fafc; }
        .rank-badge { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.8rem; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .badge-1 { background: #ef4444; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4); }
        .badge-2 { background: #f97316; box-shadow: 0 2px 4px rgba(249, 115, 22, 0.4); }
        .badge-3 { background: #eab308; box-shadow: 0 2px 4px rgba(234, 179, 8, 0.4); }
        .badge-normal { background: #94a3b8; }
        .rank-input-white { background-color: transparent; color: #334155; border: none; outline: none; text-align: center; width: 100%; }
        .rank-input-white::placeholder { color: #cbd5e1; }
  
        /* [í­íƒ„] */
        .bomb-window { position: fixed; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at 30% 30%, #334155, #020617); border-radius: 50%; color: white; z-index: 9000; border: 0.8cqw solid #1e293b; box-shadow: 0 2cqw 5cqw rgba(0, 0, 0, 0.7); container-type: size; cursor: grab; width: 300px; height: 300px;}
        .bomb-emergency { background: radial-gradient(circle at 30% 30%, #ef4444, #7f1d1d) !important; animation: bomb-shake 0.1s infinite; }
        @keyframes bomb-shake { 0%, 100% { transform: translate(1px, 1px) rotate(0deg); } 50% { transform: translate(-2px, -1px) rotate(1deg); } }
     .bomb-wick { position: absolute; top: -8%; right: 22%; width: 4%; height: 13%; background: #475569; border-radius: 0.5cqw; transform: rotate(25deg); z-index: -1; }
        
        /* [ìˆ˜ì •] ë¶ˆê½ƒ ìœ„ì¹˜ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŒ€í­ ì´ë™ (right: 16% -> 5%) */
         .bomb-fire { position: absolute; top: -22%; right: 11%; font-size: 18cqw; filter: drop-shadow(0 0 3cqw #f59e0b); animation: fire-flicker 0.15s infinite alternate; }
        /* [ìˆ˜ì •] í° ë¶ˆê½ƒ ìœ„ì¹˜ ì¡°ì • (right: 12% -> 0%) */
        .fire-big { 
            font-size: 28cqw !important; 
            filter: drop-shadow(0 0 5cqw #ef4444); 
            top: -35% !important; 
            right: 4% !important; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ */
        }

        @keyframes fire-flicker { 0% { transform: scale(1) rotate(-5deg); opacity: 0.9; } 100% { transform: scale(1.1) rotate(8deg); opacity: 1; } }
        .timer-input { background: rgba(0,0,0,0.4); border: none; width: 28cqw; text-align: center; border-radius: 3cqw; font-weight: 900; font-size: 18cqw; color: white; outline: none; }
        .time-btn-glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 1.2cqw 2.2cqw; border-radius: 1.5cqw; font-size: 3cqw; font-weight: 800; color: white; margin: 0.4cqw; transition: all 0.2s; }
        .time-btn-glass:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
        .full-screen-explosion { position: fixed; inset: 0; background: #ef4444; z-index: 10000; display: flex; align-items: center; justify-content: center; color: white; font-size: 15vw; font-weight: 900; opacity: 0; pointer-events: none; }
        .explode-active { animation: full-explode-anim 1.5s ease-out forwards; }
        @keyframes full-explode-anim { 0% { opacity: 0; transform: scale(0.5); background: #facc15; } 10% { opacity: 1; transform: scale(1); background: #ef4444; } 100% { opacity: 0; transform: scale(2); } }
  
/* íŒì„œ ì°½ ì „ì²´ ì»¨í…Œì´ë„ˆ */
body .blackboard-window { 
    position: fixed; z-index: 7000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
    display: flex; flex-direction: column; overflow: hidden; border-radius: 12px; background: white;
}

/* í—¤ë” ë“œë˜ê·¸ ì˜ì—­ */
.blackboard-header { 
    height: 64px; /* íˆ´ë°”ì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
    background-color: #f1f5f9; 
    border-bottom: 1px solid #e2e8f0; 
    display: flex; 
    align-items: center; 
    padding: 0 20px; 
    cursor: move; 
    user-select: none; 
    flex-shrink: 0; 
}

/* ë„êµ¬ ëª¨ìŒ(íˆ´ë°”) */
.blackboard-toolbar { 
    height: 64px; background: white; border-bottom: 1px solid #e2e8f0; 
    display: flex; align-items: center; padding: 0 20px; gap: 20px; flex-shrink: 0; z-index: 10; 
}
/* í—¤ë” ì œëª© ê¸€ì”¨ í¬ê¸° í™•ëŒ€ */
.blackboard-header span {
    font-size: 1.5rem; /* ê¸°ì¡´ë³´ë‹¤ í¬ê²Œ */
    font-weight: 800;
}

/* ì „ì²´ í™”ë©´(ìµœëŒ€í™”) ëª¨ë“œ ìŠ¤íƒ€ì¼ */
.blackboard-window.maximized {
    top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
    border-radius: 0 !important; z-index: 9999 !important;
}

/* ë²„íŠ¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ ì¡°ì • */
.toolbar-btn { 
    width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; 
    border-radius: 12px; transition: all 0.2s; color: #475569; font-size: 1.6rem; 
    border: none !important; background: transparent; cursor: pointer;
}
.toolbar-btn:hover { background-color: #f1f5f9; color: #1e293b; }
.toolbar-select {
    height: 48px; padding: 0 10px; border-radius: 10px; font-size: 1rem;
    font-weight: bold; color: #475569; border: 1px solid #e2e8f0; cursor: pointer;
}

/* ì´ˆë¡ìƒ‰ ë°°ê²½ ì—ë””í„° ì˜ì—­ (ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬ ì¶”ê°€) */
body .blackboard-editor { 
    outline: none; flex: 1; width: 100%; height: 100%; overflow: auto !important; 
    background-color: #0f4c3a !important; position: relative; padding: 0 !important; 
    scrollbar-width: none; -ms-overflow-style: none;
}

body .blackboard-editor:hover { scrollbar-width: auto; }
body .blackboard-editor::-webkit-scrollbar { display: none; }
body .blackboard-editor:hover::-webkit-scrollbar { display: block; width: 8px; }
body .blackboard-editor::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }

/* ë°°ìœ¨ í‘œì‹œ ìˆ«ì ìŠ¤íƒ€ì¼ */
.zoom-text-input {
    font-size: 1.2rem; /* í¬ê¸° ì•½ê°„ í™•ëŒ€ */
    font-weight: 800;
   color: #334155;       
   min-width: 55px;
    text-align: center;
    outline: none;
    cursor: text;
}

/* í—¤ë” ë‚´ ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ë° ì •ë ¬ ì¡°ì • */
.blackboard-header .flex.items-center.gap-4 {
    gap: 1.5rem;           /* ì¡°ì ˆ ì¹¸ê³¼ ë²„íŠ¼ë“¤ ì‚¬ì´ì˜ ê°„ê²© í™•ëŒ€ */
}

/* ì‹¤ì œ ê¸€ì”¨ ë ˆì´ì–´ (ì¢Œì¸¡ ìƒë‹¨ ì •ë ¬ ìµœì í™”) */
.board-zoom-container {
    transform-origin: top left; min-width: 100%; min-height: 100vh !important;
    padding: 5px 12px !important; outline: none; display: block !important; 
    color: white; text-align: left; cursor: text;
}

/* [ì¶”ê°€] ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œë„ ë§ˆìš°ìŠ¤ í´ë¦­ì´ ì˜ ë˜ë„ë¡ í•¨ */
    cursor: text;
}

/* í™•ëŒ€ ë¹„ìœ¨ ìˆ«ì ì…ë ¥ ì‹œ ê°•ì¡° íš¨ê³¼ ì œê±° */
span[contenteditable="true"] {
    display: inline-block;
    outline: none;
    min-width: 35px;
    cursor: text;
}

/* ëª¨ë“  font íƒœê·¸: ìœ„ìª½ ì—¬ë°±ì„ ìŒìˆ˜(-)ë¡œ ì£¼ì–´ ë” ìœ„ë¡œ ëŒì–´ì˜¬ë¦¼ */
body .blackboard-editor font {
    display: inline-block !important;
    outline: none;       /* í´ë¦­ ì‹œ ìƒê¸°ëŠ” íŒŒë€ í…Œë‘ë¦¬ ì œê±° */
    min-width: 35px;    /* ìˆ«ìë¥¼ ë‹¤ ì§€ì›Œë„ í´ë¦­í•  ìˆ˜ ìˆëŠ” ìµœì†Œ ê³µê°„ í™•ë³´ */
    cursor: text;       /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì…ë ¥ ê°€ëŠ¥í•œ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½ */
}

    /* ê¸€ì ìœ„ìª½ ê³µê°„ì„ ê°•ì œë¡œ ê¹ì•„ì„œ ì²œì¥ì— ë¶™ì…ë‹ˆë‹¤ */
    margin-top: -30px !important; 
    margin-left: -10 !important;
    margin-bottom: 10px;
}
/* ëª¨ë“  font íƒœê·¸ì— ëŒ€í•´ í¬ê¸° ì¡°ì ˆì´ ê°€ëŠ¥í•˜ë„ë¡ 'ìƒì' í˜•íƒœë¡œ ë§Œë“­ë‹ˆë‹¤ (í•µì‹¬) */
body .blackboard-editor font {
    display: inline-block !important;
    vertical-align: top;
    margin-bottom: 20px;
}

/* [ê¸€ì”¨ í¬ê¸° ë‹¨ê³„ë³„ 2ë°° í™•ëŒ€ ì„¤ì •] */

/* 2ë‹¨ê³„: ì‘ê²Œ (ê¸°ì¡´ 1000px -> 2000px) */
body .blackboard-editor font[size="3"] { 
    font-size: 2000px !important; 
}

/* 3ë‹¨ê³„: ë³´í†µ (ê¸°ì¡´ 2000px -> 4000px) */
body .blackboard-editor font[size="5"] { 
    font-size: 4000px !important; 
    font-weight: 800 !important;
}

/* 4ë‹¨ê³„: í¬ê²Œ (ê¸°ì¡´ 3000px -> 6000px) 
   ë¸Œë¼ìš°ì €ê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” ì‚¬ì‹¤ìƒì˜ ìµœëŒ€ í¬ê¸°ì…ë‹ˆë‹¤. */
body .blackboard-editor font[size="7"] { 
    font-size: 6000px !important; 
    font-weight: 900 !important; 
    letter-spacing: -0.05em;
    -webkit-font-smoothing: antialiased;
}
  /* íŒ”ë ˆíŠ¸ z-index ìƒí–¥ ì¡°ì • */
        .color-palette { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e2e8f0; padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 9999; display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.25rem; width: max-content; }
        .color-dot { width: 1.5rem; height: 1.5rem; border-radius: 9999px; cursor: pointer; border: 1px solid rgba(0,0,0,0.2); transition: all 0.1s; }
        .board-list-mini {
            position: absolute;
            top: 50px;
            right: 0;
            width: 250px;
            bottom: 0;
            background: white;
            border-left: 1px solid #e2e8f0;
            z-index: 20;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            animation: slideInRight 0.2s ease-out;
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }       /* [ì¢Œì„ ì„¤ì • ì•„ì´ì½˜] */
        .seat-preview { width: 45px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid; cursor: pointer; transition: all 0.1s; position: relative; user-select: none; }
        .seat-active { background-color: #fff; border-color: #cbd5e1; color: #64748b; }
        .seat-empty { background-color: #fca5a5; border-color: #ef4444; color: #b91c1c; opacity: 0.8; }
        .seat-male { background-color: #dbeafe; border-color: #3b82f6; color: #1d4ed8; }
        .seat-female { background-color: #fce7f3; border-color: #ec4899; color: #be185d; }
        .seat-locked { background-color: #e2e8f0; border-color: #64748b; color: #475569; }
        
     

/* [í† ë„ˆë¨¼íŠ¸ ìŠ¤íƒ€ì¼ ê°œì„ ] */
.tournament-container {
    background: linear-gradient(to bottom, #1e3a8a, #312e81);
    color: white;
}

/* ëŒ€ì§„í‘œ íŠ¸ë¦¬ ë ˆì´ì•„ì›ƒ */
.bracket-tree {
    display: flex;
    justify-content: space-around;
    align-items: stretch;
    padding: 20px;
}

.round {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    flex: 1;
    max-width: 300px; /* ê° ë¼ìš´ë“œ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
    margin: 0 10px;
    position: relative;
}

/* ë§¤ì¹˜ ë°•ìŠ¤ (ì»¨í…Œì´ë„ˆ) */
.match-box {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 4px; /* ì´ë¦„í‘œ ì‚¬ì´ ê°„ê²© */
    margin: 10px 0;
    padding: 10px;
    /* ì—°ê²°ì„  ìœ„ì¹˜ ê¸°ì¤€ì  */
}

/* ì—°ê²°ì„  (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë»—ì–´ë‚˜ê°€ëŠ” ì„ ) */
.bracket-connector {
    position: absolute;
    right: -20px; /* ë¼ìš´ë“œ ê°„ê²©ì— ë”°ë¼ ì¡°ì ˆ */
    top: 50%;
    width: 20px;
    height: 2px;
    background: #6366f1; /* Indigo-500 */
    transform: translateY(-50%);
    z-index: 0;
}

/* ê°œë³„ ì„ ìˆ˜ ì´ë¦„í‘œ */
.player-slot {
    background: #4338ca; /* Indigo-700 */
    border: 2px solid #6366f1; /* Indigo-500 */
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 700;
    font-size: 1.1rem;
    color: #e0e7ff; /* Indigo-100 */
    text-align: center;
    position: relative;
    z-index: 10;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 50px;
}

.player-slot:hover {
    transform: scale(1.05);
    background: #4f46e5; /* Indigo-600 */
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
    z-index: 20;
}

/* ë¹ˆ ìŠ¬ë¡¯ (ì•„ì§ ì§„ì¶œì ì—†ìŒ) */
.player-slot.empty {
    background: rgba(30, 58, 138, 0.5); /* íˆ¬ëª…ë„ ìˆëŠ” ë‚¨ìƒ‰ */
    border: 2px dashed #4f46e5;
    color: #6366f1;
    cursor: default;
}
.player-slot.empty:hover {
    transform: none;
}

/* ìŠ¹ë¦¬ì ìŠ¤íƒ€ì¼ (ê°•ì¡°) */
.player-slot.winner {
    background: #fbbf24; /* Amber-400 (Gold) */
    color: #1e3a8a; /* Dark Blue Text */
    border-color: #f59e0b; /* Amber-500 */
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
    z-index: 15;
}

/* íŒ¨ë°°ì ìŠ¤íƒ€ì¼ (íë¦¬ê²Œ) */
.player-slot.loser {
    opacity: 0.5;
    filter: grayscale(0.5);
    background: #312e81;
}

/* ë¶€ì „ìŠ¹ ë¼ë²¨ */
.bye-badge {
    font-size: 0.75rem;
    background: rgba(255,255,255,0.2);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
}.winner-selection-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}
.name-tags {
    display: flex;
    gap: 20px;
}
.name-tag {
    padding: 10px 20px;
    background: white;
    border: 2px solid #ccc;
    cursor: pointer;
    font-size: 1.2rem;
}
.name-tag.selected {
    border-color: #fbbf24;
    background: #fef3c7;
    box-shadow: 0 0 10px #fbbf24;
}
.noise-level {
    font-family: 'Quantico', sans-serif;  /* ë””ì§€í„¸ ëŠë‚Œ í°íŠ¸ (headì— ì¶”ê°€ëœ í°íŠ¸) */
}

/* [ìˆ˜ì •] ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´: z-indexë¥¼ ìµœìƒìœ„ë¡œ ë†’ì´ê³  display ê°•ì œ ì ìš© */
.shuffle-countdown-overlay {
    position: fixed;
    inset: 0;
    z-index: 20000 !important; /* ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
    background: rgba(0, 0, 0, 0.85);
    display: flex !important;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    pointer-events: none; /* í´ë¦­ í†µê³¼ ë°©ì§€ */
}

.shuffle-countdown-text {
    font-size: 15rem;
    font-weight: 900;
    font-family: 'Black Han Sans', sans-serif; /* í°íŠ¸ í†µì¼ */
    color: #facc15;
    text-shadow: 0 0 50px rgba(250, 204, 21, 0.8);
    
    /* í•µì‹¬: ëª¨ë‘  ë‹¬ë¦¬ê¸°ì™€ ë™ì¼í•œ 'pop' ì• ë‹ˆë©”ì´ì…˜ ë° íƒ„ì„± íš¨ê³¼(cubic-bezier) ì ìš© */
    animation: pop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* [í™•ì¸] pop í‚¤í”„ë ˆì„ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í™•ì‹¤í•˜ê²Œ ì •ì˜ (ê¸°ì¡´ì— ìˆë‹¤ë©´ ë®ì–´ì”Œì›Œì§) */
@keyframes pop { 
    0% { transform: scale(0.5); opacity: 0; } 
    50% { transform: scale(1.15); opacity: 1; } /* 1.15ë°°ê¹Œì§€ ì»¤ì¡Œë‹¤ê°€ */
    100% { transform: scale(1); opacity: 1; }   /* ì›ë˜ í¬ê¸°ë¡œ ëŒì•„ì˜¤ë©° ë©ˆì¶¤ (íƒ„ë ¥ íš¨ê³¼) */
}
/* í•˜ë‚˜ì”© ë‚˜íƒ€ë‚  ë•Œì˜ ì• ë‹ˆë©”ì´ì…˜ */
.animate-pop-in {
    animation: tournament-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes tournament-pop {
    0% { opacity: 0; transform: scale(0.5); }
    100% { opacity: 1; transform: scale(1); }
}
/* í† ë„ˆë¨¼íŠ¸ ì „ìš© ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
.custom-scrollbar::-webkit-scrollbar { width: 10px; }
.custom-scrollbar::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; border: 2px solid #0f172a; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

/* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ: ë‚´ìš©ë¬¼ì„ ì •ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚´ */
.scaling-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* íŠ€ì–´ë‚˜ê°€ëŠ” ë¶€ë¶„ ì˜ë¼ëƒ„ */
    background-color: #f8fafc; /* ë°°ê²½ìƒ‰ */
}

/* ê³ ì • ë ˆì´ì•„ì›ƒ ë°•ìŠ¤: ë””ìì¸ì˜ ê¸°ì¤€ì´ ë˜ëŠ” íŒ */
.fixed-layout-box {
    width: 500px;  /* ê¸°ì¤€ ë„ˆë¹„ */
    height: 600px; /* ê¸°ì¤€ ë†’ì´ */
    
    /* í”Œë ‰ìŠ¤ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë‚´ë¶€ ì •ë ¬ */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    
    /* ì¤‘ì•™ì—ì„œë¶€í„° ì»¤ì§€ë„ë¡ ì„¤ì • */
    transform-origin: center center;
    /* ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™” */
    transition: transform 0.1s linear; 
}

/* 1. ìƒë‹¨ íƒ­ ìŠ¤íƒ€ì¼ */
.top-tabs {
    width: 380px;
    height: 60px;
    background: #1e293b;
    border-radius: 30px;
    padding: 6px;
    display: flex;
    gap: 10px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
}
.top-tabs button {
    flex: 1;
    border-radius: 24px;
    font-size: 20px;
    font-weight: 800;
    color: #94a3b8;
    background: transparent;
    transition: all 0.2s;
}
.top-tabs button.active {
    background: #475569;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

/* 2. ì¤‘ì•™ ì› ìŠ¤íƒ€ì¼ */
.center-circle-area {
    position: relative;
    z-index: 10;
}
.lottery-circle {
    background: white;
    border-radius: 50%;
    transition: border-color 0.4s ease, box-shadow 0.4s ease;
}

.h-full.flex-col .absolute.bottom-full {
    animation: drop-up 0.2s ease-out;
}
@keyframes drop-up {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.picker-tab-content-tournament {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden !important;
}
/* íˆ´ë°” ë‚´ ë²„íŠ¼ ê³µí†µ ì…ì²´ê° */
.fixed-layout-box + div button:active {
    transform: translateY(2px);
    border-bottom-width: 4px;
}
.lottery-name {
    font-size: 70px; /* ê³ ì • í°íŠ¸ í¬ê¸° */
    font-weight: 900;
    color: #1e293b;
    white-space: nowrap;
}

/* 3. í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
.bottom-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding-bottom: 20px;
}
.info-badge {
    background: #1e293b;
    color: white;
    font-size: 24px;
    font-weight: bold;
    padding: 10px 30px;
    border-radius: 15px;
}
.btn-group {
    display: flex;
    gap: 20px;
}
.btn-start {
    width: 200px;
    height: 70px;
    font-size: 36px;
    font-weight: 900;
    color: white;
    background: linear-gradient(to bottom, #3b82f6, #2563eb);
    border-radius: 20px;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4);
    transition: transform 0.1s;
}
.btn-start:active { transform: scale(0.95); }

.btn-reset {
    width: 140px;
    height: 70px;
    font-size: 24px;
    font-weight: bold;
    color: white;
    background: #475569;
    border-radius: 20px;
    box-shadow: 0 10px 20px rgba(71, 85, 105, 0.4);
    transition: transform 0.1s;
}
.btn-reset:active { transform: scale(0.95); }

/* 1. êµ´ëŸ¬ê°€ëŠ” ì¤‘: ìœ„ì•„ë˜ë¡œ ë¹ ë¥´ê²Œ í”ë“¤ë¦¼ */
.rolling-shake {
    animation: shake-vertical 0.4s infinite alternate;
}
@keyframes shake-vertical {
    0% { transform: translateY(0); }
    100% { transform: translateY(-50px); } /* ìœ„ë¡œ 15px íŠ€ì–´ ì˜¤ë¦„ */
}

/* ì ¤ë¦¬ì²˜ëŸ¼ íŠ•ê¸°ëŠ” ì¤Œì¸ íš¨ê³¼ */
.effect-zoom-bounce {
    animation: zoom-boing 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: center center;
    z-index: 100 !important;
    position: relative;
}

@keyframes zoom-boing {
    0% { transform: scale(1); }
    40% { transform: scale(2.0); } /* 1.4ë°°ê¹Œì§€ í™• ì»¤ì§ */
    70% { transform: scale(0.8); } /* ì‚´ì§ ì‘ì•„ì§ (ë°˜ë™) */
    100% { transform: scale(1); }   /* ì›ë˜ëŒ€ë¡œ */
}

/* [ì¶”ê°€] íƒˆë½ ì‹œ ê°•ë ¥í•œ ì¶©ê²© íš¨ê³¼ (ì§€ì§„ + ë¶‰ì€ ì„¬ê´‘) */
.effect-penalty-shock {
    animation: penalty-shake 3s cubic-bezier(.36,.07,.19,.97) both infinite;
    box-shadow: 0 0 0 1cqw #ef4444, 0 0 10cqw rgba(239, 68, 68, 1) !important;
    border-color: #ef4444 !important;
    background-color: #fee2e2 !important;
    z-index: 100;
}

@keyframes penalty-shake {
  /* ì›€ì§ì„ í­(cqw)ì„ ê¸°ì¡´ë³´ë‹¤ 3ë°° í‚¤ì›€ */
  0% { transform: translate3d(0, 0, 0) rotate(0); }
  15% { transform: translate3d(-3cqw, 0, 0) rotate(-5deg); } 
  30% { transform: translate3d(3cqw, 0, 0) rotate(3deg); }
  45% { transform: translate3d(-3cqw, 0, 0) rotate(-3deg); }
  60% { transform: translate3d(3cqw, 0, 0) rotate(2deg); }
  75% { transform: translate3d(-1cqw, 0, 0) rotate(-1deg); }
  100% { transform: translate3d(0, 0, 0) rotate(0); }
}   
/* (í™•ì¸ìš©) ìºë¦­í„° ë° ë¼ë²¨ ìŠ¤íƒ€ì¼ */
.cute-emoji { font-size: 5rem; line-height: 1; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
.cute-emoji.fire { filter: drop-shadow(0 0 10px rgba(249, 115, 22, 0.5)); }
.cute-emoji.water { filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5)); }

.gender-label {
    position: absolute; bottom: 10px; right: 10px;
    font-size: 1.2rem; font-weight: 900; padding: 2px 8px;
    border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transform: rotate(-10deg);
}
.gender-label.male { background-color: #fff7ed; color: #ea580c; border: 2px solid #f97316; }
.gender-label.female { background-color: #eff6ff; color: #2563eb; border: 2px solid #3b82f6; }
@keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }.animate-wiggle { animation: wiggle 1s ease-in-out infinite; }

@keyframes bounce-custom {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

.animate-bounce-custom {
    animation: bounce-custom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    font-family: 'Jua', sans-serif; /* ê·€ì—¬ìš´ í°íŠ¸ ì ìš© (ì„ íƒì‚¬í•­) */
    text-shadow: 0 4px 8px rgba(0,0,0,0.5); /* ê·¸ë¦¼ìë¡œ ì˜ ë³´ì´ê²Œ */
}
/* ì´ë¦„í‘œ ì›ì˜ í™©ê¸ˆìƒ‰ ì•„ìš°ë¼ íš¨ê³¼ */
.lottery-circle.winner-aura {
    border-color: #fbbf24 !important;
    box-shadow: 0 0 40px #fbbf24, 0 0 80px rgba(251, 191, 36, 0.6) !important;
    animation: aura-blink 1s infinite alternate !important;
}

/* íˆ´ë°” ë‚´ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ì²´ê° íš¨ê³¼ */
.bg-slate-800.border-b-[12px]:active {
    border-bottom-width: 0px !important;
    transform: translateY(8px) !important;
}

/* ëª¨ë“  ë²„íŠ¼ì— ê¸°ë³¸ ì»¤ì„œ ê°•ì œ */
.cursor-pointer {
    cursor: pointer !important;
}
/* [ì‹ ê·œ] CSSë¡œ ê·¸ë¦° ê°ˆìƒ‰ ì‚¬ë‹¤ë¦¬ ì•„ì´ì½˜ */
.icon-ladder {
    position: relative;
    width: 18px;
    height: 24px;
    border-left: 3px solid #8B4513;
    border-right: 3px solid #8B4513;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px; /* í…ìŠ¤íŠ¸ì™€ì˜ ê°„ê²© */
}
.icon-ladder::before, .icon-ladder::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 3px;
    background-color: #8B4513;
}
.icon-ladder::before { top: 6px; }  /* ìœ„ìª½ ë°œíŒ */
.icon-ladder::after { bottom: 6px; } /* ì•„ë˜ìª½ ë°œíŒ */

/* [ìˆ˜ì •] ìº¡ìŠ í¬ê¸° 1.3ë°° í™•ëŒ€ (ê¸°ì¡´ ì•½ w-12 h-16 ê¸°ì¤€) */
.capsule-item {
    width: 64px !important;  /* ì•½ 48px -> 64px */
    height: 86px !important; /* ì•½ 64px -> 86px */
    border-radius: 32px !important;
}
/* ìº¡ìŠ ë‚´ë¶€ í•˜ì´ë¼ì´íŠ¸ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì • */
.capsule-item::after {
    top: 10px !important;
    left: 10px !important;
    width: 16px !important;
    height: 16px !important;
}
/* [ìˆ˜ì •] ì£¼ì‚¬ìœ„ í¬ê¸° í™•ëŒ€ (ê¸°ì¡´ w-48(192px) -> 260pxë¡œ ì•½ 1.35ë°° í™•ëŒ€) */
/* ì£¼ì‚¬ìœ„ íë¸Œ ì»¨í…Œì´ë„ˆ */
.dice-cube {
    width: 260px !important;
    height: 260px !important;
}
/* ì£¼ì‚¬ìœ„ ë©´ (translateZëŠ” widthì˜ ì ˆë°˜) */
.dice-face {
    width: 260px !important;
    height: 260px !important;
    border: 4px solid #e2e8f0 !important; /* í…Œë‘ë¦¬ë„ ì•½ê°„ ë‘ê»ê²Œ */
}
.dice-face-front  { transform: rotateY(0deg) translateZ(130px) !important; }
.dice-face-back   { transform: rotateY(180deg) translateZ(130px) !important; }
.dice-face-right  { transform: rotateY(90deg) translateZ(130px) !important; }
.dice-face-left   { transform: rotateY(-90deg) translateZ(130px) !important; }
.dice-face-top    { transform: rotateX(90deg) translateZ(130px) !important; }
.dice-face-bottom { transform: rotateX(-90deg) translateZ(130px) !important; }
/* ì£¼ì‚¬ìœ„ ì  í¬ê¸° í™•ëŒ€ */
.dice-dot {
    width: 50px !important;
    height: 50px !important;
}

/* [ì‚¬ë‹¤ë¦¬ íƒ€ê¸° - ì •ê¸€ì§ í…Œë§ˆ ìŠ¤íƒ€ì¼] */

/* 1. ë°°ê²½: ê¹Šì€ ìˆ²ì† ìƒ‰ìƒ */
.ladder-jungle-bg {
    background-color: #1b4332 !important;
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 20%) !important;
}
/* 2. ìƒë‹¨ ì´ë¦„í‘œ (ë‚˜ë¬´ íŒ»ë§) */
.wood-sign-btn {
    background: #8b4513 !important;
    border: 4px solid #5e3008 !important;
    color: #fffbeb !important;
    box-shadow: 0 4px 0 #3e1f03 !important;
    
    /* â˜… ìˆ˜ì •: í•˜ë‹¨ê³¼ ë™ì¼í•˜ê²Œ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš© */
    border-radius: 0.75rem !important; 
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
}
.wood-sign-btn:active {
    transform: translateY(6px);
    box-shadow: 0 0 0 #3e1f03, inset 0 2px 5px rgba(0,0,0,0.5) !important;
}
.wood-sign-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* 3. í•˜ë‹¨ ê²°ê³¼ ìƒì (ë‚˜ë¬´ ìƒì) */
.wood-crate-box {
    background: #d4a373 !important;
    border: 4px solid #8d5524 !important;
    color: #482808 !important;
    font-family: 'Jua', sans-serif !important;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.3) !important;
    border-radius: 0.75rem;

    /* â˜… í•µì‹¬: font-size, height ì‚­ì œ (JSì—ì„œ ë™ì  ì œì–´) */
    /* font-size: 1.6rem !important; <-- ì‚­ì œë¨ */
    font-weight: 900 !important;
    
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
}
/* ë‚˜ë¬´ ì§ˆê° íš¨ê³¼ (ê°€ë¡œì„ ) */
.wood-crate-box::after {
    content: none !important; /* ì¤„ ì œê±° */
}
/* [ìƒë‹¨ ì´ë¦„í‘œ ê°•ì¡° ìŠ¤íƒ€ì¼] - í¬ê¸° í™•ëŒ€(scale) ì—†ìŒ */
.wood-sign-active {
    border-color: #fbbf24 !important; /* í™©ê¸ˆìƒ‰ í…Œë‘ë¦¬ */
    background: #fff8e1 !important;   /* ë°ì€ ë°°ê²½ */
    color: #b45309 !important;        /* ê¸€ì”¨ ìƒ‰ìƒ */
    /* transform ì†ì„± ì œê±°í•˜ì—¬ ê²¹ì¹¨ ë°©ì§€ */
    box-shadow: 0 0 20px #fbbf24, inset 0 0 10px #fbbf24 !important; /* ê´‘ì±„ íš¨ê³¼ */
    z-index: 50;
}
/* ìƒë‹¨ ì´ë¦„í‘œ & í•˜ë‹¨ ê²°ê³¼ ìƒì ê³µí†µ í™œì„±í™” ìŠ¤íƒ€ì¼ */
.wood-active {
    border-color: #d97706 !important; 
    background: #fef3c7 !important;    /* ì¼œì§ˆ ë•ŒëŠ” ë°ì€ ë…¸ë€ìƒ‰ */
    color: #92400e !important;         /* ì¼œì§ˆ ë•ŒëŠ” ì§„í•œ ê°ˆìƒ‰ ê¸€ì”¨ */
    box-shadow: 0 0 20px #d97706, inset 0 0 10px #d97706 !important;
    z-index: 60;
}
/* [ê²°ê³¼ ëª¨ë‹¬ - ì •ê¸€ ë””ìì¸] */
.jungle-modal-frame {
    background-color: #fdf6e3; /* ì–‘í”¼ì§€ ìƒ‰ */
    border: 8px solid #5e3008; /* ì§„í•œ ë‚˜ë¬´ í…Œë‘ë¦¬ */
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}
.jungle-modal-header {
    background-color: #fffbeb;
    border-bottom: 4px solid #8b4513;
    color: #5e3008;
}
.jungle-list-item {
    background-color: #fff;
    border: 3px solid #d4a373; /* ì—°í•œ ë‚˜ë¬´ í…Œë‘ë¦¬ */
    color: #5e3008;
    transition: transform 0.1s;
}
.jungle-list-item:hover {
    transform: scale(1.02);
    border-color: #8b4513;
}
.jungle-badge {
    background-color: #8b4513;
    color: #fffbeb;
    border-radius: 8px;
}
.result-box {
    border: 2px solid #3e2723; /* í…Œë‘ë¦¬ë„ ì–´ìš¸ë¦¬ëŠ” ì§„í•œ ê°ˆìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    background-color: #5D4037; /* ë°°ê²½: ì§„í•œ ê°ˆìƒ‰ */
    color: white;              /* ê¸€ì”¨: í°ìƒ‰ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* ì•½ê°„ì˜ ê·¸ë¦¼ì ì¶”ê°€ */
}
.wood-crate-box.bad-result {
    background: #5D4037 !important;
    border: 4px solid #3E2723 !important;
    color: #ffffff !important;
}
 </style>
</head>
<body>
<div id="app" class="flex h-screen w-screen" @contextmenu.prevent v-cloak>        

<div v-if="isShufflingCountdown" class="shuffle-countdown-overlay">
    <div :key="shuffleCountdownNum" class="shuffle-countdown-text">
        {{ shuffleCountdownNum }}
    </div>
</div>
<div v-if="isClockMaximized" 
     @click="isClockMaximized = false"
     class="fixed inset-0 z-[99999] bg-slate-900 flex flex-col items-center justify-center cursor-pointer animate-fade-in text-white select-none">
    
    <div class="text-5xl md:text-7xl font-bold text-slate-400 mb-9 flex items-center gap-5">
        <i class="fa-regular fa-calendar-check"></i> {{ currentDate }}
    </div>
    
    <div class="font-black tracking-tighter text-[16rem] sm:text-[20rem] md:text-[20vw] lg:text-[18vw] xl:text-[16vw] leading-none text-white drop-shadow-[0_12px_40px_rgba(0,0,0,0.5)] flex items-baseline digital-font justify-center -translate-x-1">
        <div class="inline-block w-[6ch] text-right tabular-nums">
            {{ miniTime }}
        </div>
        <span class="text-[0.60em] text-gray-400 ml-6 opacity-90 inline-block w-[2.8ch] text-left tabular-nums">
            {{ currentSeconds }}
        </span>
    </div>
</div>

        <aside class="sidebar flex flex-col px-6 py-8 w-[320px] bg-white shadow-2xl z-40">
            <div class="flex items-center gap-3 mb-10 px-2">
                <h1 class="text-2xl font-black text-slate-800">ğŸ« ìš°ë¦¬ë°˜ ë§¤ë‹ˆì €</h1>
                <button @click="openSettings" class="text-slate-300 hover:text-orange-500 transition-all"><i class="fa-solid fa-gear"></i></button>
            </div>
            
            <nav class="mb-6 flex-1 overflow-y-auto px-2 pt-2 space-y-3">
                <div @click="view = 'main'; playSound('click')" 
     :class="view === 'main' ? 'ring-4 ring-red-200' : ''" 
     class="menu-item bg-red-500 cursor-pointer p-4 rounded-2xl font-black text-white text-center shadow-md">
     ì¢Œì„ ë°°ì¹˜ë„
</div>
                <div @click="view = 'order'; playSound('click')" 
     :class="view === 'order' ? 'ring-4 ring-orange-200' : ''" 
     class="menu-item bg-orange-500 cursor-pointer p-4 rounded-2xl font-black text-white text-center shadow-md">
     ëŒ€ê¸° ë²ˆí˜¸
</div>

<div @click="view = 'group'; playSound('click')" 
     :class="view === 'group' ? 'ring-4 ring-yellow-200' : ''" 
     class="menu-item bg-yellow-400 cursor-pointer p-4 rounded-2xl font-black text-black text-center shadow-md">
     ëª¨ë‘  í™œë™
</div>
                
                <button @click="openRankModal" class="w-full text-left bg-yellow-50 border-4 border-yellow-200 rounded-[2.5rem] p-6 cursor-pointer hover:bg-yellow-100 transition-all mt-6 relative block">
                    <h3 class="font-black text-yellow-600 mb-4 text-center text-sm">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                    <div class="flex flex-col gap-2">
                        <div v-for="(s, idx) in topStudents" :key="idx" class="bg-white p-2 px-4 rounded-xl flex justify-between items-center text-sm border border-yellow-100 shadow-sm">
                            <span class="font-bold text-slate-700 flex items-center gap-2">
                                <span v-if="idx===0">ğŸ¥‡</span><span v-else-if="idx===1">ğŸ¥ˆ</span><span v-else-if="idx===2">ğŸ¥‰</span><span v-else>ğŸ…</span>
                                {{ s.name }}
                            </span>
                            <span class="font-black text-orange-500">{{ s.activityScore }}</span>
                        </div>
                    </div>
                </button>
<div @click="isClockMaximized = true"
     class="mt-6 w-full bg-white border-4 border-slate-200 rounded-[2.5rem] p-5 shadow-sm text-center select-none hover:border-blue-300 hover:shadow-md transition-all cursor-pointer group flex flex-col justify-center items-center gap-2">

    <!-- ë‚ ì§œ -->
    <div class="text-slate-400 font-bold text-base flex items-center gap-2 group-hover:text-blue-400 transition-colors">
        <i class="fa-regular fa-calendar-check"></i>
        {{ currentDate }}
    </div>

    <!-- ì‹œê°„ (ì½œë¡  ê¹œë¹¡ì„ ë³µêµ¬) -->
    <div class="text-6xl font-black text-slate-800 tracking-tight leading-none digital-font flex items-baseline">
        <span>{{ miniTime.split(':')[0] }}</span>
        <span class="blink-colon mx-2">:</span>
        <span>{{ miniTime.split(':')[1] }}</span>
    </div>
</div>            </nav>
  
            <div class="mt-auto pt-4 border-t border-slate-100 flex justify-center gap-4">
                <button @click="openBlackboard" title="íŒì„œ" class="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-2xl hover:bg-emerald-600 hover:text-white transition-all shadow-sm flex items-center justify-center text-2xl"><i class="fa-solid fa-chalkboard-user"></i></button>
                <button @click="openTimer" title="í­íƒ„ íƒ€ì´ë¨¸" class="w-14 h-14 bg-purple-100 text-purple-600 rounded-2xl hover:bg-purple-600 hover:text-white transition-all shadow-sm flex items-center justify-center text-2xl">
    <i class="fa-solid fa-bomb"></i>
</button>
                
                <button @click="openPickerMaster" title="ë½‘ê¸° ë„êµ¬" class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-2xl hover:bg-indigo-600 hover:text-white transition-all shadow-sm flex items-center justify-center text-2xl">
    <i class="fa-solid fa-gift"></i>
</button>
                
<button @click="openNoiseMeter" title="ì†ŒìŒ ì¸¡ì •ê¸°" class="w-14 h-14 bg-pink-100 text-pink-600 rounded-2xl hover:bg-pink-600 hover:text-white transition-all shadow-sm flex items-center justify-center text-2xl">
    <i class="fa-solid fa-microphone"></i>
</button>
            </div>
        </aside>
  
       <main class="flex-1 flex flex-col items-center justify-center p-8 relative">
           <div class="absolute top-8 right-8 z-50 flex flex-col gap-3">
                <button v-if="view !== 'order'" title="íšŒì „" @click="isRotated = !isRotated; saveToLocal();" class="w-14 h-14 bg-white rounded-2xl shadow-lg flex items-center justify-center text-slate-400 border-2 hover:scale-110 transition-all"><i class="fa-solid fa-arrows-rotate text-2xl"></i></button>
                
                <button v-if="view !== 'order'" title="ì ìˆ˜ ì´ˆê¸°í™”" @click="resetCurrentScores" class="w-14 h-14 bg-white rounded-2xl shadow-lg flex items-center justify-center text-red-400 border-2 hover:scale-110 transition-all"><i class="fa-solid fa-eraser text-2xl"></i></button>
                <button v-if="view !== 'order'" title="ì„ íƒ ì´ˆê¸°í™”" @click="resetCurrentSelection" class="w-14 h-14 bg-white rounded-2xl shadow-lg flex items-center justify-center text-emerald-500 border-2 hover:scale-110 transition-all"><i class="fa-solid fa-check-double text-2xl"></i></button>
                <button v-if="view !== 'order'" @click="clearMemos" title="ë©”ëª¨ ì‚­ì œ" class="w-14 h-14 bg-white rounded-2xl shadow-lg flex items-center justify-center text-indigo-500 border-2 hover:scale-110 transition-all"><i class="fa-solid fa-trash-can text-2xl"></i></button>
            </div>

            <div id="classroom-floor" 
     class="classroom-floor shadow-2xl transition-all" 
     :class="[
        {'rotate-180': isRotated}, 
        {'mr-[300px]': view === 'order'},
        isInitialLoad ? 'duration-0' : 'duration-500' 
     ]">
                <div class="flex justify-center mb-12">
                    <div class="content-reverse"><span class="bg-slate-800 text-white px-28 py-4 rounded-full text-2xl font-black inline-block shadow-xl">êµ íƒ</span></div>
                </div>
                
                <div v-if="view === 'group'" class="grid grid-cols-3 gap-12">
                    <div v-for="(g, idx) in groups" :key="idx" @click="handleGroupClick(idx)"
                         class="w-[280px] h-[220px] shadow-2xl rounded-[3rem] border-4 flex flex-col items-center justify-center relative transition-all cursor-pointer overflow-hidden"
                         :class="[ g.checked ? 'bg-slate-500 border-slate-600' : (g.score >= 7 ? 'score-rainbow' : getScoreBg(g.score)), { 'aura-gold': allMode } ]">
                        <div v-if="g.checked" class="check-icon-wrapper w-10 h-10 bg-white rounded-full flex items-center justify-center text-emerald-600 border-2 border-emerald-200 shadow-sm"><i class="fa-solid fa-check text-xl"></i></div>
                        <div class="content-reverse card-container">
                            <div class="font-black text-2xl mb-2" :class="(g.checked || g.score !== 0) ? 'text-inherit' : 'text-slate-800'">{{ idx + 1 }}ëª¨ë‘ </div>
                            <div class="font-black text-7xl" :class="(g.checked || g.score !== 0) ? 'text-inherit' : 'text-slate-800'">{{ g.score > 0 ? '+' : '' }}{{ g.score }}</div>
                            <div v-if="isMemoVisible" class="memo-container" @click.stop>
                                <input v-model="g.memo" @change="saveToLocal" placeholder="ë©”ëª¨..." class="memo-input" :class="{'memo-star-active': g.starred}">
                                <button @click="g.starred = !g.starred; saveToLocal();"> <i :class="g.starred ? 'fa-solid fa-star text-yellow-500' : 'fa-regular fa-star text-slate-400'"></i> </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="flex gap-12">
                    <div v-for="bIdx in 3" :key="bIdx" class="grid grid-rows-5 gap-4">
                        <div v-for="rIdx in 5" :key="rIdx" class="flex gap-4">
                            <div v-for="pIdx in 2" :key="pIdx" class="w-[140px] h-[115px] rounded-2xl relative empty-slot" @dragover.prevent @drop="onDropSeat($event, getIndex(bIdx, rIdx, pIdx))">
                                <div v-if="seats[getIndex(bIdx, rIdx, pIdx)]" 
                                     class="seat-card-item w-full h-full absolute inset-0 rounded-2xl flex flex-col items-center justify-center shadow-md border-2 cursor-pointer overflow-hidden px-2"
                                     :draggable="view === 'main'" @dragstart="onDragStart($event, getIndex(bIdx, rIdx, pIdx), 'seat')" 
                                     @dragend="onDragEnd"
                                     @click="handleCardClick(getIndex(bIdx, rIdx, pIdx))" 
                                     :class="[
                                         (view === 'order') ? (isFirstOrder(seats[getIndex(bIdx, rIdx, pIdx)]) ? 'bg-red-600 scale-110 shadow-2xl z-50 text-white' : (seats[getIndex(bIdx, rIdx, pIdx)].order ? 'bg-yellow-400 text-black' : 'bg-white text-black')) : '',
                                         (view !== 'order' && seats[getIndex(bIdx, rIdx, pIdx)].checked) ? 'bg-slate-500 border-slate-600 text-white' : 
                                         (view !== 'order' ? (seats[getIndex(bIdx, rIdx, pIdx)].activityScore >= 7 ? 'score-rainbow' : getScoreBg(seats[getIndex(bIdx, rIdx, pIdx)].activityScore)) : ''),
                                         { 'aura-gold': allMode && view !== 'order' }
                                     ]">
                                    <div v-if="view !== 'order' && seats[getIndex(bIdx, rIdx, pIdx)].checked" class="check-icon-wrapper w-7 h-7 bg-white rounded-full flex items-center justify-center text-emerald-600 border border-emerald-200 shadow-sm"><i class="fa-solid fa-check text-xs"></i></div>
                                    <div class="content-reverse card-container">
                                        <div class="font-black text-xl leading-none mb-3" 
                                             :class="[ (view !== 'order' && (seats[getIndex(bIdx, rIdx, pIdx)].checked || seats[getIndex(bIdx, rIdx, pIdx)].activityScore !== 0)) ? 'text-inherit' : '', (view === 'order' && isFirstOrder(seats[getIndex(bIdx, rIdx, pIdx)])) ? 'text-white' : (view === 'order' ? 'text-black' : '') ]">
                                             {{ seats[getIndex(bIdx, rIdx, pIdx)].name }}
                                        </div>
                                        <div v-if="view === 'main'" class="text-2xl font-black leading-none mb-1" :class="(seats[getIndex(bIdx, rIdx, pIdx)].checked || seats[getIndex(bIdx, rIdx, pIdx)].activityScore !== 0) ? 'text-inherit' : ''">{{ seats[getIndex(bIdx, rIdx, pIdx)].activityScore > 0 ? '+' : '' }}{{ seats[getIndex(bIdx, rIdx, pIdx)].activityScore }}</div>
                                        <div v-if="view === 'order' && seats[getIndex(bIdx, rIdx, pIdx)].order" class="w-8 h-8 bg-black/10 rounded-full flex items-center justify-center font-black text-sm text-black">{{ seats[getIndex(bIdx, rIdx, pIdx)].order }}</div>
                                        <div v-if="isMemoVisible && view !== 'order'" class="memo-container" @click.stop>
                                            <input v-model="seats[getIndex(bIdx, rIdx, pIdx)].memo" @change="saveToLocal" placeholder="ë©”ëª¨..." class="memo-input" :class="{'memo-star-active': seats[getIndex(bIdx, rIdx, pIdx)].starred}">
                                            <button @click="seats[getIndex(bIdx, rIdx, pIdx)].starred = !seats[getIndex(bIdx, rIdx, pIdx)].starred; saveToLocal();"> <i :class="seats[getIndex(bIdx, rIdx, pIdx)].starred ? 'fa-solid fa-star text-yellow-500' : 'fa-regular fa-star text-slate-400'"></i> </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
  
           <div v-if="view === 'order'" 
                 class="fixed right-10 top-10 w-[260px] h-[80vh] bg-white/90 backdrop-blur rounded-[2.5rem] flex flex-col items-center py-8 px-5 gap-5 shadow-2xl border-4 border-slate-200 z-30" 
                 @dragover.prevent @drop="onDropToBottom">
                 <div class="shrink-0 w-full text-center border-b-2 border-slate-200 pb-4 mb-1">
                    <span class="text-slate-700 font-black text-3xl flex items-center justify-center gap-2">
                        ìˆœì„œ
                    </span>
                </div>
                <div class="flex flex-col gap-3 w-full flex-1 overflow-y-auto pr-1 custom-scrollbar">
                    <div v-if="sortedOrderedStudents.length === 0" class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60 text-center">
                        <i class="fa-solid fa-list-ol text-4xl mb-3"></i>
                        <span class="text-sm font-bold break-keep">ëŒ€ê¸°ìê°€<br>ì—†ìŠµë‹ˆë‹¤</span>
                    </div>
                    <div v-for="(s, idx) in sortedOrderedStudents" :key="s.name" draggable="true" @dragstart="draggedOrderIdx = idx" @dragover.prevent @drop.stop="onDropReorder(idx)" @contextmenu.prevent="s.order = null" class="flex items-center gap-3 border-4 px-3 py-3 rounded-2xl shrink-0 cursor-move transition-all shadow-sm hover:scale-[1.02]" :class="[isFirstOrder(s) ? 'bg-red-600 text-white border-white' : 'bg-yellow-400 text-black border-yellow-500']">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-black text-base shrink-0" :class="isFirstOrder(s) ? 'bg-white/20 text-white' : 'bg-black/10 text-black'">{{ s.order }}</div>
                        <span class="font-black text-lg flex-1 truncate">{{ s.name }}</span>
                        <i class="fa-solid fa-grip-lines opacity-50 text-sm"></i>
                    </div>
                </div>
            </div>
        </main>
  
        <div class="fixed bottom-10 right-8 flex flex-col gap-4">
            
            <button v-if="view === 'main'" title="ìë¦¬ ë°”ê¾¸ê¸°" @click="openShuffleModal" class="w-16 h-16 bg-blue-500 text-white rounded-3xl shadow-2xl border-4 border-white flex items-center justify-center text-2xl hover:scale-110 transition-all">
                <i class="fa-solid fa-chair"></i>
            </button>

            <button v-if="view === 'group'" @click="openGroupMaker" title="ëª¨ë‘  í¸ì„±" class="w-16 h-16 bg-blue-600 text-white rounded-3xl shadow-2xl border-4 border-white flex items-center justify-center text-2xl hover:scale-110 transition-all">
                <i class="fa-solid fa-shuffle"></i>
            </button>
            
            <button v-if="view === 'main'" @click="openRockRace" title="ëŒ êµ´ëŸ¬ê°€ìœ ~" class="w-16 h-16 bg-orange-500 text-white rounded-3xl shadow-2xl border-4 border-white flex items-center justify-center text-2xl hover:scale-110 transition-all">
    <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Rock.png" width="35" height="35" alt="Rock">
</button>

            <button v-if="view === 'group'" @click="openAnimalRaceModal" class="w-16 h-16 bg-orange-500 text-white rounded-3xl shadow-2xl border-4 border-white flex items-center justify-center text-2xl hover:scale-110 transition-all">
                <i class="fa-solid fa-person-running"></i>
            </button>
            
            <button v-if="view !== 'order'" @click="allMode = !allMode" class="w-16 h-16 rounded-3xl shadow-2xl border-4 font-black flex items-center justify-center transition-all bg-yellow-400 text-white hover:scale-110 text-lg">
                ALL
            </button>

            <template v-if="view === 'main' || view === 'group'">
                <button @click="handleToolClick('check')" :class="activeTool === 'check' ? 'bg-emerald-500 text-white' : 'bg-white text-emerald-500 border-emerald-500'" class="w-16 h-16 rounded-3xl shadow-xl border-4 flex items-center justify-center text-2xl transition-all"><i class="fa-solid fa-check"></i></button>
                <button @click="handleToolClick('plus')" :class="activeTool === 'plus' ? 'bg-red-500 text-white' : 'bg-white text-red-500 border-red-500'" class="w-16 h-16 rounded-3xl shadow-xl border-4 font-black text-3xl transition-all">+</button>
                <button @click="handleToolClick('minus')" :class="activeTool === 'minus' ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 border-blue-600'" class="w-16 h-16 rounded-3xl shadow-xl border-4 font-black text-3xl transition-all">-</button>
                <button @click="isMemoVisible = !isMemoVisible" :class="isMemoVisible ? 'bg-indigo-600 text-white' : 'bg-white text-indigo-600 border-indigo-600'" class="w-16 h-16 rounded-3xl shadow-xl border-4 flex items-center justify-center text-2xl transition-all"><i class="fa-solid fa-clipboard-list"></i></button>
            </template>

            <div v-if="view === 'order'" class="flex gap-4">
                <button v-if="view === 'order'" @click="resetOrder" class="w-16 h-16 bg-white rounded-3xl shadow-2xl flex items-center justify-center text-yellow-500 border-4 border-yellow-500 font-black text-xs leading-tight hover:scale-110 transition-all">ìˆœì„œ<br>ì´ˆê¸°í™”</button>
                <button title="íšŒì „" @click="isRotated = !isRotated; saveToLocal();" class="w-16 h-16 bg-white rounded-3xl shadow-2xl flex items-center justify-center text-slate-400 border-4 border-white font-black hover:scale-110 transition-all">
                    <i class="fa-solid fa-arrows-rotate text-2xl"></i>
                </button>
            </div>
        </div>
  
        <div v-if="showRockRace" class="rock-race-container">
             <div class="game-layout">
                <div class="canvas-wrapper" ref="canvasContainer">
                    <canvas id="raceCanvas"></canvas>
                    <div v-if="isGameRunning" class="fixed bottom-8 right-8 z-[100] pointer-events-auto">
                        <button class="bg-red-500 text-white px-8 py-3 rounded-full font-black shadow-2xl border-4 border-red-400 text-xl cursor-pointer hover:bg-red-600 hover:scale-105 transition-all" @click="forceFinishRace">
                            <i class="fa-solid fa-flag-checkered mr-2"></i>ê²½ê¸° ì¢…ë£Œ
                        </button>
                    </div>
                </div>
                <div class="rank-sidebar">
                    <div class="bg-emerald-500 text-white p-5 text-center shadow-md relative z-10 flex items-center justify-center gap-2">
                        <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Rock.png" alt="Rock" width="35" height="35" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));">
                        <h2 class="text-2xl font-game">ëŒë©©ì´ ë­í‚¹</h2>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-slate-50 relative">
                        <div v-if="liveRanking.length === 0" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-4 text-center">
                            <i class="fa-solid fa-flag-checkered text-4xl mb-2 opacity-50"></i>
                            <span class="font-cute text-xl">ì•„ì§ ë„ì°©í•œ<br>ëŒë©©ì´ê°€ ì—†ì–´ìš”!</span>
                        </div>
                     <div v-for="(runner, idx) in liveRanking" :key="runner.id" class="rank-item" :class="{'bg-yellow-50': idx === 0}">
 
                           <div class="rank-badge-race" :class="idx === 0 ?
'rank-1' : (idx === 1 ? 'rank-2' : (idx === 2 ? 'rank-3' : 'rank-normal'))">
                                <span v-if="idx === 0">ğŸ¥‡</span>
                                <span v-else-if="idx === 1">ğŸ¥ˆ</span>
                                <span v-else-if="idx === 2">ğŸ¥‰</span>
                                <span v-else>{{ idx + 1 }}</span>
                            </div>
                            <div class="font-cute text-xl flex-1 truncate text-slate-700">{{ runner.name }}</div>
                            <div class="text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-500 min-w-[50px] text-center">{{ runner.state === 'sleep' ? 'Zzz...' : 'ë„ì°©!' }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="showRaceSetup" class="race-setup-overlay">
                <div class="race-setup-window" :style="{width: setupW + 'px', height: setupH + 'px'}">
                    <div class="bg-emerald-50 p-6 border-b-2 border-emerald-100 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 class="text-3xl font-game text-emerald-600 flex items-center gap-2">
                                <span class="text-4xl">ğŸ</span> ì„ ìˆ˜ ì„ ë°œ
                            </h2>
                            <label class="flex items-center gap-2 cursor-pointer select-none bg-white px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50 transition-colors">
                                <input type="checkbox" v-model="isSelectAll" @change="toggleSelectAll" class="w-5 h-5 accent-emerald-500 rounded cursor-pointer">
                                <span class="font-bold text-emerald-700">ì „ì²´ ì„ íƒ</span>
                            </label>
                            <div v-if="selectedCount > 0" class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg">
                                <span class="font-bold text-sm text-slate-600">{{ selectedCount }}ëª…</span>
                                <div class="h-3 w-px bg-slate-300 mx-1"></div>
                                <button @click="bulkAdjust(-1)" class="w-6 h-6 rounded-full bg-slate-200 hover:bg-slate-300 font-bold text-sm">-</button>
                                <button @click="bulkAdjust(1)" class="w-6 h-6 rounded-full bg-slate-200 hover:bg-slate-300 font-bold text-sm">+</button>
                                <button @click="resetParticipants" class="w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-500 font-bold text-xs flex items-center justify-center ml-1" title="ì „ì²´ 0ê°œë¡œ ì´ˆê¸°í™”"><i class="fa-solid fa-rotate-left"></i></button>
  
                          </div>
                        </div>
                        <button @click="closeRace" class="text-slate-400 hover:text-red-500 text-2xl"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex-1 card-grid-10">
                        <div v-for="(item, idx) in participantList" :key="idx" 
                             class="student-rock-wrapper"
                             :class="{'selected': item.selected, 'inactive': item.count === 0}" 
                             @click="toggleSelection(item)">
                             <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Travel%20and%20places/Rock.png" 
     class="rock-avatar-img" 
     alt="Rock">
                             <div class="rock-overlay-info">
                                 <div class="rock-name">{{ item.name }}</div>
                                 <div class="rock-count-row">
    <div class="arrow-btn" @click.stop="item.count = Math.max(0, item.count-1)">â–¼</div>
    <span class="rock-count-num">Ã—{{ item.count }}</span>
    <div class="arrow-btn" @click.stop="item.count++">â–²</div>
</div>
                             </div>
                        </div>
                        <div @click="addParticipant" class="student-rock-wrapper border-2 border-dashed border-slate-300 rounded-2xl justify-center opacity-50 hover:opacity-100 hover:border-slate-500" style="background:white!important;">
                            <i class="fa-solid fa-plus text-3xl text-slate-400 mb-2"></i>
                            <span class="font-bold text-slate-400">ì¶”ê°€</span>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-50 border-t border-slate-200 flex justify-center shrink-0">
                        <button @click="startRaceSequence" class="w-2/3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-4 rounded-full font-game text-4xl shadow-xl hover:scale-105 transition-all active:scale-95 border-b-4 border-emerald-700">
                            ëŒ êµ´ëŸ¬ê°€ìœ ~ ì¶œë°œ!
                        </button>
                    </div>
                    <div class="resize-handle" @mousedown="startSetupResize"></div>
                </div>
            </div>
            <div v-if="showRaceCountdown" class="countdown-overlay"><div :key="countdownNum" class="countdown-text-race">{{ countdownNum }}</div></div>
            <div v-if="showRaceResult" class="result-overlay-race">
                <canvas id="confettiCanvas" class="absolute inset-0 pointer-events-none"></canvas>
                <h2 class="text-6xl font-game text-yellow-300 mb-8 drop-shadow-lg animate-bounce">ğŸ‰ ê²½ê¸° ì¢…ë£Œ! ğŸ‰</h2>
                <div class="bg-white w-[500px] max-h-[60vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col border-4 border-slate-800">
                    <div class="bg-slate-800 text-white p-4 text-center font-bold text-xl">ìµœì¢… ìˆœìœ„</div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        <div v-for="(rank, idx) in finalRanking" :key="idx" 
     class="flex items-center p-3 rounded-xl border-b-2 transition-all" 
     :class="idx===0 ? 'bg-yellow-100 border-yellow-200' : 'bg-white border-slate-100'">
    <span class="rank-badge-race" :class="idx===0?'rank-1':(idx===1?'rank-2':(idx===2?'rank-3':'rank-normal'))">
        {{ idx + 1 }}
    </span>
    <div class="flex-1 font-black text-xl text-slate-700 font-game ml-3">{{ rank.name }}</div>
    <div class="text-xs font-bold text-slate-400">{{ (rank.finishTime/1000).toFixed(2) }}s</div>
</div>
                    </div>
                </div>
                <div class="mt-8 flex gap-4">
                     <button @click="fullResetRace" class="bg-white text-emerald-600 px-10 py-4 rounded-full font-black text-2xl hover:bg-emerald-50 shadow-xl transition-transform hover:scale-105">ë‹¤ì‹œ í•˜ê¸°</button>
                     <button @click="closeRace" class="bg-slate-700 text-white px-10 py-4 rounded-full font-black text-2xl hover:bg-slate-600 shadow-xl transition-transform hover:scale-105">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
  
        <div v-if="showRankModal" class="fixed inset-0 bg-black/80 z-[8000] flex items-center justify-center" @click.self="showRankModal = false">
            <div class="bg-white w-full max-w-3xl rounded-[2rem] p-10 shadow-2xl flex flex-col max-h-[90vh]">
                <div class="flex items-center mb-6 relative">
                    <h2 class="text-3xl font-black text-yellow-600 text-center flex-1"><i class="fa-solid fa-trophy mr-2"></i>ëª…ì˜ˆì˜ ì „ë‹¹</h2>
                    <button @click="showRankModal = false" class="text-slate-400 hover:text-slate-600 text-2xl absolute right-0"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <table class="rank-table">
                        <thead>
                            <tr>
                                <th @click="sortRank('number')" class="rounded-tl-xl w-16 text-center cursor-pointer">ë²ˆí˜¸</th>
                                <th @click="sortRank('name')" class="text-center cursor-pointer">ì´ë¦„</th>
                                <th @click="sortRank('gender')" class="text-center w-16 cursor-pointer">ì„±ë³„</th>
                                <th @click="sortRank('activityScore')" class="text-center w-24 cursor-pointer">ì ìˆ˜</th>
                                <th @click="sortRank('checked')" class="text-center w-24 cursor-pointer">ê³¼ì œ</th>
                                <th @click="sortRank('memo')" class="rounded-tr-xl w-1/3 text-center cursor-pointer">ë©”ëª¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(s, idx) in sortedRankStudents" :key="s.name">
                                <td class="text-center font-bold text-gray-500">{{ s.number || '-' }}</td>
                                <td class="font-bold text-slate-700 text-center">{{ s.name }}</td>
                                <td class="text-center font-bold opacity-70">{{ s.gender === 'M' ? 'ë‚¨' : (s.gender === 'F' ? 'ì—¬' : '-') }}</td>
                                <td class="font-black text-center text-blue-600">{{ s.activityScore }}</td>
                                <td class="text-center cursor-pointer font-black text-lg select-none" @click="toggleCheck(s)" :class="s.checked ? 'text-emerald-500' : 'text-red-400'">{{ s.checked ? 'O' : 'X' }}</td>
                                <td><input v-model="s.memo" @change="saveToLocal" class="rank-input-white" placeholder="ë‚´ìš© ì…ë ¥..."></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
  
      

        <div v-if="showAnimalRace" class="fixed inset-0 z-[6000] bg-slate-900 flex items-center justify-center p-10">
            <div v-if="showAnimalRaceCountdown" class="countdown-overlay">
                <div :key="countdownText" class="countdown-text-group">{{ countdownText }}</div>
            </div>
            
            <div class="max-w-6xl w-full bg-slate-800 rounded-[4rem] p-10 shadow-2xl relative flex flex-col">
                <button @click="showAnimalRace = false; stopSound('bgm_animal');" class="absolute top-8 right-8 text-slate-500 hover:text-white text-4xl">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                
                <div class="flex justify-between items-end mb-8">
                    <h2 class="text-5xl font-black text-white italic">ğŸ ëª¨ë‘  ë‹¬ë¦¬ê¸°</h2>
                    <div class="flex gap-4">
                        <button v-if="animalRaceFinished" @click="startAnimalRace" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-2xl shadow-lg hover:bg-blue-700">
                            <i class="fa-solid fa-rotate-right mr-2"></i>ì¬ì‹œí•©
                        </button>
                        <button v-if="!isAnimalRacing && !showAnimalRaceCountdown && !animalRaceFinished" @click="startAnimalRace" class="bg-orange-500 text-white px-10 py-4 rounded-2xl font-black text-4xl shadow-lg hover:bg-orange-600">
                            <i class="fa-solid fa-play mr-2"></i>START
                        </button>
                    </div>
                </div>
                
                <div class="race-track-container rounded-[3rem] p-6 relative">
                    <div class="finish-line"></div>
                    
                    <div v-for="(g, idx) in animalRunners" :key="idx" class="track-lane flex items-center">
                        <div class="w-16 text-3xl font-black text-slate-500 italic">#{{ idx + 1 }}</div>
                        
                        <div class="character-wrapper absolute" 
                             :style="{ left: `calc(60px + ${g.pos}%)` }" 
                             :class="{
                                'status-sprint': g.state === 'sprint', 
                                'status-tired': g.state === 'tired'
                             }">
    
                            <div v-if="g.state === 'sprint'" class="effect-dust">ğŸ’¨</div>
                            <div v-if="g.state === 'tired'" class="effect-sweat">ğŸ’¦</div>
                            
                            <div class="animal-icon text-5xl" :style="{ color: groupColors[idx] }">
                                <i :class="animalIcons[idx]"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="animalRaceResults.length > 0" class="mt-8 bg-slate-700/50 p-6 rounded-3xl border-2 border-slate-600">
                    <h3 class="text-white text-2xl font-black mb-4"><i class="fa-solid fa-trophy text-yellow-400 mr-2"></i>ê²½ê¸° ê²°ê³¼</h3>
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <div v-for="(res, rankIdx) in animalRaceResults" :key="rankIdx" class="bg-slate-800 px-6 py-4 rounded-2xl border border-slate-500 flex items-center gap-4 shrink-0 transition-all shadow-lg">
                            <div class="text-3xl">
                                <i v-if="rankIdx === 0" class="fa-solid fa-medal text-yellow-400"></i>
                                <i v-else-if="rankIdx === 1" class="fa-solid fa-medal text-slate-300"></i>
                                <i v-else-if="rankIdx === 2" class="fa-solid fa-medal text-orange-400"></i>
                                <i v-else class="fa-solid fa-award text-slate-500"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs font-black text-slate-400 uppercase tracking-tighter">{{ rankIdx + 1 }}st Place</span>
                                <span class="text-white text-xl font-black">{{ res + 1 }}ëª¨ë‘ </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
  
        <div v-if="showGroupingResultModal" class="fixed inset-0 bg-black/60 z-[8000] flex items-center justify-center" @click.self="showGroupingResultModal = false">
    <div class="bg-white w-full max-w-5xl rounded-[3rem] p-8 shadow-2xl flex flex-col max-h-[90vh] relative overflow-hidden">
        
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <h2 class="text-3xl font-black text-slate-800 flex items-center">
                    <i class="fa-solid fa-people-group mr-2 text-blue-500"></i>
                    ëª¨ë‘  í¸ì„± ê²°ê³¼
                </h2>
                <button @click="showGroupingHistory = !showGroupingHistory" 
                        title="ì €ì¥ëœ ëª¨ë‘  ëª©ë¡ ë³´ê¸°"
                        class="relative group text-slate-400 hover:text-yellow-500 transition-all hover:scale-110 p-2 cursor-pointer">
                    <i class="fa-solid fa-folder-open text-3xl drop-shadow-sm"></i>
                    <span v-if="savedGroupings.length > 0" 
                          class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center border-2 border-white shadow-sm animate-bounce">
                        {{ savedGroupings.length }}
                    </span>
                </button>
            </div>

            <div class="flex gap-3">
                <button @click="saveCurrentGrouping" 
                    class="px-5 py-3 rounded-xl font-black text-white bg-gradient-to-b from-emerald-400 to-emerald-600 shadow-[0_4px_0_rgb(6,95,70)] active:shadow-none active:translate-y-[4px] transition-all flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> ì €ì¥
                </button>
                <button @click="reshuffleGroups" 
                    class="px-5 py-3 rounded-xl font-black text-white bg-gradient-to-b from-blue-400 to-blue-600 shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-[4px] transition-all flex items-center gap-2">
                    <i class="fa-solid fa-rotate-right"></i> ë‹¤ì‹œ í¸ì„±
                </button>
                <button @click="showGroupingResultModal = false" 
                    class="px-5 py-3 rounded-xl font-black text-slate-500 bg-slate-100 hover:bg-slate-200 shadow-[0_4px_0_rgb(203,213,225)] active:shadow-none active:translate-y-[4px] transition-all">
                    ë‹«ê¸°
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50 p-6 rounded-3xl border border-slate-200">
            <div v-if="groupingList.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400">
                <i class="fa-solid fa-users-slash text-6xl mb-4"></i><span class="text-xl font-bold">ì•„ì§ í¸ì„±ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
            <div v-else class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div v-for="(group, idx) in groupingList" :key="idx" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col" :class="{'slot-stopped': isGroupStopped(idx)}">
                    <div class="bg-slate-800 text-white p-3 font-black text-center text-lg">{{ idx + 1 }}ëª¨ë‘ </div>
                    <div class="p-4 flex-1 flex flex-col gap-2 min-h-[120px]">
                        <div v-for="(member, mIdx) in group" :key="mIdx" class="flex items-center gap-2 border-b border-slate-100 last:border-0 pb-2 last:pb-0" :class="{'slot-spinning': !isGroupStopped(idx)}">
                            <span class="w-2 h-2 rounded-full bg-blue-400"></span><span class="font-bold text-slate-700 text-lg" :style="{color: !isGroupStopped(idx) ? getRandomColor() : ''}">{{ member.name }}</span>
                        </div>
                        <div v-if="group.length === 0" class="text-center text-slate-400 text-sm py-4">ë¹„ì–´ìˆìŒ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showGroupingHistory" class="absolute inset-0 bg-white z-20 flex flex-col p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b-2 border-slate-100 pb-4">
                <h3 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-folder-open text-yellow-500"></i> ì €ì¥ëœ ëª¨ë‘  ëª©ë¡
                </h3>
                <button @click="showGroupingHistory = false" class="text-slate-400 hover:text-red-500 text-3xl transition-transform hover:scale-110">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                <div v-if="savedGroupings.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400">
                    <i class="fa-regular fa-folder-open text-6xl mb-4 opacity-30"></i>
                    <span class="text-lg font-bold">ì €ì¥ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                </div>

                <div v-for="(record, idx) in savedGroupings" :key="record.id" 
                     @click="loadGrouping(record)"
                     class="bg-white border-2 border-slate-200 p-5 rounded-2xl cursor-pointer hover:border-blue-400 hover:bg-blue-50 hover:shadow-lg transition-all group relative flex justify-between items-center">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="bg-blue-100 text-blue-600 text-xs font-black px-2 py-1 rounded-md">No.{{ savedGroupings.length - idx }}</span>
                            <span class="text-xl font-black text-slate-700 group-hover:text-blue-600 transition-colors">{{ record.title }}</span>
                        </div>
                        <span class="text-sm font-bold text-slate-400 ml-1">
                            <i class="fa-regular fa-clock mr-1"></i>{{ record.date }}
                        </span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-slate-300 group-hover:text-blue-400 text-sm font-bold">ë¶ˆëŸ¬ì˜¤ê¸°</span>
                        <button @click.stop="deleteGrouping(idx)" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-500 transition-all flex items-center justify-center z-10" title="ì‚­ì œ">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div v-if="showGroupMakerModal" class="fixed inset-0 bg-black/60 z-[7000] flex items-center justify-center" @click.self="showGroupMakerModal = false">
    <div class="bg-white w-80 rounded-3xl p-6 shadow-xl flex flex-col items-center gap-4 text-slate-800">
        <div class="w-12 h-12 bg-slate-800 text-white rounded-full flex items-center justify-center text-xl mb-2"><i class="fa-solid fa-pen"></i></div>
        <h3 class="font-black text-lg">ëª¨ë‘  ë§Œë“¤ê¸°</h3>
        <div class="w-full bg-slate-100 rounded-xl p-4 flex flex-col items-center"><span class="text-xs text-slate-500 font-bold mb-1">ì´ í•™ìƒìˆ˜</span><span class="text-4xl font-black">{{ allStudents.length }}ëª…</span></div>
        <div class="w-full bg-slate-100 rounded-xl p-4 flex flex-col items-center">
            <span class="text-xs text-slate-500 font-bold mb-2">ëª¨ë‘  ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</span>
            <div class="flex items-center gap-4"><button @click="tempGroupCount = Math.max(2, tempGroupCount - 1)" class="w-10 h-10 bg-white rounded-full shadow font-black text-slate-600 hover:bg-slate-50">-</button><span class="text-4xl font-black">{{ tempGroupCount }}</span><button @click="tempGroupCount = Math.min(12, tempGroupCount + 1)" class="w-10 h-10 bg-white rounded-full shadow font-black text-slate-600 hover:bg-slate-50">+</button></div>
        </div>
        <div class="w-full flex flex-col gap-2">
            <span class="text-xs text-slate-400 font-bold ml-1">êµ¬ì„± ë°©ì‹</span>
            <div class="grid grid-cols-3 gap-2">
                <button @click="groupingMode = 'mixed'" :class="groupingMode === 'mixed' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" class="py-3 rounded-xl font-bold text-sm border-b-4 transition-all active:scale-95">
                    ğŸ‘« í˜¼ì„±<br><span class="text-[10px] opacity-80 font-normal">ë‚¨ë…€ ê· ë“±</span>
                </button>
                <button @click="groupingMode = 'same'" :class="groupingMode === 'same' ? 'bg-pink-500 text-white border-pink-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" class="py-3 rounded-xl font-bold text-sm border-b-4 transition-all active:scale-95">
                    ğŸ‘­ ë™ì„±<br><span class="text-[10px] opacity-80 font-normal">ë¼ë¦¬ë¼ë¦¬</span>
                </button>
                <button @click="groupingMode = 'random'" :class="groupingMode === 'random' ? 'bg-purple-500 text-white border-purple-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" class="py-3 rounded-xl font-bold text-sm border-b-4 transition-all active:scale-95">
                    ğŸ² ëœë¤<br><span class="text-[10px] opacity-80 font-normal">ë¬´ì‘ìœ„</span>
                </button>
            </div>
        </div>
        <button @click="applyGroupMaker" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-2xl font-black text-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
    <i class="fa-solid fa-wand-magic-sparkles"></i> í¸ì„± ì‹œì‘
</button>
    </div>
</div>
     

        <div v-if="showShuffleModal" class="fixed inset-0 bg-black/60 z-[5000] flex items-center justify-center" @click.self="showShuffleModal = false">
            <div class="bg-white w-full max-w-2xl rounded-[3rem] p-0 shadow-2xl flex flex-col max-h-[90vh] overflow-hidden relative">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 flex justify-between items-center text-white">
                    <h2 class="text-3xl font-black italic"><i class="fa-solid fa-chair mr-2"></i>ìë¦¬ ë°”ê¾¸ê¸°</h2>
                    <button @click="showShuffleSettings = !showShuffleSettings" class="bg-white/20 hover:bg-white/30 rounded-full p-3 transition-all"><i class="fa-solid fa-gear text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 bg-slate-50 flex flex-col gap-6">
                    <div v-if="showShuffleSettings" class="flex flex-col gap-6 animate-fade-in">
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                            <h3 class="text-lg font-black text-slate-700 mb-3">ì§ê¿ ëª¨ë“œ ì„ íƒ</h3>
                            <div class="flex gap-2">
                                <button type="button" @click="selectShuffleMode('mixed')" 
                                    :class="{'border-blue-500 bg-blue-50 text-blue-600': shuffleMode === 'mixed', 'border-slate-200 text-slate-400': shuffleMode !== 'mixed'}"
                                    class="flex-1 py-3 rounded-xl border-2 font-bold transition-all hover:bg-slate-50">
                                    <span v-if="shuffleMode !== 'mixed'">ğŸ‘« ë‚¨/ì—¬</span>
                                    <span v-else>{{ mixedOrder === 'MF' ? 'ğŸ‘« ë‚¨-ì—¬' : 'ğŸ‘« ì—¬-ë‚¨' }}</span>
                                </button>

                                <button type="button" @click="selectShuffleMode('same')" 
                                    :class="{'border-pink-500 bg-pink-50 text-pink-600': shuffleMode === 'same', 'border-slate-200 text-slate-400': shuffleMode !== 'same'}"
                                    class="flex-1 py-3 rounded-xl border-2 font-bold transition-all hover:bg-slate-50">
                                    <span v-if="shuffleMode !== 'same'">ğŸ‘¬ ë™ì„±</span>
                                    <span v-else>{{ sameOrder === 'M_First' ? 'ğŸ‘¬ ë‚¨-ì—¬-ë‚¨...' : 'ğŸ‘­ ì—¬-ë‚¨-ì—¬...' }}</span>
                                </button>

                                <button type="button" @click="selectShuffleMode('random')" 
                                    :class="{'border-purple-500 bg-purple-50 text-purple-600': shuffleMode === 'random', 'border-slate-200 text-slate-400': shuffleMode !== 'random'}"
                                    class="flex-1 py-3 rounded-xl border-2 font-bold transition-all hover:bg-slate-50">
                                    ğŸ² ëœë¤
                                </button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 select-none" @mouseleave="endSeatDraw">

                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-black text-slate-700">ì¢Œì„ ì„¤ì •</h3><div class="flex gap-1 bg-slate-100 p-1 rounded-xl"><button @click="selectSeatTool('lock')" :class="currentSeatTool === 'lock' ? 'bg-white text-slate-800 shadow' : 'text-slate-400'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all"><i class="fa-solid fa-lock mr-1"></i>ê³ ì •</button>
<button @click="selectSeatTool('random')" :class="currentSeatTool === 'random' ? 'bg-white text-slate-800 shadow' : 'text-slate-400'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all">â¬œ ëœë¤</button><button @click="selectSeatTool('M')" :class="currentSeatTool === 'M' ? 'bg-blue-100 text-blue-600 shadow-sm' : 'text-slate-400'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all">ğŸ‘¦ ë‚¨</button><button @click="selectSeatTool('F')" :class="currentSeatTool === 'F' ? 'bg-pink-100 text-pink-500 shadow-sm' : 'text-slate-400'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all">ğŸ‘§ ì—¬</button><button @click="selectSeatTool('empty')" :class="currentSeatTool === 'empty' ? 'bg-red-50 text-red-500 shadow-sm' : 'text-slate-400'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all">âŒ ë¹ˆìë¦¬</button></div></div>
                            <div class="w-full bg-slate-200 text-slate-500 font-black text-center py-2 rounded-xl mb-6 text-sm tracking-widest">êµ íƒ</div>
                            <div class="flex gap-8 justify-center"><div v-for="bIdx in 3" :key="bIdx" class="grid grid-cols-2 gap-3"><template v-for="rIdx in 5" :key="rIdx"><div v-for="pIdx in 2" :key="pIdx" class="seat-preview" :class="[ manualLocks.some(l => l.seatIdx === getIndex(bIdx, rIdx, pIdx)) ? 'seat-locked' : (seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'X' ? 'seat-empty' : (seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'M' ? 'seat-male' : (seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'F' ? 'seat-female' : 'seat-active'))) ]" @mousedown="startSeatDraw(getIndex(bIdx, rIdx, pIdx))" @mouseover="overSeatDraw(getIndex(bIdx, rIdx, pIdx))" @mouseup="endSeatDraw">
                                <span v-if="manualLocks.find(l => l.seatIdx === getIndex(bIdx, rIdx, pIdx))">{{ manualLocks.find(l => l.seatIdx === getIndex(bIdx, rIdx, pIdx)).student }}</span>
                                <span v-else-if="seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'X'">âŒ</span>
                                <span v-else-if="seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'M'"><i class="fa-solid fa-child text-xl"></i></span>
                                <span v-else-if="seatConfig[getIndex(bIdx, rIdx, pIdx)] === 'F'"><i class="fa-solid fa-child-dress text-xl"></i></span>
                            </div></template></div></div>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col gap-4">
                             <div class="flex items-center gap-3 mb-2"><h3 class="text-lg font-black text-slate-700">í•™ìƒ ê°„ ê±°ë¦¬ë‘ê¸°</h3><div class="h-px bg-slate-200 flex-1"></div></div>
                            <div class="flex gap-2"><select v-model="selectedStudentA" class="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm font-bold text-slate-700 outline-none">
    <option value="" disabled>í•™ìƒ A</option>
    <option v-for="s in sortedStudentsByName" :key="s.name" :value="s.name">{{ s.name }}</option>
</select>
<span class="flex items-center text-slate-300"><i class="fa-solid fa-arrows-left-right"></i></span>
<select v-model="selectedStudentB" class="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm font-bold text-slate-700 outline-none">
    <option value="" disabled>í•™ìƒ B</option>
    <option v-for="s in sortedStudentsByName" :key="s.name" :value="s.name">{{ s.name }}</option>
</select><button @click="addSeparationPair" class="bg-slate-800 text-white px-5 rounded-xl font-bold text-sm hover:bg-slate-700">ì¶”ê°€</button></div>
                            <div class="flex flex-wrap gap-2"><span v-for="(pair, idx) in separationPairs" :key="idx" class="bg-red-50 border border-red-100 px-3 py-2 rounded-xl text-xs font-bold text-red-500 flex items-center gap-2">{{ pair.student1 }} ğŸ’” {{ pair.student2 }} <button @click="removeSeparationPair(idx)" class="text-red-300 hover:text-red-600"><i class="fa-solid fa-xmark"></i></button></span></div>
                            <label class="flex items-center gap-3 cursor-pointer p-3 bg-slate-50 rounded-xl mt-2"><div class="relative"><input type="checkbox" v-model="avoidPrevious" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></div><span class="font-bold text-slate-600 text-sm">ì´ì „ ì§ê¿ í”¼í•˜ê¸° (ìŠ¤ë§ˆíŠ¸ ë°°ì¹˜)</span></label>
                        </div>
                    </div>
                    <div v-else class="flex flex-col gap-8 justify-center items-center flex-1 py-10">
                        <button @click="startShuffleSequence" class="relative group"><div class="absolute inset-0 bg-blue-400 rounded-full blur-xl opacity-50 group-hover:opacity-75 transition-opacity duration-500 btn-start-pulse"></div><div class="w-64 h-64 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex flex-col items-center justify-center text-white shadow-2xl relative z-10 group-hover:scale-105 transition-transform duration-300 border-8 border-white/20"><i class="fa-solid fa-shuffle text-6xl mb-4 group-hover:rotate-180 transition-transform duration-700"></i><span class="text-3xl font-black tracking-tighter">START</span><span class="text-xs text-blue-200 mt-2 font-bold uppercase tracking-widest">Shuffle Seats</span></div></button>
                    </div>
                </div>
                <div class="p-6 bg-white border-t border-slate-100 flex justify-center"><button @click="showShuffleHistory = true" class="px-8 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition-all text-sm flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> ì§€ë‚œ ê¸°ë¡ ë³´ê¸°</button></div>
            </div>
        </div>
  
        <div v-if="showShuffleHistory" class="fixed inset-0 z-[6000] bg-black/60 flex items-center justify-center p-4" @click.self="showShuffleHistory = false">
    <div class="bg-[#fdfbf7] w-full max-w-md rounded-[3rem] p-6 h-[75vh] flex flex-col shadow-2xl border-8 border-white relative overflow-hidden animate-fade-in">
        
        <div class="flex justify-between items-center mb-6 px-2 shrink-0">
            <h3 class="text-2xl text-slate-700" style="font-family: 'Pretendard', sans-serif; font-weight: 800;">ê¸°ë¡</h3>
            
            <div class="flex items-center gap-2">
                <button @click="saveCurrentLayoutToHistory" 
                        class="w-11 h-11 flex items-center justify-center bg-blue-100 text-blue-500 rounded-2xl hover:bg-blue-200 transition-all shadow-sm active:scale-90" title="í˜„ì¬ ë°°ì¹˜ ì €ì¥">
                    <i class="fa-solid fa-bookmark"></i>
                </button>
                <button @click="deleteAllShuffles" 
                        class="w-11 h-11 flex items-center justify-center bg-red-100 text-red-500 rounded-2xl hover:bg-red-200 transition-all shadow-sm active:scale-90" title="ì „ì²´ ì‚­ì œ">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                </button>
                <button @click="showShuffleHistory = false" 
                        class="w-11 h-11 flex items-center justify-center bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-all shadow-sm active:scale-90">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-2 relative custom-scrollbar">
            <div v-if="shuffleHistory.length === 0" class="h-full flex flex-col items-center justify-center text-slate-300 py-10 relative z-10">
                <i class="fa-solid fa-ghost text-6xl mb-4 opacity-20"></i>
                <p class="font-bold text-lg text-slate-400">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”!</p>
            </div>
            
            <div class="flex flex-col gap-4 w-full mb-4">
                <div v-for="(rec, idx) in shuffleHistory" :key="rec.id" 
                     class="group bg-white border-2 border-slate-200 p-4 rounded-[2rem] cursor-pointer hover:border-blue-400 hover:shadow-[6px_6px_0px_0px_rgba(191,219,254,1)] transition-all transform hover:-rotate-1 active:scale-[0.98] flex justify-between items-center w-full shadow-sm"
                     @click="openHistoryPreview(rec)">
                    
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-[10px] font-bold text-blue-400 mb-1 tracking-widest uppercase">Memory {{ shuffleHistory.length - idx }}</span>
                        <div class="font-black text-slate-800 text-lg leading-tight">{{ rec.date }}</div>
                    </div>
                    
                    <button @click.stop="deleteShuffle(idx)" 
                            class="w-9 h-9 rounded-full bg-red-50 text-red-300 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all shadow-sm shrink-0 ml-2">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <button @click="showShuffleHistory = false" 
                class="mt-4 w-full py-4 bg-slate-100 text-slate-500 rounded-3xl font-black hover:bg-slate-200 transition-all shrink-0">
            ë‹«ê¸°
        </button>
    </div>
</div>


                
        <div v-if="showSettings" class="fixed inset-0 bg-black/60 z-[5000] flex items-center justify-center" @click.self="showSettings = false">
    <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
        
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-3xl font-black mb-2 text-slate-800">ğŸ“ ëª…ë‹¨ ê´€ë¦¬</h2>
                <p class="text-slate-500 text-sm">ë²ˆí˜¸, ì´ë¦„, ì„±ë³„ ìˆœì„œë¡œ ì…ë ¥ (ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)<br>ì˜ˆ: 1 í™ê¸¸ë™ ë‚¨</p>
            </div>

            <div class="flex gap-3">
                <button @click="soundSettings.ui = !soundSettings.ui" 
                        class="w-16 h-16 rounded-2xl font-black border-2 flex flex-col items-center justify-center shadow-md active:scale-95 transition-all"
                        :class="soundSettings.ui ? 'bg-slate-700 text-white border-slate-800' : 'bg-slate-100 text-slate-400 border-slate-200'"
                        title="íš¨ê³¼ìŒ (ë²„íŠ¼/ì•Œë¦¼)">
                    <i :class="soundSettings.ui ? 'fa-solid fa-volume-high text-2xl' : 'fa-solid fa-volume-xmark text-2xl'"></i>
                    <span class="text-[10px] mt-1 font-bold">íš¨ê³¼ìŒ</span>
                </button>

                <button @click="soundSettings.game = !soundSettings.game" 
                        class="w-16 h-16 rounded-2xl font-black border-2 flex flex-col items-center justify-center shadow-md active:scale-95 transition-all"
                        :class="soundSettings.game ? 'bg-slate-700 text-white border-slate-800' : 'bg-slate-100 text-slate-400 border-slate-200'"
                        title="ë°°ê²½ìŒ (BGM/ê²Œì„)">
                    <i :class="soundSettings.game ? 'fa-solid fa-music text-2xl' : 'fa-solid fa-bell-slash text-2xl'"></i>
                    <span class="text-[10px] mt-1 font-bold">ë°°ê²½ìŒ</span>
                </button>
            </div>
        </div>

        <textarea v-model="tempNameList" 
                  class="w-full h-64 border-4 border-slate-200 rounded-3xl p-6 mb-6 outline-none text-lg font-bold text-slate-700 resize-none focus:border-slate-500 transition-colors custom-scrollbar" 
                  placeholder="1 í™ê¸¸ë™ ë‚¨"></textarea>
        
        <div class="flex gap-4">
             <button @click="showSettings = false" class="flex-1 bg-slate-200 text-slate-600 py-5 rounded-2xl font-black text-xl hover:bg-slate-300 transition-all">ì·¨ì†Œ</button>
             <button @click="saveNameList" class="flex-[2] bg-slate-800 text-white py-5 rounded-2xl font-black text-xl hover:bg-slate-900 shadow-xl transition-all">ì €ì¥</button>
        </div>
    </div>
</div>
        
        <div v-if="showStudentSelectModal" class="fixed inset-0 bg-black/60 z-[8000] flex items-center justify-center" @click.self="showStudentSelectModal = false">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-xl max-h-[80vh] flex flex-col">
                <h3 class="text-lg font-bold text-center mb-4">ëˆ„êµ¬ë¥¼ ì•‰íê¹Œìš”?</h3>
                <div class="flex-1 overflow-y-auto grid grid-cols-2 gap-2">
                    <button @click="confirmSeatLock(null)" class="bg-red-50 text-red-500 border border-red-200 py-2 rounded-xl font-bold hover:bg-red-100">ì„ íƒ í•´ì œ</button>
                    <button v-for="s in allStudents" :key="s.name" @click="confirmSeatLock(s.name)" class="bg-slate-50 border border-slate-200 py-2 rounded-xl font-bold hover:bg-blue-50 text-slate-700 text-sm">{{ s.name }}</button>
                </div>
                <button @click="showStudentSelectModal = false" class="mt-4 w-full bg-slate-200 py-3 rounded-xl font-bold text-slate-600">ë‹«ê¸°</button>
            </div>
        </div>
  
        <div v-if="showHistoryPreview" class="fixed inset-0 bg-black/60 z-[7000] flex items-center justify-center" @click.self="showHistoryPreview = false">
            <div class="bg-white w-full max-w-lg rounded-[3rem] p-8 shadow-2xl flex flex-col gap-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-black text-center mb-2">ë°°ì¹˜ ê¸°ë¡ ë¯¸ë¦¬ë³´ê¸°</h3><p class="text-center text-slate-500 text-sm mb-4">{{ previewHistoryItem.date }}</p>
                <div class="bg-slate-100 p-4 rounded-2xl flex justify-center"><div class="flex gap-4"><div v-for="bIdx in 3" :key="bIdx" class="grid grid-cols-2 gap-2"><template v-for="rIdx in 5" :key="rIdx"><div v-for="pIdx in 2" :key="pIdx" class="seat-preview cursor-default" :class="previewHistoryItem.seats[getIndex(bIdx, rIdx, pIdx)] ? 'seat-active' : 'seat-empty'">{{ previewHistoryItem.seats[getIndex(bIdx, rIdx, pIdx)] ? previewHistoryItem.seats[getIndex(bIdx, rIdx, pIdx)].name : '' }}</div></template></div></div></div>
                <div class="flex gap-2 mt-4"><button @click="restoreHistory" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">ì´ ë°°ì¹˜ë¡œ ì ìš©</button><button @click="showHistoryPreview = false" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold">ë‹«ê¸°</button></div>
            </div>
        </div>
  
   <div v-show="showBlackboard" 
     @mousedown="focusWindow('board')"  :class="['blackboard-window border border-slate-300', { 'maximized': isMaximized }]"
     :style="{
         top: !isMaximized ? boardY + 'px' : '0', 
         left: !isMaximized ? boardX + 'px' : '0', 
         width: !isMaximized ? boardW + 'px' : '100%', 
         height: !isMaximized ? boardH + 'px' : '100%',
         zIndex: boardZ  /* z-index ì—°ê²° ì¶”ê°€ */
     }">

    <div class="blackboard-header justify-between" @mousedown="startBoardDrag">
    <span class="text-slate-700 flex items-center gap-3 pointer-events-none">
        <i class="fa-solid fa-chalkboard text-3xl"></i> 
        <span class="font-bold">íŒì„œ {{ isMaximized ? '(ì „ì²´ í™”ë©´)' : '' }}</span>
    </span>

        <div class="flex items-center gap-1">
            <div class="flex items-center gap-2 px-3 bg-white rounded-xl border border-slate-200 shadow-sm mr-3" @mousedown.stop style="height: 44px;">
                <span contenteditable="true" @blur="updateZoomDirect" @keydown.enter.prevent="$event.target.blur()" class="zoom-text-input">
                    {{ Math.round(boardZoom * 100) }}%
                </span>
                <div class="flex items-center border-l border-slate-200 pl-2">
                    <button @mousedown="startZoom(-0.1)" @mouseup="stopZoom()" @mouseleave="stopZoom()" class="px-2 hover:bg-slate-100 rounded text-slate-500 font-bold text-xl">-</button>
                    <button @mousedown="startZoom(0.1)" @mouseup="stopZoom()" @mouseleave="stopZoom()" class="px-2 hover:bg-slate-100 rounded text-slate-500 font-bold text-xl">+</button>
                </div>
            </div>

            <button v-if="isMaximized" @click="isMaximized = false" class="toolbar-btn !w-12 !h-12 !text-xl text-slate-500 hover:bg-slate-200" title="ì°½ ëª¨ë“œë¡œ ë³µì›">
                <i class="fa-solid fa-window-restore"></i>
            </button>
            <button v-else @click="isMaximized = true" class="toolbar-btn !w-12 !h-12 !text-xl text-slate-500 hover:bg-slate-200" title="ì „ì²´ í™”ë©´">
                <i class="fa-solid fa-expand"></i>
            </button>
            
            <button @click="showBlackboard = false" class="toolbar-btn !w-12 !h-12 !text-3xl text-slate-400 hover:text-red-500 hover:bg-red-50" title="ë‹«ê¸°">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
    
    <div class="blackboard-toolbar">
        <select @change="applyStyle('fontSize', $event.target.value)" class="toolbar-select !h-[52px] !text-lg bg-white">
            <option value="3">ì‘ê²Œ</option>
            <option value="5">ë³´í†µ</option>
            <option value="7">í¬ê²Œ</option>
        </select>

        <button @click="applyStyle('bold')" class="toolbar-btn font-black text-3xl">B</button>
        <button @click="applyStyle('italic')" class="toolbar-btn italic font-serif text-3xl">I</button>
        <button @click="applyStyle('underline')" class="toolbar-btn underline text-3xl">U</button>
        
        <div class="w-px h-10 bg-slate-200 mx-1"></div>

        <div class="relative">
            <button @click="toggleForeColorPalette" class="toolbar-btn"><i class="fa-solid fa-font"></i></button>
            <div v-if="showForeColorPalette" class="color-palette"><div v-for="color in paletteColors" :key="'fg-' + color" :style="{background: color}" class="color-dot" @click="applyColor('foreColor', color)"></div></div>
        </div>
        <div class="relative">
            <button @click="toggleHiliteColorPalette" class="toolbar-btn"><i class="fa-solid fa-fill-drip"></i></button>
            <div v-if="showHiliteColorPalette" class="color-palette"><div v-for="color in paletteColors" :key="'bg-' + color" :style="{background: color}" class="color-dot" @click="applyColor('hiliteColor', color)"></div><div class="color-dot bg-transparent border-slate-300 flex items-center justify-center" @click="applyColor('hiliteColor', 'transparent')">/</div></div>
        </div>

        <div class="flex-1"></div>

        <button @click="clearBoard" class="toolbar-btn text-slate-600 hover:text-slate-900" title="ì§€ìš°ê°œ">
            <i class="fa-solid fa-eraser text-2xl"></i>
        </button>
        <button @click="saveBoardToList" class="toolbar-btn text-slate-600 hover:text-slate-900" title="ì €ì¥">
            <i class="fa-solid fa-floppy-disk text-2xl"></i>
        </button>
        <button @click="toggleBoardList" class="toolbar-btn text-slate-600 hover:text-slate-900" title="ëª©ë¡">
            <i class="fa-solid fa-list-ul text-2xl"></i>
        </button>
    </div>

    <div class="blackboard-editor">
        <div ref="boardEditor" id="board-editor" contenteditable="true" class="board-zoom-container"
            :style="{ transform: `scale(${boardZoom})`, width: (boardZoom > 1 ? 100 : 100 / boardZoom) + '%', height: (100 / boardZoom) + '%' }"
            @input="updateBoardContent" @click="closePalettes">
        </div>
    </div>
    
    <div v-if="!isMaximized" class="resize-handle" @mousedown="startBoardResize"></div>

    <div v-if="showBoardList" class="board-list-mini">
        <div class="h-10 bg-slate-100 flex items-center justify-between px-3 border-b shrink-0">
            <span class="font-bold text-slate-700 text-sm">ğŸ“‚ ì €ì¥ ëª©ë¡</span>
            <button @click="showBoardList = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-2 bg-slate-50">
            <div v-if="savedBoards.length === 0" class="text-center text-slate-400 mt-4 text-xs">ì €ì¥ëœ ë‚´ìš© ì—†ìŒ</div>
            <div v-for="(board, idx) in savedBoards" :key="board.id" @click="loadBoard(board)" class="bg-white p-2 rounded mb-2 border border-slate-200 shadow-sm cursor-pointer hover:border-blue-400 group relative">
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-slate-700 text-sm truncate max-w-[140px]">{{ board.title }}</span>
                    <span class="text-[10px] text-slate-400">{{ board.time }}</span>
                </div>
                <div class="text-slate-800 text-xs truncate">{{ board.preview }}</div>
                <button @click.stop="deleteBoard(idx)" class="absolute top-1 right-1 text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can"></i></button>
            </div>
        </div>
        <div class="p-2 border-t bg-white shrink-0">
            <button @click="deleteAllBoards" class="w-full py-1.5 bg-red-50 text-red-500 rounded text-xs font-bold hover:bg-red-100">ì „ì²´ ì‚­ì œ</button>
        </div>
    </div>
</div>
   
        <!-- ë½‘ê¸° ë§ˆìŠ¤í„° ëª¨ë‹¬ -->
<div v-if="showPickerMaster"
     class="fixed bg-white shadow-2xl overflow-hidden border-4 border-slate-200"
     :class="[
        isPickerMaximized ? 'inset-0 rounded-none' : 'rounded-[3rem]',
        isInteracting ? 'duration-0' : 'transition-all duration-300' 
     ]"
     :style="[
        !isPickerMaximized ? {
           top: pickerY + 'px',
           left: pickerX + 'px',
           width: pickerW + 'px',
           height: pickerH + 'px'
        } : {},
        { zIndex: isPickerMaximized ? 9999 : pickerZ } 
     ]"
     @mousedown="focusWindow('picker')">
    <div class="h-20 bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-between px-8 shrink-0 select-none cursor-move"
         @mousedown="startPickerDrag">
        <h2 class="text-white font-black text-3xl">ğŸ ë½‘ê¸° ë„êµ¬</h2>
        <div class="flex items-center gap-3">
            <button @click="isPickerMaximized = !isPickerMaximized"
                    class="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white text-xl">
                <i :class="isPickerMaximized ? 'fa-solid fa-compress' : 'fa-solid fa-expand'"></i>
            </button>
            <button @click="showPickerMaster = false"
                    class="w-12 h-12 bg-red-500/80 hover:bg-red-600 rounded-xl flex items-center justify-center text-white text-2xl">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

    <div class="flex bg-slate-100 border-b-2 border-slate-300">
        <button @click="setPickerTab('lottery')"
                class="flex-1 py-4 font-bold text-lg transition-all"
                :class="pickerTab === 'lottery' ? 'bg-white text-indigo-600 border-b-4 border-indigo-600' : 'text-slate-500 hover:text-slate-700'">
            ğŸ”® ì£¼ì¸ê³µ ì¶”ì²¨
        </button>
        <button @click="setPickerTab('capsule')"
            class="flex-1 py-4 font-bold text-lg transition-all flex items-center justify-center"
            :class="pickerTab === 'capsule' ? 'bg-white text-purple-600 border-b-4 border-purple-600' : 'text-slate-500 hover:text-slate-700'">
        <div class="capsule-mini-icon"></div> ìº¡ìŠ ë½‘ê¸°
    </button>
        
        <button @click="setPickerTab('roulette')"
                class="flex-1 py-4 font-bold text-lg transition-all"
                :class="pickerTab === 'roulette' ? 'bg-white text-pink-600 border-b-4 border-pink-600' : 'text-slate-500 hover:text-slate-700'">
            ğŸ¯ ëŒë¦¼íŒ
        </button>

        <button @click="setPickerTab('ladder')"
            class="flex-1 py-4 font-bold text-lg transition-all flex items-center justify-center"
            :class="pickerTab === 'ladder' ? 'bg-white text-green-600 border-b-4 border-green-600' : 'text-slate-500 hover:text-slate-700'">
        <div class="icon-ladder"></div> ì‚¬ë‹¤ë¦¬ íƒ€ê¸°
    </button>

        <button @click="setPickerTab('dice')"
                class="flex-1 py-4 font-bold text-lg transition-all"
                :class="pickerTab === 'dice' ? 'bg-white text-orange-600 border-b-4 border-orange-600' : 'text-slate-500 hover:text-slate-700'">
            ğŸ² ì£¼ì‚¬ìœ„
        </button>
        <button @click="setPickerTab('tournament')"
                class="flex-1 py-4 font-bold text-lg transition-all"
                :class="pickerTab === 'tournament' ? 'bg-white text-red-600 border-b-4 border-red-600' : 'text-slate-500 hover:text-slate-700'">
            ğŸ† í† ë„ˆë¨¼íŠ¸
        </button>
    </div>

    <!-- íƒ­ ë‚´ìš© ì˜ì—­ -->
<div class="flex-1 overflow-y-auto bg-slate-50 p-8 h-[calc(100%-160px)]">

<div v-if="pickerTab === 'lottery'" class="h-full flex flex-col overflow-hidden relative bg-slate-50">
    
    <div class="flex-1 flex items-center justify-center p-4 pt-8 overflow-hidden">
        <div class="fixed-layout-box !w-[380px] !h-[380px] !p-0 transition-transform duration-300" 
             :style="{ transform: `scale(${ getScale(380, 380) })` }">
            
            <div class="lottery-circle !w-[360px] !h-[360px] border-[18px] bg-white rounded-full flex items-center justify-center shadow-2xl transition-all duration-300" 
                 :class="[
                    (isRolling || displayWinner === '?') 
                    ? 'border-purple-500 shadow-[0_0_50px_rgba(168,85,247,0.3)]' 
                    : 'border-[#fbbf24] winner-aura'
                 ]">
                <span class="lottery-name !text-[80px] font-black text-slate-800 tabular-nums">
                    {{ displayWinner || '?' }}
                </span>
            </div>
        </div>
    </div>

   <div class="w-full h-28 bg-gradient-to-r from-indigo-500 to-purple-600 flex justify-center items-center gap-8 px-10 shrink-0 z-50 shadow-[0_-10px_40px_rgba(79,70,229,0.3)] border-t-2 border-white/20 mt-auto">
    
    <div class="relative min-w-[140px]">
        <button @click.stop="showLotteryFilter = !showLotteryFilter" 
                class="h-16 w-full px-6 bg-white/10 text-white rounded-2xl font-black text-xl hover:bg-white/20 transition-all flex items-center justify-between gap-3 border-2 border-white/30 cursor-pointer backdrop-blur-sm">
            <span>{{ lotteryMode === 'all' ? 'ì „ì²´' : (lotteryMode === 'M' ? 'ë‚¨í•™ìƒ' : 'ì—¬í•™ìƒ') }}</span>
            <i class="fa-solid fa-chevron-up text-sm transition-transform" :class="{'rotate-180': showLotteryFilter}"></i>
        </button>
        
        <div v-if="showLotteryFilter" 
     class="absolute bottom-[115%] left-0 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 overflow-hidden z-[100] animate-fade-in">
    
    <button @click="changeLotteryMode('all')" class="w-full py-5 px-6 text-center text-xl font-black hover:bg-indigo-50 border-b-2 border-slate-50 transition-colors text-indigo-900">ì „ì²´</button>
    <button @click="changeLotteryMode('M')" class="w-full py-5 px-6 text-center text-xl font-black hover:bg-indigo-50 border-b-2 border-slate-50 transition-colors text-indigo-900">ë‚¨í•™ìƒ</button>
    <button @click="changeLotteryMode('F')" class="w-full py-5 px-6 text-center text-xl font-black hover:bg-indigo-50 transition-colors text-indigo-900">ì—¬í•™ìƒ</button>

</div>
    </div>

    <button @click="rollLottery" class="h-20 px-16 bg-white text-indigo-600 rounded-[2rem] border-x-4 border-t-4 border-indigo-100 font-black text-4xl shadow-xl hover:bg-slate-50 transition-all active:translate-y-2 active:border-b-0 border-b-[10px] border-indigo-200 cursor-pointer">START</button>

    <div class="h-20 px-8 bg-indigo-900/30 text-white rounded-2xl border-2 border-white/30 flex flex-col items-center justify-center shadow-inner backdrop-blur-sm min-w-[140px]">
        <span class="text-[10px] font-bold opacity-60 uppercase tracking-widest leading-none mb-1">Remaining</span>
        <div class="flex items-baseline gap-1">
            <span class="text-4xl font-black tabular-nums text-yellow-300 leading-none">{{ remainingCount }}</span>
            <span class="text-lg font-bold opacity-90 leading-none">ëª…</span>
        </div>
    </div>

    <button @click.stop="resetLottery" class="w-16 h-16 bg-white/10 text-white rounded-2xl hover:bg-red-500 hover:border-red-400 transition-all shadow-md flex items-center justify-center border-2 border-white/20 group cursor-pointer backdrop-blur-sm" title="í˜„ì¬ ëª¨ë“œ ì´ˆê¸°í™”">
        <i class="fa-solid fa-rotate-right text-2xl group-hover:rotate-180 transition-transform duration-500"></i>
    </button>
</div>
</div>
   <div v-else-if="pickerTab === 'capsule'" class="h-full flex flex-col bg-slate-50 relative overflow-hidden">
    <div class="flex-1 overflow-y-auto p-6 custom-scrollbar pb-[18vh]">
        
        <div v-if="capsules.length > 0" class="grid grid-cols-9 gap-2 gap-y-20 place-items-center mt-4">
        <div v-for="(capsule, index) in capsules" :key="capsule.id" 
                 class="capsule-container w-full aspect-square relative perspective"
                 :class="isPickerMaximized ? 'max-w-[133px]' : 'max-w-[120px]'">
                
                <div class="capsule-card w-full h-full relative transform-style-3d cursor-pointer"
                     :class="{ 'revealed': capsule.revealed }"
                     @click="toggleCapsule(capsule.id)">
                    
                    <div class="capsule-front absolute inset-0 backface-hidden ball-style">
                        <div class="ball-top">
                            <div class="ball-highlight"></div>
                        </div>
                        <div class="ball-band">
                            <div class="ball-button"
                                 :class="{
                                     'btn-gender': showGenderHint && capsule.student.gender,
                                     'btn-random': !showGenderHint || !capsule.student.gender
                                 }">
                                 <span v-if="showGenderHint && capsule.student.gender" class="gender-text">
                                     {{ capsule.student.gender === 'M' ? 'ë‚¨' : 'ì—¬' }}
                                 </span>
                                 <div v-else class="random-dot"></div>
                            </div>
                        </div>
                        <div class="ball-bottom"></div>
                    </div>

                    <div class="capsule-back absolute inset-0 backface-hidden red-circle-style">
                      <div class="student-name-back !text-[2.5cqw]">
                            {{ capsule.student.name }}
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div v-else class="h-full flex items-center justify-center text-3xl text-slate-400 font-bold opacity-50">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i> í•™ìƒ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>

    <div class="w-full h-28 bg-gradient-to-r from-purple-600 to-indigo-600 flex justify-center items-center gap-6 px-10 shrink-0 z-50 shadow-[0_-10px_40px_rgba(79,70,229,0.3)] border-t-2 border-white/20 mt-auto">
    
    <button @click="showGenderHint = !showGenderHint" 
            class="w-20 h-20 rounded-2xl font-black transition-all border-2 flex items-center justify-center shadow-md active:scale-95 bg-white/10 text-white border-white/30 hover:bg-white/20 box-border"
            title="ì„±ë³„ íŒíŠ¸ ì¼œê¸°/ë„ê¸°">
        <i :class="showGenderHint ? 'fa-solid fa-eye text-3xl' : 'fa-solid fa-eye-slash text-3xl'"></i>
    </button>

    <div class="relative w-80 h-20 bg-black/20 rounded-2xl p-1.5 flex items-center cursor-pointer shadow-inner border-2 border-white/10 box-border"
         @click="toggleCapsuleSwitch">
        
        <div class="absolute top-1.5 bottom-1.5 w-[calc(50%-6px)] bg-white rounded-xl shadow-lg transition-all duration-300 cubic-bezier(0.4, 0, 0.2, 1)"
             :class="capsuleSwitchState === 'open' ? 'left-1.5' : 'left-[calc(50%+4px)]'">
        </div>

        <div class="flex-1 z-10 text-center font-black text-2xl transition-colors duration-300 flex items-center justify-center gap-2 h-full"
             :class="capsuleSwitchState === 'open' ? 'text-indigo-600' : 'text-white/40'">
            <i class="fa-solid fa-lock-open"></i> ì—´ê¸°
        </div>

        <div class="flex-1 z-10 text-center font-black text-2xl transition-colors duration-300 flex items-center justify-center gap-2 h-full"
             :class="capsuleSwitchState === 'closed' ? 'text-indigo-600' : 'text-white/40'">
            <i class="fa-solid fa-lock"></i> ë‹«ê¸°
        </div>
    </div>

    <button @click="shuffleCapsules" 
            class="w-20 h-20 bg-white/10 text-white rounded-2xl transition-all shadow-md flex items-center justify-center border-2 border-white/20 group cursor-pointer backdrop-blur-sm active:scale-90 box-border
                   hover:bg-red-500 hover:border-red-400 hover:text-white" 
            title="ì„ê¸°">
        <i class="fa-solid fa-shuffle text-3xl group-hover:rotate-180 transition-transform duration-500"></i>
    </button>

</div>
</div>



        <div v-else-if="pickerTab === 'roulette'" class="h-full flex flex-row overflow-hidden relative">
            
            <div v-if="showRouletteResult" class="absolute inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center" @click="showRouletteResult = false">
                <div class="text-7xl font-black text-yellow-300 drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)] mb-6 animate-bounce">{{ rouletteWinner }}</div>
                <div class="text-white text-4xl font-bold">ì¶•í•˜í•©ë‹ˆë‹¤!</div>
                <div class="mt-8 text-white/50 text-lg">í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹«í™ë‹ˆë‹¤</div>
            </div>

            <div class="flex-1 bg-slate-50 flex items-center justify-center relative overflow-hidden p-4">
                
                <div class="relative w-full aspect-square transition-all duration-300" 
                     :class="isPickerMaximized ? 'max-w-[70vh]' : 'max-w-[650px]'">
                    
                    <div class="w-full h-full rounded-full border-[12px] border-slate-800 shadow-2xl overflow-hidden transition-transform duration-[4000ms] cubic-bezier(0.1, 0.7, 0.1, 1)" 
                         :style="{ transform: `rotate(${rouletteRotation}deg)`, background: rouletteBackground }">
                        <svg viewBox="0 0 100 100" class="absolute inset-0 w-full h-full pointer-events-none">
                            <g v-for="(item, idx) in rouletteItems" :key="idx" :transform="`rotate(${360/rouletteItems.length * idx + (360/rouletteItems.length/2)} 50 50)`">
                                <text x="50" y="20" text-anchor="middle" dominant-baseline="middle" fill="white" font-weight="900" font-size="5" transform="rotate(-90 50 20)" style="filter: drop-shadow(0px 0px 2px rgba(0,0,0,0.5));">
                                    {{ item }}
                                </text>
                            </g>
                        </svg>
                    </div>
                    
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-[25%] w-[14%] aspect-square z-20 drop-shadow-md pointer-events-none">
                        <svg viewBox="0 0 100 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 115 C50 115 10 75 10 45 C10 22.9 27.9 5 50 5 C72.1 5 90 22.9 90 45 C90 75 50 115 50 115 Z" fill="#ef4444" stroke="white" stroke-width="8"/>
                            <circle cx="50" cy="45" r="15" fill="white"/>
                        </svg>
                    </div>
                    
                    <button @click="spinRoulette" 
                            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[15%] h-[15%] bg-white rounded-full font-black shadow-[0_5px_15px_rgba(0,0,0,0.2)] hover:scale-110 active:scale-95 transition-transform z-30 border-[5px] border-slate-100 flex items-center justify-center text-slate-700 group cursor-pointer">
                        <span class="group-hover:text-indigo-600 transition-colors text-[min(5vw,2.5rem)] leading-none mt-1">GO</span>
                    </button>
                </div>
            </div>

            <div class="w-[350px] bg-white border-l border-slate-200 p-6 flex flex-col z-10 relative shadow-lg">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-black text-slate-800"><i class="fa-solid fa-gear mr-2"></i>ì„¤ì •</h3><button @click="toggleRouletteList" class="w-10 h-10 bg-slate-100 rounded-lg hover:bg-blue-100 text-slate-500 hover:text-blue-600 transition-all"><i class="fa-solid fa-list"></i></button></div>
                
                <textarea v-model="rouletteInput" @input="saveToLocal" 
                          class="flex-1 w-full border-2 border-slate-200 rounded-xl p-4 font-bold outline-none resize-none focus:border-blue-400 mb-4 bg-slate-50 leading-relaxed font-game text-slate-600" 
                          :class="isPickerMaximized ? 'text-5xl' : 'text-4xl'" 
                          placeholder="í•­ëª©ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                
                <div class="flex gap-2"><button @click="saveCurrentRoulette" class="flex-1 py-3 bg-blue-100 text-blue-600 rounded-xl font-bold hover:bg-blue-200 transition-all">ì €ì¥</button><button @click="resetRoulette" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition-all">ì´ˆê¸°í™”</button></div>
                
                <div v-if="showRouletteList" class="absolute inset-0 bg-white z-40 flex flex-col p-6 animate-fade-in shadow-xl">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b"><h3 class="font-black text-lg">ğŸ“‚ ì €ì¥ëœ ëª©ë¡</h3><button @click="showRouletteList = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                    <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar">
                        <div v-for="(item, idx) in savedRoulettes" :key="idx" @click="loadRoulette(item)" class="bg-slate-50 p-3 rounded-xl border hover:border-blue-400 cursor-pointer flex justify-between items-center group"><span class="font-bold text-slate-700 truncate">{{ item.title }}</span><button @click.stop="deleteRoulette(idx)" class="text-slate-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button></div>
                        <div v-if="savedRoulettes.length === 0" class="text-center text-slate-400 py-4 text-sm">ì €ì¥ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else-if="pickerTab === 'ladder'" class="h-full flex flex-col relative">

    <div v-if="!showLadderGame" class="flex-1 flex flex-col gap-6 p-6 overflow-y-auto ladder-jungle-bg">
        
        <div class="rounded-[3rem] shadow-2xl p-8 flex-1 flex flex-col justify-center min-h-[600px] border-[6px] border-[#5e3008]"
             style="background-color: #fdf6e3; box-shadow: inset 0 0 30px rgba(94, 48, 8, 0.2);">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-1">
                <div class="p-6 rounded-3xl border-4 border-[#8b4513] flex flex-col shadow-inner h-full max-h-[500px]"
                     style="background-color: #fffbeb;">
                    <h3 class="text-2xl font-black mb-4 text-[#5e3008] flex items-center gap-2 shrink-0 font-game">
                        <span class="bg-[#5e3008] text-[#fdf6e3] w-8 h-8 rounded-full flex items-center justify-center text-sm border-2 border-[#8b4513]">1</span> 
                        ì°¸ê°€ì ì„¤ì •
                    </h3>
                    
                    <div class="flex gap-2 mb-3 shrink-0">
                        <button @click="ladderPeopleMode = 'select'" 
                                :class="ladderPeopleMode === 'select' ? 'wood-sign-btn transform scale-105 ring-2 ring-[#facc15]' : 'bg-[#e2c7a5] text-[#5e3008] border-2 border-[#8b4513]'" 
                                class="flex-1 py-3 rounded-xl font-black transition-all text-base shadow-sm">
                            ì„ íƒ
                        </button>
                        <button @click="ladderPeopleMode = 'custom'" 
                                :class="ladderPeopleMode === 'custom' ? 'wood-sign-btn transform scale-105 ring-2 ring-[#facc15]' : 'bg-[#e2c7a5] text-[#5e3008] border-2 border-[#8b4513]'" 
                                class="flex-1 py-3 rounded-xl font-black transition-all text-base shadow-sm">
                            ì§ì ‘
                        </button>
                    </div>

                    <textarea v-if="ladderPeopleMode === 'custom'" v-model="customLadderNames" 
                              class="w-full flex-1 p-4 border-4 border-[#d4a373] rounded-xl resize-none outline-none focus:border-[#8b4513] font-bold text-[#5e3008] text-base bg-white" 
                              placeholder="ì´ë¦„ì„ ì—”í„°ë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                    
                    <div v-else class="flex-1 flex flex-col min-h-0 bg-white rounded-xl border-4 border-[#d4a373] overflow-hidden">
                        <div class="flex justify-between items-center p-3 border-b-2 border-[#d4a373] bg-[#fff8e1] shrink-0">
                            <span class="font-black text-[#8b4513] text-sm">{{ ladderSelectionList.length }}ëª… ì„ íƒë¨</span>
                            <button @click="toggleAllLadder" class="text-xs font-bold px-3 py-1.5 rounded-lg border-2 transition-colors bg-[#8b4513] text-[#fffbeb] border-[#5e3008] hover:bg-[#a0522d]">
                                {{ isAllLadderSelected ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ' }}
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 custom-scrollbar">
                            <div class="grid grid-cols-5 gap-2">
                                <div v-for="s in allStudents" :key="s.name" @click="toggleLadderStudent(s.name)" 
                                     class="cursor-pointer rounded-lg border-2 py-2 flex items-center justify-center transition-all select-none text-sm font-bold active:scale-95" 
                                     :class="ladderSelectionList.includes(s.name) ? 'bg-[#8b4513] border-[#5e3008] text-[#fffbeb] shadow-md' : 'bg-[#fdf6e3] border-[#d4a373] text-[#8b4513] hover:bg-[#faebd7]'">
                                    <span class="truncate px-1">{{ s.name }}</span>
                                </div>
                            </div>
                            <div v-if="allStudents.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400 text-sm">ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>

                <div class="p-6 rounded-3xl border-4 border-[#8b4513] flex flex-col shadow-inner"
                     style="background-color: #fffbeb;">
                    <h3 class="text-xl font-bold mb-4 text-[#5e3008] flex items-center gap-2 font-game">
                        <span class="bg-[#5e3008] text-[#fdf6e3] w-8 h-8 rounded-full flex items-center justify-center text-sm border-2 border-[#8b4513]">2</span> 
                        ë‚´ìš© ì„¤ì •
                    </h3>
                    <div class="flex gap-2 mb-4">
                        <button @click="ladderContentMode = 'winner'" :class="ladderContentMode === 'winner' ? 'wood-sign-btn transform scale-105 ring-2 ring-[#facc15]' : 'bg-[#e2c7a5] text-[#5e3008] border-2 border-[#8b4513]'" class="flex-1 py-3 rounded-xl font-black transition-all text-base shadow-sm">ë‹¹ì²¨</button>
                        <button @click="ladderContentMode = 'penalty'" :class="ladderContentMode === 'penalty' ? 'wood-sign-btn transform scale-105 ring-2 ring-[#facc15]' : 'bg-[#e2c7a5] text-[#5e3008] border-2 border-[#8b4513]'" class="flex-1 py-3 rounded-xl font-black transition-all text-base shadow-sm">ë²Œì¹™</button>
                        <button @click="ladderContentMode = 'custom'" :class="ladderContentMode === 'custom' ? 'wood-sign-btn transform scale-105 ring-2 ring-[#facc15]' : 'bg-[#e2c7a5] text-[#5e3008] border-2 border-[#8b4513]'" class="flex-1 py-3 rounded-xl font-black transition-all text-base shadow-sm">ì§ì ‘</button>
                    </div>
                    
                    <textarea v-if="ladderContentMode === 'custom'" v-model="customLadderResults" 
                              class="w-full flex-1 p-5 border-4 border-[#d4a373] rounded-2xl resize-y outline-none focus:border-[#8b4513] font-bold text-[#5e3008] text-lg bg-white" 
                              placeholder="ê²°ê³¼ë¥¼ ì—”í„°ë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                    
                    <div v-else class="flex-1 flex flex-col items-center justify-center text-[#5e3008] font-bold border-4 border-dashed border-[#d4a373] rounded-2xl bg-[#fff8e1] gap-6">
                        <div class="text-2xl font-black font-game">{{ ladderContentMode === 'winner' ? 'ğŸ‰ ë‹¹ì²¨ì ìˆ˜' : 'ğŸ”¥ ë²Œì¹™ì ìˆ˜' }}</div>
                        <div class="flex items-center gap-4 bg-white p-3 rounded-2xl border-2 border-[#d4a373] shadow-sm">
                            <button @click="updateCount($event, ladderContentMode); ladderContentMode === 'winner' ? winnerCount = Math.max(1, winnerCount - 1) : penaltyCount = Math.max(1, penaltyCount - 1)" 
                                    class="w-12 h-12 bg-[#8b4513] text-[#fffbeb] rounded-xl shadow border-2 border-[#5e3008] text-2xl font-black hover:scale-105 transition-all active:scale-95">-</button>
                            <div class="w-20 text-center text-4xl font-black text-[#5e3008] font-game">{{ ladderContentMode === 'winner' ? winnerCount : penaltyCount }}</div>
                            <button @click="ladderContentMode === 'winner' ? winnerCount++ : penaltyCount++" 
                                    class="w-12 h-12 bg-[#8b4513] text-[#fffbeb] rounded-xl shadow border-2 border-[#5e3008] text-2xl font-black hover:scale-105 transition-all active:scale-95">+</button>
                        </div>
                        <div class="text-sm text-[#8b4513] bg-[#e2c7a5] px-4 py-2 rounded-lg font-game">ë‚˜ë¨¸ì§€ëŠ” '{{ ladderContentMode === 'winner' ? 'ê½' : 'í†µê³¼' }}'ì´ ë©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
    <button @click="generateLadder" 
            class="wood-sign-btn shadow-2xl hover:scale-100 transition-transform font-game mx-auto" 
            style="font-size: 1.5rem !important; padding: 15px 45px !important; height: auto !important; width: auto !important; border-radius: 9999px !important;">
        ì‚¬ë‹¤ë¦¬ ìƒì„±í•˜ê¸°!
    </button>
</div>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-full w-full relative ladder-jungle-bg" style="background-color: #1b4332 !important;">
        
        <div class="h-20 flex items-center justify-between px-6 shrink-0 z-50 shadow-md" style="background-color: #0f281e; border-bottom: 1px solid #2d6a4f;">
            <h2 class="font-black text-2xl flex items-center gap-2 font-game" style="color: #52b788;">
                <i class="fa-solid fa-tree mr-2"></i> ì •ê¸€ íƒí—˜
            </h2>
            <div class="flex gap-4">
                <button @click="revealAllLadders" class="group relative inline-flex items-center justify-center px-6 py-2 font-black text-white transition-all duration-200 bg-emerald-600 font-game rounded-xl hover:bg-emerald-500 active:scale-95 shadow-md active:translate-y-[4px]">
                    <i class="fa-solid fa-eye mr-2"></i> ê²°ê³¼ ê³µê°œ
                </button>
                <button @click="resetLadderSettings" class="group relative inline-flex items-center justify-center px-6 py-2 font-black text-white transition-all duration-200 font-game rounded-xl active:scale-95 shadow-md active:translate-y-[4px]" style="background-color: #8b4513;">
                    <i class="fa-solid fa-gear mr-2"></i> ì„¤ì •
                </button>
            </div>
        </div>
        
        <div class="w-full flex justify-between items-end z-20 absolute top-[160px] left-0 pointer-events-none"
     style="transform: translateY(-100%);"> <div v-for="(name, idx) in ladderStudents" :key="'name-'+idx" class="flex-1 flex justify-center px-[1px] pointer-events-auto">
        <button @click="startLadderGame(idx)" 
                :disabled="isLadderAnimating" 
                class="w-full wood-sign-btn truncate"
                :class="{'wood-active': revealedStarts.includes(idx)}"
                :style="ladderDynamicStyle">
            {{ name }}
        </button>
    </div>
</div>
        <div class="w-full h-full absolute inset-0 pt-[160px] pb-[90px]">
            <svg class="w-full h-full" viewBox="0 0 1000 1000" preserveAspectRatio="none">
                <pattern id="leafGrid" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M10 10 L15 15 M30 30 L35 35" stroke="rgba(255,255,255,0.05)" stroke-width="2"/>
                </pattern>
                <rect width="1000" height="1000" fill="url(#leafGrid)" />

                <line v-for="(name, i) in ladderStudents" :key="'v'+i" 
                      :x1="getLadderX(i)" y1="0" :x2="getLadderX(i)" y2="1000" 
                      stroke="#d4a373" stroke-width="12" stroke-linecap="round" />
                
                <line v-for="(line, i) in ladderLines" :key="'h'+i" 
                      :x1="getLadderX(line.col)" :y1="line.y" 
                      :x2="getLadderX(line.col + 1)" :y2="line.y + (line.slant || 0)" 
                      stroke="#d4a373" stroke-width="12" stroke-linecap="round" />

                <polyline v-if="activePolyline" :points="activePolyline" 
                          fill="none" stroke="#facc15" stroke-width="12" 
                          stroke-linecap="round" stroke-linejoin="round" 
                          class="drop-shadow-[0_0_15px_rgba(250,204,21,0.8)]" />

                <foreignObject v-if="ballPos.visible" 
                               :x="ballPos.x - 30" :y="ballPos.y - 30" 
                               width="60" height="60" class="overflow-visible">
                    <div class="w-full h-full flex items-center justify-center text-[50px] animate-bounce-custom" 
                         style="filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));">
                        ğŸ¹
                    </div>
                </foreignObject>
            </svg>
        </div>
        
    <div class="w-full flex justify-between items-start z-20 absolute bottom-[90px] left-0 pointer-events-none"
     style="transform: translateY(100%);"> <div v-for="(res, idx) in ladderResults" :key="'res-'+idx" class="flex-1 flex justify-center px-[1px] h-full items-center pointer-events-auto">
        
        <div class="w-full wood-crate-box rounded-xl font-black cursor-pointer transition-all duration-300" 
             :class="{
                 'wood-active': revealedResults.includes(idx), 
                 'bad-result': res.includes('ë‹¹ì²¨') || res.includes('ê±¸') 
             }"
             :style="ladderDynamicStyle" 
             @click="startReverseLadderGame(idx)">
            <span class="truncate px-1">{{ res }}</span>
        </div>

    </div>
</div>
    


        <div v-if="showLadderResultModal" class="fixed inset-0 bg-black/60 z-[9000] flex items-center justify-center p-4" @click.self="showLadderResultModal = false">
            <div class="jungle-modal-frame w-full max-w-3xl rounded-[2.5rem] overflow-hidden relative flex flex-col max-h-[80vh] animate-pop-in" 
                 style="resize: both; min-width: 400px; min-height: 500px;">
                
                <div class="jungle-modal-header p-6 pb-4 flex flex-col items-center justify-center shrink-0 relative">
                    <button @click="showLadderResultModal = false" class="absolute top-5 right-5 text-[#8b4513] hover:text-[#5e3008] transition-colors text-3xl cursor-pointer" @mousedown.stop>
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <div class="w-16 h-16 bg-[#5e3008] rounded-full flex items-center justify-center text-[#fdf6e3] text-3xl mb-3 shadow-lg pointer-events-none">
                        <i class="fa-solid fa-clipboard-list"></i>
                    </div>
                    <h3 class="text-3xl font-black font-game pointer-events-none">ì‚¬ë‹¤ë¦¬ ê²°ê³¼</h3>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-3 custom-scrollbar bg-[#fdf6e3]">
                    <div v-for="(item, idx) in ladderFinalList" :key="idx" 
                         class="jungle-list-item flex items-center justify-between p-4 rounded-2xl shadow-sm cursor-default">
                        
                        <div class="flex items-center gap-4">
                            <span class="jungle-badge font-black text-xl w-10 h-10 flex items-center justify-center shadow-inner">{{ item.rank }}</span>
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-[#8b4513] opacity-70 mb-0.5">ì°¸ê°€ì</span>
                                <span class="font-black text-xl">{{ item.name }}</span>
                            </div>
                        </div>

                        <div class="flex-1 px-4 flex items-center justify-center text-[#d4a373] opacity-50">
                            <i class="fa-solid fa-arrow-right text-xl"></i>
                        </div>

                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-black text-2xl" :class="item.isBad ? 'text-gray-500' : 'text-[#b45309]'">{{ item.result }}</div>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-inner border-2 border-[#d4a373]"
                                 :class="item.isBad ? 'bg-gray-200 text-gray-500' : 'bg-[#fff8e1] text-[#fbbf24]'">
                                <i :class="item.isBad ? 'fa-solid fa-face-dizzy' : 'fa-solid fa-face-laugh-squint'"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 border-t-4 border-[#d4a373] bg-[#fffbeb] shrink-0">
                    <button @click="showLadderResultModal = false" class="w-full py-4 wood-sign-btn text-2xl rounded-2xl shadow-lg hover:scale-[1.02] active:scale-95 font-game">
                        í™•ì¸ ì™„ë£Œ
                    </button>
                </div>
                
                <div class="resize-handle" @mousedown.stop.prevent="startLadderResultResize"></div>
            </div>
</div>
</div>
    </div>

      <div v-else-if="pickerTab === 'dice'" class="scaling-container h-full w-full bg-slate-50">
            
            <div class="fixed-layout-box flex flex-col items-center justify-between py-16 gap-24 mb-[8vh]" 
                 style="width: 1700px; height: 1600px;" 
                 :style="{ transform: `scale(${ getScale(1650, 1550, 0.95) })` }">
                
                <div class="flex items-center justify-between bg-white w-[900px] px-16 py-10 rounded-[5rem] shadow-xl border-[12px] border-slate-200 z-10 relative">
                    <button @click="diceCount = Math.max(1, diceCount - 1)" 
                            class="w-40 h-40 bg-orange-100 text-orange-600 rounded-full font-black text-[7rem] hover:bg-orange-200 transition-colors shadow-md pb-4 flex items-center justify-center shrink-0">
                        -
                    </button>
                    
                    <span class="text-[10rem] font-black text-center text-slate-700 font-game leading-none pt-4">{{ diceCount }}</span>
                    
                    <button @click="diceCount = Math.min(6, diceCount + 1)" 
                            class="w-40 h-40 bg-orange-100 text-orange-600 rounded-full font-black text-[7rem] hover:bg-orange-200 transition-colors shadow-md pb-4 flex items-center justify-center shrink-0">
                        +
                    </button>
                </div>

                <div class="flex-1 flex items-center justify-center w-full">
                    <div class="dice-wrapper flex flex-wrap gap-20 justify-center items-center w-full relative z-50">
                        
                        <div v-for="(value, idx) in displayDiceValues" :key="idx" 
                             class="w-[900px] h-[900px] bg-white rounded-[8rem] flex items-center justify-center text-[600px] shadow-[0_30px_60px_rgba(0,0,0,0.3)] border-[24px] border-orange-300 select-none text-slate-800 leading-none pb-14 transition-transform">
                            {{ getDiceFace(value) }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-center z-10 relative">
                    <button @click="rollDice" :disabled="isRollingDice" 
                            class="w-[900px] py-16 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-black text-[8rem] rounded-[6rem] shadow-2xl hover:scale-105 transition-all disabled:opacity-50 disabled:scale-100 active:scale-95 border-b-[24px] border-orange-700 leading-tight">
                        {{ isRollingDice ? '...' : 'ë˜ì§€ê¸°' }}
                    </button>
                </div>
            </div>
        </div>
<div v-else-if="pickerTab === 'tournament'" class="picker-tab-content-tournament">
    
    <div class="spotlight-overlay" :class="{'active': finalWinner}"></div>

    <div class="w-full h-16 flex justify-between items-center px-6 shrink-0 z-50 bg-slate-900 border-b border-slate-700 shadow-md">
        <h2 class="text-2xl font-black text-white flex items-center gap-3 drop-shadow-md">
            <i class="fa-solid fa-sitemap text-yellow-400"></i> ëŒ€ì§„í‘œ
        </h2>
        <div class="flex gap-2">
            <select v-model="selectedBracketMode" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold border border-slate-600 outline-none text-sm cursor-pointer hover:bg-slate-700 transition-all">
                <option value="group8">ğŸ§© 8ê°• (ëª¨ë‘  ëŒ€í•­)</option>
                <option value="male16">ğŸ‘¦ 16ê°• (ë‚¨í•™ìƒ)</option>
                <option value="female16">ğŸ‘§ 16ê°• (ì—¬í•™ìƒ)</option>
                <option value="random32">ğŸ² 32ê°• (ì „ì²´ ëœë¤)</option>
            </select>
            <button @click="generateBracket" :disabled="isGenerating" class="bg-yellow-500 text-slate-900 px-5 py-2 rounded-lg font-black hover:bg-yellow-400 shadow-md active:scale-95 transition-all text-sm flex items-center gap-2 disabled:opacity-50">
                <i class="fa-solid fa-play"></i> {{ isGenerating ? 'ìƒì„± ì¤‘...' : 'ìƒì„±' }}
            </button>
            <button @click="resetBracket" class="bg-white/10 text-white px-3 py-2 rounded-lg font-bold hover:bg-white/20 border border-white/10 text-sm transition-all" title="ì´ˆê¸°í™”">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </div>

    <div class="flex-1 relative overflow-auto custom-scrollbar bg-slate-900">
        
        <div v-if="isGenerating" class="absolute top-10 left-0 right-0 z-[100] flex justify-center pointer-events-none">
            <div class="bg-blue-600/90 px-8 py-4 rounded-full text-white font-black animate-bounce shadow-2xl border-2 border-blue-400 flex items-center gap-3">
                <i class="fa-solid fa-spinner animate-spin text-xl"></i> 
                <span>ëŒ€ì§„í‘œë¥¼ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
        </div>

        <div v-if="visibleBracketTree.length > 0" class="bracket-wrapper" :key="bracketKey" :style="layoutStyle">
            
            <div class="side-bracket left">
                <div v-for="rIdx in (visibleBracketTree.length - 1)" :key="'left-round-'+rIdx" class="round-column">
                    <div v-for="(pair, pIdx) in leftSideBracket[rIdx-1]" :key="'l-pair-'+pIdx" class="match-pair" :style="getPairStyle(rIdx-1)">
                        <div v-if="pair[0]" class="match-box" :class="getPlayerStatusClass(pair[0].player1)" draggable="true" @dragstart="handleDragStart($event, rIdx-1, pair[0].originalIndex, 'player1')" @drop="handleDrop($event, rIdx-1, pair[0].originalIndex, 'player1')" @dragover.prevent @click="pickWinner(rIdx-1, pair[0].originalIndex, 'player1', $event)" @contextmenu.prevent="cancelMatchWinner(rIdx-1, pair[0].originalIndex, 'player1')">
                            <span v-if="pair[0].player1">{{ pair[0].player1 }}</span>
                            <i v-else class="fa-solid fa-crown text-white/40"></i>
                        </div>
                        <div class="bracket-line" :style="getLineStyle(rIdx-1)"></div>
                        <div v-if="pair[0]" class="match-box" :class="getPlayerStatusClass(pair[0].player2)" draggable="true" @dragstart="handleDragStart($event, rIdx-1, pair[0].originalIndex, 'player2')" @drop="handleDrop($event, rIdx-1, pair[0].originalIndex, 'player2')" @dragover.prevent @click="pickWinner(rIdx-1, pair[0].originalIndex, 'player2', $event)" @contextmenu.prevent="cancelMatchWinner(rIdx-1, pair[0].originalIndex, 'player2')">
                            <span v-if="pair[0].player2">{{ pair[0].player2 }}</span>
                            <i v-else class="fa-solid fa-crown text-white/40"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="final-stage-wrapper">
                <div class="trophy-section">
                    <div class="god-rays" :class="{'active': finalWinner}"></div>
                    <i class="fa-solid fa-trophy trophy-icon"></i>
                    <div class="champion-display" @contextmenu.prevent="cancelFinalWinner">
                        <span v-if="finalWinner">{{ finalWinner }}</span>
                        <span v-else class="text-sm opacity-50 tracking-widest">CHAMPION</span>
                    </div>
                </div>
                <div v-if="visibleBracketTree[visibleBracketTree.length-1]" class="final-match-row">
                    <div class="finalist-card" :class="getPlayerStatusClass(visibleBracketTree[visibleBracketTree.length-1][0].player1)" @click="pickWinner(visibleBracketTree.length-1, 0, 'player1', $event)" @contextmenu.prevent="cancelMatchWinner(visibleBracketTree.length-1, 0, 'player1')">
                        <span v-if="visibleBracketTree[visibleBracketTree.length-1][0].player1">{{ visibleBracketTree[visibleBracketTree.length-1][0].player1 }}</span>
                        <i v-else class="fa-solid fa-crown text-white/40 text-xl"></i>
                    </div>
                    <div class="vs-container">VS</div>
                    <div class="finalist-card" :class="getPlayerStatusClass(visibleBracketTree[visibleBracketTree.length-1][0].player2)" @click="pickWinner(visibleBracketTree.length-1, 0, 'player2', $event)" @contextmenu.prevent="cancelMatchWinner(visibleBracketTree.length-1, 0, 'player2')">
                        <span v-if="visibleBracketTree[visibleBracketTree.length-1][0].player2">{{ visibleBracketTree[visibleBracketTree.length-1][0].player2 }}</span>
                        <i v-else class="fa-solid fa-crown text-white/40 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="side-bracket right">
                <div v-for="rIdx in (visibleBracketTree.length - 1)" :key="'right-round-'+rIdx" class="round-column">
                    <div v-for="(pair, pIdx) in rightSideBracket[rIdx-1]" :key="'r-pair-'+pIdx" class="match-pair" :style="getPairStyle(rIdx-1)">
                        <div v-if="pair[0]" class="match-box" :class="getPlayerStatusClass(pair[0].player1)" draggable="true" @dragstart="handleDragStart($event, rIdx-1, pair[0].originalIndex, 'player1')" @drop="handleDrop($event, rIdx-1, pair[0].originalIndex, 'player1')" @dragover.prevent @click="pickWinner(rIdx-1, pair[0].originalIndex, 'player1', $event)" @contextmenu.prevent="cancelMatchWinner(rIdx-1, pair[0].originalIndex, 'player1')">
                            <span v-if="pair[0].player1">{{ pair[0].player1 }}</span>
                            <i v-else class="fa-solid fa-crown text-white/40"></i>
                        </div>
                        <div class="bracket-line" :style="getLineStyle(rIdx-1)"></div>
                        <div v-if="pair[0]" class="match-box" :class="getPlayerStatusClass(pair[0].player2)" draggable="true" @dragstart="handleDragStart($event, rIdx-1, pair[0].originalIndex, 'player2')" @drop="handleDrop($event, rIdx-1, pair[0].originalIndex, 'player2')" @dragover.prevent @click="pickWinner(rIdx-1, pair[0].originalIndex, 'player2', $event)" @contextmenu.prevent="cancelMatchWinner(rIdx-1, pair[0].originalIndex, 'player2')">
                            <span v-if="pair[0].player2">{{ pair[0].player2 }}</span>
                            <i v-else class="fa-solid fa-crown text-white/40"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div v-else-if="!isGenerating" class="flex flex-col items-center justify-center opacity-20 gap-6 select-none h-full">
            <i class="fa-solid fa-trophy text-9xl text-white animate-pulse"></i>
            <span class="text-3xl font-black text-white tracking-widest">ì¸ì›ì„ ì„ íƒí•˜ê³  [ìƒì„±] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>
        </div>
    </div>
</div>
    <div v-if="!isPickerMaximized" class="resize-handle" @mousedown.stop="startPickerResize"></div>
</div></div>
<div v-if="showTimer && isTimerMaximized" 
     class="fixed inset-0 bg-black z-[9999]">
</div>

<div v-if="showTimer" 
     class="bomb-window"
     :class="[
       {'stopwatch-mode': isStopwatchMode},
       {'stopwatch-running-beat': isStopwatchMode && timerInterval},
       {'bomb-active-glow': !isStopwatchMode && timerInterval && timerSeconds > 10},
       {'bomb-warning': !isStopwatchMode && timerInterval && timerSeconds <= 10 && timerSeconds > 0},
       {'fixed inset-0 z-[10000]': isTimerMaximized} 
     ]"
     :style="{ 
         top: !isTimerMaximized ? (timerY || 200) + 'px' : '0', 
         left: !isTimerMaximized ? (timerX || 200) + 'px' : '0', 
         width: !isTimerMaximized ? (timerSize || 400) + 'px' : '100%', 
         height: !isTimerMaximized ? ((timerSize || 400) * 0.633) + 'px' : '100%',
         zIndex: isTimerMaximized ? 10000 : (timerZ || 5002)
     }" 
     @mousedown="focusWindow('timer'); !isTimerMaximized && startTimerDrag($event)">     
    <div class="display-unit" @mousedown.stop>
        <div class="time-group" :style="isStopwatchMode ? { width: '25% !important' } : {}">
            <button v-if="!isStopwatchMode" class="time-adj-btn" @click="adjustTimer(60)"><i class="fa-solid fa-caret-up"></i></button>
<input type="text" v-model="inputMin" 
       @click="$event.target.select()" 
       @input="onTimerInput" 
       @blur="inputMin = inputMin.padStart(2, '0')"
       class="timer-input no-spin">

            <button v-if="!isStopwatchMode" class="time-adj-btn" @click="adjustTimer(-60)"><i class="fa-solid fa-caret-down"></i></button>
        </div>

        <span class="timer-colon" :class="{'animate-pulse': timerInterval && !isStopwatchMode}">:</span>

        <div class="time-group" :style="isStopwatchMode ? { width: '55% !important' } : {}">
            <button v-if="!isStopwatchMode" class="time-adj-btn" @click="adjustTimer(30)"><i class="fa-solid fa-caret-up"></i></button>
           <input type="text" v-model="inputSec" 
       @click="$event.target.select()" 
       @input="onTimerInput" 
       @blur="inputSec = inputSec.padStart(2, '0')"
       class="timer-input no-spin">

            <button v-if="!isStopwatchMode" class="time-adj-btn" @click="adjustTimer(-30)"><i class="fa-solid fa-caret-down"></i></button>
        </div>
    </div>

    <button @click.stop="resetTimer" class="timer-ctrl-btn btn-pos-1" title="ì´ˆê¸°í™”"><i class="fa-solid fa-rotate-left"></i></button>
    <button @click.stop="toggleTimer" class="timer-ctrl-btn btn-pos-2" :class="{'timer-running': timerInterval}" title="ì‘ë™/ì •ì§€"><i :class="timerInterval ? 'fa-solid fa-pause' : 'fa-solid fa-play'"></i></button>
    <button @click.stop="isTimerMaximized = !isTimerMaximized" class="timer-ctrl-btn btn-pos-3" title="í™”ë©´ì „í™˜"><i :class="isTimerMaximized ? 'fa-solid fa-compress' : 'fa-solid fa-expand'"></i></button>
    <button @click.stop="showTimer = false" class="timer-ctrl-btn btn-pos-4" title="ë‹«ê¸°"><i class="fa-solid fa-xmark"></i></button>

    <div v-if="!isTimerMaximized" class="timer-resize-handle" @mousedown.stop="startTimerResize"></div>
</div>

<div class="full-screen-explosion" :class="{'explode-active': isExploding}">BOOM!</div>

<div v-if="showNoiseMeter"
     class="fixed bg-white shadow-2xl overflow-hidden flex flex-col"
     :class="{ 'inset-0 rounded-none': isNoiseMaximized, 'rounded-[3rem] border-4 border-slate-200': !isNoiseMaximized }"
     :style="[
        !isNoiseMaximized ? { 
            top: (noiseY || 100) + 'px', 
            left: (noiseX || 100) + 'px', 
            width: (noiseW || 400) + 'px', 
            height: (noiseH || 300) + 'px' 
        } : {},
        { 'container-type': 'size' },
        { zIndex: isNoiseMaximized ? 9999 : (noiseZ || 5004) } 
     ]"
     @mousedown="focusWindow('noise')">    <div class="h-20 bg-gradient-to-r from-cyan-500 to-teal-600 flex items-center justify-between px-8 cursor-move select-none shrink-0"
         @mousedown="startNoiseDrag">
        <h2 class="text-white font-black text-3xl">ğŸ¤ ì†ŒìŒ ì¸¡ì •ê¸°</h2>
        <div class="flex items-center gap-3">
            <button @click.stop="showNoiseSettings = true" class="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white text-xl transition-all"><i class="fa-solid fa-gear"></i></button>
            <button @click.stop="isNoiseMaximized = !isNoiseMaximized" class="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white text-xl transition-all"><i :class="isNoiseMaximized ? 'fa-solid fa-compress' : 'fa-solid fa-expand'"></i></button>
            <button @click.stop="showNoiseMeter = false; stopNoiseMeasurement();" class="w-12 h-12 bg-red-500/80 hover:bg-red-600 rounded-xl flex items-center justify-center text-white text-2xl transition-all"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

   <div class="flex-1 flex flex-col bg-slate-50 transition-colors duration-200 overflow-hidden relative">
    
    <div class="flex-1 w-full flex flex-col items-center justify-center" 
         :style="{ gap: '4cqw' }">
        
        <div class="flex items-center justify-center w-full" :style="{ gap: '3cqw' }">
    <span class="font-bold rounded-full text-white shadow-sm flex items-center justify-center leading-none" 
          :class="getNoiseClass(currentNoiseLevel, 'bg')" 
          :style="{ fontSize: '4.5cqw', padding: '1.5cqw 3cqw', borderRadius: '9999px' }">
        [{{ getNoiseStage(currentNoiseLevel) }}]
    </span>
    
    <div class="font-black drop-shadow-md leading-none" 
         :class="getNoiseClass(currentNoiseLevel)"
         :style="{ fontSize: '18cqw' }">
        {{ currentNoiseLevel }} <span class="text-slate-400 font-bold" :style="{ fontSize: '6cqw' }">dB</span>
    </div>
</div>

        <div class="relative w-[90cqw] select-none transition-all" 
             ref="noiseBar" 
             :style="{ height: '12cqw', borderRadius: '4cqw' }"
             :class="{ 'effect-penalty-shock': isPenaltyShock }"> 
            
            <div class="absolute inset-x-0 top-0 overflow-hidden shadow-inner bg-slate-200"
                 :style="{ height: '12cqw', borderRadius: '4cqw', borderWidth: '0.8cqw', borderColor: '#f1f5f9' }">
                <div class="h-full transition-all duration-100 ease-linear relative"
                     :class="getNoiseBarColorClass()"
                     :style="{ width: Math.min(100, (currentNoiseLevel / maxDB) * 100) + '%' }">
                     <div class="absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"></div>
                     <div class="absolute right-0 top-0 bottom-0 bg-white/50 shadow-[0_0_15px_white]" :style="{ width: '0.5cqw' }"></div>
                </div>
            </div>

            <div class="absolute top-0 flex flex-col items-center cursor-col-resize group z-10 hover:z-50 transition-all duration-75" 
                 :style="{ left: (noiseLevels.safe / maxDB * 100) + '%', transform: 'translateX(-50%)', height: '12cqw' }" 
                 @mousedown.stop="startDrag('safe', $event)">
                <div class="bg-white/80 shadow-sm group-hover:bg-green-500 transition-colors" :style="{ width: '0.8cqw', height: '100%' }"></div>
                <div class="bg-white border-green-200 text-green-600 font-black flex flex-col items-center whitespace-nowrap shadow-lg group-hover:scale-110 transition-transform" 
                     :style="{ marginTop: '1.5cqw', fontSize: '2.5cqw', padding: '0.5cqw 1.5cqw', borderRadius: '1.5cqw', borderWidth: '0.4cqw' }">
                    <span :style="{ fontSize: '2cqw' }">â–²</span><span>ì£¼ì˜</span>
                </div>
            </div>

            <div class="absolute top-0 flex flex-col items-center cursor-col-resize group z-20 hover:z-50 transition-all duration-75" 
                 :style="{ left: (noiseLevels.caution / maxDB * 100) + '%', transform: 'translateX(-50%)', height: '12cqw' }" 
                 @mousedown.stop="startDrag('caution', $event)">
                <div class="bg-white/80 shadow-sm group-hover:bg-orange-500 transition-colors" :style="{ width: '0.8cqw', height: '100%' }"></div>
                <div class="bg-white border-orange-300 text-orange-600 font-black flex flex-col items-center whitespace-nowrap shadow-lg group-hover:scale-110 transition-transform" 
                     :style="{ marginTop: '1.5cqw', fontSize: '2.5cqw', padding: '0.5cqw 1.5cqw', borderRadius: '1.5cqw', borderWidth: '0.4cqw' }">
                    <span :style="{ fontSize: '2cqw' }">â–²</span><span>ê²½ê³ </span>
                </div>
            </div>
            
            <div class="absolute top-0 flex flex-col items-center cursor-col-resize group z-30 hover:z-50 transition-all duration-75" 
                 :style="{ left: (noiseLevels.warning / maxDB * 100) + '%', transform: 'translateX(-50%)', height: '12cqw' }" 
                 @mousedown.stop="startDrag('warning', $event)">
                <div class="bg-white/80 shadow-sm group-hover:bg-red-500 transition-colors" :style="{ width: '0.8cqw', height: '100%' }"></div>
                <div class="bg-white border-red-200 text-red-500 font-black flex flex-col items-center whitespace-nowrap shadow-lg group-hover:scale-110 transition-transform" 
                     :style="{ marginTop: '1.5cqw', fontSize: '2.5cqw', padding: '0.5cqw 1.5cqw', borderRadius: '1.5cqw', borderWidth: '0.4cqw' }">
                    <span :style="{ fontSize: '2cqw' }">â–²</span><span>íƒˆë½</span>
                </div>
            </div>
        </div>
    </div>

    <div class="shrink-0 w-full flex justify-center z-50" 
         :style="{ paddingBottom: '3cqw', paddingTop: '1cqw' }">
        <div class="flex items-center bg-white shadow-sm border-slate-200" 
             :style="{ gap: '2.5cqw', padding: '1.2cqw 3cqw', borderRadius: '1.5cqw', borderWidth: '0.2cqw' }">
            
            <div class="flex items-center" :style="{ gap: '1cqw' }">
                <span class="rounded-full bg-orange-500 animate-pulse" :style="{ width: '1.5cqw', height: '1.5cqw' }"></span>
                <span class="font-bold text-slate-600" :style="{ fontSize: '2cqw' }">ê²½ê³ </span>
                <span class="font-black text-orange-500 leading-none" :style="{ fontSize: '3.5cqw', marginLeft: '0.5cqw' }">{{ statsWarningCount }}</span>
                <span class="font-bold text-slate-400" :style="{ fontSize: '1.5cqw' }">íšŒ</span>
            </div>
            
            <div class="bg-slate-200" :style="{ width: '0.2cqw', height: '3cqw' }"></div>
            
            <div class="flex items-center" :style="{ gap: '1cqw' }">
                <span class="rounded-full bg-red-500 animate-pulse" :style="{ width: '1.5cqw', height: '1.5cqw' }"></span>
                <span class="font-bold text-slate-600" :style="{ fontSize: '2cqw' }">íƒˆë½</span>
                <span class="font-black text-red-500 leading-none" :style="{ fontSize: '3.5cqw', marginLeft: '0.5cqw' }">{{ statsPenaltyCount }}</span>
                <span class="font-bold text-slate-400" :style="{ fontSize: '1.5cqw' }">íšŒ</span>
            </div>
            
            <div class="bg-slate-200" :style="{ width: '0.2cqw', height: '3cqw' }"></div>
            
            <button @click="resetNoiseStats" 
                    class="flex items-center justify-center bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600 hover:rotate-180 transition-all rounded-xl" 
                    title="ì´ˆê¸°í™”"
                    :style="{ width: '4cqw', height: '4cqw' }">
                <i class="fa-solid fa-rotate-right" :style="{ fontSize: '1.8cqw' }"></i>
            </button>
        </div>
    </div>

    <div v-if="showNoiseSettings" class="absolute inset-0 z-[10000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6" @click.self="showNoiseSettings = false">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl animate-pop-in border-4 border-slate-100">
            <h3 class="text-2xl font-black text-slate-800 mb-6 text-center"><i class="fa-solid fa-sliders mr-2 text-indigo-500"></i>ì†ŒìŒ ê¸°ì¤€ ì„¤ì •</h3>
            <div class="space-y-6">
                <div><label class="block text-sm font-bold text-green-600 mb-2 flex justify-between"><span>ğŸŸ¢ ì£¼ì˜</span><span>{{ noiseLevels.safe }}dB</span></label>
                <input type="range" v-model.number="noiseLevels.safe" min="0" max="120" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-500"></div>
                <div><label class="block text-sm font-bold text-yellow-500 mb-2 flex justify-between"><span>ğŸŸ¡ ê²½ê³ </span><span>{{ noiseLevels.caution }}dB</span></label>
                <input type="range" v-model.number="noiseLevels.caution" min="0" max="120" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-yellow-400"></div>
                <div><label class="block text-sm font-bold text-red-500 mb-2 flex justify-between"><span>ğŸ”´ íƒˆë½</span><span>{{ noiseLevels.warning }}dB</span></label>
                <input type="range" v-model.number="noiseLevels.warning" min="0" max="120" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500"></div>
            </div>
            <div class="flex gap-3 mt-8">
                <button @click="showNoiseSettings = false" class="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200">ì·¨ì†Œ</button>
                <button @click="saveNoiseSettings" class="flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 shadow-lg active:scale-95">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div v-if="!isNoiseMaximized" class="resize-handle" @mousedown.stop="startNoiseResize"></div>
</div> 

<transition
    enter-active-class="transition ease-out duration-300"
    enter-from-class="opacity-0 scale-50"
    enter-to-class="opacity-100 scale-100"
    leave-active-class="transition ease-in duration-200"
    leave-from-class="opacity-100 scale-100"
    leave-to-class="opacity-0 scale-110">
    
    <div v-if="notificationMsg" 
         class="fixed inset-0 z-[100000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
         @click="notificationMsg = ''"> <div class="bg-white rounded-[3rem] shadow-2xl border-[8px] flex flex-col items-center justify-center text-center animate-bounce-slow"
             :class="{
                'border-orange-500 text-orange-600': notificationType === 'warning-big',
                'border-red-600 text-red-600': notificationType === 'danger-big'
             }"
             style="width: 80cqw; height: 50cqw; min-width: 600px; min-height: 400px;">
            
            <i class="fa-solid mb-8 animate-pulse" 
               :class="{
                  'fa-triangle-exclamation text-[15cqw]': notificationType === 'warning-big',
                  'fa-circle-exclamation text-[15cqw]': notificationType === 'danger-big'
               }"></i>
               
            <span class="font-black leading-tight drop-shadow-md whitespace-pre-line" 
                  style="font-size: 8cqw;">
                {{ notificationMsg }}
            </span>
            
        </div>
    </div>
</transition>  
</div>

 <script type="module">   
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCzsI9FW3bga1V73lCR7pNgfPLdcqcbsgM",
        authDomain: "class-manager-bad00.firebaseapp.com",
        databaseURL: "https://class-manager-bad00-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "class-manager-bad00",
        storageBucket: "class-manager-bad00.firebasestorage.app",
        messagingSenderId: "436830301778",
        appId: "1:436830301778:web:d3da11a5ac0e6c252d798b",
        measurementId: "G-H95D2Z7MFF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const DB_KEY = 'myClassroomData';
    const ROCK_AVATARS = ['ğŸª¨'];

    createApp({
        data() {
            return {
isInitialLoad: true,
showBombTimer: false,
showNoiseMeter: false,
                saveTimeout: null,
                view: 'main', activeTool: 'plus', allModeMain: false, allModeGroup: false, isMemoVisible: false, 
lotteryPools: {
            all: [],   // ì „ì²´ ëª¨ë“œìš© í’€
            M:   [],   // ë‚¨í•™ìƒ ëª¨ë“œìš© í’€
            F:   []    // ì—¬í•™ìƒ ëª¨ë“œìš© í’€
        },
currentMaxZ: 20000, // ê¸°ì¤€ ë†’ì´
        boardZ: 20001,      // íŒì„œ
        timerZ: 20002,      // íƒ€ì´ë¨¸
        pickerZ: 20003,     // ë½‘ê¸°ì°½
        noiseZ: 20004,      // ì†ŒìŒ ì¸¡ì •ê¸°
        ladderResultZ: 20005,
revealedStarts: [],
isAnimating: false, 
        countText: '3',
displayWinner: '?',
lastWinners: {
            all: null, // ì „ì²´ ëª¨ë“œì˜ ë§ˆì§€ë§‰ ë‹¹ì²¨ì
            M: null,   // ë‚¨í•™ìƒ ëª¨ë“œì˜ ë§ˆì§€ë§‰ ë‹¹ì²¨ì
            F: null    // ì—¬í•™ìƒ ëª¨ë“œì˜ ë§ˆì§€ë§‰ ë‹¹ì²¨ì
        },
isInteracting: false,
winW: window.innerWidth,
winH: window.innerHeight,
displayWinner: '?',
bracketMode: 'random32',
selectedBracketMode: 'random32',
                ballPos: { x: 0, y: 0, visible: false },  
                activePolyline: '',
                lotteryMode: 'all',
                winnerCount: 1,
                penaltyCount: 1,
                seats: Array(30).fill(null), waitingRoom: [],
                groups: Array(6).fill().map(() => ({ score: 0, checked: false, memo: "", starred: false, members: [], showMembers: false })),
                groupingList: [], 
                showGroupingResultModal: false, 
                stoppedGroups: [], 
                boardZoom: 5.0, 
                zoomTimer: null,
showNoiseSettings: false,
showLadderGame: false,
bracketKey: 0,
showClock: true, 
currentTime: '00:00 00', 
            miniTime: '00:00',
currentSeconds: '00',
isClockMaximized: false,
                currentDate: '1ì›” 1ì¼ ì›”ìš”ì¼',
                clockInterval: null,
showLotteryFilter: false,
// ì‹ ê·œ: ë½‘ê¸° ë§ˆìŠ¤í„° ëª¨ë‹¬
        showPickerMaster: false,
        pickerTab: 'lottery',         isPickerMaximized: false,
        pickerX: 100,
        pickerY: 100,
        pickerW: 900,
        pickerH: 700,
        ladderContentMode: 'winner',     
        ladderPeopleMode: 'all',        
        ladderResults: [],
ballHideTimeout: null,
        ladderLines: [],
        revealedResults: [],
        customLadderNames: '',           
        customLadderResults: '',
        ladderMode: 'winner',           
        ladderNameSource: 'all',    
        showLadderSelector: false,
        tempLadderList: [],   
        customLadderNames: '',
        ladderItems: '',    
        ladderStudents: [], 
        ladderLines: [],    
        ladderResults: [],  
        isLadderAnimating: false,
        showLadderResultModal: false, 
        ladderFinalList: [],
            selectedStudents: [], // ì„ íƒëœ í•™ìƒ ë°°ì—´
            isSelectAllStudents: false,
ladderResultX: 400,
ladderResultY: 150,
ladderResultW: 450,
ladderResultH: 600,
ladderSelectionList: [],
        animatedStudent: null,
        animatedPosY: 0,

// [ì‚¬ìš´ë“œ]
                sounds: {
    hover: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
    click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), 
    ding: new Audio('https://assets.mixkit.co/active_storage/sfx/1114/1114-preview.mp3'), 
    warning: new Audio('https://assets.mixkit.co/active_storage/sfx/950/950-preview.mp3'), 
    close: new Audio('https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3'), 
    save: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'), 
    beep: new Audio('https://assets.mixkit.co/active_storage/sfx/216/216-preview.mp3'), 
    
    // [ìˆ˜ì •ë¨] êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë§í¬ë¡œ ë³€ê²½
    whistle: new Audio('./whistle.mp3'), 
   
    // [ìˆ˜ì •ë¨] êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë§í¬ë¡œ ë³€ê²½
    drum: new Audio('./drumroll.mp3'), 
    
    shuffle: new Audio('https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3'), 
    fanfare: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'), 
    
    // [ìˆ˜ì •ë¨] êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë§í¬ë¡œ ë³€ê²½
    fail: new Audio('./game over.mp3'),  
    
    magic: new Audio('https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3'), 
    explode: new Audio('https://assets.mixkit.co/active_storage/sfx/1699/1699-preview.mp3'), 
    firework: new Audio('https://assets.mixkit.co/active_storage/sfx/2021/2021-preview.mp3'), 
    shake_plastic: new Audio('https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3'), 
    pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'),
    tick: new Audio('https://assets.mixkit.co/active_storage/sfx/2585/2585-preview.mp3'),
    tock: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
    jump: new Audio('https://assets.mixkit.co/active_storage/sfx/223/223-preview.mp3'),
    slide: new Audio('https://assets.mixkit.co/active_storage/sfx/127/127-preview.mp3'),
    dice_roll: new Audio('https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3'),
    move: new Audio('https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3'),
    finish: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
    
    // ë°°ê²½ìŒ (ê¸°ì¡´ì— ì˜ ë³€í™˜í•´ë‘ì‹  ê²ƒ ìœ ì§€)
    bgm_rock: new Audio('./Rock race.mp3'),
    bgm_animal: new Audio('./Animal race.mp3')
},

        // ìº¡ìŠ ë½‘ê¸° (ì•„ì§ ë¯¸êµ¬í˜„ - ë‚˜ì¤‘ì— ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ ë¯¸ë¦¬ ì„ ì–¸)
        capsuleCount: 0,
        capsules: [],
        showGenderHint: true,
capsuleRevealedCount: 0,
isShuffling: false,
capsuleSwitchState: 'closed',

        // ì£¼ì‚¬ìœ„ (ë¯¸êµ¬í˜„)
        diceCount: 1,
        diceValues: [],
        diceSum: 0,
isRollingDice: false,
showDiceResultEffect: false,
        // í† ë„ˆë¨¼íŠ¸ (ë¯¸êµ¬í˜„)
pickerTab: 'tournament',
bracketTree: [], 
        roundTitles: ['16ê°•', '8ê°•', '4ê°•', 'ê²°ìŠ¹'],
        bracketSize: 16, // ê¸°ë³¸ 16ê°•
        bracket: [], // ë¼ìš´ë“œë³„ ë§¤ì¹˜ ë°°ì—´ (e.g. [{player1: 'ì´ë¦„', player2: 'ì´ë¦„', winner: null}, ...])
        leftBracket: [], // ì™¼ìª½ ë°˜
        rightBracket: [], // ì˜¤ë¥¸ìª½ ë°˜
        currentRound: 0, // í˜„ì¬ ë¼ìš´ë“œ
        finalWinner: null, // ìµœì¢… ìš°ìŠ¹ì
tournamentRounds: [], // í† ë„ˆë¨¼íŠ¸ ë¼ìš´ë“œ ë°°ì—´ (ê° ë¼ìš´ë“œëŠ” ë§¤ì¹˜ ë°°ì—´)
        participants: [], // ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ (ì´ë¦„ ë°°ì—´)
        isSelectingWinner: false, // ìŠ¹ì ì„ íƒ ëª¨ë“œ í”Œë˜ê·¸
        currentMatch: null,
allTournamentData: [], // ê³„ì‚°ì´ ì™„ë£Œëœ ì „ì²´ ëŒ€ì§„í‘œ ë°ì´í„°
        visiblePlayers: [],    // í™”ë©´ì— ì‹¤ì œë¡œ ë Œë”ë§ë  ë°ì´í„° (í•˜ë‚˜ì”© ì¶”ê°€ë¨)
        isGenerating: false,
visibleBracketTree: [],
fullBracketTree: [],


// ì†ŒìŒ ì¸¡ì •ê¸° ëª¨ë‹¬
        showNoiseMeter: false,
        isNoiseMaximized: false,
        noiseX: 100,
        noiseY: 100,
        noiseW: 400,
        noiseH: 300,
        currentNoiseLevel: 0,  
        noiseHistory: [],      
        noiseAnalyzer: null,   
        noiseStream: null,     
        noiseInterval: null,
lastTriggerType: null,
noiseLevels: {
            safe: 50,     // ì•ˆì „ ~ ì£¼ì˜ ì„ê³„
            caution: 75,  // ì£¼ì˜ ~ ê²½ê³  ì„ê³„
            warning: 100,  // ê²½ê³  ~ íƒˆë½ ì„ê³„
        },
statsWarningCount: 0, // ê²½ê³  íšŸìˆ˜
        statsPenaltyCount: 0, // íƒˆë½ íšŸìˆ˜
        isNoiseCooldown: false, // ì¿¨íƒ€ì„ ì¤‘ì¸ì§€? (ì¤‘ë³µ ë°©ì§€)
        isPenaltyShock: false,
notificationMsg: '', // ì•Œë¦¼ í…ìŠ¤íŠ¸
        notificationType: '', // ì•Œë¦¼ ìƒ‰ìƒ (info, warning, danger)
        notificationTimer: null,
        notificationMsg: '',    // â˜… ì´ê²Œ ìˆì–´ì•¼ ì•Œë¦¼ì´ ëœ¹ë‹ˆë‹¤!
maxDB: 100,
        noiseWarningCount: 3,  // ê²½ê³  ëˆ„ì  ì¹´ìš´íŠ¸
        noisePenaltyCount: 0,  // íƒˆë½ ëˆ„ì  ì¹´ìš´íŠ¸
        maxWarnings: 3,

                isRotated: false, showSettings: false, tempNameList: '', dragInfo: null, draggedOrderIdx: null,
                isRolling: false, 
                
                showRankModal: false, rankSortKey: 'activityScore', rankSortOrder: 'desc', lotteryMode: 'all',
                
                showTimer: false, timerSeconds: 0, timerInterval: null, timerX: null, timerY: null, timerSize: 400, isExploding: false,
                isTimerMaximized: false,
               inputMin: "0", 
                inputSec: "00",
timerTargetTime: 0,
                isStopwatchMode: false,
userSelectedMode: null,
                isMaximized: false,
                isLotteryMaximized: false,
                isRouletteMaximized: false,
                lotteryX: 100,
                lotteryY: 100,
                lotteryW: 500,
                lotteryH: 600, 
                /* ğŸ‡ [ë™ë¬¼ ë ˆì´ìŠ¤ ë°ì´í„°] (Animal) */
                showAnimalRace: false,          
                isAnimalRacing: false,          
                showAnimalRaceCountdown: false, 
                countdownText: '', 
                animalRaceResults: [],          
                animalRaceFinished: false,      
                animalRunners: Array(6).fill().map(() => ({ pos: 0, speed: 0, finished: false, state: 'run', timer: 0 })), 
                groupColors: ['#ff4757', '#ffa502', '#2ed573', '#1e90ff', '#a55eea', '#ff6b81'],
                animalIcons: ['fa-solid fa-cat', 'fa-solid fa-dog', 'fa-solid fa-hippo', 'fa-solid fa-horse', 'fa-solid fa-frog', 'fa-solid fa-dove'],
                
                showBlackboard: false, blackboardContent: '', boardX: 100, boardY: 100, boardW: 600, boardH: 400, showBoardList: false, savedBoards: [],
paletteColors: ['#ffffff', '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#06b6d4', '#3b82f6', '#6366f1', '#a855f7', '#d946ef', '#000000'],                showForeColorPalette: false, showHiliteColorPalette: false,

                /* ìë¦¬ ë°”ê¾¸ê¸° */
                showShuffleModal: false, showShuffleSettings: false, showShuffleHistory: false, shuffleHistory: [],
                seatConfig: Array(30).fill(null), manualLocks: [], currentSeatTool: 'random', 
                isDrawingSeats: false, dragStartIdx: null, separationPairs: [],
                shuffleMode: 'mixed', mixedOrder: 'MF', sameOrder: 'M_First',  
                selectedStudentA: '', selectedStudentB: '', avoidPrevious: true, 
                showStudentSelectModal: false, targetLockSeatIdx: null,
                isShufflingCountdown: false, shuffleCountdownNum: 3,
                showHistoryPreview: false, previewHistoryItem: null,

                rouletteInput: "1\n2\n3\n4\n5\n6", rouletteRotation: 0, isSpinningRoulette: false,
                showRouletteResult: false, rouletteWinner: '',
                rouletteX: 300, rouletteY: 150, rouletteW: 1050, rouletteH: 750, showRouletteList: false, savedRoulettes: [],

                /* ëª¨ë‘  í¸ì„± */
showGroupMakerModal: false, tempGroupCount: 6, 
groupingMode: 'mixed', // tempGenderBalance ì‚­ì œí•˜ê³  ëª¨ë“œ ë³€ìˆ˜ ì¶”ê°€
savedGroupings: [],     // ì €ì¥ëœ ëª¨ë‘  ëª©ë¡
showGroupingHistory: false, // ì €ì¥ ëª©ë¡ ì°½ í‘œì‹œ ì—¬ë¶€
                /* ğŸª¨ [ëŒ ë ˆì´ìŠ¤ ë°ì´í„°] (Rock) */
                showRockRace: false,
                showRaceSetup: true,
                isGameRunning: false,
                showRaceCountdown: false,
                countdownNum: 3,
                showRaceResult: false,
                participantList: [],
                isSelectAll: true,
                rockRunners: [],
                obstacles: [],
                cameraX: 0,
                finalRanking: [],
                canvas: null,
                ctx: null,
                animationId: null,
                finishLineX: 4500, 
                startTime: 0,
                timeScale: 1.0,             
                slowMoTimer: 0,            
                firstWinner: null,
setupW: 1600, setupH: 950,
                activeSkillNames: new Set(), 
mysteryBoxes: [],      
                projectiles: [],        
                flashTimer: 0,  
soundSettings: {
    ui: true,   // ë²„íŠ¼ìŒ (í‹±, ë½, ë ë§ ë“±)
    game: true  // í™œë™ìŒ (BGM, íŒ¡íŒŒë ˆ, ë“œëŸ¼ ë“±)
},        
            }
        },
computed: {

ladderDynamicStyle() {
    const count = this.ladderStudents.length;
    
    // 1. ì¸ì›ìˆ˜ê°€ ì ì„ ë•Œ (10ëª… ì´í•˜) - í¼ì§í•˜ê²Œ
    if (count <= 10) {
        return { 
            fontSize: '1.6rem', 
            padding: '12px 8px', 
            height: 'auto',
            minHeight: '60px' 
        };
    } 
    // 2. ì¤‘ê°„ ì •ë„ (11 ~ 20ëª…) - ì•½ê°„ ì¶•ì†Œ
    else if (count <= 20) {
        return { 
            fontSize: '1.1rem', 
            padding: '8px 2px', 
            height: '50px',
            minHeight: '50px' 
        };
    } 
    // 3. ë§ì„ ë•Œ (21ëª… ì´ìƒ) - ë¯¸ë‹ˆ ëª¨ë“œ
    else {
        return { 
            fontSize: '0.8rem', // ê¸€ì”¨ ì‘ê²Œ
            padding: '4px 0px', // íŒ¨ë”© ìµœì†Œí™”
            height: '40px',     // ë†’ì´ ì¶•ì†Œ
            minHeight: '40px',
            letterSpacing: '-0.5px' // ìê°„ ì¢í˜
        };
    }
},

isAllLadderSelected() {
        return this.allStudents.length > 0 && this.ladderSelectionList.length === this.allStudents.length;
    },
eliminatedPlayers() {
    const eliminated = new Set();
    // ë¶€ì „ìŠ¹ì€ ë¬´ì¡°ê±´ íŒ¨ë°°(íšŒìƒ‰) ì²˜ë¦¬
    eliminated.add('ë¶€ì „ìŠ¹');

    // ëª¨ë“  ë¼ìš´ë“œë¥¼ ëŒë©° íŒ¨ì í™•ì¸
    if (this.bracketTree && this.bracketTree.length > 0) {
        this.bracketTree.forEach(round => {
            round.forEach(match => {
                if (match.winner) {
                    // ìŠ¹ìê°€ ê²°ì •ëœ ê²½ê¸°ì—ì„œ
                    // ìŠ¹ìê°€ ì•„ë‹Œ ìª½ì€ íƒˆë½ì ëª…ë‹¨ì— ì¶”ê°€
                    if (match.player1 && match.player1 !== match.winner) eliminated.add(match.player1);
                    if (match.player2 && match.player2 !== match.winner) eliminated.add(match.player2);
                }
            });
        });
    }
    return eliminated;
},

layoutStyle() {
    // 1. ë°°ìœ¨(Scale) ì„¤ì •
    let scale = 1.0; 
    let gapBase = 10; // ê¸°ë³¸ ê°„ê²©

    if (this.bracketMode === 'group8') { 
        scale = 1.5;   // 8ê°•: 150% í™•ëŒ€
        gapBase = 30;  // ê°„ê²© ë„“ê²Œ
    } 
    else if (this.bracketMode.includes('16')) { 
        scale = 1.25;  // 16ê°•: 125% í™•ëŒ€
        gapBase = 15;
    } 
    else { 
        scale = 0.85;  // 32ê°•: 85% ì¶•ì†Œ (í™”ë©´ ê½‰ ì°¨ê²Œ)
        gapBase = 5;   // ê°„ê²© ì¢ê²Œ
    }

    // 2. ê¸°ì¤€ ì‚¬ì´ì¦ˆ (ì—¬ê¸°ì„œ ê¸°ë³¸ í¬ê¸°ë¥¼ ì¡ìŠµë‹ˆë‹¤)
    const baseWidth = 130;  // ì´ë¦„í‘œ ë„ˆë¹„
    const baseHeight = 45;  // ì´ë¦„í‘œ ë†’ì´
    const baseFont = 1.0;   // í°íŠ¸ í¬ê¸° (rem)
    const baseLine = 30;    // ì—°ê²°ì„  ê¸¸ì´

    // 3. ì‹¤ì œ ì ìš©ë  CSS ë³€ìˆ˜ ê³„ì‚° (ê¸°ì¤€ * ë°°ìœ¨)
    return {
        '--card-w': `${baseWidth * scale}px`,
        '--card-h': `${baseHeight * scale}px`,
        '--font-s': `${baseFont * scale}rem`,
        '--gap-s': `${gapBase * scale}px`,
        '--line-w': `${baseLine * scale}px`
    };
},
// 1. ì™¼ìª½ ëŒ€ì§„í‘œ ë°ì´í„° (ë¯¸ë¦¬ ê³„ì‚°í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”)
leftSideBracket() {
    if (!this.visibleBracketTree || !this.visibleBracketTree.length) return [];
    return this.visibleBracketTree.slice(0, this.visibleBracketTree.length - 1).map(roundMatches => {
        const half = Math.ceil(roundMatches.length / 2);
        const targetMatches = roundMatches.slice(0, half);
        return targetMatches.map(m => {
            const originalIndex = roundMatches.indexOf(m);
            return [{ ...m, originalIndex }];
        });
    });
},

// 2. ì˜¤ë¥¸ìª½ ëŒ€ì§„í‘œ ë°ì´í„°
rightSideBracket() {
    if (!this.visibleBracketTree || !this.visibleBracketTree.length) return [];
    return this.visibleBracketTree.slice(0, this.visibleBracketTree.length - 1).map(roundMatches => {
        const half = Math.ceil(roundMatches.length / 2);
        const targetMatches = roundMatches.slice(half);
        return targetMatches.map(m => {
            const originalIndex = roundMatches.indexOf(m);
            return [{ ...m, originalIndex }];
        });
    });
},

displayDiceValues() {
        if (this.diceValues.length === 0) {
            // diceValuesê°€ ë¹„ì—ˆì„ ë•Œ diceCountë§Œí¼ ?(0) í‘œì‹œ
            return Array(this.diceCount).fill(0);
        }
        return this.diceValues;
    },

ladderStudentNames() {
        return this.allStudents.map(s => s.name);},

currentLotteryPool() {
        return this.lotteryPools[this.lotteryMode] || [];
    },

    remainingCount() {
        // lotteryPoolsë‚˜ í˜„ì¬ ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0 ë°˜í™˜
        if (!this.lotteryPools || !this.lotteryPools[this.lotteryMode]) {
            return 0;
        }
        return this.lotteryPools[this.lotteryMode].length;
    },


    filteredStudents() {
        if (this.lotteryMode === 'all') return this.allStudents;
        return this.allStudents.filter(s => s.gender === this.lotteryMode);
  
},
  

  allStudents() { return [...this.seats.filter(s => s), ...this.waitingRoom]; },
            sortedAllStudents() { return [...this.allStudents].sort((a,b) => b.activityScore - a.activityScore); },
            sortedStudentsByName() { return [...this.allStudents].sort((a, b) => a.name.localeCompare(b.name)); },
            topStudents() { return this.sortedAllStudents.slice(0, 5); },
            sortedOrderedStudents() { return this.allStudents.filter(s => s.order).sort((a,b) => a.order - b.order); },
            sortedRankStudents() {
                return [...this.allStudents].sort((a, b) => {
                    let modifier = this.rankSortOrder === 'asc' ? 1 : -1;
                    if(this.rankSortKey === 'activityScore') return (a.activityScore - b.activityScore) * modifier;
                    else if(this.rankSortKey === 'name') return a.name.localeCompare(b.name) * modifier;
                    else if(this.rankSortKey === 'number') {
                        const numA = (a.number !== null && a.number !== undefined) ? a.number : (modifier === 1 ? 999999 : -999999);
                        const numB = (b.number !== null && b.number !== undefined) ? b.number : (modifier === 1 ? 999999 : -999999);
                        return (numA - numB) * modifier;
                    }
                    else if(this.rankSortKey === 'gender') return (a.gender || 'U').localeCompare(b.gender || 'U') * modifier;
                    else if(this.rankSortKey === 'checked') return ((a.checked?1:0) - (b.checked?1:0)) * modifier;
                    else if(this.rankSortKey === 'memo') return (((a.memo&&a.memo.trim().length>0)?1:0) - ((b.memo&&b.memo.trim().length>0)?1:0)) * modifier;
                    return 0;
                });
            },
            allMode: { get() { return this.view === 'group' ? this.allModeGroup : this.allModeMain; }, set(val) { if(this.view === 'group') this.allModeGroup = val; else this.allModeMain = val; } },
            rouletteItems() { return this.rouletteInput.split('\n').filter(item => item.trim() !== ''); },
            rouletteBackground() {
                const items = this.rouletteItems; 
    if (items.length === 0) return '#e2e8f0';
    
    // [ìˆ˜ì •] paletteColorsì—ì„œ ì²« ë²ˆì§¸ ìƒ‰ìƒ(í°ìƒ‰)ì„ ì œì™¸í•˜ê³  ì‚¬ìš©í•©ë‹ˆë‹¤.
    const colors = this.paletteColors.slice(1, -1); 
    let gradient = 'conic-gradient(';
    const step = 100 / items.length;
    
    items.forEach((_, i) => { 
        const color = colors[i % colors.length]; 
        gradient += `${color} ${step * i}%, ${color} ${step * (i + 1)}%${i === items.length - 1 ? '' : ','} `; 
    });
    
    gradient += ')'; 
    return gradient;
},
            selectedCount() { return this.participantList.filter(p => p.selected).length; },
            liveRanking() { return this.rockRunners.filter(r => r.finished).sort((a, b) => a.finishRank - b.finishRank); },
            remainingDistance() {
                if (this.rockRunners.length === 0) return this.finishLineX / 10;
                const activeRunners = this.rockRunners.filter(r => !r.finished);
                const leaderX = activeRunners.length > 0 ? Math.max(...activeRunners.map(r => r.x)) : this.finishLineX;
                return Math.max(0, Math.floor((this.finishLineX - leaderX) / 10)); 
            }
        },

        watch: {

'soundSettings.game'(val) {
    if (!val) {
        // ê²Œì„ ì†Œë¦¬ë¥¼ ë„ë©´, ë£¨í”„ ëŒê³  ìˆëŠ” ê¸´ ì†Œë¦¬ë“¤ì€ ì¦‰ì‹œ ì •ì§€
        this.stopSound('bgm_race');
        this.stopSound('drum');
    }
},

showTimer(val) {
        if (val) {
            // ì°½ì´ ì¼œì§ˆ ë•Œ ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ì¤‘ì•™ìœ¼ë¡œ
            if (!this.timerX || isNaN(this.timerX)) this.timerX = 200;
            if (!this.timerY || isNaN(this.timerY)) this.timerY = 200;
            this.focusWindow('timer');
        }
    },
    showNoiseMeter(val) {
        if (val) {
            if (!this.noiseX || isNaN(this.noiseX)) this.noiseX = 100;
            if (!this.noiseY || isNaN(this.noiseY)) this.noiseY = 100;
            this.focusWindow('noise');
        }
    },
            // 1. ëª¨ë“œ ë³€ê²½ ê°ì§€
    lotteryMode(newMode) {
        if (!this.lotteryPools[newMode] || this.lotteryPools[newMode].length === 0) {
            if (this.allStudents.length > 0) this.initializeLotteryPool(newMode);
        }
        this.displayWinner = this.lastWinners[newMode] || '?';
    },

    // 2. íƒ­ ë³€ê²½ ê°ì§€
    pickerTab(newTab) {
        if (newTab === 'ladder') this.$nextTick(this.resizeLadderCanvas);
        if (newTab === 'lottery') {
            this.displayWinner = this.lastWinners[this.lotteryMode] || '?';
        }
    },

    // 3. ì†ŒìŒ ì¸¡ì •ê¸° ê°ì§€
    showNoiseMeter(val) {
        if (!val) this.stopNoiseMeasurement();
    },

    // 4. ì¹ íŒ ê°ì§€
    showBlackboard(val) {
        if (val) this.$nextTick(() => {
            const editor = document.getElementById('board-editor');
            if (editor) editor.innerHTML = this.blackboardContent;
        });
    },


// [â˜…ì¶”ê°€â˜…] ëª¨ë“œê°€ ë°”ë€” ë•Œë§ˆë‹¤ í™”ë©´ ê°±ì‹  ë° ë°ì´í„° ì²´í¬
    lotteryMode(newMode) {
                // ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™”
                if (!this.lotteryPools[newMode] || this.lotteryPools[newMode].length === 0) {
                     if(this.allStudents.length > 0) this.initializeLotteryPool(newMode);
                }
                // í™”ë©´ í‘œì‹œ ê°±ì‹ 
                this.displayWinner = this.lastWinners[newMode] || '?';
            },

    // [â˜…ì¶”ê°€â˜…] íƒ­ì´ ë°”ë€” ë•Œë„ í™”ë©´ ê°±ì‹ 
   pickerTab(newTab) {
                if (newTab === 'ladder') this.$nextTick(this.resizeLadderCanvas);
                // íƒ­ ì „í™˜ ì‹œì—ë„ ì£¼ì¸ê³µ ì¶”ì²¨ í™”ë©´ ê°±ì‹ 
                if (newTab === 'lottery') {
                    this.displayWinner = this.lastWinners[this.lotteryMode] || '?';
                }
            },

lotteryMode(newMode) {
        // [ê¸°ì¡´ ë¡œì§] ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        if (!this.lotteryPools[newMode]) {
            this.initializeLotteryPool(newMode);
        }

        // [â˜…ì¶”ê°€ëœ ë¡œì§] ëª¨ë“œ ë³€ê²½ ì‹œ, í•´ë‹¹ ëª¨ë“œì˜ 'ë§ˆì§€ë§‰ ë‹¹ì²¨ì'ë¥¼ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ
        // ê¸°ë¡ì´ ìˆìœ¼ë©´ ê·¸ ì´ë¦„ì„, ì—†ìœ¼ë©´ ë¬¼ìŒí‘œ(?)ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        this.displayWinner = this.lastWinners[newMode] || '?';
    },

showNoiseMeter(val) {
                if (!val) this.stopNoiseMeasurement();
            },
pickerTab(newTab) {
                if (newTab === 'ladder') this.$nextTick(this.resizeLadderCanvas);
            },
            lotteryMode(newMode) {
                // í•´ë‹¹ ëª¨ë“œì˜ í’€ì´ ì•„ì§ í•œ ë²ˆë„ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ â†’ ì´ˆê¸°í™”
                if (!this.lotteryPools[newMode] || this.lotteryPools[newMode].length === 0) {
                    this.initializeLotteryPool(newMode);
                }
            },
            showBlackboard(val) { 
                if (val) this.$nextTick(() => { 
                    const editor = document.getElementById('board-editor'); 
                    if (editor) editor.innerHTML = this.blackboardContent; 
                }); 
            }
        },



           methods: {

// 1. ì¹´ë“œë¥¼ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ (ì¢Œì„ë°°ì¹˜ë„ & ëŒ€ê¸°í™”ë©´ìš©)
handleCardClick(idx) { 
    const s = this.seats[idx]; 
    if(!s) return; 

    // [1] ëŒ€ê¸° ë²ˆí˜¸(Order) ëª¨ë“œì¼ ë•Œ
    if(this.view === 'order') { 
        if(!s.order) {
            // ë²ˆí˜¸ ë¶€ì—¬ (ì„ íƒ)
            const maxOrder = Math.max(0, ...this.allStudents.map(x => x.order || 0));
            s.order = maxOrder + 1;
            this.playSound('ding', false, 0.5); // [ì†Œë¦¬ ì¶”ê°€] ë ë§~
        } else {
            // ë²ˆí˜¸ í•´ì œ (ì·¨ì†Œ/ì™„ë£Œ)
            s.order = null; 
            this.playSound('ding', false, 0.5); // [ì†Œë¦¬ ì¶”ê°€] ë ë§~
        }
    } 
    // [2] ì¢Œì„ ë°°ì¹˜ë„(Main) ëª¨ë“œì¼ ë•Œ -> ë„êµ¬ ì ìš©
    else {
        this.applyTool(s, false); 
    }
    
    this.saveToLocal(); 
},
applyTool(t, fromAll = false) {
    const key = t.hasOwnProperty('score') ? 'score' : 'activityScore';
    
    // [ì²´í¬ ëª¨ë“œ]
    if (this.activeTool === 'check') {
        if(!fromAll) t.checked = !t.checked;
        this.playSound('ding', false, 0.5); // [ì†Œë¦¬ ì¶”ê°€] ë ë§~
    } 
    // [ì ìˆ˜ ì˜¬ë¦¬ê¸° (+)]
    else if (this.activeTool === 'plus') {
        t[key]++;
        this.playSound('ding', false, 0.5); // ë ë§~
    } 
    // [ì ìˆ˜ ë‚´ë¦¬ê¸° (-)]
    else if (this.activeTool === 'minus') {
        t[key]--;
        this.playSound('warning', false, 0.4); // ì‚‘!
    }
},
resetLadderSettings() {
        this.showLadderGame = false; // ê²Œì„ í™”ë©´ ë‹«ê¸° (ì„¤ì • í™”ë©´ ë³´ì´ê¸°)
        
        // 1. ëª¨ë“œ ì´ˆê¸°í™” (ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µê·€)
        this.ladderPeopleMode = 'select';  // ì°¸ê°€ì ì„¤ì • -> ì„ íƒ
        this.ladderContentMode = 'winner'; // ê²°ê³¼ ì„¤ì • -> ë‹¹ì²¨

        // 2. ë°ì´í„° ì´ˆê¸°í™” (ì‚¬ìš©ì ìš”ì²­ ì‚¬í•­)
        this.ladderSelectionList = []; // ì„ íƒëœ í•™ìƒ ëª…ë‹¨ ë¹„ìš°ê¸° (ì²´í¬ë°•ìŠ¤ í•´ì œ)
        this.customLadderNames = '';   // ì°¸ê°€ì 'ì§ì ‘' ì…ë ¥ì°½ ë¹„ìš°ê¸°
        this.customLadderResults = ''; // ê²°ê³¼ 'ì§ì ‘' ì…ë ¥ì°½ ë¹„ìš°ê¸°

        // 3. ì¹´ìš´í„° ì´ˆê¸°í™” (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ¬ì›€)
        this.winnerCount = 1;
        this.penaltyCount = 1;
    },

// í™”ë©´ íšŒì „ í† ê¸€ ë° ì¦‰ì‹œ ì €ì¥
    toggleRotation() {
        this.isRotated = !this.isRotated;
        this.saveToLocal(); // ì„œë²„ì— í˜„ì¬ íšŒì „ ìƒíƒœ ì €ì¥
    },

// [ì‹ ê·œ] ì†ŒìŒ ì„¤ì • ì €ì¥ í•¨ìˆ˜
    saveNoiseSettings() {
    const safe = parseInt(this.noiseLevels.safe);
    const caution = parseInt(this.noiseLevels.caution);
    const warning = parseInt(this.noiseLevels.warning);

    // 1. ìˆ«ì í™•ì¸
    if (isNaN(safe) || isNaN(caution) || isNaN(warning)) {
        return alert("ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }

    // 2. ìˆœì„œ í™•ì¸ (ì£¼ì˜ < ê²½ê³  < íƒˆë½)
    if (!(safe < caution && caution < warning)) {
        return alert("ì„¤ì • ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ì£¼ì˜ < ê²½ê³  < íƒˆë½ ìˆœì„œì—¬ì•¼ í•©ë‹ˆë‹¤)");
    }

    // ê°’ ì €ì¥
    this.noiseLevels.safe = safe;
    this.noiseLevels.caution = caution;
    this.noiseLevels.warning = warning;
    
    // â˜… í•µì‹¬: ì°½ ë‹«ê¸°
    this.showNoiseSettings = false; 
    this.saveToLocal();
    
    // ê·¸ë˜í”„ ì¦‰ì‹œ ê°±ì‹ 
    this.$nextTick(() => this.drawNoiseGraph());
},

adjustBracketPositions() {
        this.$nextTick(() => { 
            const matchBoxes = document.querySelectorAll('.match-box');
            matchBoxes.forEach(box => {
                const parentPair = box.closest('.match-pair');
                if (parentPair) parentPair.style.marginTop = '-5px';
            });
            const bracketLines = document.querySelectorAll('.bracket-line');
            bracketLines.forEach(line => {
                const pairHeight = line.parentElement.offsetHeight;
                line.style.height = `calc(${pairHeight}px - 75px)`;
            });
        });
    },

declareWinner(winner, matchIdx) {
    this.bracket[upperRound][upperMatchIdx] = winner; 
    this.adjustBracketPositions();
},

// 1. ì†Œë¦¬ ì¬ìƒ (ë£¨í”„ ê¸°ëŠ¥ ì¶”ê°€)
playSound(key, loop = false, volume = 0.5) {
    if (!this.sounds[key]) return;

    // [ì‹ ê·œ] ì†Œë¦¬ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
    const uiSounds = ['hover', 'click', 'close', 'save', 'warning', 'check'];
    const isUi = uiSounds.includes(key);

    // [ì‹ ê·œ] ì„¤ì • ì²´í¬: êº¼ì ¸ ìˆìœ¼ë©´ ì¬ìƒ ì•ˆ í•¨
    if (isUi && !this.soundSettings.ui) return;     // UIìŒ Offë©´ ì¤‘ë‹¨
    if (!isUi && !this.soundSettings.game) return;  // ê²Œì„ìŒ Offë©´ ì¤‘ë‹¨

    // --- ê¸°ì¡´ ì¬ìƒ ë¡œì§ ---
    const audio = this.sounds[key];
    if (!loop && !audio.paused) {
        audio.currentTime = 0;
    }
    audio.loop = loop;
    audio.volume = volume;
    audio.play().catch(() => {});
},
stopSound(key) {
        if (!this.sounds[key]) return;
        const audio = this.sounds[key];
        audio.pause();
        audio.currentTime = 0;
        audio.loop = false;
    },

// 1. ì‚¬ë‹¤ë¦¬ ê²°ê³¼ì°½ ë“œë˜ê·¸
startLadderResultDrag(e) {
    if (e.target.closest('button')) return;
    
    const startX = e.clientX;
    const startY = e.clientY;
    const initialX = this.ladderResultX;
    const initialY = this.ladderResultY;

    const mv = (ev) => {
        ev.preventDefault();
        const deltaX = ev.clientX - startX;
        const deltaY = ev.clientY - startY;

        let nextX = initialX + deltaX;
        let nextY = initialY + deltaY;

        // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
        const maxX = window.innerWidth - this.ladderResultW;
        const maxY = window.innerHeight - this.ladderResultH;

        this.ladderResultX = Math.max(0, Math.min(nextX, maxX));
        this.ladderResultY = Math.max(0, Math.min(nextY, maxY));
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };

    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},

// 2. ì‚¬ë‹¤ë¦¬ ê²°ê³¼ì°½ í¬ê¸° ì¡°ì ˆ
startLadderResultResize(e) {
    e.preventDefault();
    const startX = e.clientX;
    const startY = e.clientY;
    const startW = this.ladderResultW;
    const startH = this.ladderResultH;

    const mv = (ev) => {
        ev.preventDefault();
        const deltaX = ev.clientX - startX;
        const deltaY = ev.clientY - startY;

        let newW = Math.max(350, startW + deltaX); // ìµœì†Œ ë„ˆë¹„ 350
        let newH = Math.max(400, startH + deltaY); // ìµœì†Œ ë†’ì´ 400

        // â˜… í•µì‹¬ ìˆ˜ì •: ì œí•œì„ window(í™”ë©´) í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
        if (this.ladderResultX + newW > window.innerWidth) {
            newW = window.innerWidth - this.ladderResultX;
        }
        if (this.ladderResultY + newH > window.innerHeight) {
            newH = window.innerHeight - this.ladderResultY;
        }

        this.ladderResultW = newW;
        this.ladderResultH = newH;
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };

    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},
// [â˜…ì‹ ê·œ ì¶”ê°€] ëª¨ë“œ ë³€ê²½ ë° í™”ë©´ ê°•ì œ ê°±ì‹  í•¨ìˆ˜
    changeLotteryMode(mode) {
        // 1. ëª¨ë“œ ë³€ê²½ ë° ë©”ë‰´ ë‹«ê¸°
        this.lotteryMode = mode;
        this.showLotteryFilter = false;

        // 2. í•´ë‹¹ ëª¨ë“œ ë°ì´í„°ê°€ ë¹„ì–´ìˆë‹¤ë©´ ìë™ ë¦¬í•„ (ì•ˆì „ì¥ì¹˜)
        if (!this.lotteryPools[mode] || this.lotteryPools[mode].length === 0) {
            if (this.allStudents.length > 0) {
                this.initializeLotteryPool(mode);
            }
        }

        // 3. [í•µì‹¬] ì¤‘ì•™ ì´ë¦„í‘œë¥¼ í•´ë‹¹ ëª¨ë“œì˜ 'ë§ˆì§€ë§‰ ë‹¹ì²¨ì'ë¡œ ì¦‰ì‹œ êµì²´
        const lastWinner = this.lastWinners[mode];
        this.displayWinner = lastWinner ? lastWinner : '?';
    },
toggleAllLadder() {
        if (this.isAllLadderSelected) {
            this.ladderSelectionList = []; // ì „ì²´ í•´ì œ
        } else {
            this.ladderSelectionList = this.allStudents.map(s => s.name); // ì „ì²´ ì„ íƒ
        }
    },

// [ìˆ˜ì •] í•˜ë‹¨ ì—¬ë°± ì œê±°ë¥¼ ìœ„í•œ ë†’ì´ ê³„ì‚° ë³´ì •
getScale(baseW, baseH) {
    // í˜„ì¬ ì°½ ë˜ëŠ” ì „ì²´ í™”ë©´ì˜ ë„ˆë¹„ì™€ ë†’ì´ ê°€ì ¸ì˜¤ê¸°
    const w = this.isPickerMaximized ? this.winW : this.pickerW;
    const h = this.isPickerMaximized ? this.winH : this.pickerH;

    // [ìˆ˜ì •] ìƒë‹¨ ë©”ë‰´ë°” + í•˜ë‹¨ íˆ´ë°” + ìƒí•˜ ì•ˆì „ ì—¬ë°±ì„ í¬í•¨í•˜ì—¬ 340pxì„ ì œì™¸í•©ë‹ˆë‹¤.
    // ê¸°ì¡´ 260pxì—ì„œ 340pxë¡œ ëŠ˜ë ¤ ì´ë¦„í‘œê°€ ë©”ë‰´ë°” ì•„ë˜ë¡œ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
    const availableH = h - 340; 
    const availableW = w - 40; // ì¢Œìš° ì—¬ë°± 40px ì œì™¸

    const scaleW = availableW / baseW;
    const scaleH = availableH / baseH;
    
    // ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™”ë©´ì— ê½‰ ì°¨ê²Œ ì¡°ì ˆ (0.95ëŠ” ìµœì¢… ì•ˆì „ ê³„ìˆ˜)
    return Math.min(scaleW, scaleH) * 0.95;
},
resetLottery() {
        const modeMap = {'all':'ì „ì²´', 'M':'ë‚¨í•™ìƒ', 'F':'ì—¬í•™ìƒ'};
        const modeName = modeMap[this.lotteryMode];
        
        if(confirm(`[${modeName}] ëª…ë‹¨ì„ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?\n(ì´ë¯¸ ë½‘íŒ í•™ìƒë“¤ë„ ë‹¤ì‹œ í¬í•¨ë©ë‹ˆë‹¤)`)) {
            this.initializeLotteryPool(this.lotteryMode);
        }
    },
async startCountdown() {
        this.isAnimating = true;
        
        const texts = ['3', '2', '1', 'GO!'];
        
        for (const text of texts) {
            this.countText = text;
            await new Promise(resolve => setTimeout(resolve, 800)); // 0.8ì´ˆ ê°„ê²©
        }
        
        // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
        this.isAnimating = false;
        
        // â˜… ì¤‘ìš”: ì—¬ê¸°ì— ì‹¤ì œ ìë¦¬ ë°°ì¹˜/ëª¨ë‘  í¸ì„± ë¡œì§ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”!
        // ì˜ˆ: this.shuffleSeats(); ë˜ëŠ” this.createGroups();
        this.shuffleSeats(); 
    },
getPlayerStatusClass(playerName) {
    if (!playerName) return ''; // ì´ë¦„ ì—†ìœ¼ë©´ ê¸°ë³¸
    // íƒˆë½ì ëª…ë‹¨ì— ìˆìœ¼ë©´ 'eliminated' í´ë˜ìŠ¤ ë°˜í™˜ (íšŒìƒ‰ ì²˜ë¦¬)
    if (this.eliminatedPlayers.has(playerName)) {
        return 'eliminated';
    }
    // ì•„ë‹ˆë©´ ê¸°ë³¸(í™©ê¸ˆìƒ‰) ìœ ì§€
    return '';
},

// [ì‹ ê·œ] ë¼ìš´ë“œë³„ ê°„ê²© ê³„ì‚° í•¨ìˆ˜
getPairStyle(roundIdx) {
    const growVal = Math.pow(2, roundIdx);
    return {
        flexGrow: growVal,
        flexBasis: 0,
        display: 'flex',
        flexDirection: 'column',
        // 1ë¼ìš´ë“œë„ space-aroundë¡œ í†µì¼í•´ì•¼ ë¹„ìœ¨ ê³„ì‚°ì´ ì‰¬ì›€
        // ë‹¨, 1ë¼ìš´ë“œëŠ” ë„ˆë¬´ ë²Œì–´ì§€ë©´ ì•ˆ ë˜ë¯€ë¡œ paddingìœ¼ë¡œ ì¡°ì ˆí•˜ê±°ë‚˜ gap ì‚¬ìš©
        justifyContent: 'space-around', 
    };
},
// 4. [ì‹ ê·œ] ê°€ì§€ì„  ìŠ¤íƒ€ì¼ (ìë™ ì •ë ¬ìš©)
getLineStyle(roundIdx) {
    // 1ë¼ìš´ë“œ(0)ëŠ” ì´ë¦„í‘œë¼ë¦¬ ê°€ê¹Œìš°ë¯€ë¡œ ê³ ì •ëœ ì‘ì€ ì„  ì‚¬ìš©
    if (roundIdx === 0) {
        return { height: '50px' }; // í˜¹ì€ calc(100% - 40px) ë“±
    }
    // 2ë¼ìš´ë“œ ì´ìƒì€ space-around ë¹„ìœ¨(25%~75%)ì— ë§ì¶° ìë™ ì •ë ¬
    return { 
        top: '25%', 
        bottom: '25%', 
        height: 'auto', 
        transform: 'none' 
    };
},
// [ì‹ ê·œ] ì†ŒìŒ ìˆ˜ì¹˜ì— ë”°ë¥¸ ë°” ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
// [1] ì†ŒìŒ ë°”(Bar) ìƒ‰ìƒ ë°˜í™˜ (4ë‹¨ê³„ ì ìš©)
getNoiseBarColorClass() {
    const safe = this.noiseLevels?.safe || 60;
    const caution = this.noiseLevels?.caution || 80;
    const warning = this.noiseLevels?.warning || 100;

    if (this.currentNoiseLevel < safe) {
        return 'bg-gradient-to-r from-cyan-400 to-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.6)]';
    } else if (this.currentNoiseLevel < caution) {
        return 'bg-gradient-to-r from-emerald-400 to-green-500 shadow-[0_0_15px_rgba(16,185,129,0.6)]';
    } else if (this.currentNoiseLevel < warning) {
        return 'bg-gradient-to-r from-orange-400 to-orange-600 shadow-[0_0_15px_rgba(249,115,22,0.6)]';
    } else {
        return 'bg-gradient-to-r from-red-500 to-rose-700 shadow-[0_0_20px_rgba(239,68,68,0.8)]';
    }
},
// [2] í˜„ì¬ ë‹¨ê³„ ì´ë¦„ ë°˜í™˜ (4ë‹¨ê³„ ì ìš©)
getNoiseStage(level) {
    if (level < this.noiseLevels.safe) return 'ì•ˆì „'; // íŒŒë‘
    if (level < this.noiseLevels.caution) return 'ì£¼ì˜'; // ì´ˆë¡
    if (level < this.noiseLevels.warning) return 'ê²½ê³ '; // ë…¸ë‘
    return 'íƒˆë½'; // ë¹¨ê°•
},

// [3] í…ìŠ¤íŠ¸/ë°°ì§€ ìƒ‰ìƒ ë°˜í™˜ (4ë‹¨ê³„ ì ìš©)
getNoiseClass(level, type = 'text') {
    const prefix = type === 'bg' ? 'bg-' : 'text-';
    
    // 1ë‹¨ê³„: ì•ˆì „ (Safe) -> íŒŒë€ìƒ‰ (Blue)
    if (level < this.noiseLevels.safe) return prefix + 'blue-500';
    
    // 2ë‹¨ê³„: ì£¼ì˜ (Caution) -> ì´ˆë¡ìƒ‰ (Green)
    if (level < this.noiseLevels.caution) return prefix + 'green-500';
    
    // 3ë‹¨ê³„: ê²½ê³  (Warning) -> ì£¼í™©ìƒ‰ (Orange)
    if (level < this.noiseLevels.warning) return prefix + 'orange-500';
    
    // 4ë‹¨ê³„: íƒˆë½ (Penalty) -> ë¹¨ê°„ìƒ‰ (Red)
    return prefix + 'red-600';
},


// [ì¶”ê°€] ì‚¬ë‹¤ë¦¬ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
    openLadderSelector() {
        // 'ì„ íƒ' ëª¨ë“œë¡œ ì„¤ì •
        this.ladderPeopleMode = 'select';
        
        // ì„ì‹œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (í˜„ì¬ ì„ íƒëœ ëª©ë¡ or ì „ì²´)
        // ë§Œì•½ ì„ íƒëœ ì‚¬ëŒì´ ì—†ìœ¼ë©´(ì´ˆê¸° ìƒíƒœ) ì „ì²´ ì„ íƒ ìƒíƒœë¡œ ì‹œì‘
        if (this.ladderStudents.length === 0) {
            this.tempLadderList = this.allStudents.map(s => s.name);
        } else {
            this.tempLadderList = [...this.ladderStudents];
        }
        
        this.showLadderSelector = true;
    },

    // [ì¶”ê°€] ëª¨ë‹¬ ë‹«ê¸°
    closeLadderSelector() {
        this.showLadderSelector = false;
        // ì„ íƒì„ í™•ì •í•˜ì§€ ì•Šê³  ë‹«ì•˜ì„ ë•Œ, ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆë‹¤ë©´ 'all' ëª¨ë“œë¡œ ëŒë¦´ ìˆ˜ë„ ìˆìŒ (ì„ íƒ ì‚¬í•­)
    },

    // [ì¶”ê°€] ê°œë³„ í•™ìƒ í† ê¸€
    toggleLadderStudent(name) {
        if (this.ladderSelectionList.includes(name)) {
            this.ladderSelectionList = this.ladderSelectionList.filter(n => n !== name);
        } else {
            this.ladderSelectionList.push(name);
        }
    },

    // [ì¶”ê°€] ì „ì²´ ì„ íƒ í† ê¸€
    toggleAllLadderStudents() {
        if (this.isAllLadderSelected) {
            this.tempLadderList = []; // ì „ì²´ í•´ì œ
        } else {
            this.tempLadderList = this.allStudents.map(s => s.name); // ì „ì²´ ì„ íƒ
        }
    },

    // [ì¶”ê°€] ì„ íƒ í™•ì •
    confirmLadderSelection() {
        this.ladderStudents = [...this.tempLadderList];
        this.showLadderSelector = false;
    },

// [ìˆ˜ì •] ìë¦¬ ë°”ê¾¸ê¸° ì‹œì‘ í•¨ìˆ˜ (ì¹´ìš´íŠ¸ë‹¤ìš´ ë³µêµ¬)
startShuffle() {
    // 1. ì´ë¯¸ ëŒê³  ìˆìœ¼ë©´ ì¤‘ë‹¨
    if (this.isShuffling) return;
    
    // 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    this.showCountdown = true;
    this.countDownValue = 3;
    
    // íš¨ê³¼ìŒ (ì„ íƒì‚¬í•­)
    // this.playAudio('countdown'); 

    // 3. 1ì´ˆë§ˆë‹¤ ìˆ«ì ê°ì†Œ
    const timer = setInterval(() => {
        this.countDownValue--;
        
        if (this.countDownValue < 0) { // 0 ë‹¤ìŒ(Go) ë‹¨ê³„
            clearInterval(timer);
            this.showCountdown = false;
            
            // 4. ì¹´ìš´íŠ¸ë‹¤ìš´ ëë‚œ í›„ ì‹¤ì œ ì„ê¸° ì‹œì‘
            this.shuffleSeats(); 
        }
    }, 1000); // 1ì´ˆ ê°„ê²©
},

// [ìˆ˜ì •] ëª¨ë‘  í¸ì„± ì‹œì‘ í•¨ìˆ˜ (ì¹´ìš´íŠ¸ë‹¤ìš´ ë³µêµ¬)
startGroupShuffle() {
    // 1. ìœ íš¨ì„± ê²€ì‚¬ (í•™ìƒ ìˆ˜ ë“±)
    if (this.students.length === 0) {
        alert("í•™ìƒ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    this.showCountdown = true;
    this.countDownValue = 3;

    // 3. íƒ€ì´ë¨¸ ì‹¤í–‰
    const timer = setInterval(() => {
        this.countDownValue--;
        
        if (this.countDownValue < 0) {
            clearInterval(timer);
            this.showCountdown = false;
            
            // 4. ì‹¤ì œ ëª¨ë‘  í¸ì„± ë¡œì§ ì‹¤í–‰
            this.assignGroups(); // ì‹¤ì œ ëª¨ë‘  ì„ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        }
    }, 1000);
},

// í™”ì‚´í‘œ ë“œë˜ê·¸ ì‹œì‘
    startDrag(level, event) {
    this.focusWindow('noise'); // â˜… ì¶”ê°€
    if (!event) return;
    event.preventDefault();

    const startX = event.clientX;
    const startVal = this.noiseLevels[level];
    const bar = this.$refs.noiseBar;
    if (!bar) return;
    const barRect = bar.getBoundingClientRect();

    const move = (ev) => {
        const delta = ev.clientX - startX;
        const barWidth = barRect.width;
        const change = Math.round((delta / barWidth) * this.maxDB);
        let newVal = Math.max(0, Math.min(this.maxDB, startVal + change));

        if (level === 'safe') newVal = Math.min(newVal, this.noiseLevels.caution - 1);
        if (level === 'caution') newVal = Math.max(this.noiseLevels.safe + 1, Math.min(newVal, this.noiseLevels.warning - 1));
        if (level === 'warning') newVal = Math.max(this.noiseLevels.caution + 1, newVal);

        this.noiseLevels[level] = newVal;
    };

    const up = () => {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
        this.saveToLocal();
    };

    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
},

    // ë‹¨ê³„ ì´ë¦„ ë°˜í™˜
    getNoiseStage(level) {
        if (level < this.noiseLevels.safe) return 'ì•ˆì „';
        if (level < this.noiseLevels.caution) return 'ì£¼ì˜';
        if (level < this.noiseLevels.warning) return 'ê²½ê³ ';
        return 'íƒˆë½';
    },

    // í´ë˜ìŠ¤ ë°˜í™˜ (bgìš© ì¶”ê°€)
    getNoiseClass(level, type = 'text') {
    const prefix = type === 'bg' ? 'bg-' : 'text-';
    
    // 0. ë ˆë²¨ ì„¤ì •ê°’ì´ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„ (ê¸°ë³¸ê°’ ë°©ì–´ ì½”ë“œ)
    const safe = this.noiseLevels?.safe || 60;
    const caution = this.noiseLevels?.caution || 80;
    const warning = this.noiseLevels?.warning || 100;

    // 1ë‹¨ê³„: ì•ˆì „ (Blue) - ğŸŸ¦
    if (level < safe) return prefix + 'blue-500';
    // 2ë‹¨ê³„: ì£¼ì˜ (Green) - ğŸŸ©
    if (level < caution) return prefix + 'green-500';
    // 3ë‹¨ê³„: ê²½ê³  (Orange) - ğŸŸ§
    if (level < warning) return prefix + 'orange-500';
    // 4ë‹¨ê³„: íƒˆë½ (Red) - ğŸŸ¥
    return prefix + 'red-600';
},

// ì†ŒìŒ ì¸¡ì •ê¸° ì—´ê¸° (ì¢Œì¸¡ í•˜ë‹¨ ë²„íŠ¼ìš©)
    openNoiseMeter() {
    this.showNoiseMeter = true;
    this.focusWindow('noise'); // â˜… ì¶”ê°€ (í™•ì‹¤í•˜ê²Œ)

    if (!this.noiseX || isNaN(this.noiseX) || this.noiseX < 0 || this.noiseX > window.innerWidth) {
        this.noiseX = 100;
    }
    if (!this.noiseY || isNaN(this.noiseY) || this.noiseY < 0 || this.noiseY > window.innerHeight) {
        this.noiseY = 100;
    }
    this.startNoiseMeasurement();
},

// [ìˆ˜ì •] íƒ€ì´ë¨¸ ì—´ê¸° ì‹œ ìœ„ì¹˜ ì²´í¬
   openTimer() {
    this.showTimer = true;
    this.focusWindow('timer');
    
    // ê¸°ì¡´ì˜ 'í™”ë©´ ë°– ì²´í¬ ë° êµ¬ì¡°(Rescue)' ì½”ë“œë¥¼ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
    // ì´ì œ ì €ì¥ëœ ìœ„ì¹˜ê°€ ì–´ë””ë“  ìƒê´€ì—†ì´ ê·¸ëŒ€ë¡œ ëœ¹ë‹ˆë‹¤.
},

   // [ìµœì¢… ìˆ˜ì •] ì†ŒìŒ ì¸¡ì • ì‹œì‘ (AGC ë„ê¸° + ìŠ¤ë¬´ë”© ì ìš©)
startNoiseMeasurement() {
    if (this.noiseInterval) return;

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("âš ï¸ ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const constraints = {
        audio: {
            echoCancellation: false,
            noiseSuppression: true,
            autoGainControl: false // AGC ë„ê¸°
        }
    };

    navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            this.noiseStream = stream;
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            this.noiseAnalyzer = audioContext.createAnalyser();
            
            this.noiseAnalyzer.fftSize = 2048; 
            this.noiseAnalyzer.smoothingTimeConstant = 0.8;
            source.connect(this.noiseAnalyzer);
            
            const dataArray = new Uint8Array(this.noiseAnalyzer.frequencyBinCount);

            // [ì„¤ì • 1] ë³´ì •ê°’ (-20 ~ -30 ì¶”ì²œ)
            const calibration = -20; 

            // [ì„¤ì • 2] ë…¸ì´ì¦ˆ ê²Œì´íŠ¸ (ì´ ê°’ ì´í•˜ì˜ ë¯¸ì„¸ ì†Œë¦¬ëŠ” 30ìœ¼ë¡œ ê³ ì •)
            const noiseGateThreshold = 5;

            // â˜… [ì„¤ì • 3] ì¶©ê²©ìŒ í•„í„° (ì§§ì€ ì†ŒìŒ ë¬´ì‹œ)
            // ì†Œë¦¬ê°€ ê°‘ìê¸° ì»¤ì¡Œì„ ë•Œ, ëª‡ ë²ˆ ì—°ì†ìœ¼ë¡œ ê°ì§€ë¼ì•¼ ì¸ì •í• ì§€ ì„¤ì •
            // 3 = 0.3ì´ˆ ì´ìƒ ì§€ì†ë¼ì•¼ ì†ŒìŒìœ¼ë¡œ ì¸ì • (ë§ˆìš°ìŠ¤ í´ë¦­ ë¬´ì‹œ)
            const spikeDurationThreshold = 3; 
            let spikeCounter = 0; // ì‹œë„ëŸ¬ìš´ ìƒíƒœê°€ ì–¼ë§ˆë‚˜ ì§€ì†ëëŠ”ì§€ ì„¸ëŠ” ë³€ìˆ˜

            // ì´ì „ ê°’ ê¸°ì–µ
            let previousDb = 30; 

            this.noiseInterval = setInterval(() => {
                this.noiseAnalyzer.getByteFrequencyData(dataArray);
                
                // 1. RMS ê³„ì‚° (ì €ì£¼íŒŒ ì œì™¸)
                let sum = 0;
                for (let i = 15; i < dataArray.length; i++) {
                    sum += dataArray[i] * dataArray[i];
                }
                const rms = Math.sqrt(sum / (dataArray.length - 15));

                // 2. 1ì°¨ ê°€ê³µ (ë¡œê·¸ ë³€í™˜ + ê²Œì´íŠ¸)
                let rawDb = 30; // ê¸°ë³¸ ì¡°ìš©í•œ ìƒíƒœ
                if (rms > noiseGateThreshold) {
                    const db = 20 * Math.log10(rms / 255); 
                    rawDb = Math.floor(db + 100 + calibration);
                }
                rawDb = Math.max(30, Math.min(120, rawDb));

                // 3. â˜… ì¶©ê²©ìŒ í•„í„° ë¡œì§ (í•µì‹¬)
                // í˜„ì¬ ì†Œë¦¬ê°€ ì´ì „ë³´ë‹¤ 10dB ì´ìƒ ê°‘ìê¸° ì»¤ì¡Œë‹¤ë©´?
                let targetDb = rawDb;

                if (rawDb > previousDb + 5) { // 5dB ì´ìƒ ê¸‰ìƒìŠ¹ ì‹œ
                    spikeCounter++; // ì¹´ìš´íŠ¸ ì‹œì‘
                    
                    // ì§€ì† ì‹œê°„ì´ ì§§ìœ¼ë©´(0.3ì´ˆ ë¯¸ë§Œ) ë¬´ì‹œí•˜ê³  ì´ì „ ê°’ ìœ ì§€
                    if (spikeCounter < spikeDurationThreshold) {
                        targetDb = previousDb; 
                    } else {
                        // ì¶©ë¶„íˆ ì˜¤ë˜ ì§€ì†ë˜ë©´ ì¸ì • (ì•„ì´ë“¤ì´ ë– ë“œëŠ” ì†Œë¦¬)
                        targetDb = rawDb; 
                    }
                } else {
                    // ì†Œë¦¬ê°€ ì¤„ì–´ë“¤ê±°ë‚˜ ë¹„ìŠ·í•˜ë©´ ì¹´ìš´íŠ¸ ë¦¬ì…‹
                    spikeCounter = 0;
                    targetDb = rawDb;
                }

                // 4. ìŠ¤ë¬´ë”© (ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„)
                const smoothingFactor = 0.8; 
                let smoothDb = (targetDb * (1 - smoothingFactor)) + (previousDb * smoothingFactor);
                let finalDb = Math.floor(smoothDb);

                // 5. í™”ë©´ ì—…ë°ì´íŠ¸
                if (Math.abs(finalDb - this.currentNoiseLevel) >= 1) {
                    this.currentNoiseLevel = finalDb;
                    this.updateNoiseLevel(); 
                }

                previousDb = smoothDb;

            }, 100);
        })
        .catch(err => {
    console.error("ë§ˆì´í¬ ì—ëŸ¬:", err);
    this.stopNoiseMeasurement();  // â˜… ì¶”ê°€: ì‹¤íŒ¨ ì‹œ ì¸¡ì • ì¤‘ì§€
    alert("âš ï¸ ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
});
},

   // ì†ŒìŒ ì¸¡ì • ì¢…ë£Œ (ì°½ ë‹«ì„ ë•Œ)
    stopNoiseMeasurement() {
        if (this.noiseInterval) clearInterval(this.noiseInterval);
        this.noiseInterval = null;
        if (this.noiseStream) {
            this.noiseStream.getTracks().forEach(track => track.stop());
            this.noiseStream = null;
        }
        this.noiseAnalyzer = null;
        this.currentNoiseLevel = 0;
        this.noiseHistory = [];
    },

    // ëª¨ë‹¬ ë“œë˜ê·¸ (pickerì™€ ë¹„ìŠ·í•˜ê²Œ ë³µì‚¬)
    startNoiseDrag(e) {
        if (e.target.closest('button')) return;
        if (this.isNoiseMaximized) return;
        const startX = e.clientX - this.noiseX;
        const startY = e.clientY - this.noiseY;
        const mv = (ev) => {
            this.noiseX = ev.clientX - startX;
            this.noiseY = ev.clientY - startY;
        };
        const mu = () => {
            document.removeEventListener('mousemove', mv);
            document.removeEventListener('mouseup', mu);
        };
        document.addEventListener('mousemove', mv);
        document.addEventListener('mouseup', mu);

this.saveToLocal();
    },

    // ëª¨ë‹¬ ë¦¬ì‚¬ì´ì¦ˆ (pickerì™€ ë¹„ìŠ·í•˜ê²Œ ë³µì‚¬)
    startNoiseResize(e) {
    this.focusWindow('noise'); // â˜… ì¶”ê°€
    e.preventDefault();
    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = this.noiseW;
    const startHeight = this.noiseH;

    const mv = (ev) => {
        const deltaX = ev.clientX - startX;
        const deltaY = ev.clientY - startY;

        let newWidth = Math.max(300, startWidth + deltaX);
        let newHeight = Math.max(200, startHeight + deltaY);

        const maxW = window.innerWidth - this.noiseX;
        const maxH = window.innerHeight - this.noiseY;

        if (newWidth > maxW) newWidth = maxW;
        if (newHeight > maxH) newHeight = maxH;

        this.noiseW = newWidth;
        this.noiseH = newHeight;
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal(); 
    };

    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},

// ì†ŒìŒ ì—…ë°ì´íŠ¸ ì‹œ ë‹¨ê³„ ì²´í¬ (ê¸°ì¡´ ì¸í„°ë²Œ ì•ˆì— ì¶”ê°€)
    updateNoiseLevel() {
    // 1ë‹¨ê³„: ì•ˆì „ (Safe)
    if (this.currentNoiseLevel < this.noiseLevels.safe) {
        // ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
    }
    // 2ë‹¨ê³„: ì£¼ì˜ (Caution)
    else if (this.currentNoiseLevel < this.noiseLevels.caution) {
        // í•„ìš” ì‹œ ì—¬ê¸°ì— ì£¼ì˜ ë¡œì§ ì¶”ê°€
    }
    // 3ë‹¨ê³„: ê²½ê³  (Warning) - ì£¼í™©ìƒ‰ êµ¬ê°„
    else if (this.currentNoiseLevel < this.noiseLevels.warning) {
        this.triggerPenalty('warning');
    }
    // 4ë‹¨ê³„: íƒˆë½ (Penalty) - ë¹¨ê°„ìƒ‰ êµ¬ê°„
    else {
        this.triggerPenalty('penalty');
    }
},
    // ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ (ì›¹ ì˜¤ë””ì˜¤ë¡œ ê°„ë‹¨ êµ¬í˜„)
    playWarningSound() {
        const audio = new Audio('https://freesound.org/data/previews/476/476545_10096752-lq.mp3'); // ë¬´ë£Œ ê²½ê³ ìŒ URL (í•„ìš” ì‹œ ë³€ê²½)
        audio.play();
    },

    // íŒ¨ë„í‹° íŠ¸ë¦¬ê±° (ë‹¨ê³„ë³„)
   triggerPenalty(level) {
    if (this.isNoiseCooldown) {
        if (level === 'penalty' && this.lastTriggerType === 'warning') {
            // í†µê³¼
        } else {
            return; 
        }
    }

    if (level === 'warning') {
        this.statsWarningCount++;
        this.lastTriggerType = 'warning'; 
        this.showToast("âš  ì‰¿! ì†ŒìŒ ê¸°ì¤€ ì´ˆê³¼", "warning-big");
        this.playSound('siren', false, 0.5); // [ì†Œë¦¬ ì¶”ê°€] ê²½ê³ ìŒ
        
        this.isNoiseCooldown = true;
        setTimeout(() => { this.isNoiseCooldown = false; this.lastTriggerType = null; }, 60000); 
    } 
    else if (level === 'penalty') {
        this.statsPenaltyCount++;
        this.lastTriggerType = 'penalty'; 
        this.showToast("ğŸš¨ ê¸°ì¤€ì¹˜ ì´ˆê³¼! íƒˆë½", "danger-big");
        this.isPenaltyShock = true;
        this.playSound('explode', false, 0.8); // [ì†Œë¦¬ ì¶”ê°€] íƒˆë½ìŒ
        
        setTimeout(() => { this.isPenaltyShock = false; }, 5000);
        this.isNoiseCooldown = true;
        setTimeout(() => { this.isNoiseCooldown = false; this.lastTriggerType = null; }, 60000);
    }
    this.saveToLocal();
},

showToast(msg, type = 'warning') {
    this.notificationMsg = msg;
    this.notificationType = type;
    
    if (this.notificationTimer) clearTimeout(this.notificationTimer);
    
    // 3ì´ˆ ë’¤ ì‚¬ë¼ì§
    this.notificationTimer = setTimeout(() => {
        this.notificationMsg = '';
    }, 3000);
},

// [ì‹ ê·œ] í†µê³„ ì´ˆê¸°í™” í•¨ìˆ˜
resetNoiseStats() {
    if(confirm("ëˆ„ì ëœ ê²½ê³ /íƒˆë½ íšŸìˆ˜ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
        this.statsWarningCount = 0;
        this.statsPenaltyCount = 0;
        this.saveToLocal();
    }
},

    // ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (Canvasë¡œ ë‹¨ê³„ ìƒ‰ìƒ ë°˜ì˜)
    drawNoiseGraph() {
    const canvas = this.$refs.noiseChart;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ë°°ê²½ ë¼ì¸ (maxDB ê¸°ì¤€ ìœ„ì¹˜)
    ctx.strokeStyle = '#e2e8f0';
    ctx.beginPath(); ctx.moveTo(0, canvas.height * (1 - this.noiseLevels.safe / this.maxDB)); ctx.lineTo(canvas.width, canvas.height * (1 - this.noiseLevels.safe / this.maxDB)); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, canvas.height * (1 - this.noiseLevels.caution / this.maxDB)); ctx.lineTo(canvas.width, canvas.height * (1 - this.noiseLevels.caution / this.maxDB)); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, canvas.height * (1 - this.noiseLevels.warning / this.maxDB)); ctx.lineTo(canvas.width, canvas.height * (1 - this.noiseLevels.warning / this.maxDB)); ctx.stroke();

    // ì‹¤ì œ ì†ŒìŒ ë¼ì¸ (í´ë¨í•‘)
    ctx.beginPath();
    this.noiseHistory.forEach((level, i) => {
        const clamped = Math.min(this.maxDB, Math.max(0, level));
        const x = (i / this.noiseHistory.length) * canvas.width;
        const y = canvas.height - (clamped / this.maxDB * canvas.height);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 3;
    ctx.stroke();
},

    // ë‹¨ê³„ ìˆ˜ì • UI (ëª¨ë‹¬ì— ë²„íŠ¼ ì¶”ê°€ ì‹œ í˜¸ì¶œ)
    editNoiseLevels() {
        // ê¸°ì¡´ prompt ëŒ€ì‹  ìŠ¬ë¼ì´ë” UI (ëª¨ë‹¬ ì•ˆì— ìƒˆ div íŒì—…)
        // í•˜ì§€ë§Œ ì½”ë“œ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ prompt 3ê°œë¡œ ëŒ€ì²´ (ë“œë˜ê·¸ ìŠ¬ë¼ì´ë”ëŠ” ë³„ë„ ì»´í¬ë„ŒíŠ¸ í•„ìš” ì‹œ ì¶”ê°€)
        const newSafe = prompt("ì•ˆì „ ~ ì£¼ì˜ ì„ê³„ (ê¸°ë³¸ 50dB):", this.noiseLevels.safe);
        const newCaution = prompt("ì£¼ì˜ ~ ê²½ê³  ì„ê³„ (ê¸°ë³¸ 70dB):", this.noiseLevels.caution);
        const newWarning = prompt("ê²½ê³  ~ íƒˆë½ ì„ê³„ (ê¸°ë³¸ 90dB):", this.noiseLevels.warning);
        if (newSafe && newCaution && newWarning) {
            this.noiseLevels.safe = parseInt(newSafe);
            this.noiseLevels.caution = parseInt(newCaution);
            this.noiseLevels.warning = parseInt(newWarning);
            this.saveToLocal();
        }
    },

cancelFinalWinner() {
    if (!this.finalWinner) return;
    // ë§ˆì§€ë§‰ ë¼ìš´ë“œ(ê²°ìŠ¹ì „) ê°€ì ¸ì˜¤ê¸°
    const lastRoundIdx = this.bracketTree.length - 1;
    const finalMatch = this.bracketTree[lastRoundIdx][0];

    // ê²°ìŠ¹ì „ ìŠ¹ì ë°ì´í„° ì´ˆê¸°í™”
    if (finalMatch && finalMatch.winner && finalMatch.winner !== 'ë¶€ì „ìŠ¹') {
        finalMatch.winner = null;
        this.finalWinner = null; 
        this.propagateUpdate(); 
    }
},

initTournament(participants) {
            this.participants = [...participants]; // ì°¸ê°€ì ë³µì‚¬
            this.tournamentRounds = []; // ì´ˆê¸°í™”

            // ì°¸ê°€ì ì„ê¸° (ëœë¤ ë°°ì¹˜)
            this.shuffleArray(this.participants);

            // ì°¸ê°€ì ìˆ˜ì— ë”°ë¼ ë°”ì´(bye) ì²˜ë¦¬ (2ì˜ ê±°ë“­ì œê³±ìœ¼ë¡œ ë§ì¶¤)
            let numPlayers = this.participants.length;
            let nextPowerOfTwo = Math.pow(2, Math.ceil(Math.log2(numPlayers)));
            while (numPlayers < nextPowerOfTwo) {
                this.participants.push(null); // ë°”ì´ ìŠ¬ë¡¯ ì¶”ê°€ (nullë¡œ í‘œì‹œ)
                numPlayers++;
            }

            // ì²« ë¼ìš´ë“œ ë§¤ì¹˜ ìƒì„±: ì–‘ìª½ìœ¼ë¡œ ë‚˜ëˆ  ë°°ì¹˜ (ì™¼ìª½ ì ˆë°˜, ì˜¤ë¥¸ìª½ ì ˆë°˜)
            let firstRound = [];
            let half = this.participants.length / 2;
            for (let i = 0; i < half; i++) {
                // ì™¼ìª½: participants[i], ì˜¤ë¥¸ìª½: participants[i + half]
                let leftPlayer = this.participants[i];
                let rightPlayer = this.participants[i + half];
                firstRound.push({
                    left: leftPlayer ? { name: leftPlayer, winner: false } : null,
                    right: rightPlayer ? { name: rightPlayer, winner: false } : null,
                    winner: null // ë§¤ì¹˜ ìŠ¹ì
                });
            }

            this.tournamentRounds.push(firstRound);

            // í›„ì† ë¼ìš´ë“œ ìƒì„± (ë¹ˆ ë§¤ì¹˜ë¡œ)
            let currentRound = firstRound;
            while (currentRound.length > 1) {
                let nextRound = [];
                for (let i = 0; i < currentRound.length / 2; i++) {
                    nextRound.push({
                        left: null,
                        right: null,
                        winner: null
                    });
                }
                this.tournamentRounds.push(nextRound);
                currentRound = nextRound;
            }
        },

        // ë°°ì—´ ì„ê¸° í—¬í¼
        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        },

        // ë§¤ì¹˜ í´ë¦­ ì‹œ ìŠ¹ì ì„ íƒ ëª¨ë“œ ì§„ì… (í…œí”Œë¦¿ì—ì„œ match í´ë¦­ ì´ë²¤íŠ¸ë¡œ í˜¸ì¶œ)
        selectWinnerForMatch(roundIndex, matchIndex) {
            this.currentMatch = { round: roundIndex, match: matchIndex };
            this.isSelectingWinner = true;
            // ì´ë¦„í‘œ í‘œì‹œ ë¡œì§ì€ í…œí”Œë¦¿ì—ì„œ v-ifë¡œ ì²˜ë¦¬
        },

        // ì´ë¦„í‘œ í´ë¦­ ì‹œ ìŠ¹ì í† ê¸€ (í…œí”Œë¦¿ì—ì„œ @clickìœ¼ë¡œ í˜¸ì¶œ)
        toggleWinner(side) { // side: 'left' ë˜ëŠ” 'right'
            if (!this.currentMatch) return;

            let match = this.tournamentRounds[this.currentMatch.round][this.currentMatch.match];
            let opponentSide = side === 'left' ? 'right' : 'left';

            if (match[side]) {
                if (match[side].winner) {
                    // ì·¨ì†Œ: winner í•´ì œ
                    match[side].winner = false;
                    match.winner = null;
                } else {
                    // ì„ íƒ: ì´ìª½ winner ì„¤ì •, ìƒëŒ€ í•´ì œ
                    match[side].winner = true;
                    if (match[opponentSide]) match[opponentSide].winner = false;
                    match.winner = match[side].name;
                }

                // ë‹¤ìŒ ë¼ìš´ë“œë¡œ ìŠ¹ì ì§„ì¶œ (ìë™ ì—…ë°ì´íŠ¸)
                this.advanceWinner(this.currentMatch.round, this.currentMatch.match);
            }
        },

        // ìŠ¹ì ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œ
        advanceWinner(roundIndex, matchIndex) {
            let nextRoundIndex = roundIndex + 1;
            if (nextRoundIndex >= this.tournamentRounds.length) return;

            let nextMatchIndex = Math.floor(matchIndex / 2);
            let nextSide = matchIndex % 2 === 0 ? 'left' : 'right';

            let currentMatch = this.tournamentRounds[roundIndex][matchIndex];
            let nextMatch = this.tournamentRounds[nextRoundIndex][nextMatchIndex];

            if (currentMatch.winner) {
                nextMatch[nextSide] = { name: currentMatch.winner, winner: false };
            } else {
                nextMatch[nextSide] = null;
            }

            // ë‹¤ìŒ ë§¤ì¹˜ winner ì´ˆê¸°í™” (ë³€ê²½ ì‹œ)
            nextMatch.winner = null;
        },

        // ìŠ¹ì ì„ íƒ ì™„ë£Œ (ì·¨ì†Œ ë˜ëŠ” í™•ì¸ ë²„íŠ¼ìœ¼ë¡œ í˜¸ì¶œ, í•„ìš” ì‹œ)
        finishSelectingWinner() {
            this.isSelectingWinner = false;
            this.currentMatch = null;
        },


// --- [í† ë„ˆë¨¼íŠ¸ ê¸°ëŠ¥ ê°œì„ : ì¤‘ì•™ ì§‘ì¤‘í˜•] ---

// 0. ë¼ìš´ë“œ íƒ€ì´í‹€ (16ê°•, 8ê°•...)
getRoundTitle(index) {
    const totalRounds = this.bracketTree.length;
    // index 0 = 16ê°•(ê°€ì¥ ë°”ê¹¥), index increased = 8ê°•...
    // bracketTreeì—ëŠ” [Round1, Round2, ... Final] ìˆœì„œë¡œ ì €ì¥ë¨
    const revIndex = totalRounds - index; 
    if (revIndex === 1) return 'ê²°ìŠ¹'; // ì¤‘ì•™ í‘œì‹œìš©ì´ë¼ ì‹¤ì œ ë¼ìš´ë“œ ë£¨í”„ì—ì„  ì•ˆì“°ì¼ ìˆ˜ ìˆìŒ
    if (revIndex === 2) return '4ê°•'; // Semi
    return Math.pow(2, revIndex) + 'ê°•';
},

// 1. í™”ë©´ ë Œë”ë§ìš© ë§¤ì¹˜ ìŒ(Pair) ë°ì´í„° ê°€ê³µ
getRoundPairs(roundIndex, side) {
    if (!this.bracketTree[roundIndex]) return [];
    
    const allMatches = this.bracketTree[roundIndex];
    const total = allMatches.length;
    const half = Math.ceil(total / 2);
    
    // ì™¼ìª½ íŒ¨ë„: ì•ìª½ ì ˆë°˜ / ì˜¤ë¥¸ìª½ íŒ¨ë„: ë’¤ìª½ ì ˆë°˜
    let targetMatches = (side === 'left') 
        ? allMatches.slice(0, half) 
        : allMatches.slice(half);
    
    // ì—¬ê¸°ì„œ ê° MatchëŠ” {player1, player2}ë¥¼ ê°–ê³  ìˆìŒ.
    // ì¤‘ì•™ ì§‘ì¤‘í˜• ë””ìì¸ì—ì„œëŠ”, í•˜ë‚˜ì˜ Match ë°•ìŠ¤ê°€ ìœ„ì•„ë˜ë¡œ player1, player2ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì•„ë‹ˆë¼
    // ê° Playerê°€ ë³„ë„ì˜ ë°•ìŠ¤ë¡œ ë Œë”ë§ë˜ê³  ê·¸ ë‘˜ì´ ë¬¶ì—¬ì•¼ í•¨ (ì´ë¯¸ì§€ ì°¸ì¡°).
    // í•˜ì§€ë§Œ í˜„ì¬ ë°ì´í„° êµ¬ì¡°ëŠ” Match ë‹¨ìœ„ì´ë¯€ë¡œ, 
    // í…œí”Œë¦¿ì—ì„œ "Match í•˜ë‚˜"ë¥¼ "Pair í•˜ë‚˜"ë¡œ ì·¨ê¸‰í•˜ì—¬ ë Œë”ë§í•˜ê³  ìˆìŒ.
    // ë”°ë¼ì„œ, ë‹¨ìˆœíˆ targetMatchesë¥¼ ë°˜í™˜í•˜ë˜, ì›ë³¸ ì¸ë±ìŠ¤ ì •ë³´ë¥¼ ìœ ì§€í•´ì•¼ í•¨.
    
    return targetMatches.map(m => {
        // ì›ë³¸ ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤ ì°¾ê¸° (pickWinner í˜¸ì¶œìš©)
        const originalIndex = allMatches.indexOf(m);
        // ë°°ì—´ë¡œ ê°ì‹¸ì„œ ë°˜í™˜ (v-for êµ¬ì¡° ìœ ì§€ìš©)
        return [{...m, originalIndex}];
    });
},

async generateBracket() {
    if (this.isGenerating) return;
    
this.bracketMode = this.selectedBracketMode;
    this.isGenerating = true;
    this.visibleBracketTree = []; // í™”ë©´ ì´ˆê¸°í™”
    
    // 1. ëŒ€ì§„í‘œ ë¡œì§ ê³„ì‚° ì‹¤í–‰
    const calculatedTree = await this.makeBracketLogic(); 
    
    // 2. ë‹¨ê³„ë³„ë¡œ í™”ë©´ì— ë¿Œë ¤ì¤ë‹ˆë‹¤ (ì§€ì—° ë Œë”ë§)
    for (let i = 0; i < calculatedTree.length; i++) {
        this.visibleBracketTree.push(calculatedTree[i]);
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    this.isGenerating = false;
    this.saveToLocal();
},

async makeBracketLogic() {
    this.bracketTree = [];
    this.finalWinner = null;
    await this.$nextTick();
    this.bracketKey++;

    // 1. ì°¸ê°€ì ëª…ë‹¨ í™•ë³´
    let participants = [];
    let targetSize = 0;

    if (this.bracketMode === 'group8') {
        const groupCount = this.groups.length > 0 ? this.groups.length : 6;
        for (let i = 0; i < groupCount; i++) participants.push({ name: `${i + 1}ëª¨ë‘ ` });
        targetSize = 8;
    } 
    else if (this.bracketMode.includes('16')) {
        const gender = this.bracketMode === 'male16' ? 'M' : 'F';
        participants = this.allStudents.filter(s => s.gender === gender);
        targetSize = 16;
    } 
    else {
        participants = [...this.allStudents];
        targetSize = 32;
    }

    if (participants.length < 2) {
        alert("ìµœì†Œ 2ëª…ì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        return [];
    }

    // 2. ì¸ì› ìˆ˜ ë§ì¶”ê¸° (32ê°•ì¸ë° 20ëª…ì´ë©´ -> 12ëª…ì€ ë¶€ì „ìŠ¹)
    const realPlayerCount = Math.min(participants.length, targetSize);
    // ì‹¤ì œ ì„ ìˆ˜ë“¤ ëœë¤ ì„ê¸°
    this.shuffleArray(participants); 
    const realPlayers = participants.slice(0, realPlayerCount).map(p => p.name);
    
    // í•„ìš”í•œ ì´ ê²½ê¸° ìˆ˜ (ì˜ˆ: 16ê°•ì´ë©´ 8ê²½ê¸°)
    const matchCount = targetSize / 2;
    
    // 3. [í•µì‹¬] ë¶€ì „ìŠ¹ ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜
    // ë§¤ì¹˜ ë°°ì—´ ìƒì„±
    let matches = Array.from({ length: matchCount }, (_, i) => ({
        id: `r0-m${i}`,
        player1: null,
        player2: null,
        winner: null
    }));

    // (1) ëª¨ë“  ë§¤ì¹˜ì˜ Player 1 ìë¦¬ì— 'ì‹¤ì œ ì„ ìˆ˜'ë¥¼ ë¨¼ì € ì±„ìš´ë‹¤.
    let pIndex = 0;
    for (let i = 0; i < matchCount; i++) {
        if (pIndex < realPlayers.length) {
            matches[i].player1 = realPlayers[pIndex++];
        } else {
            matches[i].player1 = 'ë¶€ì „ìŠ¹';
        }
    }

    // (2) ë‚¨ì€ 'ì‹¤ì œ ì„ ìˆ˜'ë¥¼ Player 2 ìë¦¬ì— ì±„ìš´ë‹¤.
    // (ì´ë ‡ê²Œ í•˜ë©´ ë¶€ì „ìŠ¹ì€ Player 2 ìë¦¬ì— ëª°ë¦¬ê²Œ ë˜ì–´, ë¶€ì „ìŠ¹ë¼ë¦¬ì˜ ëŒ€ê²°ì„ ìµœì†Œí™”í•¨)
    for (let i = 0; i < matchCount; i++) {
        if (pIndex < realPlayers.length) {
            matches[i].player2 = realPlayers[pIndex++];
        } else {
            matches[i].player2 = 'ë¶€ì „ìŠ¹';
        }
    }
    
    // (3) ë°°ì—´ì„ í•œ ë²ˆ ë” ì„ì–´ì„œ ëŒ€ì§„í‘œ ìœ„ì¹˜ë¥¼ ëœë¤í•˜ê²Œ ë¶„ì‚° (ì„ íƒ ì‚¬í•­)
    this.shuffleArray(matches);

    // 4. ìë™ ìŠ¹ë¦¬(ë¶€ì „ìŠ¹) íŒì • ì ìš©
    matches.forEach(m => this.checkAutoWin(m));

    let tree = [matches];

    // 5. ìƒìœ„ ë¼ìš´ë“œ ë¹ˆ ìŠ¬ë¡¯ ìƒì„±
    let currentRound = matches;
    while (currentRound.length > 1) {
        let nextRound = [];
        for (let i = 0; i < currentRound.length; i += 2) {
            nextRound.push({
                id: `r${tree.length}-m${i / 2}`,
                player1: null,
                player2: null,
                winner: null
            });
        }
        tree.push(nextRound);
        currentRound = nextRound;
    }

    this.bracketTree = tree;
    
    // 6. ìë™ ìŠ¹ë¦¬ ê²°ê³¼ ìƒìœ„ ë¼ìš´ë“œë¡œ ì „íŒŒ
    this.propagateUpdate();
    
    return tree;
},
// [ì‹ ê·œ] ë§¤ì¹˜ ë‚´ì—ì„œ ë¶€ì „ìŠ¹ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ìŠ¹ìë¥¼ ìë™ ê²°ì •í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
checkAutoWin(match) {
    // ì´ë¯¸ ìŠ¹ìê°€ ê²°ì •ëœ ìƒíƒœë¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ë‹¨, ë¶€ì „ìŠ¹ ë¡œì§ì€ ê°•ì œ ì ìš©)
    
    // Case 1: ë‘˜ ë‹¤ ë¶€ì „ìŠ¹ (ê±°ì˜ ì—†ì§€ë§Œ ë°©ì–´ ì½”ë“œ)
    if (match.player1 === 'ë¶€ì „ìŠ¹' && match.player2 === 'ë¶€ì „ìŠ¹') {
        match.winner = null; // ë‘˜ ë‹¤ íƒˆë½
    }
    // Case 2: Player 1ì´ ë¶€ì „ìŠ¹ -> Player 2 ìë™ ìŠ¹ë¦¬
    else if (match.player1 === 'ë¶€ì „ìŠ¹' && match.player2) {
        match.winner = match.player2;
    }
    // Case 3: Player 2ê°€ ë¶€ì „ìŠ¹ -> Player 1 ìë™ ìŠ¹ë¦¬
    else if (match.player2 === 'ë¶€ì „ìŠ¹' && match.player1) {
        match.winner = match.player1;
    }
    // Case 4: ë‘˜ ë‹¤ ì¼ë°˜ ì„ ìˆ˜ -> ìŠ¹ì ì´ˆê¸°í™” (ì¬ê²½ê¸°)
    else if (match.player1 && match.player2 && match.winner === 'ë¶€ì „ìŠ¹') {
         // ì´ì „ ìŠ¹ìê°€ ë¶€ì „ìŠ¹ì´ì—ˆëŠ”ë° ì‚¬ëŒì´ ë“¤ì–´ì˜¤ë©´ ì´ˆê¸°í™”
         match.winner = null;
    }
},
// 3. ìŠ¹ì ì„ íƒ (ê°œë³„ ì´ë¦„í‘œ í´ë¦­)
pickWinner(roundIdx, matchIdx, playerKey) {
            // ë§¤ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let match = null;
            if (roundIdx === this.bracketTree.length - 1) {
                // ê²°ìŠ¹ì „ì¸ ê²½ìš°
                match = this.bracketTree[roundIdx][0];
            } else {
                // ì¼ë°˜ ë¼ìš´ë“œì¸ ê²½ìš°
                match = this.bracketTree[roundIdx][matchIdx];
            }
            
            // ë°ì´í„°ê°€ ì—†ê±°ë‚˜, ì•„ì§ í•™ìƒì´ ì˜¬ë¼ì˜¤ì§€ ì•Šì€ ë¹ˆì¹¸ì´ë©´ ë¬´ì‹œ
            if (!match || !match[playerKey]) return;

            const selectedPlayer = match[playerKey];

            // [í•µì‹¬ ë³€ê²½] ì´ë¯¸ í•´ë‹¹ í•™ìƒì´ ìŠ¹ìë¼ë©´ -> 'ìŠ¹ì ì·¨ì†Œ' (nullë¡œ ë³€ê²½)
            if (match.winner === selectedPlayer) {
                match.winner = null;
            } 
            // ìŠ¹ìê°€ ì•„ë‹ˆê±°ë‚˜ ë¹„ì–´ìˆë‹¤ë©´ -> 'ìŠ¹ìë¡œ ì„ íƒ'
            else {
                match.winner = selectedPlayer;
            }

            // ë‹¤ìŒ ë¼ìš´ë“œë¡œ ê²°ê³¼ ë°˜ì˜ (ì·¨ì†Œ ì‹œ ë‹¤ìŒ ë¼ìš´ë“œ ì§„ì¶œìë„ ì‚¬ë¼ì§)
            this.propagateUpdate();
this.saveToLocal();
        },

// [ì¶”ê°€í•  ì½”ë“œ] ìš°í´ë¦­ ì‹œ ìŠ¹ì ì·¨ì†Œ
        cancelMatchWinner(roundIdx, matchIdx, targetSide) {
            // ê²°ìŠ¹ì „ì¸ì§€ ì¼ë°˜ ë§¤ì¹˜ì¸ì§€ êµ¬ë¶„
            let match;
            if (roundIdx === this.bracketTree.length - 1) {
                match = this.bracketTree[roundIdx][0];
            } else {
                match = this.bracketTree[roundIdx][matchIdx];
            }

            if (!match) return;

            // 1. í˜„ì¬ ì¹¸ì´ 'ìŠ¹ë¦¬ì(ë…¸ë€ìƒ‰)' ìƒíƒœë¼ë©´ -> ìŠ¹ë¦¬ ì·¨ì†Œ
            if (match.winner) {
                if (match.winner === 'ë¶€ì „ìŠ¹') return; // ë¶€ì „ìŠ¹ì€ ì·¨ì†Œ ë¶ˆê°€
                match.winner = null;
            } 
            // 2. í˜„ì¬ ì¹¸ì´ 'ì§„ì¶œì(ë³´ë¼ìƒ‰)' ìƒíƒœë¼ë©´ -> 'ì´ í•™ìƒì´ ì˜¬ë¼ì˜¨ ì´ì „ ê²½ê¸°'ì˜ ìŠ¹ë¦¬ë¥¼ ì·¨ì†Œ
            else if (roundIdx > 0 && targetSide) {
                // ì´ì „ ë¼ìš´ë“œ ì¸ë±ìŠ¤
                const prevRoundIdx = roundIdx - 1;
                
                // ì´ì „ ë§¤ì¹˜ ì¸ë±ìŠ¤ ê³„ì‚° (í˜„ì¬ê°€ 2ë²ˆ ë§¤ì¹˜ë©´, ì´ì „ ë¼ìš´ë“œì˜ 4ë²ˆ í˜¹ì€ 5ë²ˆ ë§¤ì¹˜ì—ì„œ ì˜¬ë¼ì˜´)
                // player1ì€ ì§ìˆ˜(0, 2, 4...), player2ëŠ” í™€ìˆ˜(1, 3, 5...) ì¸ë±ìŠ¤ì—ì„œ ìœ ë˜
                const prevMatchIdx = (matchIdx * 2) + (targetSide === 'player1' ? 0 : 1);
                
                // ì´ì „ ë§¤ì¹˜ ê°€ì ¸ì˜¤ê¸°
                if (this.bracketTree[prevRoundIdx] && this.bracketTree[prevRoundIdx][prevMatchIdx]) {
                    const prevMatch = this.bracketTree[prevRoundIdx][prevMatchIdx];
                    
                    // ì´ì „ ë§¤ì¹˜ì˜ ìŠ¹ìê°€ ì¡´ì¬í•˜ê³  ë¶€ì „ìŠ¹ì´ ì•„ë‹ˆë¼ë©´ ì·¨ì†Œ
                    if (prevMatch.winner && prevMatch.winner !== 'ë¶€ì „ìŠ¹') {
                        prevMatch.winner = null;
                    }
                }
            }

            // ë³€ê²½ ì‚¬í•­ ì „íŒŒ (í™”ë©´ ê°±ì‹ )
            this.propagateUpdate();
        },

handleDragStart(evt, rIdx, mIdx, playerKey) {
    if (rIdx !== 0) { // 1ë¼ìš´ë“œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
        evt.preventDefault();
        return;
    }
    evt.dataTransfer.effectAllowed = 'move';
    evt.dataTransfer.dropEffect = 'move';
    const dragData = JSON.stringify({ rIdx, mIdx, playerKey });
    evt.dataTransfer.setData('text/plain', dragData);
    evt.target.classList.add('dragging');
},


handleDrop(evt, targetRIdx, targetMIdx, targetPlayerKey) {
    evt.preventDefault();
    if(evt.target.classList) evt.target.classList.remove('dragging');

    const data = evt.dataTransfer.getData('text/plain');
    if (!data) return;
    const src = JSON.parse(data);

    if (src.rIdx !== 0 || targetRIdx !== 0) return; // 1ë¼ìš´ë“œë¼ë¦¬ë§Œ

    const getMatch = (r, m) => this.bracketTree[r][m];
    const srcMatch = getMatch(src.rIdx, src.mIdx);
    const targetMatch = getMatch(targetRIdx, targetMIdx);

    if (!srcMatch || !targetMatch) return;

    // ì´ë¦„ êµí™˜
    const tempName = srcMatch[src.playerKey];
    srcMatch[src.playerKey] = targetMatch[targetPlayerKey];
    targetMatch[targetPlayerKey] = tempName;

    // ìŠ¹íŒ¨ ì¬íŒì • (ë¶€ì „ìŠ¹ ì²´í¬)
    srcMatch.winner = null;
    targetMatch.winner = null;
    this.checkAutoWin(srcMatch);
    this.checkAutoWin(targetMatch);

    this.propagateUpdate();
},


// 4. ìƒíƒœ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì „íŒŒ)
propagateUpdate() {
    // 1ë¼ìš´ë“œë¶€í„° ê²°ìŠ¹ ì „ê¹Œì§€ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
    for (let r = 0; r < this.bracketTree.length - 1; r++) {
        const currentRound = this.bracketTree[r];
        const nextRound = this.bracketTree[r+1];

        for (let i = 0; i < currentRound.length; i += 2) {
            const matchTop = currentRound[i];     // ìœ„ìª½ ê²½ê¸° (ë˜ëŠ” ì™¼ìª½)
            const matchBottom = currentRound[i+1]; // ì•„ë˜ìª½ ê²½ê¸° (ë˜ëŠ” ì˜¤ë¥¸ìª½)
            
            const targetMatch = nextRound[Math.floor(i / 2)];

            // ìŠ¹ì ì´ë¦„ ì „ì†¡
            targetMatch.player1 = matchTop.winner;
            targetMatch.player2 = matchBottom.winner;

            // ë¶€ì „ìŠ¹ ìë™ ì²˜ë¦¬
            if (targetMatch.winner) {
                // ê¸°ì¡´ ìŠ¹ìê°€ ìœ íš¨í•˜ì§€ ì•Šê²Œ ë˜ë©´ ì·¨ì†Œ
                if (targetMatch.winner !== targetMatch.player1 && targetMatch.winner !== targetMatch.player2) {
                    targetMatch.winner = null;
                }
            }
            
            if (targetMatch.player1 && targetMatch.player2) {
                if (targetMatch.player1 === 'ë¶€ì „ìŠ¹' && targetMatch.player2 !== 'ë¶€ì „ìŠ¹') targetMatch.winner = targetMatch.player2;
                else if (targetMatch.player2 === 'ë¶€ì „ìŠ¹' && targetMatch.player1 !== 'ë¶€ì „ìŠ¹') targetMatch.winner = targetMatch.player1;
            }
        }
    }

    // [í•µì‹¬] ê²°ìŠ¹ì „(ë§ˆì§€ë§‰ ë¼ìš´ë“œ) ìŠ¹ì í™•ì¸ ë¡œì§
    const finalRoundIndex = this.bracketTree.length - 1;
    const finalMatch = this.bracketTree[finalRoundIndex][0]; // ê²°ìŠ¹ì „ì€ í•­ìƒ 1ê²½ê¸°

    if (finalMatch && finalMatch.winner) {
        // ë¶€ì „ìŠ¹ì´ ì•„ë‹Œ ì‹¤ì œ ìŠ¹ìê°€ ìˆì„ ë•Œë§Œ ìš°ìŠ¹ ì²˜ë¦¬
        if (finalMatch.winner !== 'ë¶€ì „ìŠ¹') {
            this.finalWinner = finalMatch.winner;
            this.startConfetti();
        } else {
            this.finalWinner = null;
        }
    } else {
        this.finalWinner = null;
    }
},
resetBracket() {
    // 1. ëŒ€ì§„í‘œê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨
    if (!this.visibleBracketTree || this.visibleBracketTree.length === 0) return;

    // 2. ì‚¬ìš©ì í™•ì¸ (ì„ íƒ ì‚¬í•­)
    if (!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    // 3. [í•µì‹¬] ëŒ€ì§„í‘œì˜ êµ¬ì¡°(ë°°ì—´)ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³  ë‚´ë¶€ ë°ì´í„°ë§Œ nullë¡œ ë³€ê²½
    this.visibleBracketTree.forEach(round => {
        round.forEach(match => {
            match.player1 = null; // ì™¼ìª½ ì´ë¦„ ë¹„ìš°ê¸° -> ì™•ê´€ í‘œì‹œë¨
            match.player2 = null; // ì˜¤ë¥¸ìª½ ì´ë¦„ ë¹„ìš°ê¸° -> ì™•ê´€ í‘œì‹œë¨
            match.winner = null;  // ìŠ¹ì ê¸°ë¡ ë¹„ìš°ê¸°
        });
    });

    // 4. ìµœì¢… ìš°ìŠ¹ì ë° ê´€ë ¨ íš¨ê³¼ ì´ˆê¸°í™”
    this.finalWinner = null;

    // 5. ì„œë²„(Firebase)ì— ì´ˆê¸°í™”ëœ ìƒíƒœ ì €ì¥
    this.saveToLocal();
    
    // 6. í™”ë©´ ê°•ì œ ë¦¬ë Œë”ë§ (UI ë™ê¸°í™”)
    this.bracketKey++;

    console.log("ğŸ‘‘ ëŒ€ì§„í‘œ ì´ë¦„í‘œê°€ ëª¨ë‘ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
},

    closePickerMaster() {
        this.showPickerMaster = false;
        this.resetBracket(); // í† ë„ˆë¨¼íŠ¸ ì´ˆê¸°í™”
    },

getDiceFace(value) {
        if (value === 0) return '?';  // ì´ˆê¸° ë˜ëŠ” ê¸°ë³¸ ìƒíƒœ: ë¬¼ìŒí‘œ í‘œì‹œ
        const faces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
        return faces[value - 1] || '?';
    },

// NEW: ì£¼ì‚¬ìœ„ ë˜ì§€ê¸° ì• ë‹ˆë©”ì´ì…˜ ë©”ì„œë“œ
    rollDice() {
    if (this.isRollingDice) return;
    this.isRollingDice = true;
    this.playSound('shake_plastic'); // [ì†Œë¦¬ ì¶”ê°€] í”ë“œëŠ” ì†Œë¦¬

    const container = document.querySelector('.dice-wrapper'); 
    if(container) container.classList.add('rolling-shake');

    this.diceValues = Array(this.diceCount).fill(1);
    this.diceSum = 0;
    
    let rolls = 0;
    const maxRolls = 30;
    const intervalTime = 120; 

    const interval = setInterval(() => {
        this.diceValues = this.diceValues.map(() => Math.floor(Math.random() * 6) + 1);
        rolls++;
        
        if (rolls >= maxRolls) {
            clearInterval(interval);
            this.diceValues = this.diceValues.map(() => Math.floor(Math.random() * 6) + 1);
            this.updateDiceSum();
            this.isRollingDice = false;
            this.playSound('dice_roll'); // [ì†Œë¦¬ ì¶”ê°€] ê²°ê³¼ìŒ

            if(container) {
                container.classList.remove('rolling-shake');
                void container.offsetWidth; 
                container.classList.add('effect-zoom-bounce');
            }
        }
    }, intervalTime);
},
    // NEW: ì£¼ì‚¬ìœ„ í•©ê³„ ì—…ë°ì´íŠ¸
    updateDiceSum() {
        this.diceSum = this.diceValues.reduce((a, b) => a + b, 0);
    },
    
    // NEW: ì£¼ì‚¬ìœ„ ê°’ì— ë§ëŠ” ì•„ì´ì½˜ ë°˜í™˜ (âš€ ~ âš…)
    getDiceFace(value) {
        const faces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
        return faces[value - 1] || 'âš€';
    },

 updateCount(e, mode) {
     let val = parseInt(e.target.value) || 1;
     val = Math.max(1, Math.min(val, this.allStudents.length));
     if (mode === 'winner') this.winnerCount = val;
     else this.penaltyCount = val;
},

/* --- [3. ì‚¬ë‹¤ë¦¬ íƒ€ê¸° (SVG Logic)] --- */

// (1) X ì¢Œí‘œ ê³„ì‚° (1000px ê¸°ì¤€)
getLadderX(colIndex) {
    if (this.ladderStudents.length === 0) return 0;
    const sectionWidth = 1000 / this.ladderStudents.length;
    return (colIndex * sectionWidth) + (sectionWidth / 2);
},

// (2) ì‚¬ë‹¤ë¦¬ ë°ì´í„° ìƒì„±
/* --- methods ì˜ì—­ --- */

// [ìˆ˜ì •ë¨] ì‚¬ë‹¤ë¦¬ ìƒì„± (ê°„ê²© í™•ë³´ + ê¹”ë”í•œ ë°°ì¹˜)
generateLadder() {
    let participants = [];

    // 1. ì¸ì› ì„¤ì • ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    if (this.ladderPeopleMode === 'custom') {
        if (!this.customLadderNames.trim()) return alert("ì¸ì›ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        participants = this.customLadderNames.split('\n').map(n => n.trim()).filter(n => n);
        this.customLadderNames = ''; 
    } else {
        if (this.ladderSelectionList.length === 0) {
             this.ladderSelectionList = this.allStudents.map(s => s.name);
             participants = [...this.ladderSelectionList];
        } else {
             participants = [...this.ladderSelectionList];
        }
    }

    if (participants.length < 2) {
        return alert("ì°¸ê°€ìê°€ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
    }

    this.ladderStudents = [...participants].sort(() => Math.random() - 0.5);

    // 2. ê²°ê³¼ ì„¤ì • ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    let results = [];
    if (this.ladderContentMode === 'custom') {
        if (!this.customLadderResults.trim()) return alert("ê²°ê³¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        results = this.customLadderResults.split('\n').map(r => r.trim()).filter(r => r);
        if (results.length !== participants.length) {
            while (results.length < participants.length) results.push("ê½");
            results = results.slice(0, participants.length);
        }
    } else if (this.ladderContentMode === 'winner') {
        const winCount = Math.min(this.winnerCount, participants.length);
        const winIndices = new Set();
        while (winIndices.size < winCount) winIndices.add(Math.floor(Math.random() * participants.length));
        results = participants.map((_, i) => winIndices.has(i) ? "ë‹¹ì²¨!" : "ê½");
    } else {
        const penCount = Math.min(this.penaltyCount, participants.length);
        const penIndices = new Set();
        while (penIndices.size < penCount) penIndices.add(Math.floor(Math.random() * participants.length));
        results = participants.map((_, i) => penIndices.has(i) ? "ê±¸ë ¸ë‹¤" : "í†µê³¼!");
    }
    this.ladderResults = results;

    // 3. [í•µì‹¬ ìˆ˜ì •] ì‚¬ë‹¤ë¦¬ ì„  ìƒì„± ë¡œì§ ê°œì„  (ìµœì†Œ ê°„ê²© ë³´ì¥)
    this.activePolyline = '';
    this.ballPos.visible = false;
    this.revealedResults = [];
    this.revealedStarts = [];
    this.isLadderAnimating = false;
    this.ladderLines = [];

    const startY = 150; 
    const endY = 850;
    const minGap = 80; // â˜… ê°€ë¡œì„  ì‚¬ì´ì˜ ìµœì†Œ ê°„ê²© (ì´ ê°’ì„ ëŠ˜ë¦¬ë©´ ë” ë„ë„í•´ì§)

    // ê° ê¸°ë‘¥ ì‚¬ì´(ì—´)ë§ˆë‹¤ ë°˜ë³µ
    for (let col = 0; col < this.ladderStudents.length - 1; col++) {
        let currentY = startY + (Math.random() * 50); // ì‹œì‘ì  ëœë¤ ì˜¤ì°¨

        while (currentY < endY) {
            // ë‹¤ìŒ ì„  ìœ„ì¹˜ ê²°ì • (ìµœì†Œ ê°„ê²© + ëœë¤)
            const gap = minGap + (Math.random() * 60); 
            currentY += gap;

            if (currentY > endY) break;

            // ì˜† ê¸°ë‘¥ì˜ ì„ ê³¼ ë„ˆë¬´ ê°€ê¹Œìš´ì§€ í™•ì¸ (ê²¹ì¹¨ ë°©ì§€)
            // ì™¼ìª½(col-1)ì´ë‚˜ ì˜¤ë¥¸ìª½(col+1) ê¸°ë‘¥ì— ë¹„ìŠ·í•œ ë†’ì´ì˜ ì„ ì´ ìˆìœ¼ë©´ ìŠ¤í‚µí•˜ê±°ë‚˜ ì¡°ì •
            const tooClose = this.ladderLines.some(line => 
                (line.col === col - 1 || line.col === col + 1) && 
                Math.abs(line.y - currentY) < 30
            );

            if (!tooClose) {
                // ì•½ê°„ì˜ ê¸°ìš¸ê¸° (ë„ˆë¬´ ì‹¬í•˜ì§€ ì•Šê²Œ -20 ~ 20 ì œí•œ)
                const slant = (Math.random() - 0.5) * 40; 
                this.ladderLines.push({ col, y: currentY, slant });
            }
        }
    }
    
    // Yì¶• ê¸°ì¤€ ì •ë ¬ (í•„ìˆ˜)
    this.ladderLines.sort((a, b) => a.y - b.y);
    this.showLadderGame = true;
},

resizeLadderCanvas() {
            // SVG ë°©ì‹ì´ë¼ ë³„ë„ ë¦¬ì‚¬ì´ì¦ˆ ë¡œì§ ë¶ˆí•„ìš”í•˜ë‚˜, í˜¸ì¶œ ì—ëŸ¬ ë°©ì§€ìš©ìœ¼ë¡œ ë¹ˆ í•¨ìˆ˜ ìœ ì§€
        },

// (3) ê²Œì„ ì‹œì‘ (ê²½ë¡œ ê³„ì‚°)
startLadderGame(startColIdx) {
    if (this.isLadderAnimating) return;
    this.isLadderAnimating = true;
    this.playSound('move', true);
    if (this.ballHideTimeout) { clearTimeout(this.ballHideTimeout); this.ballHideTimeout = null; }

    this.activePolyline = '';
    let pathPoints = [];
    let currentCol = startColIdx;
    let currentY = 50; 

    // ì‹œì‘ì 
    pathPoints.push({ x: this.getLadderX(currentCol), y: currentY });

    // ë°”ë‹¥ì— ë‹¿ì„ ë•Œê¹Œì§€ ë°˜ë³µ
    while (currentY < 1000) {
        // ë‚´ í˜„ì¬ ìœ„ì¹˜(currentCol)ì™€ ì—°ê²°ëœ ëª¨ë“  ë‹¤ë¦¬ ì°¾ê¸°
        // ë‚´ê°€ ë‹¤ë¦¬ì˜ ì™¼ìª½ì— ìˆìœ¼ë©´(col === currentCol), ë‚´ê°€ ë‹¤ë¦¬ì˜ ì˜¤ë¥¸ìª½ì— ìˆìœ¼ë©´(col === currentCol - 1)
        const possibleBridges = this.ladderLines.filter(line => 
            line.col === currentCol || line.col === currentCol - 1
        );

        // â˜… [í•µì‹¬] 'ë‚´ ìœ„ì¹˜ ê¸°ì¤€' ì§„ì…ì  ë†’ì´(Entry Y) ê³„ì‚°
        let validBridge = null;
        let minDist = Infinity;

        possibleBridges.forEach(line => {
            let entryY;
            // Case 1: ë‚˜ëŠ” ì™¼ìª½, ë‹¤ë¦¬ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë»—ìŒ
            if (line.col === currentCol) {
                entryY = line.y;
            } 
            // Case 2: ë‚˜ëŠ” ì˜¤ë¥¸ìª½, ë‹¤ë¦¬ëŠ” ì™¼ìª½ì—ì„œ ì˜´ (ê¸°ìš¸ê¸° ê³ ë ¤!)
            else {
                entryY = line.y + line.slant;
            }

            // â˜… í˜„ì¬ ë†’ì´ë³´ë‹¤ 'í™•ì‹¤íˆ ì•„ë˜'ì— ìˆëŠ” ë‹¤ë¦¬ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒ ì°¾ê¸°
            if (entryY > currentY + 1) { // +1ì€ ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€
                const dist = entryY - currentY;
                if (dist < minDist) {
                    minDist = dist;
                    validBridge = { line, entryY };
                }
            }
        });

        // ë” ì´ìƒ íƒˆ ë‹¤ë¦¬ê°€ ì—†ìœ¼ë©´ ë°”ë‹¥ìœ¼ë¡œ ì§í–‰
        if (!validBridge) {
            pathPoints.push({ x: this.getLadderX(currentCol), y: 950 });
            break;
        }

        // ë‹¤ë¦¬ íƒ€ê¸°
        const { line, entryY } = validBridge;

        // 1. ìˆ˜ì§ ì´ë™ (ë‹¤ë¦¬ ì…êµ¬ê¹Œì§€)
        pathPoints.push({ x: this.getLadderX(currentCol), y: entryY });
        currentY = entryY;

        // 2. ìˆ˜í‰ ì´ë™ (ë‹¤ë¦¬ ê±´ë„ˆê¸°)
        if (line.col === currentCol) {
            // ì™¼ìª½ -> ì˜¤ë¥¸ìª½ ì´ë™
            currentCol++;
            const exitY = line.y + line.slant; // ë„ì°© ë†’ì´
            pathPoints.push({ x: this.getLadderX(currentCol), y: exitY });
            currentY = exitY;
        } else {
            // ì˜¤ë¥¸ìª½ -> ì™¼ìª½ ì´ë™
            currentCol--;
            const exitY = line.y; // ë„ì°© ë†’ì´ (ì™¼ìª½ì€ slant ì—†ìŒ)
            pathPoints.push({ x: this.getLadderX(currentCol), y: exitY });
            currentY = exitY;
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ë„ì°© ì—´ ì¸ë±ìŠ¤ë¥¼ ì „ë‹¬)
    this.runSVGAnimation(pathPoints, currentCol, startColIdx); 
},
// (4) ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
// (4) ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ë„ì°©ìŒ ë¡œì§ ìˆ˜ì •ë¨)
runSVGAnimation(pathPoints, finalResultIdx, topIdx = null) {
    this.ballPos = { x: pathPoints[0].x, y: pathPoints[0].y, visible: true };
    this.activePolyline = `${pathPoints[0].x},${pathPoints[0].y}`;
    
    let currentPointIdx = 0;
    let progress = 0;
    const speed = 0.045;

    const animate = () => {
        if (currentPointIdx >= pathPoints.length - 1) {
            this.stopSound('move'); // ì´ë™ ì†Œë¦¬ ë„ê¸°

            // 1. í•˜ë‹¨ ê²°ê³¼ ê³µê°œ (ì •ë°©í–¥ íƒ€ê¸°: ìœ„->ì•„ë˜ ë„ì°© ì‹œ)
            if (finalResultIdx !== null && !this.revealedResults.includes(finalResultIdx)) {
                this.revealedResults.push(finalResultIdx);
                this.playSound('finish');
            }

            // 2. ìƒë‹¨ ì´ë¦„í‘œ ì²˜ë¦¬
            if (topIdx !== null) {
                // (1) ì•„ì§ ê³µê°œ ì•ˆ ëœ ìƒë‹¨ ì´ë¦„í‘œë¼ë©´ ë…¸ë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ê³µê°œ ëª©ë¡ ì¶”ê°€)
                if (!this.revealedStarts.includes(topIdx)) {
                    this.revealedStarts.push(topIdx);
                }

                // (2) â˜… [ìˆ˜ì •ë¨] ì—­ë°©í–¥(ì•„ë˜->ìœ„) íƒ€ê¸°ì¸ ê²½ìš°, ë¬´ì¡°ê±´ ë„ì°© íš¨ê³¼ìŒ ì¬ìƒ
                // finalResultIdxê°€ nullì´ë¼ëŠ” ê²ƒì€ ì—­ë°©í–¥ ì£¼í–‰ì„ ì˜ë¯¸í•¨
                if (finalResultIdx === null) {
                    this.playSound('finish');
                }
            }
            
            this.isLadderAnimating = false;
            this.ballHideTimeout = setTimeout(() => { 
                this.ballPos.visible = false; 
            }, 1000);
            return;
        }

        progress += speed;
        if (progress >= 1) {
            progress = 0;
            currentPointIdx++;
            const p = pathPoints[currentPointIdx];
            
            // ì„  ê·¸ë¦¬ê¸°
            this.activePolyline += ` ${p.x},${p.y}`;
            
            // ê³µ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            this.ballPos.x = p.x;
            this.ballPos.y = p.y;
        } else {
            // ì ê³¼ ì  ì‚¬ì´ ë¶€ë“œëŸ¬ìš´ ì´ë™ (Interpolation)
            const p1 = pathPoints[currentPointIdx];
            const p2 = pathPoints[currentPointIdx + 1];
            this.ballPos.x = p1.x + (p2.x - p1.x) * progress;
            this.ballPos.y = p1.y + (p2.y - p1.y) * progress;
        }
        requestAnimationFrame(animate);
    };
    requestAnimationFrame(animate);
},
// (5) ì „ì²´ ê³µê°œ
revealAllLadders() {
    // 1. ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨ ë° ì‹œê°ì  ì´ˆê¸°í™”
    this.isLadderAnimating = false;
    this.ballPos.visible = false;
    this.activePolyline = '';
    
    // 2. í•˜ë‹¨ ì´ë¦„í‘œ ëª¨ë‘ ê³µê°œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    this.revealedResults = this.ladderStudents.map((_, i) => i);

    // 3. [ì¶”ê°€] ì‚¬ë‹¤ë¦¬ ê²½ë¡œë¥¼ ë¡œì§ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    if (this.ladderStudents.length > 0 && this.ladderResults.length > 0) {
        this.ladderFinalList = this.ladderStudents.map((studentName, startIdx) => {
            // ì‹œì‘ì (startIdx)ì—ì„œ ì¶œë°œí•˜ì—¬ ë„ì°©ì (endIdx) ê³„ì‚°
            const endIdx = this.calculateLadderPath(startIdx);
            const resultText = this.ladderResults[endIdx] || 'ê²°ê³¼ ì—†ìŒ';
            
            // 'ê½', 'ê±¸ë¦¼', 'ë²Œì¹™' ë“±ì´ í¬í•¨ë˜ë©´ ë¶€ì •ì ì¸ ê²°ê³¼ë¡œ íŒë‹¨ (ë””ìì¸ìš©)
            const isBad = resultText.includes('ê½') || resultText.includes('ê±¸') || resultText.includes('ë²Œì¹™');

            return {
                rank: startIdx + 1,
                name: studentName,
                result: resultText,
                isBad: isBad
            };
        });

        // 4. ê²°ê³¼ ëª¨ë‹¬ ì—´ê¸°
        this.showLadderResultModal = true;
    }
},



// [ì¶”ê°€] ì‚¬ë‹¤ë¦¬ ê²½ë¡œ ê³„ì‚° ë¡œì§ (ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ê²°ê³¼ ì‚°ì¶œ)
calculateLadderPath(startCol) {
    let col = startCol;
    // ì‚¬ë‹¤ë¦¬ ê°€ë¡œì„ ë“¤ì„ Yì¢Œí‘œ(ìœ„->ì•„ë˜) ìˆœì„œë¡œ ì •ë ¬í•˜ì—¬ ìˆœíšŒ
    const sortedLines = [...this.ladderLines].sort((a, b) => a.y - b.y);
    
    for (const line of sortedLines) {
        // í˜„ì¬ ë‚´ ìœ„ì¹˜(col)ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ëŠ” ë‹¤ë¦¬ê°€ ìˆëŠ” ê²½ìš°
        if (line.col === col) {
            col++;
        } 
        // í˜„ì¬ ë‚´ ìœ„ì¹˜(col)ë¡œ ì™¼ìª½ì—ì„œ ì˜¤ëŠ” ë‹¤ë¦¬ê°€ ìˆëŠ” ê²½ìš°
        else if (line.col === col - 1) {
            col--;
        }
    }
    return col; // ìµœì¢… ë„ì°© ì—´(Index) ë°˜í™˜
},

initializeLotteryPool(mode) {
        // í˜„ì¬ ë“±ë¡ëœ ëª¨ë“  í•™ìƒ ê°€ì ¸ì˜¤ê¸° (computed í™œìš©)
        const students = this.allStudents;

        if (!students || students.length === 0) return; 

        let targetNames = [];

        if (mode === 'all') {
            targetNames = students.map(s => s.name);
        } else {
            // ì„±ë³„ í•„í„°ë§
            targetNames = students
                .filter(s => s.gender === mode)
                .map(s => s.name);
        }
        
        // ë°ì´í„° ì§‘ì–´ë„£ê¸°
        this.lotteryPools[mode] = targetNames;
        
        // ì´ˆê¸°í™”í–ˆìœ¼ë¯€ë¡œ í•´ë‹¹ ëª¨ë“œì˜ ë‹¹ì²¨ì ê¸°ë¡ë„ ë¦¬ì…‹ (ì„ íƒì‚¬í•­: ì›í•˜ì‹œë©´ ì£¼ì„ ì²˜ë¦¬)
        this.lastWinners[mode] = null;
        
        // í˜„ì¬ ë³´ê³  ìˆëŠ” ëª¨ë“œë¥¼ ì´ˆê¸°í™”í–ˆë‹¤ë©´ í™”ë©´ë„ '?'ë¡œ ë³€ê²½
        if (this.lotteryMode === mode) {
            this.displayWinner = '?';
        }

        this.saveToLocal();
    },

// ë½‘ê¸° ë§ˆìŠ¤í„° ëª¨ë‹¬ ì—´ê¸° (ì¢Œì¸¡ í•˜ë‹¨ ë²„íŠ¼ìš©)
    openPickerMaster() {
    this.showPickerMaster = true;
    this.focusWindow('picker'); // â˜… ì¶”ê°€
    this.pickerTab = 'lottery'; 
},

   // ì°¸ê°€ì ëª¨ë“œ ë³€ê²½ (ì „ì²´ / ì„ íƒ)
        setLadderPeopleMode(mode) {
            this.ladderPeopleMode = mode;
            if (mode === 'select') {
                this.openStudentSelectModal();
            } else {
                this.ladderStudents = this.allStudents.map(s => s.name);
            }
        },

        // í•™ìƒ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
        openStudentSelectModal() {
            this.selectedStudents = [...this.ladderStudents]; // ê¸°ì¡´ ì„ íƒ ë³µì‚¬
            this.updateSelectAllState(); // ì „ì²´ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            this.showStudentSelectModal = true;
        },

        // í•™ìƒ ê°œë³„ ì„ íƒ í† ê¸€
        toggleStudentSelection(name) {
            const idx = this.selectedStudents.indexOf(name);
            if (idx === -1) this.selectedStudents.push(name);
            else this.selectedStudents.splice(idx, 1);
            this.updateSelectAllState();
        },

        // ì „ì²´ ì„ íƒ í† ê¸€
        toggleSelectAllStudents() {
            if (this.isSelectAllStudents) {
                this.selectedStudents = this.allStudents.map(s => s.name);
            } else {
                this.selectedStudents = [];
            }
        },

        // ì „ì²´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„ íƒ ìˆ˜ì— ë”°ë¼ ìë™ ì²´í¬/ì–¸ì²´í¬)
        updateSelectAllState() {
            this.isSelectAllStudents = this.selectedStudents.length === this.allStudents.length;
        },

        // í•™ìƒ ì„ íƒ í™•ì¸ (ëª¨ë‹¬ ë‹«ê¸° + ladderStudents ì—…ë°ì´íŠ¸)
        confirmStudentSelection() {
            this.ladderStudents = [...this.selectedStudents];
            this.showStudentSelectModal = false;
            this.generateLadder(); // ì„ íƒ í›„ ì‚¬ë‹¤ë¦¬ ìƒì„± (í•„ìš” ì‹œ)
        },

    // ëª¨ë‹¬ ë“œë˜ê·¸
    startPickerDrag(e) {
    if (e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea')) return;
    if (this.isPickerMaximized) return;

    this.isInteracting = true; // â˜… ì• ë‹ˆë©”ì´ì…˜ ë„ê¸° ì‹œì‘

    const startMouseX = e.clientX;
    const startMouseY = e.clientY;
    const initialX = this.pickerX;
    const initialY = this.pickerY;

    let animationFrameId = null;

    const mv = (ev) => {
        ev.preventDefault();
        if (animationFrameId) return;

        animationFrameId = requestAnimationFrame(() => {
            const deltaX = ev.clientX - startMouseX;
            const deltaY = ev.clientY - startMouseY;
            const maxX = window.innerWidth - this.pickerW;
            const maxY = window.innerHeight - this.pickerH;

            this.pickerX = Math.max(0, Math.min(initialX + deltaX, maxX));
            this.pickerY = Math.max(0, Math.min(initialY + deltaY, maxY));

            animationFrameId = null;
        });
    };

    const mu = () => {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        
        this.isInteracting = false; // â˜… ì• ë‹ˆë©”ì´ì…˜ ë‹¤ì‹œ ì¼œê¸°
        this.saveToLocal();
    };

    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},

// 2. [ìµœì í™”] í¬ê¸° ì¡°ì ˆ (ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë„ê¸°)
startPickerResize(e) {
    this.focusWindow('picker'); // â˜… ì¶”ê°€
    e.preventDefault();
    e.stopPropagation();
    this.isInteracting = true;
    const startX = e.clientX;
    const startY = e.clientY;
    const startW = this.pickerW;
    const startH = this.pickerH;
    let animationFrameId = null;
    const mv = (ev) => {
        ev.preventDefault();
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        animationFrameId = requestAnimationFrame(() => {
            const deltaX = ev.clientX - startX;
            const deltaY = ev.clientY - startY;
            const maxW = window.innerWidth - this.pickerX;
            const maxH = window.innerHeight - this.pickerY;
            this.pickerW = Math.max(600, Math.min(startW + deltaX, maxW));
            this.pickerH = Math.max(500, Math.min(startH + deltaY, maxH));
            animationFrameId = null;
        });
    };
    const mu = () => {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        document.removeEventListener('mousemove', mv, { passive: true });
        document.removeEventListener('mouseup', mu);
        this.isInteracting = false;
        this.saveToLocal();
    };
    document.addEventListener('mousemove', mv, { passive: true });
    document.addEventListener('mouseup', mu);
},updateClock() {
    const now = new Date();
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    this.currentDate = `${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ (${days[now.getDay()]})`;
    let rawHour = now.getHours();
    const hour12 = rawHour % 12 || 12;
    const h = String(hour12).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    
    // ë¯¸ë‹ˆ ì‹œê³„ìš© (ì´ˆ ì—†ì´)
    this.miniTime = `${h}:${m}`;
    
    // ì „ì²´ í™”ë©´ìš© : ë¶„ê³¼ ì´ˆ ì‚¬ì´ì— ì (.)ìœ¼ë¡œ êµ¬ë¶„
    this.currentTime = `${h}:${m}.${s}`;
    
    // ì´ˆë§Œ ë”°ë¡œ (í•„ìš” ì‹œ ì‚¬ìš©)
    this.currentSeconds = s;
},
focusWindow(target) {
    this.currentMaxZ++; // í´ë¦­í•  ë•Œë§ˆë‹¤ ë²ˆí˜¸ ì¦ê°€ (ë§¨ ì•ìœ¼ë¡œ)
    
    if (target === 'board') this.boardZ = this.currentMaxZ;
    else if (target === 'timer') {
        if (!this.isTimerMaximized) this.timerZ = this.currentMaxZ;
    }
    else if (target === 'picker') {
        if (!this.isPickerMaximized) this.pickerZ = this.currentMaxZ;
    }
    else if (target === 'noise') {
        if (!this.isNoiseMaximized) this.noiseZ = this.currentMaxZ;
    }
    else if (target === 'ladderResult') {
        this.ladderResultZ = this.currentMaxZ;
    }
},
syncInputToTime() { 
    const min = parseInt(this.inputMin) || 0;
    const sec = parseInt(this.inputSec) || 0;
    this.timerSeconds = (min * 60) + sec; 
    this.isStopwatchMode = false;
},

syncTimeToInput() {
                if (this.isStopwatchMode) {
                    // [ìŠ¤í†±ì›Œì¹˜] ë¶„(1ìë¦¬):ì´ˆ(2ìë¦¬).ë°€ë¦¬ì´ˆ(1ìë¦¬)
                    // ê¸°ì¡´ì— ë”°ë¡œ ë†€ë˜ ë°€ë¦¬ì´ˆ(ms)ë¥¼ ì´ˆ(secs) ë’¤ì— ì (.)ê³¼ í•¨ê»˜ ë¶™ì˜€ìŠµë‹ˆë‹¤.
                    const totalDs = Math.floor(this.timerSeconds * 10);
                    const mins = Math.floor(totalDs / 600);
                    const secs = Math.floor((totalDs % 600) / 10);
                    const ms = totalDs % 10;
                    
                    this.inputMin = String(mins); 
                    this.inputSec = String(secs).padStart(2, '0') + "." + ms; // ì´ˆ+ì +ë°€ë¦¬ì´ˆ í†µí•©
                } else {
                    // [íƒ€ì´ë¨¸] ë¶„(2ìë¦¬):ì´ˆ(2ìë¦¬)
                    const m = Math.floor(this.timerSeconds / 60);
                    const s = Math.floor(this.timerSeconds % 60);
                    this.inputMin = String(m).padStart(2, '0');
                    this.inputSec = String(s).padStart(2, '0');
                }
            },

adjustTimer(v) { 
    this.focusWindow('timer'); // â˜… ì¶”ê°€
    this.isStopwatchMode = false; 
    let newSeconds = this.timerSeconds + v;
    if (newSeconds < 0) newSeconds = 0;
    
    this.timerSeconds = newSeconds;
    this.syncTimeToInput();

    if (this.timerInterval) {
        this.timerTargetTime = Date.now() + (this.timerSeconds * 1000);
    }
    if (!this.timerInterval) this.saveToLocal();
},
updateRunningTimer() {
    // í˜„ì¬ ì‘ë™ ë°©ì‹ì´ ëª©í‘œì‹œê°„(StartTime)ì—ì„œ í˜„ì¬ì‹œê°„ì„ ë¹¼ëŠ” ë°©ì‹ì´ë¯€ë¡œ,
    // ìƒˆë¡œìš´ timerSecondsì— ë§ì¶° ëª©í‘œì‹œê°„ì„ ë‹¤ì‹œ ê³„ì‚°í•©ë‹ˆë‹¤.
    this.startTime = Date.now() + (this.timerSeconds * 1000);
},

onTimerInput() {
    this.inputMin = this.inputMin.replace(/[^0-9]/g, '').slice(0, 2);
    this.inputSec = this.inputSec.replace(/[^0-9]/g, '').slice(0, 2);
    
    const min = parseInt(this.inputMin) || 0;
    const sec = parseInt(this.inputSec) || 0;
    this.timerSeconds = (min * 60) + sec;

    // íƒ€ì´ë¨¸ê°€ ì‘ë™ ì¤‘ì¼ ë•Œ ëª©í‘œ ì‹œê°„ì„ ìƒˆ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    if (this.timerInterval) {
        this.timerTargetTime = Date.now() + (this.timerSeconds * 1000);
    }
},
toggleTimer() {
    if (this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
    } else {
        if (!this.userSelectedMode) {
            this.syncInputToTime();
            this.isStopwatchMode = (this.timerSeconds === 0);
            this.userSelectedMode = this.isStopwatchMode ? 'stopwatch' : 'timer';
        }
        const now = Date.now();
        if (this.isStopwatchMode) {
            this.timerTargetTime = now - (this.timerSeconds * 1000);
        } else {
            this.timerTargetTime = now + (this.timerSeconds * 1000);
        }

        this.timerInterval = setInterval(() => {
            const currentNow = Date.now();
            if (this.isStopwatchMode) {
                this.timerSeconds = (currentNow - this.timerTargetTime) / 1000;
            } else {
                const remaining = (this.timerTargetTime - currentNow) / 1000;
                
                // [ì†Œë¦¬ ì¶”ê°€] 10ì´ˆ ì´í•˜ì¼ ë•Œ ê²½ê³ ìŒ
                if (remaining <= 10 && remaining > 0) {
                     // 1ì´ˆì— í•œ ë²ˆì”© ìš¸ë¦¬ê²Œ í•˜ë ¤ë©´ ì •ìˆ˜ ì²´í¬ í•„ìš”í•˜ì§€ë§Œ, 
                     // ê°„ë‹¨í•˜ê²Œ ì‚- ì†Œë¦¬ ë°˜ë³µì„ ìœ„í•´ ì• ë‹ˆë©”ì´ì…˜ê³¼ ì‹±í¬ ë§ì¶¤
                     // ì—¬ê¸°ì„œëŠ” ë¸Œë¼ìš°ì € ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ë³„ë„ ì²˜ë¦¬ ì—†ì´ ì‹œê° íš¨ê³¼ì™€ í•¨ê»˜ ìì—°ìŠ¤ëŸ½ê²Œ ë‘¡ë‹ˆë‹¤.
                     // (í•„ìš” ì‹œ playSound í˜¸ì¶œ ê°€ëŠ¥)
                }

                if (remaining <= 0) {
                    this.timerSeconds = 0;
                    this.handleExplosion();
                    return;
                }
                this.timerSeconds = remaining;
            }
            this.syncTimeToInput();
        }, 50);
    }
},

updateCountdownEffect() {
    const el = document.querySelector('.bomb-window');
    if (!el) return;
    const speed = Math.max(0.2, (this.timerSeconds / 60) * 1); 
    el.style.setProperty('--beat-speed', speed + 's');
    el.style.setProperty('--glow-color', 'rgba(255, 0, 0, 0.6)');
},

// ìŠ¤í†±ì›Œì¹˜: ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë³´ë¼ìƒ‰ì—ì„œ íŒŒë€ìƒ‰ìœ¼ë¡œ (ì•ˆì •ê°)
updateStopwatchEffect() {
    const el = document.querySelector('.bomb-window');
    if (!el) return;
    const ratio = Math.min(1, this.timerSeconds / 120); 
    const color = ratio > 0.5 ? '#3b82f6' : '#a855f7';
    el.style.setProperty('--stopwatch-color', color);
},

startTimerDrag(e) {
    if (this.isTimerMaximized) return;
    if (e.target.tagName === 'INPUT' || e.target.closest('button')) return;

    e.preventDefault(); 
    const el = e.currentTarget;
    el.style.transition = 'none';

    const startMouseX = e.clientX;
    const startMouseY = e.clientY;
    const startWinX = this.timerX;
    const startWinY = this.timerY;

    // íƒ€ì´ë¨¸ í˜„ì¬ í¬ê¸° ê³„ì‚°
    const boxW = this.timerSize;
    const boxH = this.timerSize * 0.633;

    const mv = (ev) => {
        ev.preventDefault();

        const winW = window.innerWidth;
        const winH = window.innerHeight;

        const deltaX = ev.clientX - startMouseX;
        const deltaY = ev.clientY - startMouseY;

        let newX = startWinX + deltaX;
        let newY = startWinY + deltaY;

        // [ìˆ˜ì •ë¨] í™”ë©´ ë°–ìœ¼ë¡œ ì ˆëŒ€ ë‚˜ê°€ì§€ ëª»í•˜ê²Œ ì œí•œ (Strict Limit)
        
        // 1. ê°€ë¡œ ì œí•œ (0 ~ í™”ë©´ë„ˆë¹„-ì°½ë„ˆë¹„)
        const minX = -10;              
        const maxX = winW - boxW;    

        // 2. ì„¸ë¡œ ì œí•œ (0 ~ í™”ë©´ë†’ì´-ì°½ë†’ì´)
        const minY = 0;              
        const maxY = winH - boxH;    

        // ì¢Œí‘œ ì ìš© (Math.max, Math.minì„ í†µí•´ ë²”ìœ„ ì•ˆì— ê°€ë‘ )
        this.timerX = Math.max(minX, Math.min(newX, maxX));
        this.timerY = Math.max(minY, Math.min(newY, maxY));
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        
        el.style.transition = '';
        this.saveToLocal(); 
    };

    document.addEventListener('mousemove', mv, { passive: false });
    document.addEventListener('mouseup', mu);
},

startTimerResize(e) {
    this.focusWindow('timer');
    e.stopPropagation();
    e.preventDefault(); 

    const startX = e.clientX;
    const startSize = this.timerSize; 
    let animationFrameId = null;

    const mv = (ev) => {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(() => {
            const deltaX = ev.clientX - startX;
            let newWidth = Math.max(300, startSize + deltaX); 
            
            // í™”ë©´ ë„ˆë¹„ ë“± ë¹„ìœ¨ ì œí•œ ë¡œì§
            const initialW = 600; 
            const initialH = 380; 
            const aspectRatio = initialH / initialW;
            const maxW = window.innerWidth - this.timerX;
            const maxH = window.innerHeight - this.timerY;

            if (newWidth > maxW) newWidth = maxW;
            if (newWidth * aspectRatio > maxH) newWidth = maxH / aspectRatio;

            this.timerSize = newWidth;
            animationFrameId = null; 
            // âŒ ì—¬ê¸°ì— ìˆë˜ this.saveToLocal() ì‚­ì œ (ë ‰ ìœ ë°œ ì›ì¸)
        });
    };
   const mu = () => {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        
        // âœ… [ì¤‘ìš”] ë§ˆìš°ìŠ¤ë¥¼ ë—ì„ ë•Œ ë”± í•œ ë²ˆ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
        this.saveToLocal(); 
    };

    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},
resetTimer() {
                if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; }
                this.timerSeconds = 0;
                this.inputMin = "00";
                this.inputSec = "00";
                this.userSelectedMode = null;
                this.isStopwatchMode = false;
                this.isExploding = false;
                const el = document.querySelector('.bomb-window');
                if (el) el.style.setProperty('--glow-color', 'rgba(255, 0, 0, 0.5)');
                this.syncTimeToInput();
                this.saveToLocal();
            },

handleExplosion() { 
    clearInterval(this.timerInterval); 
    this.timerInterval = null; 
    this.showTimer = false; 
    this.isExploding = true; 
    this.playSound('explode', false, 1.0); // [ì†Œë¦¬ ì¶”ê°€] í­ë°œìŒ
    setTimeout(() => { 
        this.isExploding = false; 
        this.timerSeconds = 0; 
        this.syncTimeToInput(); 
    }, 1500); 
},
    /* ì£¼ì¸ê³µ ì¶”ì²¨ ì°½ ë“œë˜ê·¸ ë¡œì§ */
startLotteryDrag(e) {
    if(e.target.closest('button')) return;
    if(this.isLotteryMaximized) return;

    const startMouseX = e.clientX;
    const startMouseY = e.clientY;
    const initialX = this.lotteryX;
    const initialY = this.lotteryY;

    const mv = (ev) => {
        const maxX = window.innerWidth - this.lotteryW;
        const maxY = window.innerHeight - this.lotteryH;

        this.lotteryX = Math.max(0, Math.min(initialX + (ev.clientX - startMouseX), maxX));
        this.lotteryY = Math.max(0, Math.min(initialY + (ev.clientY - startMouseY), maxY));
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},

/* ì£¼ì¸ê³µ ì¶”ì²¨ ì°½ ë¦¬ì‚¬ì´ì¦ˆ ë¡œì§ */
startLotteryResize(e) {
    e.preventDefault();
    const startX = e.clientX;
    const initialW = this.lotteryW;
    const initialH = this.lotteryH;
    const aspectRatio = initialH / initialW; // í˜„ì¬ ë¹„ìœ¨ ì €ì¥

    const mv = (ev) => {
    const deltaX = ev.clientX - startX;
    
    // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ìµœëŒ€ë¡œ ì»¤ì§ˆ ìˆ˜ ìˆëŠ” ë„ˆë¹„ ê³„ì‚°
    const maxAllowedW = window.innerWidth - this.lotteryX;
    const maxAllowedH = window.innerHeight - this.lotteryY;
    
    // ê°€ë¡œ ë„ˆë¹„ ê¸°ì¤€ ì œí•œ
    let newW = Math.max(350, initialW + deltaX);
    
    // ê°€ë¡œ/ì„¸ë¡œ ì¤‘ ë¨¼ì € í™”ë©´ ëì— ë‹¿ëŠ” ìª½ì— ë§ì¶° ë„ˆë¹„ ì œí•œ
    if (newW > maxAllowedW) newW = maxAllowedW;
    if (newW * aspectRatio > maxAllowedH) newW = maxAllowedH / aspectRatio;

    this.lotteryW = newW;
    this.lotteryH = newW * aspectRatio;
};
    
    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal(); // í¬ê¸° ì €ì¥
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},
updateZoomDirect(e) {
                let val = parseFloat(e.target.innerText.replace('%', '')) / 100;
                if (!isNaN(val)) this.boardZoom = Math.min(Math.max(0.5, val), 10.0);
                e.target.innerText = Math.round(this.boardZoom * 100) + '%';
            },
            startZoom(delta) {
    this.focusWindow('board'); // â˜… ì¶”ê°€
    this.stopZoom();
    this.changeZoom(delta);
    this.zoomTimer = setInterval(() => { this.changeZoom(delta); }, 100);
},
            stopZoom() { if (this.zoomTimer) { clearInterval(this.zoomTimer); this.zoomTimer = null; } },
           changeZoom(delta) {
                this.boardZoom = Math.min(Math.max(0.5, this.boardZoom + delta), 10.0);
            },
   

// ìº¡ìŠ ë½‘ê¸° ì´ˆê¸°í™” (íƒ­ ì „í™˜ ë˜ëŠ” ëª¨ë‹¬ ì—´ ë•Œ í˜¸ì¶œ)
   initCapsules() {
    // 1. ì „ì²´ í•™ìƒ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
    const rawList = [...this.seats.filter(s => s), ...this.waitingRoom];
    
    // 2. ì¤‘ë³µ ì œê±°
    const uniqueMap = new Map();
    rawList.forEach(s => {
        if (s && s.name && s.name.trim() !== '') {
            uniqueMap.set(s.name, s);
        }
    });
    const students = Array.from(uniqueMap.values());

    // 3. ëª…ë‹¨ í™•ì¸
    if (students.length === 0) {
        this.capsules = [];
        this.capsuleRevealedCount = 0;
        alert("í•™ìƒ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤! ëª…ë‹¨ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 4. ëœë¤ ì„ê¸°
    for (let i = students.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [students[i], students[j]] = [students[j], students[i]];
    }

    // 5. ìº¡ìŠ ë°°ì—´ ìƒì„± (isPopping ì œê±°ë¨)
    this.capsules = students.map((student, index) => ({
        id: index,
        student: { name: student.name, gender: student.gender },
        revealed: false // ì´ˆê¸°ì—” ë‹«íŒ ìƒíƒœ
    }));
    
    this.capsuleRevealedCount = 0;
},

    // ê°œë³„ ìº¡ìŠ ë’¤ì§‘ê¸°
    toggleCapsule(id) {
    const capsule = this.capsules.find(c => c.id === id);
    if (capsule) {
        capsule.revealed = !capsule.revealed;
        this.saveToLocal(); // â˜… ì €ì¥ ì¶”ê°€
    }
},

    // ëª¨ë‘ ê³µê°œ
   revealAllCapsules() {
        this.capsules.forEach(c => c.revealed = true);
        this.capsuleSwitchState = 'open'; // ìƒíƒœ ë™ê¸°í™”
        this.saveToLocal(); 
    },

    // [ìˆ˜ì •] ëª¨ë‘ ë‹«ê¸°
    closeAllCapsules() {
        this.capsules.forEach(c => c.revealed = false);
        this.capsuleSwitchState = 'closed'; // ìƒíƒœ ë™ê¸°í™”
        this.saveToLocal(); 
    },

// [ì‹ ê·œ] ìŠ¤ìœ„ì¹˜ í† ê¸€ í•¨ìˆ˜
    toggleCapsuleSwitch() {
        if (this.capsuleSwitchState === 'closed') {
            this.revealAllCapsules();
        } else {
            this.closeAllCapsules();
        }
    },
       // ìº¡ìŠ ì„ê¸° (ìœ„ì¹˜ ì¬ë°°ì¹˜ + chaos íš¨ê³¼)
    shuffleCapsules() {
        if (this.isShuffling) return;
        this.isShuffling = true;
        
        // ì„ì„ ë•ŒëŠ” ì‹œê°ì ìœ¼ë¡œ ë‹«í˜ ìƒíƒœë¡œ ë³´ì„
        this.capsuleSwitchState = 'closed'; 

        // 1. ìˆœì°¨ì ìœ¼ë¡œ í•˜ë‚˜ì”© ì•ë©´ìœ¼ë¡œ ë’¤ì§‘ê¸°
        this.capsules.forEach((c, index) => {
            setTimeout(() => {
                c.revealed = false; 
            }, index * 30); 
        });

    // 2. ëª¨ë“  ì¹´ë“œê°€ ë’¤ì§‘íˆëŠ” ì‹œê°„ì„ ê³„ì‚°í•´ì„œ ê¸°ë‹¤ë¦° í›„ ë°ì´í„° ì„ê¸°
    const totalDelay = this.capsules.length * 30 + 500; // ì „ì²´ ì‹œê°„ + ì—¬ìœ  ì‹œê°„

    setTimeout(() => {
        // ë°ì´í„° ì‹¤ì œ ì„ê¸° (Fisher-Yates Shuffle)
        for (let i = this.capsules.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.capsules[i], this.capsules[j]] = [this.capsules[j], this.capsules[i]];
        }
        
        this.isShuffling = false;
    }, totalDelay);
},

    // íƒ­ ì „í™˜ ë©”ì„œë“œ ìˆ˜ì • (capsule íƒ­ì¼ ë•Œ ì´ˆê¸°í™” ì¶”ê°€)
    setPickerTab(tab) {
    this.pickerTab = tab;
    if (tab === 'capsule') {
        if (!this.capsules || this.capsules.length === 0) {
            this.initCapsules();  // â˜… ìˆ˜ì •: í•­ìƒ í˜¸ì¶œ (ë°ì´í„° ìµœì‹ í™”)
         }
    }
    
    if (tab === 'roulette') {
        if (this.rouletteItems.length === 0) {
            this.rouletteInput = "1\n2\n3\n4\n5\n6";
        }
    }
    
    // ì‚¬ë‹¤ë¦¬ ì´ˆê¸°í™”
    if (tab === 'ladder') {
        this.showLadderGame = false;
        this.$nextTick(this.resizeLadderCanvas);
    }
},

// [ìˆ˜ì •] í˜„ì¬ ìë¦¬ë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
            saveCurrentLayoutToHistory() {
    const pureLayoutSnapshot = this.seats.map(s => {
        if (s && s.name) {
            return {
                name: s.name, number: s.number, gender: s.gender,
                activityScore: 0, checked: false, order: null, memo: "", starred: false
            };
        }
        return null;
    });

    const now = new Date();
    const dateStr = `${now.getMonth() + 1}/${now.getDate()}`;
    
    // [ìˆ˜ì •] this.mode -> this.shuffleModeë¡œ ë³€ê²½í•˜ì—¬ ëª¨ë“œê°€ ì •í™•íˆ ì €ì¥ë˜ê²Œ í•¨
    const currentMode = this.shuffleMode === 'mixed' ? 'ì´ì„±' : (this.shuffleMode === 'same' ? 'ë™ì„±' : 'ëœë¤');

    this.shuffleHistory.unshift({
        id: Date.now(),
        date: dateStr,
        mode: currentMode, // ìˆ˜ì •ë¨
        seats: JSON.parse(JSON.stringify(this.seats))
    });
    
    this.saveToLocal();
    alert("í˜„ì¬ ë°°ì¹˜ê°€ ê¸°ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾\n(ë‹¤ìŒ ìë¦¬ ë°°ì¹˜ ì‹œ ì´ ì§ê¿ë“¤ì€ í”¼í•˜ê²Œ ë©ë‹ˆë‹¤)");
},


            saveToFirebase() {

// 1. ë™ë¬¼ ë‹¬ë¦¬ê¸° í˜„ì¬ ìƒíƒœ ìŠ¤ëƒ…ìƒ· (ë‹¬ë¦¬ëŠ” ë„ì¤‘ì—ë„ ì €ì¥ë˜ë„ë¡)
const currentAnimalRunners = this.animalRunners ? this.animalRunners.map(r => ({
        pos: r.pos || 0, state: r.state || 'run', finished: r.finished || false, 
        speed: r.speed || 0, timer: r.timer || 0, id: r.id || 0, name: r.name || '', 
        avatar: r.avatar || '', finishRank: r.finishRank || 0, finishTime: r.finishTime || 0, isGold: r.isGold || false
    })) : [];

   const dataToSave = {
currentView: this.view,
isRotated: this.isRotated,
capsules: this.capsules,
                    seats: this.seats, 
                    waitingRoom: this.waitingRoom, 
                    seatConfig: this.seatConfig, 
                    manualLocks: this.manualLocks,
                    groups: this.groups, 
                    separationPairs: this.separationPairs,
                    shuffleHistory: this.shuffleHistory, 
                    savedBoards: this.savedBoards, 
                    savedRoulettes: this.savedRoulettes, 
                    lotteryPools: this.lotteryPools, 
                    lastWinners: this.lastWinners,
                    lotteryMode: this.lotteryMode,
                    savedGroupings: this.savedGroupings, 
                    rouletteInput: this.rouletteInput,
                    blackboardContent: this.blackboardContent, 
                    groupingList: this.groupingList, 
                    animalRunners: currentAnimalRunners,
                    animalRaceResults: this.animalRaceResults,
                    animalRaceFinished: this.animalRaceFinished,
noiseLevels: this.noiseLevels,
statsWarningCount: this.statsWarningCount,
            statsPenaltyCount: this.statsPenaltyCount,
                    uiState: {
           timer: { x: this.timerX, y: this.timerY, size: this.timerSize, isMaximized: this.isTimerMaximized },
    board: { x: this.boardX, y: this.boardY, w: this.boardW, h: this.boardH, isMaximized: this.isMaximized },
    noise: { x: this.noiseX, y: this.noiseY, w: this.noiseW, h: this.noiseH, isMaximized: this.isNoiseMaximized },
    picker: { x: this.pickerX, y: this.pickerY, w: this.pickerW, h: this.pickerH, isMaximized: this.isPickerMaximized },
    raceSetup: { w: this.setupW, h: this.setupH }
        },
    
tournamentData: {
            tree: this.visibleBracketTree,       // ëŒ€ì§„í‘œ ì „ì²´ ë°ì´í„°
            winner: this.finalWinner,            // ìµœì¢… ìš°ìŠ¹ì
            mode: this.selectedBracketMode,      // ì„ íƒëœ ëª¨ë“œ (8ê°•/16ê°• ë“±)
            left: this.leftSideBracket,          // (ì¤‘ìš”) ì™¼ìª½ ë°°ì¹˜ ë°ì´í„°
            right: this.rightSideBracket         // (ì¤‘ìš”) ì˜¤ë¥¸ìª½ ë°°ì¹˜ ë°ì´í„°
       }
    };

                set(ref(db, DB_KEY), dataToSave)
                    .then(() => console.log("ë°ì´í„° ì €ì¥ ì™„ë£Œ"))
                    .catch((error) => console.error("ì €ì¥ ì‹¤íŒ¨:", error));
            },
            saveToLocal() { 
                if (this.saveTimeout) clearTimeout(this.saveTimeout); 
                this.saveTimeout = setTimeout(() => { this.saveToFirebase(); }, 1000); 
            },
            loadFromFirebase() {
    const dbRef = ref(db);
    get(child(dbRef, DB_KEY)).then((snapshot) => {
        if (snapshot.exists()) {
            const parsed = snapshot.val();
            
            // 1. [ê¸°ë³¸ ë·° & íšŒì „ ìƒíƒœ ë³µêµ¬]
            this.view = parsed.currentView || 'main';
            this.isRotated = parsed.isRotated || false;
setTimeout(() => {
    const ww = window.innerWidth;
    const wh = window.innerHeight;
    const boxW = this.timerSize || 400;
    const boxH = boxW * 0.633;

    // 1. ì €ì¥ëœ ìœ„ì¹˜ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì¤‘ì•™
    if (this.timerX === null || isNaN(this.timerX) || this.timerY === null || isNaN(this.timerY)) {
        this.timerX = (ww / 2) - (boxW / 2);
        this.timerY = (wh / 2) - (boxH / 2);
    } 
    // 2. ì €ì¥ëœ ìœ„ì¹˜ê°€ ìˆì§€ë§Œ í™”ë©´ ë°–ìœ¼ë¡œ 'ì™„ì „íˆ' ì‚¬ë¼ì§„ ê²½ìš° êµ¬ì¡°
    else {
        let needsRescue = false;

        if (this.timerX > ww) needsRescue = true;          // ì˜¤ë¥¸ìª½ ê°€ì¶œ
        if (this.timerX + boxW < 0) needsRescue = true;    // ì™¼ìª½ ê°€ì¶œ
        if (this.timerY > wh) needsRescue = true;          // ì•„ë˜ ê°€ì¶œ
        if (this.timerY + boxH < 0) needsRescue = true;    // ìœ„ë¡œ ê°€ì¶œ

        if (needsRescue) {
            this.timerX = (ww / 2) - (boxW / 2);
            this.timerY = (wh / 2) - (boxH / 2);
        }
        
        // [í•˜ë‹¨ ë°©ì–´] í•˜ë‹¨ì€ ì ˆëŒ€ ë„˜ì§€ ëª»í•˜ê²Œ í•œë²ˆ ë” Clamp (ë“œë˜ê·¸ ë¡œì§ê³¼ ë™ì¼)
        // í™”ë©´ ë°”ë‹¥(wh) - íƒ€ì´ë¨¸ ë†’ì´(boxH) ë³´ë‹¤ ì•„ë˜ì— ìˆìœ¼ë©´ ëŒì–´ì˜¬ë¦¼
        if (this.timerY + boxH > wh) {
            this.timerY = wh - boxH;
        }
    }

    // (ì†ŒìŒ ì¸¡ì •ê¸°ë„ ë™ì¼í•˜ê²Œ ì ìš© ê°€ëŠ¥)
    if (this.noiseX === null) this.noiseX = 100;
    if (this.noiseY === null) this.noiseY = 100;
    
}, 1000);

            // 2. [ì¢Œì„] ë°ì´í„° ë³µêµ¬ (ë°°ì—´ì´ ê°ì²´ë¡œ ë³€í™˜ë˜ëŠ” í˜„ìƒ ë°©ì–´)
            const rawSeats = parsed.seats || {};
const seatValues = Array.isArray(rawSeats) ? rawSeats : Object.values(rawSeats);  // â˜… ì¶”ê°€: ê°ì²´ â†’ ë°°ì—´ ë³€í™˜
this.seats = Array.from({length: 30}, (_, i) => {
    const s = seatValues[i] || null;  // â˜… ìˆ˜ì •: seatValues[i]
    if (s && s.name) {
        return {
            ...s,
            activityScore: s.activityScore || 0,
            checked: s.checked || false,
            memo: s.memo || "",
            starred: s.starred || false,
            order: s.order || null
        };
    }
    return null;
});

            // 3. [ëŒ€ê¸°ì‹¤] ë°ì´í„° ë³µêµ¬
            const rawWaiting = parsed.waitingRoom || [];
            const waitingList = Array.isArray(rawWaiting) ? rawWaiting : Object.values(rawWaiting);
            this.waitingRoom = waitingList.map(s => ({ 
                ...s, 
                activityScore: s.activityScore || 0, 
                checked: s.checked || false, 
                memo: s.memo || "", 
                starred: s.starred || false, 
                order: s.order || null 
            }));
            
            // 4. [ì„¤ì •ê°’] ë³µêµ¬
            this.seatConfig = parsed.seatConfig || Array(30).fill(null);
            this.manualLocks = parsed.manualLocks || [];
            this.separationPairs = parsed.separationPairs || [];
            this.blackboardContent = parsed.blackboardContent || '';

            // 5. [ëª¨ë‘ ] ë°ì´í„° ë³µêµ¬
            const rawGroups = parsed.groups || [];
            this.groups = Array(6).fill().map((_, i) => {
                const savedG = rawGroups[i] || {};
                return { 
                    score: savedG.score || 0, 
                    checked: savedG.checked || false, 
                    memo: savedG.memo || "", 
                    starred: savedG.starred || false, 
                    members: savedG.members || [], 
                    showMembers: savedG.showMembers || false 
                };
            });
            
            // ëª¨ë‘  í¸ì„± ì´ë ¥ ë³µêµ¬
            this.savedGroupings = parsed.savedGroupings || [];
            this.groupingList = parsed.groupingList || [];
            if (this.groupingList.length > 0) {
                this.tempGroupCount = this.groupingList.length;
                // í˜„ì¬ ê·¸ë£¹ì— ë©¤ë²„ ë™ê¸°í™”
                this.groupingList.forEach((members, idx) => { 
                    if (this.groups[idx]) this.groups[idx].members = members; 
                });
            }

// 1. ìº¡ìŠ ìƒíƒœ ë³µêµ¬
            if (parsed.capsules) {
                // Firebase íŠ¹ì„±ìƒ ë°°ì—´ì´ ê°ì²´ë¡œ ë³€í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°°ì—´ ë³€í™˜ ì²˜ë¦¬
                this.capsules = Array.isArray(parsed.capsules) ? parsed.capsules : Object.values(parsed.capsules);
            }

// 2. íƒ€ì´ë¨¸ ë° UI ì°½ ìœ„ì¹˜/í¬ê¸° ë³µêµ¬
           if (parsed.uiState && parsed.uiState.timer) {
    const t = parsed.uiState.timer;
    
    // [í•µì‹¬ ìˆ˜ì •] undefinedë‚˜ nullì´ ì•„ë‹ ë•Œë§Œ ìˆ«ìë¡œ ë³€í™˜
    // ê°’ì´ 0ì´ì–´ë„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    this.timerX = (t.x !== undefined && t.x !== null) ? Number(t.x) : null;
    this.timerY = (t.y !== undefined && t.y !== null) ? Number(t.y) : null;
    
    this.timerSize = Number(t.size) || 400;
    this.isTimerMaximized = !!t.isMaximized;
    
    console.log("ğŸ“ ì„œë²„ ì €ì¥ ìœ„ì¹˜ ë¡œë“œ:", this.timerX, this.timerY);
}

            // 6. [ë™ë¬¼ ë‹¬ë¦¬ê¸°] ë³µêµ¬
            const rawRunners = parsed.animalRunners || [];
            if (rawRunners && (Array.isArray(rawRunners) || Object.keys(rawRunners).length > 0)) {
                this.animalRunners = Array.isArray(rawRunners) ? rawRunners : Object.values(rawRunners);
                this.animalRaceResults = parsed.animalRaceResults || [];
                this.animalRaceFinished = parsed.animalRaceFinished || false;
            } else {
                this.animalRunners = Array(6).fill().map(() => ({ pos: 0, speed: 0, finished: false, state: 'run', timer: 0 }));
            }

            // 7. [ì´ë ¥ ë° ì €ì¥ ëª©ë¡] ë³µêµ¬
            this.shuffleHistory = parsed.shuffleHistory || [];
            this.savedBoards = parsed.savedBoards || [];
            this.savedRoulettes = parsed.savedRoulettes || [];

            // 8. [ì£¼ì¸ê³µ ì¶”ì²¨ & ë£°ë ›] ë°ì´í„° ë³µêµ¬
            this.lotteryPools = parsed.lotteryPools || { all: [], M: [], F: [] };
            this.lastWinners = parsed.lastWinners || { all: null, M: null, F: null };
            this.lotteryMode = parsed.lotteryMode || 'all';
            this.rouletteInput = parsed.rouletteInput || "1\n2\n3\n4\n5\n6";
            this.capsules = (parsed.capsules && Array.isArray(parsed.capsules)) ? parsed.capsules : [];
            
            // 9. [ì†ŒìŒ ì¸¡ì •ê¸°] í†µê³„ ë° ì„¤ì • ë³µêµ¬
            this.statsWarningCount = parsed.statsWarningCount || 0;
            this.statsPenaltyCount = parsed.statsPenaltyCount || 0;
            if (parsed.noiseLevels) {
                this.noiseLevels = {
                    safe: parsed.noiseLevels.safe ?? 50,
                    caution: parsed.noiseLevels.caution ?? 70,
                    warning: parsed.noiseLevels.warning ?? 90
                };
            }

            // 10. [í† ë„ˆë¨¼íŠ¸] ë°ì´í„° ë³µêµ¬
            if (parsed.tournamentData) {
                this.visibleBracketTree = parsed.tournamentData.tree || [];
                this.finalWinner = parsed.tournamentData.winner || null;
                this.selectedBracketMode = parsed.tournamentData.mode || 'group8';
                this.leftSideBracket = parsed.tournamentData.left || [];
                this.rightSideBracket = parsed.tournamentData.right || [];
                this.bracketKey++; // ê°•ì œ ë¦¬ë Œë”ë§
            }
            
            // 11. [â˜… ì¤‘ìš”] UI ì°½ ìœ„ì¹˜ ë° í¬ê¸° ë³µêµ¬ (ì•ˆì „ì¥ì¹˜ í¬í•¨)
            if (parsed.uiState) {
                const ww = window.innerWidth || 1920;
                const wh = window.innerHeight || 1080;

                // ìˆ«ìë¡œ ê°•ì œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
                const getNum = (val, def) => {
                    const num = parseInt(val);
                    return isNaN(num) ? def : num;
                };

                // [1] íƒ€ì´ë¨¸ ìœ„ì¹˜ ë³µêµ¬ (ì•ˆì „ì¥ì¹˜ í¬í•¨)
                if (parsed.uiState.timer) {
                    this.timerSize = getNum(parsed.uiState.timer.size, 400);
                    const tx = getNum(parsed.uiState.timer.x, (ww / 2) - 200);
                    const ty = getNum(parsed.uiState.timer.y, (wh / 2) - 150);
                    
                   this.isTimerMaximized = parsed.uiState.timer.isMaximized || false;
                }

                // [2] ì†ŒìŒì¸¡ì •ê¸° ìœ„ì¹˜ ë³µêµ¬
                if (parsed.uiState.noise) {
                    this.noiseW = getNum(parsed.uiState.noise.w, 400);
                    this.noiseH = getNum(parsed.uiState.noise.h, 300);
                    const nx = getNum(parsed.uiState.noise.x, 100);
                    const ny = getNum(parsed.uiState.noise.y, 100);

                    this.noiseX = Math.max(0, Math.min(nx, ww - 100));
                    this.noiseY = Math.max(0, Math.min(ny, wh - 100));
                    this.isNoiseMaximized = parsed.uiState.noise.isMaximized || false;
                }
                
                // [3] ê·¸ ì™¸ ì°½ë“¤ (íŒì„œ, ë½‘ê¸° ë“±)
                if (parsed.uiState.board) {
                    this.boardX = getNum(parsed.uiState.board.x, 100);
                    this.boardY = getNum(parsed.uiState.board.y, 100);
                    this.boardW = getNum(parsed.uiState.board.w, 600);
                    this.boardH = getNum(parsed.uiState.board.h, 400);
                    this.isMaximized = parsed.uiState.board.isMaximized || false;
                }
                if (parsed.uiState.picker) {
                    this.pickerX = getNum(parsed.uiState.picker.x, 100);
                    this.pickerY = getNum(parsed.uiState.picker.y, 100);
                    this.pickerW = getNum(parsed.uiState.picker.w, 900);
                    this.pickerH = getNum(parsed.uiState.picker.h, 700);
                    this.isPickerMaximized = parsed.uiState.picker.isMaximized || false;
                }
            }

            // 12. [í›„ì²˜ë¦¬] ë°ì´í„° ë¡œë“œ í›„ í•„ìš”í•œ ê°±ì‹  ì‘ì—…
            this.displayWinner = this.lastWinners[this.lotteryMode] || '?';

            // ì¶”ì²¨ í’€ì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ í•™ìƒ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì´ˆê¸°í™”
            const currentAllStudents = [...this.seats.filter(s => s), ...this.waitingRoom];
            if (currentAllStudents.length > 0) {
                if (!this.lotteryPools.all || this.lotteryPools.all.length === 0) this.initializeLotteryPool('all');
                if (!this.lotteryPools.M || this.lotteryPools.M.length === 0) this.initializeLotteryPool('M');
                if (!this.lotteryPools.F || this.lotteryPools.F.length === 0) this.initializeLotteryPool('F');
            }

            console.log("ğŸ”¥ Firebase ë°ì´í„° ë¡œë“œ ë° ìœ„ì¹˜ ë³´ì • ì™„ë£Œ");
        } else {
            console.log("ì‹ ê·œ ì‚¬ìš©ìì…ë‹ˆë‹¤ (ë°ì´í„° ì—†ìŒ)");
        }
    }).catch((error) => {
        alert("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: " + error.message);
        console.error(error);
    });
},
            getScoreBg(score) {
                if (score === 0) return 'bg-white border-slate-200';
                if (score < 0) return 'bg-slate-700 border-slate-800 text-white'; 
                const colors = { 1: 'bg-red-500 border-red-600 text-white', 2: 'bg-orange-500 border-orange-600 text-white', 3: 'bg-yellow-400 border-yellow-500 text-black', 4: 'bg-green-500 border-green-600 text-white', 5: 'bg-blue-500 border-blue-600 text-white', 6: 'bg-purple-500 border-purple-600 text-white' };
                return colors[score] || 'bg-white';
            },
            openRankModal() { this.showRankModal = true; },
            sortRank(key) { 
                if (this.rankSortKey === key) { this.rankSortOrder = this.rankSortOrder === 'asc' ? 'desc' : 'asc'; } 
                else { this.rankSortKey = key; this.rankSortOrder = ['activityScore','checked','memo'].includes(key) ? 'desc' : 'asc'; } 
            },
// [ë©”ì„œë“œ ì¶”ê°€] ESC í‚¤ ëˆ„ë¥´ë©´ ì°½ ë‹«ê¸°
    handleEscKey(e) {
    if (e.key === 'Escape') {
        if (this.showBlackboard) { this.showBlackboard = false; return; }
        if (this.showTimer) { this.showTimer = false; return; }
        if (this.showLottery) { this.showLottery = false; return; }
        if (this.showRoulette) { this.showRoulette = false; return; }
        if (this.showHistoryPreview) { this.showHistoryPreview = false; return; }
        if (this.showShuffleHistory) { this.showShuffleHistory = false; return; }
        if (this.showShuffleModal) { this.showShuffleModal = false; return; }
        if (this.showRaceResult) { this.showRaceResult = false; this.showRaceSetup = true; return; }
        if (this.showRockRace) { this.closeRace(); return; }
        if (this.showGroupingHistory) { this.showGroupingHistory = false; return; }
        if (this.showGroupingResultModal) { this.showGroupingResultModal = false; return; }
        if (this.showGroupMakerModal) { this.showGroupMakerModal = false; return; }
        if (this.showAnimalRace) { this.showAnimalRace = false; return; }
        if (this.showRankModal) { this.showRankModal = false; return; }
        if (this.showSettings) { this.showSettings = false; return; }
        if (this.showBoardList) { this.showBoardList = false; return; } 
    } // Escape ì²´í¬ ì¢…ë£Œ

                // 2. Enter í‚¤: í™•ì¸/ì €ì¥
                if (e.key === 'Enter') {
                    // ëª¨ë‘  ê²°ê³¼ì°½
                    if (this.showGroupingResultModal && !this.showGroupingHistory) {
                        e.preventDefault();
                        this.saveCurrentGrouping();
                        return;
                    }
                    // ë°°ì¹˜ ê¸°ë¡ ë¯¸ë¦¬ë³´ê¸°ì°½
                    if (this.showHistoryPreview) {
                        e.preventDefault();
                        this.restoreHistory();
                        return;
                    }
                    // ë£°ë › ì„¤ì •ì°½ (í…ìŠ¤íŠ¸ ì…ë ¥ ì¤‘ ì•„ë‹ ë•Œë§Œ)
                    if (this.showRoulette && !this.showRouletteList && !this.isSpinningRoulette) {
                        if(document.activeElement.tagName !== 'TEXTAREA') {
                             this.saveCurrentRoulette();
                        }
                    }
                }
            },
          // ğŸ‡ [1] ë™ë¬¼ ë ˆì´ìŠ¤ ì‹œì‘
            async startAnimalRace() { 
                // ì¶©ëŒ ë°©ì§€: ëŒ ë ˆì´ìŠ¤ ë„ê¸°
                this.isGameRunning = false; 
                if(this.animationId) cancelAnimationFrame(this.animationId);

                this.animalRaceResults = []; 
                this.animalRaceFinished = false; 
                this.isAnimalRacing = true; 
                
                // ë°ì´í„° ì•ˆì „ì¥ì¹˜
                if (!this.animalRunners || this.animalRunners.length === 0) {
                     this.animalRunners = Array(6).fill().map(() => ({}));
                }

                // ì´ˆê¸°í™” (ëª¨ë‘ 'run' ìƒíƒœë¡œ ì‹œì‘)
                this.animalRunners.forEach(r => { 
                    r.pos = 0; 
                    r.finished = false; 
                    r.state = 'run'; 
                    r.timer = Math.random() * 50 + 20; 
                    r.speed = 0;
                }); 
                
                // ì¹´ìš´íŠ¸ë‹¤ìš´
                this.showAnimalRaceCountdown = true;
                const seq = ['3', '2', '1', 'GO!']; 
                for (const s of seq) { 
                    this.countdownText = s; 
                    await new Promise(r => setTimeout(r, 800)); 
                } 
                this.showAnimalRaceCountdown = false; 
                this.playSound('bgm_animal', true, 0.3);
                // ë£¨í”„ ì‹œì‘
                this.runAnimalLoop(); 
            },
openAnimalRaceModal() {
                // 1. ì´ë¯¸ ê²½ê¸°ê°€ ëë‚œ ê¸°ë¡ì´ ìˆë‹¤ë©´ (ì¬ì‹œì‘ ì•„ë‹˜)
                if (this.animalRaceFinished === true) {
                    this.showAnimalRace = true;
                    this.showAnimalRaceCountdown = false; // ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ¨ê¹€
                    
                    // â˜… [í•µì‹¬] ì‹œê°ì  ìƒíƒœ ê°•ì œ ë³µêµ¬ (ëª¨ë‘ ê²°ìŠ¹ì„ ìœ¼ë¡œ ì´ë™)
                    this.animalRunners.forEach(r => {
                        r.pos = 90;       // ê²°ìŠ¹ì„  ìœ„ì¹˜
                        r.state = 'run';  // ì–Œì „íˆ ì„œ ìˆê¸°
                        r.finished = true; // ì™„ì£¼ ìƒíƒœ
                    });
                    
                    return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ! (ì´ˆê¸°í™” ì½”ë“œ ì‹¤í–‰ ì•ˆ í•¨)
                }

                // 2. ê¸°ë¡ì´ ì—†ìœ¼ë©´(ì²˜ìŒì´ë©´) ì´ˆê¸°í™” ì§„í–‰
                if (!this.animalRunners || this.animalRunners.length === 0) {
                     this.animalRunners = Array(6).fill().map(() => ({ 
                         pos: 0, speed: 0, finished: false, state: 'run', timer: 0 
                     }));
                }
                
                // 3. ì¶œë°œì„  ì •ë ¬
                this.animalRunners.forEach(r => { 
                    r.pos = 0; 
                    r.state = 'run'; 
                    r.finished = false; 
                });
                this.showAnimalRaceCountdown = false;
                this.isAnimalRacing = false;
                this.animalRaceResults = [];
                this.animalRaceFinished = false;

                // 4. ì°½ ì—´ê¸°
                this.showAnimalRace = true;
            },

    runAnimalLoop() { 
                if (!this.isAnimalRacing) return;
                
                this.animalRunners.forEach((r, idx) => { 
                    if (r.pos < 90) { 
                        // (1) ìƒíƒœ ë° íƒ€ì´ë¨¸ ê´€ë¦¬
                        if (r.timer > 0) {
                            r.timer--;
                        } else {
                            // (2) ìƒíƒœ ë³€í™” ë¡œì§
                            // A. ì§ˆì£¼ í›„ íœ´ì‹
                            if (r.state === 'sprint') {
                                if (Math.random() < 0.9) { r.state = 'tired'; r.timer = 60 + Math.random() * 60; } 
                                else { r.state = 'run'; r.timer = 20; }
                            }
                            // B. íœ´ì‹ í›„ ë‹¬ë¦¬ê¸°
                            else if (r.state === 'tired') {
                                r.state = 'run'; r.timer = 20 + Math.random() * 20;
                            }
                            // C. ë‹¬ë¦¬ê¸° ì¤‘ ê²°ì •
                            else {
                                let sprintChance = 0.10; 
                                let tiredChance = 0.05;
                                const rand = Math.random();
                                if (rand < sprintChance) { r.state = 'sprint'; r.timer = 30 + Math.random() * 20; } 
                                else if (rand < sprintChance + tiredChance) { r.state = 'tired'; r.timer = 60 + Math.random() * 60; } 
                                else { r.state = 'run'; r.timer = 20 + Math.random() * 20; }
                            }
                        }

                        // (3) ì†ë„ ê³„ì‚°
                        let targetSpeed = 0;
                        const speedFactor = 1.5; 
                        switch (r.state) {
                            case 'sprint': targetSpeed = (0.8 + Math.random() * 0.5) * speedFactor; break;
                            case 'tired': targetSpeed = 0.02 * speedFactor; break;
                            case 'run': default: targetSpeed = (0.15 + Math.random() * 0.2) * speedFactor; break;
                        }
                        r.speed += (targetSpeed - r.speed) * 0.2;
                        
                        // (4) ìœ„ì¹˜ ì´ë™
                        r.pos += r.speed * 0.3; 
                        
                        if (r.pos >= 90) { 
                            r.pos = 90; r.finished = true; r.state = 'run'; 
                            if (!this.animalRaceResults.includes(idx)) this.animalRaceResults.push(idx); 
                        } 
                    } 
                }); 
                
                if (this.animalRaceResults.length < this.animalRunners.length) { 
                    requestAnimationFrame(() => this.runAnimalLoop()); 
                } else { 
                    // [ê²½ê¸° ì¢…ë£Œ ìƒí™©]
                    this.isAnimalRacing = false; 
                    this.animalRaceFinished = true; // 1. ëë‚¬ë‹¤ê³  í‘œì‹œ
                    
this.stopSound('bgm_animal'); 
    this.playSound('fanfare');
                    this.saveToLocal(); 
                } 
            },
            toggleCheck(student) { student.checked = !student.checked; this.saveToLocal(); },
            isFirstOrder(s) { return this.sortedOrderedStudents[0] === s; },
            onDragStart(e, idx, type) { this.dragInfo = { idx, type }; e.target.classList.add('dragging'); },
            onDragEnd(e) { if(e.target.classList) e.target.classList.remove('dragging'); },
            onDropSeat(e, targetIdx) { if (!this.dragInfo || (this.view !== 'main' && this.view !== 'order')) return; const { idx, type } = this.dragInfo; if (type === 'seat') { const temp = this.seats[targetIdx]; this.seats[targetIdx] = this.seats[idx]; this.seats[idx] = temp; } this.saveToLocal(); },
            onDropToBottom() { }, onDropReorder(targetIdx) { if (this.draggedOrderIdx === null) return; const list = this.sortedOrderedStudents; const item = list[this.draggedOrderIdx]; list.splice(this.draggedOrderIdx, 1); list.splice(targetIdx, 0, item); list.forEach((s, i) => s.order = i + 1); this.draggedOrderIdx = null; this.saveToLocal(); },
            handleToolClick(tool) { this.activeTool = tool; if(this.allMode) { const targets = (this.view === 'group') ? this.groups : this.seats.filter(s => s); if(tool === 'check') { const anyUnchecked = targets.some(i => !i.checked); targets.forEach(i => i.checked = anyUnchecked); } else targets.forEach(i => this.applyTool(i, true)); this.saveToLocal(); } },
           
            handleGroupClick(idx) { if(!this.groups[idx].showMembers) { this.applyTool(this.groups[idx], false); this.saveToLocal(); } },
            resetCurrentScores() { if(confirm("ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) { if(this.view === 'group') this.groups.forEach(g => g.score = 0); else this.allStudents.forEach(s => s.activityScore = 0); this.saveToLocal(); } },
            resetCurrentSelection() { 
                if(confirm("ì„ íƒì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    if(this.view === 'group') this.groups.forEach(g => g.checked = false); 
                    else this.allStudents.forEach(s => s.checked = false); 
                    this.saveToLocal(); 
                }
            },
            clearMemos() { if(confirm("ëª¨ë“  ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?")) { if(this.view === 'group') this.groups.forEach(g => { g.memo = ""; g.starred = false; }); else this.allStudents.forEach(s => { s.memo = ""; s.starred = false; }); this.saveToLocal(); } },
            resetOrder() { this.allStudents.forEach(s => s.order = null); this.saveToLocal(); },
           
                     
            getModeName(mode) {
    if (mode === 'all') return 'ì „ì²´';
    if (mode === 'M') return 'ë‚¨í•™ìƒ';
    if (mode === 'F') return 'ì—¬í•™ìƒ';
    return '';
},
    // ì¶”ì²¨ ì‹¤í–‰ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ ìˆ˜ì •)
    rollLottery() {
        const pool = this.lotteryPools[this.lotteryMode];

        // ì¸ì› ì²´í¬
        if (!pool || pool.length === 0) {
            alert('ë‚¨ì€ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤! \nìš°ì¸¡ í•˜ë‹¨ì˜ ì´ˆê¸°í™” ë²„íŠ¼(â†»)ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
            return;
        }

        if (this.isRolling) return;
        this.isRolling = true;

        let count = 0;
        const interval = setInterval(() => {
            // ë£°ë › íš¨ê³¼
            const randomName = pool[Math.floor(Math.random() * pool.length)];
            this.displayWinner = randomName;

            if (++count > 25) { 
                clearInterval(interval);
                
                // ìµœì¢… ë‹¹ì²¨ì
                const winnerName = this.displayWinner;
                
                // í•´ë‹¹ ëª¨ë“œ í’€ì—ì„œ ì œê±°
                const winnerIndex = pool.indexOf(winnerName);
                if (winnerIndex !== -1) {
                    pool.splice(winnerIndex, 1);
                }

                // ê¸°ë¡ ì €ì¥
                this.lastWinners[this.lotteryMode] = winnerName;

                this.isRolling = false;
                this.saveToLocal();
            }
        }, 80);
    },
         openSettings() { 
                try {
                    const seats = Array.isArray(this.seats) ? this.seats : [];
                    const waiting = Array.isArray(this.waitingRoom) ? this.waitingRoom : [];
                    const allCurrent = [...seats.filter(s => s), ...waiting]; 
                    allCurrent.sort((a,b) => {
                        const numA = (a && a.number) ? parseInt(a.number) : 99999;
                        const numB = (b && b.number) ? parseInt(b.number) : 99999;
                        return numA - numB;
                    });

                    this.tempNameList = allCurrent.map(s => {
                        if (!s) return '';
                        const num = s.number ? s.number + ' ' : '';
                        const name = s.name || '';
                        const gender = s.gender === 'M' ? ' ë‚¨' : (s.gender === 'F' ? ' ì—¬' : '');
                        return `${num}${name}${gender}`;
                    }).join('\n');
                    
                    this.showSettings = true; 
                } catch (e) {
                    console.error("ì„¤ì • ì°½ ì—´ê¸° ì˜¤ë¥˜:", e);
                    this.tempNameList = ""; 
                    this.showSettings = true;
                }
            }, 


            saveNameList() { 
               try {
        const lines = this.tempNameList.split('\n');
        const newStudentList = [];
        const processedNames = new Set(); 

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim(); 
            if (!line) continue; 
            let parts = line.split(/[\t\s,]+/); 
            let number = null;
            let name = '';
            let gender = 'U'; 

            if (/^\d+/.test(parts[0])) { 
                number = parseInt(parts[0].replace(/[^0-9]/g, '')); 
                parts.shift(); 
            }

            if (parts.length > 0) name = parts[0];
            if (!name || processedNames.has(name)) continue; 
            processedNames.add(name); 

            if (parts.length > 1) {
                const genderStr = parts[parts.length - 1].toUpperCase();
                if (['ë‚¨', 'ë‚¨ì', 'M', 'MALE'].includes(genderStr)) gender = 'M';
                else if (['ì—¬', 'ì—¬ì', 'F', 'FEMALE'].includes(genderStr)) gender = 'F';
            } else {
                if (name.includes('ë‚¨') || name.includes('(ë‚¨)')) gender = 'M';
                if (name.includes('ì—¬') || name.includes('(ì—¬)')) gender = 'F';
            }
            
            newStudentList.push({ 
                number, name, gender, 
                activityScore: 0, checked: false, order: null, memo: "", starred: false 
            });
        }

        if (newStudentList.length === 0) {
            alert("í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 1ë²ˆ í™ê¸¸ë™ ë‚¨)");
            return;
        }

        if (!confirm(`ì´ ${newStudentList.length}ëª…ì˜ í•™ìƒì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        // ê¸°ì¡´ ë°ì´í„° ìœ ì§€ ë¡œì§
        const oldDataMap = new Map();
        [...this.seats.filter(s => s), ...this.waitingRoom].forEach(s => {
            if(s && s.name) oldDataMap.set(s.name, s);
        });

        const finalAllStudents = newStudentList.map(newItem => {
            const oldItem = oldDataMap.get(newItem.name);
            if (oldItem) { 
                oldItem.number = newItem.number; 
                oldItem.gender = newItem.gender; 
                return oldItem; 
            }
            return newItem; 
        });

        // ì¢Œì„ ì—…ë°ì´íŠ¸
        const newNameSet = new Set(finalAllStudents.map(s => s.name));
        this.seats = this.seats.map(s => (s && newNameSet.has(s.name)) ? oldDataMap.get(s.name) : null);

        // ëŒ€ê¸°ì‹¤ ì—…ë°ì´íŠ¸ (â˜… ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„: parsed ëŒ€ì‹  finalAllStudents ì‚¬ìš©)
        const seatedNames = new Set(this.seats.filter(s => s).map(s => s.name));
        this.waitingRoom = finalAllStudents.filter(fs => !seatedNames.has(fs.name));

        this.showSettings = false; 
        this.saveToFirebase(); // Firebaseì— ì¦‰ì‹œ ì €ì¥
        alert("ì €ì¥ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"); 
    } catch (e) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        console.error(e);
    }
},
            
            getIndex(b, r, p) { return ((b-1)*10) + ((r-1)*2) + (p-1); },
            
            openBlackboard() { 
    this.showBlackboard = true; 
    this.focusWindow('board'); // â˜… ì¶”ê°€
    this.closePalettes(); 
    this.$nextTick(() => { 
        const editor = this.$refs.boardEditor || document.getElementById('board-editor');
        if(editor) {
            editor.innerHTML = this.blackboardContent || ''; 
        }
    });
},


            applyStyle(cmd, val = null) { const editor = document.getElementById('board-editor');
                
                // 1. ì—ë””í„°ì— í¬ì»¤ìŠ¤ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë§ì¶¤ (ì„ íƒ ì˜ì—­ ìœ ì§€ ë…¸ë ¥)
                if (document.activeElement !== editor) {
                    editor.focus();
                }

                // 2. CSS ìŠ¤íƒ€ì¼ ëª¨ë“œ ì¼œê¸° (ìµœì‹  ë¸Œë¼ìš°ì € í˜¸í™˜ì„±)
                document.execCommand('styleWithCSS', false, true);

                // 3. ëª…ë ¹ ì‹¤í–‰
                document.execCommand(cmd, false, val);
                
                // 4. íŒ”ë ˆíŠ¸ ë‹«ê¸°
                this.closePalettes();
            },
            applyColor(cmd, color) { this.applyStyle(cmd, color); },
            toggleForeColorPalette() { this.showForeColorPalette = !this.showForeColorPalette; this.showHiliteColorPalette = false; },
            toggleHiliteColorPalette() { this.showHiliteColorPalette = !this.showHiliteColorPalette; this.showForeColorPalette = false; },
            closePalettes() { this.showForeColorPalette = false; this.showHiliteColorPalette = false; },
            updateBoardContent(e) {
    this.blackboardContent = e.target.innerHTML;
    // ë„ˆë¬´ ì¦ì€ ì €ì¥ì„ ë§‰ê¸° ìœ„í•´ saveToLocal ì‚¬ìš© (ë””ë°”ìš´ì‹± ë˜ì–´ìˆìŒ)
    this.saveToLocal();
},
            clearBoard() {
    if (confirm("ì¹ íŒì„ ì§€ìš¸ê¹Œìš”?")) {
        this.blackboardContent = '';
        const editor = this.$refs.boardEditor || document.getElementById('board-editor');
        if (editor) {
            editor.innerHTML = ''; // ë‚´ìš©ì„ ë¹„ìš°ê³ 
            editor.focus();       // ì¦‰ì‹œ ê¸€ì“°ê¸° ê°€ëŠ¥í•œ ìƒíƒœë¡œ í¬ì»¤ìŠ¤ ì´ë™
        }
    }
},
            saveBoardToList() { 
const editor = document.getElementById('board-editor');
                const textContent = editor.innerText.trim(); // í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                
                if (!textContent && !editor.innerHTML.includes('<img')) {
                    alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const now = new Date();
                const timeString = `${now.getHours() < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„'} ${now.getHours() > 12 ? now.getHours()-12 : now.getHours()}ì‹œ ${now.getMinutes()}ë¶„`;

                // 1. ì²« ë²ˆì§¸ ì¤„ì„ ì œëª©ìœ¼ë¡œ ì¶”ì¶œ
                const lines = textContent.split('\n').filter(line => line.trim() !== '');
                let title = lines.length > 0 ? lines[0] : "ì´ë¯¸ì§€/ë‚´ìš© ì—†ìŒ";
                
                // ì œëª©ì´ ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸° (15ì)
                if (title.length > 15) title = title.substring(0, 15) + '...';

                // 2. ë¯¸ë¦¬ë³´ê¸° (ë‚´ìš©) ìƒì„±
                let preview = textContent.replace(/\n/g, ' ').substring(0, 30);
                if (textContent.length > 30) preview += '...';
                if (!preview) preview = "(ë‚´ìš© ì—†ìŒ)";

                this.savedBoards.unshift({
                    id: Date.now(),
                    content: editor.innerHTML, // HTML ìŠ¤íƒ€ì¼ í¬í•¨ ì›ë³¸
                    title: title,              // [NEW] ì¶”ì¶œí•œ ì œëª©
                    time: timeString,
                    preview: preview
                });

                this.saveToLocal();
                alert("ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            },            toggleBoardList() { this.showBoardList = !this.showBoardList; this.closePalettes(); },
            loadBoard(board) { if(confirm("ì´ íŒì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) { this.blackboardContent = board.content; document.getElementById('board-editor').innerHTML = board.content; this.showBoardList = false; } },
            deleteBoard(idx) { if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) { this.savedBoards.splice(idx, 1); this.saveToLocal(); } },
            deleteAllBoards() { if(confirm("ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) { this.savedBoards = []; this.saveToLocal(); } },
           /* íŒì„œ ì°½ ë“œë˜ê·¸ (ì´íƒˆ ë°©ì§€ í¬í•¨) */
startBoardDrag(e) {
    if (e.target.closest('button') || e.target.closest('.zoom-text-input')) return;
    if (this.isMaximized) return;

    // ë“œë˜ê·¸ ì‹œì‘ ì‹œì ì˜ ë§ˆìš°ìŠ¤ ì¢Œí‘œì™€ ì°½ ì¢Œí‘œì˜ ì°¨ì´(ì˜¤í”„ì…‹) ì €ì¥
    const startMouseX = e.clientX;
    const startMouseY = e.clientY;
    const startBoardX = this.boardX;
    const startBoardY = this.boardY;

    const mv = (ev) => {
        // ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í•˜ëŠ” ì´ë™ ê±°ë¦¬ ê³„ì‚°
        const deltaX = ev.clientX - startMouseX;
        const deltaY = ev.clientY - startMouseY;

        // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ëª»í•˜ê²Œ ë²”ìœ„ ì œí•œ (0 ~ í™”ë©´ë„ˆë¹„-ì°½ë„ˆë¹„)
        const maxX = window.innerWidth - this.boardW;
        const maxY = window.innerHeight - this.boardH;

        this.boardX = Math.max(0, Math.min(startBoardX + deltaX, maxX));
        this.boardY = Math.max(0, Math.min(startBoardY + deltaY, maxY));
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},
/* íŒì„œ ì°½ ë¦¬ì‚¬ì´ì¦ˆ (ì´íƒˆ ë°©ì§€ í¬í•¨) */
startBoardResize(e) {
    this.focusWindow('board'); // â˜… ì¶”ê°€
    e.preventDefault();
    const startX = e.clientX;
    const startY = e.clientY;
    const initialW = this.boardW;
    const initialH = this.boardH;

    const mv = (ev) => {
        const maxW = window.innerWidth - this.boardX;
        const maxH = window.innerHeight - this.boardY;
        this.boardW = Math.max(300, Math.min(initialW + (ev.clientX - startX), maxW));
        this.boardH = Math.max(200, Math.min(initialH + (ev.clientY - startY), maxH));
    };

    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
},

            /* [ëŒë¦¼íŒ ë¡œì§] */
            toggleRouletteList() { this.showRouletteList = !this.showRouletteList; },
            saveCurrentRoulette() { if(!this.rouletteInput.trim()) return alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); const title = prompt("ì €ì¥í•  ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:"); if(title) { this.savedRoulettes.push({ title, content: this.rouletteInput }); this.saveToLocal(); alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); } },
            loadRoulette(item) { this.rouletteInput = item.content; this.showRouletteList = false; },
            deleteRoulette(idx) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { this.savedRoulettes.splice(idx, 1); this.saveToLocal(); } },
spinRoulette() { 
    if (this.isSpinningRoulette) return; 
    if (this.rouletteItems.length < 2) return alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤."); 
    
    this.isSpinningRoulette = true; 
    this.playSound('tick', false, 0.3); // [ì†Œë¦¬ ì¶”ê°€] ëŒì•„ê°€ëŠ” ì†Œë¦¬
    
    const spins = 5 + Math.random() * 5; 
    const arc = 360 / this.rouletteItems.length; 
    const randomOffset = Math.floor(Math.random() * this.rouletteItems.length); 
    const finalAngle = 360 * spins + (randomOffset * arc); 
    this.rouletteRotation += finalAngle; 
    
    setTimeout(() => { 
        this.isSpinningRoulette = false; 
        const actualRotation = this.rouletteRotation % 360; 
        const degrees = (360 - actualRotation) % 360; 
        const index = Math.floor(degrees / arc); 
        this.rouletteWinner = this.rouletteItems[index]; 
        this.showRouletteResult = true; 
        this.playSound('firework'); // [ì†Œë¦¬ ì¶”ê°€] ë‹¹ì²¨ìŒ
    }, 4000); 
},
            resetRoulette() { this.rouletteInput = ""; this.rouletteRotation = 0; },

startRouletteDrag(e) {
    if(e.target.closest('button') || e.target.tagName === 'TEXTAREA') return;
    if(this.isRouletteMaximized) return;
    const startX = e.clientX - this.rouletteX;
    const startY = e.clientY - this.rouletteY;
    const mv = (ev) => {
        this.rouletteX = ev.clientX - startX;
        this.rouletteY = ev.clientY - startY;
    };
    const mu = () => {
        document.removeEventListener('mousemove', mv);
        document.removeEventListener('mouseup', mu);
        this.saveToLocal();
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', mu);
}, // <-- ì´ ì‰¼í‘œê°€ ê¼­ ìˆì–´ì•¼ ë‹¤ìŒ í•¨ìˆ˜ì™€ ì—°ê²°ë©ë‹ˆë‹¤!
            /* ë£°ë › ì°½ ë“œë˜ê·¸ (ê²½ê³„ ì œí•œ ì¶”ê°€) */
            startRouletteResize(e) { 
                e.preventDefault(); 
                const startX = e.clientX;
                const startWidth = this.rouletteW;
                const aspectRatio = 1.4; 
                const mouseMoveHandler = (ev) => {
    // 1. ë§ˆìš°ìŠ¤ ì›€ì§ì„ì— ë”°ë¥¸ ìƒˆë¡œìš´ ë„ˆë¹„ ê³„ì‚°
    let newWidth = Math.max(600, startWidth + (ev.clientX - startX));
    let newHeight = newWidth / aspectRatio;

    // 2. [ë°”ë‹¥ ê³ ì •] í˜„ì¬ Yìœ„ì¹˜ì—ì„œ í™”ë©´ ë°”ë‹¥ì„ ë²—ì–´ë‚˜ëŠ”ì§€ ì²´í¬
    const maxAllowedWidth = window.innerWidth - this.rouletteX;
    const maxAllowedHeight = window.innerHeight - this.rouletteY;

    // 3. ë„ˆë¹„ê°€ ê°€ë¡œ ë²”ìœ„ë¥¼ ë„˜ì–´ê°€ë©´ ì œí•œ
    if (newWidth > maxAllowedWidth) {
        newWidth = maxAllowedWidth;
        newHeight = newWidth / aspectRatio;
    }

    // 4. ë†’ì´ê°€ ì„¸ë¡œ ë²”ìœ„ë¥¼ ë„˜ì–´ê°€ë©´ ì œí•œ (ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë„ˆë¹„ë„ ê°™ì´ ì¶•ì†Œ)
    if (newHeight > maxAllowedHeight) {
        newHeight = maxAllowedHeight;
        newWidth = newHeight * aspectRatio;
    }

    this.rouletteW = newWidth;
    this.rouletteH = newHeight;
};
                const mouseUpHandler = () => {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                };
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            },
            
            openGroupMaker() { 
                // 1. ì´ë¯¸ í¸ì„±ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ì°½ì„ ë„ì›€
                if (this.groupingList.length > 0) { 
                    this.showGroupingResultModal = true; 
                    
                    // (ì˜µì…˜) ë©ˆì¶˜ ìƒíƒœë¡œ í™•ì‹¤í•˜ê²Œ ì„¤ì •í•´ì„œ ì• ë‹ˆë©”ì´ì…˜ì´ ë‹¤ì‹œ ëŒì§€ ì•Šê²Œ í•¨
                    this.tempGroupCount = this.groupingList.length;
                    this.stoppedGroups = Array.from({length: this.tempGroupCount}, (_, i) => i);
                } 
                // 2. ì—†ìœ¼ë©´ ì„¤ì •ì°½(ëª‡ ëª¨ë‘ ìœ¼ë¡œ í• ì§€)ì„ ë„ì›€
                else { 
                    this.showGroupMakerModal = true; 
                    this.tempGroupCount = Math.max(1, this.groups.length); 
                } 
            },
            
            // [ëª¨ë‘  ë§Œë“¤ê¸° ë¡œì§] (ì¸ì› ë°°ì • ìš°ì„ ìˆœìœ„: 3->6->5->4->2->1 ì ìš©)
async applyGroupMaker() {
                // 1. í•™ìƒ ì²´í¬
                let students = [...this.allStudents];
                if(students.length === 0) return alert("í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                
                this.showGroupMakerModal = false;

                // 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹¤í–‰
                this.isShufflingCountdown = true;
                const seq = ['3', '2', '1', 'GO!'];
                for (const num of seq) {
                    this.shuffleCountdownNum = num;
                    await new Promise(r => setTimeout(r, 800));
                }
                this.isShufflingCountdown = false;
                
                // 3. ê²°ê³¼ì°½ ì—´ê¸° ë° ë¡œì§ ì‹œì‘
                this.showGroupingResultModal = true;
                
                let finalGroups = Array(this.tempGroupCount).fill().map(() => []);
                const globalPriority = [2, 5, 4, 3, 1, 0]; // ì¤‘ì•™ë¶€í„° ì±„ìš°ëŠ” ìš°ì„ ìˆœìœ„ (6ëª¨ë‘  ê¸°ì¤€)
                for(let i=0; i<this.tempGroupCount; i++) {
                    if(!globalPriority.includes(i)) globalPriority.push(i);
                }
                const validPriority = globalPriority.filter(idx => idx < this.tempGroupCount);

                // --- ëª¨ë‘  ë°°ì • ì•Œê³ ë¦¬ì¦˜ ---
                if (this.groupingMode === 'same') {
                    // [ë™ì„±] ë¼ë¦¬ë¼ë¦¬
                    const males = students.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
                    const females = students.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
                    
                    // ë‚¨/ë…€ ê·¸ë£¹ ìˆ˜ ë¹„ìœ¨ ê³„ì‚°
                    const maleRatio = males.length / (males.length + females.length || 1);
                    const maleGroupCount = Math.round(this.tempGroupCount * maleRatio);
                    const femaleGroupCount = this.tempGroupCount - maleGroupCount;

                    // ë‚¨ì ë°°ì •
                    const mInfo = this.calculateCapacity(males.length, maleGroupCount);
                    let mPtr = 0;
                    for(let i=0; i<maleGroupCount; i++) {
                        const targetIdx = validPriority[i]; // ìš°ì„ ìˆœìœ„ ì ìš©
                        const count = mInfo.base + (i < mInfo.remainder ? 1 : 0);
                        for(let k=0; k<count; k++) if(mPtr < males.length) finalGroups[targetIdx].push(males[mPtr++]);
                    }

                    // ì—¬ì ë°°ì •
                    const fInfo = this.calculateCapacity(females.length, femaleGroupCount);
                    let fPtr = 0;
                    for(let i=0; i<femaleGroupCount; i++) {
                        const targetIdx = validPriority[maleGroupCount + i]; // ë‚¨ì ë‹¤ìŒ ê·¸ë£¹ë¶€í„°
                        if (targetIdx !== undefined) {
                            const count = fInfo.base + (i < fInfo.remainder ? 1 : 0);
                            for(let k=0; k<count; k++) if(fPtr < females.length) finalGroups[targetIdx].push(females[fPtr++]);
                        }
                    }
                    
                    // ë‚¨ëŠ” ì¸ì› ì²˜ë¦¬ (í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ë°©ì§€)
                    while(mPtr < males.length) { finalGroups[Math.floor(Math.random()*this.tempGroupCount)].push(males[mPtr++]); }
                    while(fPtr < females.length) { finalGroups[Math.floor(Math.random()*this.tempGroupCount)].push(females[fPtr++]); }

                } else {
                    // [í˜¼ì„±] ë˜ëŠ” [ëœë¤]
                    let shuffled = [];
                    if (this.groupingMode === 'mixed') {
                        // ë‚¨ë…€ ê· í˜• ì„ê¸°
                        const males = students.filter(s => s.gender === 'M').sort(() => Math.random() - 0.5);
                        const females = students.filter(s => s.gender === 'F').sort(() => Math.random() - 0.5);
                        while(males.length || females.length) {
                            if(males.length) shuffled.push(males.pop());
                            if(females.length) shuffled.push(females.pop());
                        }
                    } else {
                        // ì™„ì „ ëœë¤
                        shuffled = students.sort(() => Math.random() - 0.5);
                    }

                    // ê· ë“± ë¶„ë°°
                    const baseInfo = this.calculateCapacity(shuffled.length, this.tempGroupCount);
                    const caps = Array(this.tempGroupCount).fill(baseInfo.base);
                    
                    // ë‚˜ë¨¸ì§€ ì¸ì›ì€ ìš°ì„ ìˆœìœ„ ê·¸ë£¹ì— +1
                    for(let i=0; i<baseInfo.remainder; i++) {
                        if(validPriority[i] !== undefined) caps[validPriority[i]]++;
                    }

                    let sPtr = 0;
                    caps.forEach((cap, idx) => {
                        for(let k=0; k<cap; k++) if(sPtr < shuffled.length) finalGroups[idx].push(shuffled[sPtr++]);
                    });
                }

                // 4. ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ ì—°ì¶œ
                // ì¼ë‹¨ ëœë¤ ë°ì´í„°ë¡œ ì±„ì›Œì„œ ëŒë¦¬ëŠ” ì²™ í•˜ë‹¤ê°€ -> ì§„ì§œ ê²°ê³¼ë¡œ êµì²´
                this.groupingList = finalGroups.map(g => g.map(() => this.getRandomStudent()));
                this.stoppedGroups = [];
                
                const stopInterval = 600; // 0.6ì´ˆë§ˆë‹¤ í•˜ë‚˜ì”© ë©ˆì¶¤
                
                const timer = setInterval(() => {
                    // ë©ˆì¶”ì§€ ì•Šì€ ê·¸ë£¹ë§Œ ê³„ì† ëœë¤ê°’ ë³€ê²½ (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
                    this.groupingList = this.groupingList.map((group, gIdx) => {
                        if (this.stoppedGroups.includes(gIdx)) return finalGroups[gIdx]; // ë©ˆì¶˜ ê·¸ë£¹ì€ ì§„ì§œ ê²°ê³¼
                        // ë©ˆì¶”ì§€ ì•Šì€ ê·¸ë£¹ì€ í•™ìƒ ìˆ˜ë§Œí¼ ëœë¤ ìƒì„±í•´ì„œ ë³´ì—¬ì¤Œ
                        return Array(finalGroups[gIdx].length).fill(null).map(() => this.getRandomStudent());
                    });
                }, 50); // 0.05ì´ˆë§ˆë‹¤ ê°±ì‹ 
                
                // ìˆœì°¨ì ìœ¼ë¡œ ë©ˆì¶”ê¸°
                for (let i = 0; i < this.tempGroupCount; i++) {
                    setTimeout(() => {
                        this.stoppedGroups.push(i); // ië²ˆ ê·¸ë£¹ ë©ˆì¶¤
                        
                        if (i === this.tempGroupCount - 1) {
                            clearInterval(timer); // ë‹¤ ë©ˆì¶”ë©´ íƒ€ì´ë¨¸ ì¢…ë£Œ
                            this.groupingList = finalGroups; // ìµœì¢… í™•ì •
                            this.saveToLocal();
                        }
                    }, stopInterval * (i + 1));
                }
            },

calculateCapacity(total, groups) {
    if (groups <= 0) return { base: 0, remainder: 0 };
    return {
        base: Math.floor(total / groups),
        remainder: total % groups
    };
},

// [ì¶”ê°€] ëª¨ë‘  ê²°ê³¼ ì €ì¥í•˜ê¸° (ì œëª© ì…ë ¥)
saveCurrentGrouping() {
    if (this.groupingList.length === 0) return alert("ì €ì¥í•  ëª¨ë‘  í¸ì„±ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    const defaultTitle = `ëª¨ë‘  í™œë™ ${new Date().getMonth()+1}/${new Date().getDate()}`;
    const title = prompt("ëª¨ë‘  í¸ì„± ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultTitle);
    
    if (title === null) return; 
    const finalTitle = title.trim() || defaultTitle;

    const newRecord = {
        id: Date.now(),
        title: finalTitle,
        date: new Date().toLocaleString(),
        data: JSON.parse(JSON.stringify(this.groupingList))
    };
    
    this.savedGroupings.unshift(newRecord);
    this.saveToLocal();
    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
},

// [ì¶”ê°€] ì €ì¥ëœ ëª¨ë‘  ë¶ˆëŸ¬ì˜¤ê¸°
loadGrouping(record) {
    if(!confirm(`'${record.title}' í¸ì„±ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ëª¨ë‘  êµ¬ì„±ê³¼ ì ìˆ˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`)) return;
    
    this.groupingList = JSON.parse(JSON.stringify(record.data));
    this.tempGroupCount = this.groupingList.length;
    this.stoppedGroups = Array.from({length: this.tempGroupCount}, (_, i) => i);
    
    // ë©”ì¸ í™”ë©´ ë°˜ì˜
    this.groups.forEach(g => { g.score = 0; g.members = []; });
    this.groupingList.forEach((members, idx) => {
        if (this.groups[idx]) {
            this.groups[idx].members = members;
        }
    });

    this.showGroupingHistory = false;
    this.showGroupingResultModal = true;
    this.saveToLocal();
},

// [ì¶”ê°€] ëª¨ë‘  ê¸°ë¡ ì‚­ì œ
deleteGrouping(idx) {
    if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        this.savedGroupings.splice(idx, 1);
        this.saveToLocal();
    }
},
            isGroupStopped(idx) { return this.stoppedGroups.includes(idx); },
            getRandomStudent() { const s = this.allStudents[Math.floor(Math.random() * this.allStudents.length)]; return { ...s }; },
            getRandomColor() { const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7']; return colors[Math.floor(Math.random() * colors.length)]; },
            reshuffleGroups() { this.showGroupingResultModal = false; this.groupingList = []; this.saveToLocal(); this.$nextTick(() => { this.showGroupMakerModal = true; }); },
            
            openHistoryPreview(rec) { this.previewHistoryItem = rec; this.showHistoryPreview = true; },
            
            restoreHistory() {
                if (!this.previewHistoryItem) return;
                if(confirm("ì´ ë°°ì¹˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    this.seats = JSON.parse(JSON.stringify(this.previewHistoryItem.seats));
                    const seatedNames = new Set(this.seats.filter(s => s).map(s => s.name));
                    const all = this.allStudents; 
                    this.waitingRoom = all.filter(s => !seatedNames.has(s.name));
                    this.showHistoryPreview = false; 
                    this.showShuffleHistory = false; 
                    this.saveToLocal(); 
                    alert("ë°°ì¹˜ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            },
            
            deleteShuffle(idx) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { this.shuffleHistory.splice(idx, 1); this.saveToLocal(); } },
            deleteAllShuffles() { if(confirm("ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) { this.shuffleHistory = []; this.saveToLocal(); } },
            addSeparationPair() { if(this.selectedStudentA && this.selectedStudentB && this.selectedStudentA !== this.selectedStudentB) { this.separationPairs.push({ student1: this.selectedStudentA, student2: this.selectedStudentB }); this.selectedStudentA = ''; this.selectedStudentB = ''; this.saveToLocal(); } },
            removeSeparationPair(idx) { this.separationPairs.splice(idx, 1); this.saveToLocal(); },
            confirmSeatLock(studentName) { if (studentName) { this.manualLocks = this.manualLocks.filter(l => l.seatIdx !== this.targetLockSeatIdx && l.student !== studentName); this.manualLocks.push({ student: studentName, seatIdx: this.targetLockSeatIdx }); } else { this.manualLocks = this.manualLocks.filter(l => l.seatIdx !== this.targetLockSeatIdx); } this.showStudentSelectModal = false; this.targetLockSeatIdx = null; this.saveToLocal(); },
            selectSeatTool(tool) { this.currentSeatTool = tool; },
            applySeatTool(idx) { if(this.currentSeatTool === 'lock') { this.targetLockSeatIdx = idx; this.showStudentSelectModal = true; } else if(this.currentSeatTool === 'empty') { this.seatConfig[idx] = 'X'; this.manualLocks = this.manualLocks.filter(l => l.seatIdx !== idx); } else if(this.currentSeatTool === 'random') { this.seatConfig[idx] = null; this.manualLocks = this.manualLocks.filter(l => l.seatIdx !== idx); } else { this.seatConfig[idx] = this.currentSeatTool; this.manualLocks = this.manualLocks.filter(l => l.seatIdx !== idx); } },
            getGridXY(idx) {
                const block = Math.floor(idx / 10);      // ë¶„ë‹¨ (0, 1, 2)
                const row = Math.floor((idx % 10) / 2);  // í–‰ (0~4)
                const col = idx % 2;                     // ë¶„ë‹¨ ë‚´ ì—´ (0, 1)
                const globalX = (block * 2) + col; 
                const globalY = row;
                return { x: globalX, y: globalY };
            },

            startSeatDraw(idx) { 
                this.isDrawingSeats = true; 
                this.dragStartIdx = idx; 
                this.applySeatTool(idx); 
            },

            overSeatDraw(currIdx) { 
                if(!this.isDrawingSeats) return;
                const start = this.getGridXY(this.dragStartIdx);
                const end = this.getGridXY(currIdx);
                const minX = Math.min(start.x, end.x);
                const maxX = Math.max(start.x, end.x);
                const minY = Math.min(start.y, end.y);
                const maxY = Math.max(start.y, end.y);

                for(let i = 0; i < 30; i++) {
                    const pos = this.getGridXY(i);
                    if (pos.x >= minX && pos.x <= maxX && pos.y >= minY && pos.y <= maxY) {
                        if (this.currentSeatTool !== 'lock' && this.manualLocks.some(l => l.seatIdx === i)) { continue; }
                        this.applySeatTool(i);
                    }
                }
            },
            endSeatDraw() { this.isDrawingSeats = false; this.dragStartIdx = null; this.saveToLocal(); },
            openShuffleModal() { this.showShuffleModal = true; this.showShuffleSettings = false; },
async startShuffleSequence() {
    this.showShuffleModal = false;
    this.isShufflingCountdown = true;
    
    // [ì†Œë¦¬ ì¶”ê°€] ì¹´ìš´íŠ¸ë‹¤ìš´ íš¨ê³¼ìŒ
    const seq = ['3', '2', '1', 'START!'];
    for (const num of seq) {
        this.shuffleCountdownNum = num;
        if (num === 'START!') this.playSound('whistle', false, 0.6);
        else this.playSound('beep', false, 0.6);
        await new Promise(r => setTimeout(r, 800));
    }
    
    this.isShufflingCountdown = false;
    this.playSound('magic'); // ì™„ë£ŒìŒ
    this.applyShuffle();
},
            selectShuffleMode(mode) {
                if (this.shuffleMode === mode) {
                    if (mode === 'mixed') { this.mixedOrder = (this.mixedOrder === 'MF') ? 'FM' : 'MF'; } 
                    else if (mode === 'same') { this.sameOrder = (this.sameOrder === 'M_First') ? 'F_First' : 'M_First'; }
                } else {
                    this.shuffleMode = mode;
                    if (mode === 'mixed') this.mixedOrder = 'MF';
                    if (mode === 'same') this.sameOrder = 'M_First';
                }
                this.applyModeToGrid();
            },

            applyModeToGrid() {
                for (let i = 0; i < 30; i++) {
                    if (this.seatConfig[i] === 'X') continue;
                    if (this.manualLocks.some(l => l.seatIdx === i)) continue;

                    const visualRow = Math.floor((i % 10) / 2); 
                    const isLeft = (i % 2 === 0); 

                    if (this.shuffleMode === 'mixed') {
                        if (this.mixedOrder === 'MF') { this.seatConfig[i] = isLeft ? 'M' : 'F'; } else { this.seatConfig[i] = isLeft ? 'F' : 'M'; }
                    } else if (this.shuffleMode === 'same') {
                        const isEvenRow = (visualRow % 2 === 0); 
                        if (this.sameOrder === 'M_First') { this.seatConfig[i] = isEvenRow ? 'M' : 'F'; } else { this.seatConfig[i] = isEvenRow ? 'F' : 'M'; }
                    } else {
                        this.seatConfig[i] = null;
                    }
                }
            },

            async applyShuffle() {
    try {
        const backupSeats = JSON.parse(JSON.stringify(this.seats));
        const backupWaiting = JSON.parse(JSON.stringify(this.waitingRoom));

        // [1] 1ì¸ì„ ê²½í—˜ íšŸìˆ˜ ê³„ì‚°
        const singleSeatCountMap = {};
        this.allStudents.forEach(s => singleSeatCountMap[s.name] = 0);
        
        // -------------------------------------------------------------
        // [2] ê¸°ë¡ Map ìƒì„± (ì§ê¿ íšŒí”¼ ë°ì´í„°ë² ì´ìŠ¤)
        // -------------------------------------------------------------
        const historyMap = new Map();
        this.allStudents.forEach(s => historyMap.set(s.name, new Set()));

        // â˜… [í•µì‹¬] ìµœê·¼ 50ê°œì˜ 'ìë¦¬ ë°°ì¹˜ ê¸°ë¡'ì„ ëª¨ë‘ í™•ì¸ (ìˆ˜ë™ ì €ì¥ í¬í•¨)
        // ëª¨ë“œ(ì´ì„±/ë™ì„±)ì™€ ìƒê´€ì—†ì´, ê³¼ê±°ì— ì§ì´ì—ˆë˜ ê¸°ë¡ì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ í”¼í•©ë‹ˆë‹¤.
        const historyToLook = this.shuffleHistory.slice(0, 50);
        
        historyToLook.forEach(rec => {
            const hSeats = Array.isArray(rec.seats) ? rec.seats : Object.values(rec.seats || {});
            
            for (let i = 0; i < 30; i++) {
                if (hSeats[i] && hSeats[i].name) {
                    // 1ì¸ì„ ì¹´ìš´íŠ¸
                    const partnerIdx = (i % 2 === 0) ? i + 1 : i - 1;
                    if (!hSeats[partnerIdx] || hSeats[partnerIdx] === 'X' || (typeof hSeats[partnerIdx] === 'object' && !hSeats[partnerIdx].name)) {
                        singleSeatCountMap[hSeats[i].name] = (singleSeatCountMap[hSeats[i].name] || 0) + 1;
                    }
                    
                    // â˜… ì§ê¿ ê´€ê³„ ë“±ë¡ (0-1, 2-3, 4-5 ...)
                    if (i % 2 === 0) {
                        const s1 = hSeats[i];
                        const s2 = hSeats[i + 1];
                        // ë‘ ìë¦¬ì— ëª¨ë‘ í•™ìƒì´ ìˆìœ¼ë©´ 'ë§Œë‚œ ì  ìˆìŒ'ìœ¼ë¡œ ê¸°ë¡
                        if (s1 && s2 && s1.name && s2.name) {
                            if (historyMap.has(s1.name)) historyMap.get(s1.name).add(s2.name);
                            if (historyMap.has(s2.name)) historyMap.get(s2.name).add(s1.name);
                        }
                    }
                }
            }
        });
        // (ì°¸ê³ : ì—¬ê¸°ì— ìˆë˜ 'ëª¨ë‘  ëª©ë¡(savedGroupings)' í™•ì¸ ì½”ë“œëŠ” ì‚­ì œí–ˆìŠµë‹ˆë‹¤)
        // -------------------------------------------------------------

        const uniqueMap = new Map();
        const currentSeats = Array.isArray(this.seats) ? this.seats : Object.values(this.seats || {});
        const currentWaiting = Array.isArray(this.waitingRoom) ? this.waitingRoom : Object.values(this.waitingRoom || {});
        [...currentSeats, ...currentWaiting].forEach(s => {
            if (s && s.name && s.name.trim() !== '') uniqueMap.set(s.name.trim(), s);
        });
        
        let pool = Array.from(uniqueMap.values());
        let newSeats = Array(30).fill(null);

        if (pool.length === 0) return alert("ë°°ì¹˜í•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

        // ì¹´ë“œ ì„ëŠ” ì• ë‹ˆë©”ì´ì…˜
        const cardElements = document.querySelectorAll('.seat-card-item');
        cardElements.forEach(el => el.classList.add('float-active', 'chaos-move'));
        for (let i = 0; i < 8; i++) {
            cardElements.forEach(el => {
                const rx = (Math.random() - 0.5) * 300; 
                const ry = (Math.random() - 0.5) * 300;
                const rot = (Math.random() - 0.5) * 30;
                el.style.transform = `translate(${rx}px, ${ry}px) scale(1.1) rotate(${rot}deg)`;
            });
            await new Promise(r => setTimeout(r, 120));
        }

        // 1. ê³ ì •ì„(ìë¬¼ì‡ ) ìš°ì„  ë°°ì¹˜
        this.manualLocks.forEach(lock => {
            if (this.seatConfig[lock.seatIdx] === 'X') return;
            const idx = pool.findIndex(s => s.name === lock.student);
            if (idx !== -1) {
                newSeats[lock.seatIdx] = pool[idx];
                pool.splice(idx, 1);
            }
        });

        // 2. ê³ ì •ì„ ì˜†ìë¦¬(ì§ê¿) ìš°ì„  ì±„ìš°ê¸°
        for (let i = 0; i < 30; i += 2) {
            let fixedStudent = null;
            let targetIdx = -1;

            if (newSeats[i] && !newSeats[i+1] && this.seatConfig[i+1] !== 'X' && !this.manualLocks.some(l => l.seatIdx === i+1)) {
                fixedStudent = newSeats[i]; targetIdx = i + 1;
            } else if (!newSeats[i] && newSeats[i+1] && this.seatConfig[i] !== 'X' && !this.manualLocks.some(l => l.seatIdx === i)) {
                fixedStudent = newSeats[i+1]; targetIdx = i;
            }

            if (fixedStudent && targetIdx !== -1) {
                let candidates = pool.filter(c => {
                    if (this.separationPairs.some(p => (p.student1===fixedStudent.name && p.student2===c.name) || (p.student1===c.name && p.student2===fixedStudent.name))) return false;
                    if (this.shuffleMode === 'mixed' && fixedStudent.gender === c.gender) return false;
                    if (this.shuffleMode === 'same' && fixedStudent.gender !== c.gender) return false;
                    if (this.seatConfig[targetIdx] && this.seatConfig[targetIdx] !== c.gender) return false;
                    return true;
                });

                candidates.sort((a, b) => {
                    // â˜… ì´ë ¥ í™•ì¸: ê³ ì •ì„ í•™ìƒê³¼ ë§Œë‚œ ì  ì—†ëŠ” í•™ìƒ ìš°ì„ 
                    const historyA = (historyMap.has(fixedStudent.name) && historyMap.get(fixedStudent.name).has(a.name)) ? 1 : 0;
                    const historyB = (historyMap.has(fixedStudent.name) && historyMap.get(fixedStudent.name).has(b.name)) ? 1 : 0;
                    if (historyA !== historyB) return historyA - historyB;
                    
                    const countA = singleSeatCountMap[a.name] || 0;
                    const countB = singleSeatCountMap[b.name] || 0;
                    return countB - countA;
                });

                if (candidates.length > 0) {
                    const bestPartner = candidates[0];
                    newSeats[targetIdx] = bestPartner;
                    const pIndex = pool.findIndex(p => p.name === bestPartner.name);
                    if (pIndex !== -1) pool.splice(pIndex, 1);
                }
            }
        }

        // 3. ë‚˜ë¨¸ì§€ í•™ìƒ ë§¤ì¹­ (solveMatching)
        const solveMatching = (inputPool) => {
            for(let tryCount = 0; tryCount < 100; tryCount++) {
                let tempPool = [...inputPool];
                
                tempPool.sort((a, b) => {
                    const countA = singleSeatCountMap[a.name] || 0;
                    const countB = singleSeatCountMap[b.name] || 0;
                    if (countA !== countB) return countB - countA;
                    return Math.random() - 0.5;
                });

                let units = [];
                let failed = false;

                while(tempPool.length > 1) {
                    const me = tempPool[0];
                    const cands = tempPool.slice(1).filter(target => {
                        // ê±°ë¦¬ë‘ê¸° í™•ì¸
                        if (this.separationPairs.some(p => (p.student1===me.name && p.student2===target.name) || (p.student1===target.name && p.student2===me.name))) return false;
                        // ì„±ë³„ ëª¨ë“œ í™•ì¸
                        if (this.shuffleMode === 'mixed' && me.gender === target.gender) return false;
                        if (this.shuffleMode === 'same' && me.gender !== target.gender) return false;
                        
                        // â˜… [ì¤‘ìš”] ì´ë ¥ í™•ì¸: ì´ë¯¸ ì§ê¿ì´ì—ˆìœ¼ë©´(historyMapì— ìˆìœ¼ë©´) ì œì™¸
                        if (historyMap.has(me.name) && historyMap.get(me.name).has(target.name)) return false;
                        
                        return true;
                    });

                    if(cands.length === 0) {
                        // ì§ì„ ëª» ì°¾ì•˜ì„ ë•Œì˜ ì²˜ë¦¬ (ì¡°ê±´ ì™„í™” ì—¬ë¶€ í™•ì¸)
                        const theoryCheck = tempPool.slice(1).some(p => 
                            (this.shuffleMode !== 'mixed' || p.gender !== me.gender) &&
                            (this.shuffleMode !== 'same' || p.gender === me.gender)
                        );
                        if(theoryCheck) { failed = true; break; } 
                        else { units.push([me]); tempPool.shift(); continue; }
                    }

                    const partner = cands[Math.floor(Math.random() * cands.length)];
                    units.push([me, partner]);
                    tempPool = tempPool.filter(s => s !== me && s !== partner);
                }

                if(!failed) {
                    if(tempPool.length > 0) units.push([tempPool[0]]);
                    return units;
                }
            }
            return null;
        };

        let finalUnits = null;
        let isFullCycle = false;

        if (this.shuffleMode === 'same') {
            const males = pool.filter(s => s.gender === 'M');
            const females = pool.filter(s => s.gender === 'F');
            const others = pool.filter(s => s.gender !== 'M' && s.gender !== 'F');
            const resM = solveMatching(males);
            const resF = solveMatching(females);
            const resO = solveMatching(others);
            if (resM && resF && resO) finalUnits = [...resM, ...resF, ...resO];
        } else {
            finalUnits = solveMatching(pool);
        }

        // [ì‹¤íŒ¨ ì‹œ] ì¡°ê±´ ì™„í™” (ì´ë ¥ ë¬´ì‹œ)
        if (!finalUnits) {
            isFullCycle = true; 
            const solveLoose = (inputPool) => {
                let tempPool = [...inputPool];
                tempPool.sort((a, b) => (singleSeatCountMap[b.name] || 0) - (singleSeatCountMap[a.name] || 0));
                let units = [];
                while(tempPool.length > 1) {
                    const s1 = tempPool.shift();
                    let bestIdx = -1, minHistory = Infinity;
                    for(let k=0; k<tempPool.length; k++) {
                        const s2 = tempPool[k];
                        if (this.separationPairs.some(p => (p.student1===s1.name && p.student2===s2.name) || (p.student1===s2.name && p.student2===s1.name))) continue;
                        if (this.shuffleMode === 'mixed' && s1.gender === s2.gender) continue;
                        if (this.shuffleMode === 'same' && s1.gender !== s2.gender) continue;
                        
                        // ì´ë ¥ì´ ìˆì–´ë„ í—ˆìš©í•˜ë˜, ê°€ì¤‘ì¹˜ë¥¼ ë‘ 
                        let hCount = (historyMap.has(s1.name) && historyMap.get(s1.name).has(s2.name)) ? 100 : 0;
                        if (hCount < minHistory) { minHistory = hCount; bestIdx = k; }
                    }
                    if(bestIdx !== -1) { units.push([s1, tempPool[bestIdx]]); tempPool.splice(bestIdx, 1); } 
                    else { units.push([s1]); }
                }
                if(tempPool.length > 0) units.push([tempPool[0]]);
                return units;
            };
            finalUnits = (this.shuffleMode === 'same') ? 
                [...solveLoose(pool.filter(s=>s.gender==='M')), ...solveLoose(pool.filter(s=>s.gender==='F'))] : solveLoose(pool);
        }

        // 4. ìë¦¬ ì±„ìš°ê¸° ë¡œì§ (VIP: ê±°ë¦¬ë‘ê¸° í•„ìš” ê·¸ë£¹ / Normal: ì¼ë°˜)
        const vipUnits = finalUnits.filter(u => u.some(s => this.separationPairs.some(p => p.student1 === s.name || p.student2 === s.name)));
        const normalUnits = finalUnits.filter(u => !vipUnits.includes(u));

        let doubleSlots = [];
        for (let i = 0; i < 30; i += 2) {
            if (!newSeats[i] && !newSeats[i+1] && this.seatConfig[i] !== 'X' && this.seatConfig[i+1] !== 'X' &&
                !this.manualLocks.some(l => l.seatIdx === i || l.seatIdx === i+1)) {
                doubleSlots.push([i, i+1]);
            }
        }
        doubleSlots.sort((a, b) => Math.abs(15 - b[0]) - Math.abs(15 - a[0]));

        const fillProcess = (targetUnits) => {
            const failed = [];
            targetUnits.forEach(unit => {
                if (unit.length === 2 && doubleSlots.length > 0) {
                    let placed = false;
                    for(let i=0; i<doubleSlots.length; i++) {
                        const slot = doubleSlots[i];
                        const c1 = this.seatConfig[slot[0]], c2 = this.seatConfig[slot[1]];
                        const u1 = unit[0], u2 = unit[1];
                        const normal = (!c1 || c1===u1.gender) && (!c2 || c2===u2.gender);
                        const reverse = (!c1 || c1===u2.gender) && (!c2 || c2===u1.gender);
                        if(normal) { newSeats[slot[0]] = u1; newSeats[slot[1]] = u2; doubleSlots.splice(i, 1); placed = true; break; }
                        else if(reverse) { newSeats[slot[0]] = u2; newSeats[slot[1]] = u1; doubleSlots.splice(i, 1); placed = true; break; }
                    }
                    if(!placed) failed.push(...unit);
                } else { failed.push(...unit); }
            });
            return failed;
        };

        let leftovers = [...fillProcess(vipUnits), ...fillProcess(normalUnits)];

        let emptyIndices = [];
        for(let i=0; i<30; i++) if(!newSeats[i] && this.seatConfig[i]!=='X' && !this.manualLocks.some(l=>l.seatIdx===i)) emptyIndices.push(i);
        emptyIndices.sort(() => Math.random() - 0.5);

        leftovers.forEach(s => {
            let tidx = emptyIndices.findIndex(idx => !this.seatConfig[idx] || this.seatConfig[idx] === s.gender);
            if(tidx === -1) tidx = emptyIndices.findIndex(idx => !this.seatConfig[idx]);
            if(tidx === -1) tidx = 0;
            if(tidx !== -1) { newSeats[emptyIndices[tidx]] = s; emptyIndices.splice(tidx, 1); }
        });

        this.seats = newSeats;
        await this.runReferee(); 

        const seatedNames = new Set(this.seats.filter(s => s).map(s => s.name));
        this.waitingRoom = Array.from(uniqueMap.values()).filter(s => !seatedNames.has(s.name));

        // ì°©ì§€ ì• ë‹ˆë©”ì´ì…˜ ë° ì •ë¦¬
        await this.$nextTick();
        const newCards = document.querySelectorAll('.seat-card-item');
        newCards.forEach(el => { 
            el.classList.remove('chaos-move'); 
            el.classList.add('landing'); 
            el.style.transform = 'translate(0,0) scale(1)'; 
        });
        await new Promise(r => setTimeout(r, 600));
        newCards.forEach(el => { 
            el.classList.remove('float-active', 'landing'); 
            el.style.transform = ''; 
        });

        if (!confirm(isFullCycle ? "ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê°€ëŠ¥í•œ ì¡°í•©ì´ ì ì–´ ì¼ë¶€ ì§ê¿ì´ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤.)" : "ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            this.seats = backupSeats; this.waitingRoom = backupWaiting; return; 
        }

        const now = new Date();
        const dateStr = `${now.getMonth()+1}/${now.getDate()}`;
        
        // [ìˆ˜ì •] ìë™ ìƒì„± ê²°ê³¼ë„ ì´ë ¥ì— ì˜¬ë°”ë¥´ê²Œ ì €ì¥
        const currentMode = this.shuffleMode === 'mixed' ? 'ì´ì„±' : (this.shuffleMode === 'same' ? 'ë™ì„±' : 'ëœë¤');
        this.shuffleHistory.unshift({ id: Date.now(), date: dateStr, mode: currentMode, seats: JSON.parse(JSON.stringify(this.seats)) });
        this.saveToLocal();

    } catch (e) {
        alert("ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        console.error(e);
    }
},

            async runReferee() {
                const getPos = (idx) => {
                    const block = Math.floor(idx / 10);
                    const row = Math.floor((idx % 10) / 2);
                    const col = idx % 2;
                    return { x: block * 2 + col, y: row }; 
                };
                
                const isTooClose = (idx1, idx2) => {
                    const p1 = getPos(idx1), p2 = getPos(idx2);
                    return Math.abs(p1.x - p2.x) <= 1 && Math.abs(p1.y - p2.y) <= 1;
                };

                const findEnemyNear = (seatIdx, student) => {
                    if (!student) return null;
                    const enemies = this.separationPairs
                        .filter(p => p.student1 === student.name || p.student2 === student.name)
                        .map(p => p.student1 === student.name ? p.student2 : p.student1);
                    
                    if (enemies.length === 0) return null;

                    for (let i = 0; i < 30; i++) {
                        if (i === seatIdx || !this.seats[i]) continue;
                        if (isTooClose(seatIdx, i) && enemies.includes(this.seats[i].name)) {
                            return i; 
                        }
                    }
                    return null;
                };

                const isValidSeat = (student, idx) => {
                    if (!student) return true;
                    if (this.manualLocks.some(l => l.seatIdx === idx)) return false;
                    if (this.seatConfig[idx] === 'X') return false;
                    const conf = this.seatConfig[idx];
                    if (conf === 'M' && student.gender !== 'M') return false;
                    if (conf === 'F' && student.gender !== 'F') return false;
                    return true;
                };

                let loopCount = 0;
                while (loopCount++ < 50) {
                    let violationFound = false;
                    let targetUnit = null; 

                    for (let i = 0; i < 30; i++) {
                        if (!this.seats[i]) continue;
                        
                        const enemyIdx = findEnemyNear(i, this.seats[i]);
                        if (enemyIdx !== null) {
                            violationFound = true;

                            const myStart = Math.floor(i / 2) * 2;
                            const myUnit = [myStart, myStart + 1];
                            const myCount = (this.seats[myStart] ? 1 : 0) + (this.seats[myStart+1] ? 1 : 0);

                            const enemyStart = Math.floor(enemyIdx / 2) * 2;
                            const enemyUnit = [enemyStart, enemyStart + 1];
                            const enemyCount = (this.seats[enemyStart] ? 1 : 0) + (this.seats[enemyStart+1] ? 1 : 0);

                            if (myCount > enemyCount) {
                                targetUnit = myUnit;
                            } else if (enemyCount > myCount) {
                                targetUnit = enemyUnit;
                            } else {
                                targetUnit = Math.random() > 0.5 ? myUnit : enemyUnit;
                            }
                            
                            if (targetUnit.some(idx => this.manualLocks.some(l=>l.seatIdx===idx))) {
                                targetUnit = (targetUnit === myUnit) ? enemyUnit : myUnit;
                            }
                            
                            if (targetUnit.some(idx => this.manualLocks.some(l=>l.seatIdx===idx))) {
                                targetUnit = null; 
                            }
                            
                            break; 
                        }
                    }

                    if (!violationFound) break; 
                    if (!targetUnit) continue; 

                    const candidates = Array.from({length: 15}, (_, k) => k * 2) 
                        .filter(idx => !targetUnit.includes(idx)) 
                        .sort(() => Math.random() - 0.5); 

                    for (let destStart of candidates) {
                        const destUnit = [destStart, destStart + 1];
                        
                        if (destUnit.some(idx => this.manualLocks.some(l=>l.seatIdx===idx))) continue;

                        const s1 = this.seats[targetUnit[0]];
                        const s2 = this.seats[targetUnit[1]];
                        const d1 = this.seats[destUnit[0]];
                        const d2 = this.seats[destUnit[1]];

                        if (!isValidSeat(s1, destUnit[0]) || !isValidSeat(s2, destUnit[1])) continue;
                        if (!isValidSeat(d1, targetUnit[0]) || !isValidSeat(d2, targetUnit[1])) continue;

                        const temp1 = this.seats[targetUnit[0]];
                        const temp2 = this.seats[targetUnit[1]];
                        
                        this.seats[targetUnit[0]] = this.seats[destUnit[0]];
                        this.seats[targetUnit[1]] = this.seats[destUnit[1]];
                        
                        this.seats[destUnit[0]] = temp1;
                        this.seats[destUnit[1]] = temp2;
                        
                        break; 
                    }
                }
            },

            /* ğŸª¨ [ëŒ ë ˆì´ìŠ¤ ê¸°ëŠ¥] */
            openRockRace() {
                this.showRockRace = true;
                if (this.finalRanking.length > 0) { 
                    this.showRaceResult = true; 
                    this.showRaceSetup = false; 
                    this.startConfetti(); 
                    this.$nextTick(() => { this.resizeCanvas(); }); 
                } else { 
                    this.showRaceResult = false; 
                    this.showRaceSetup = true; 
                    this.syncParticipants(); 
                }
            },
            
            closeRace() { 
                this.showRockRace = false;
                this.isGameRunning = false; 
                cancelAnimationFrame(this.animationId); 
this.stopSound('bgm_rock');
            },
            
            forceFinishRace() {
    this.isGameRunning = false;
    cancelAnimationFrame(this.animationId); 
    this.stopSound('bgm_rock'); 
    this.playSound('fanfare');
    
    const unfinished = this.rockRunners.filter(r => !r.finished).sort((a,b) => b.x - a.x);
    unfinished.forEach(r => {
        r.finished = true;
        r.finishRank = this.finalRanking.length + 1;
        r.finishTime = Date.now() - this.startTime;
        this.finalRanking.push(r);
    });
    
    this.applyWinnerDeduction(); 
    this.showRaceResult = true;
    this.startConfetti();
},

            resetParticipants() {
                this.participantList.forEach(p => p.count = 0);
            },

            applyWinnerDeduction() {
                const winners = this.finalRanking.slice(0, 3);
                winners.forEach(winner => {
                    const participant = this.participantList.find(p => p.name === winner.name);
                    if (participant && participant.count > 0) {
                        participant.count--; 
                    }
                });
            },
            
            syncParticipants() {
    // 1. ì „ì²´ í•™ìƒ ëª…ë‹¨ì„ ê°€ì ¸ì™€ì„œ ì •ë ¬
    const sortedList = [...this.allStudents].sort((a, b) => {
        // ë²ˆí˜¸ê°€ ë‘˜ ë‹¤ ìˆëŠ” ê²½ìš° ë²ˆí˜¸ìˆœ ì •ë ¬
        if (a.number && b.number) return a.number - b.number;
        // í•œìª½ë§Œ ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš° ë²ˆí˜¸ ìˆëŠ” ìª½ì„ ìœ„ë¡œ
        if (a.number) return -1;
        if (b.number) return 1;
        // ë²ˆí˜¸ê°€ ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš° ì´ë¦„ìˆœ ì •ë ¬
        return a.name.localeCompare(b.name);
    });

    // 2. ì •ë ¬ëœ ëª…ë‹¨ì„ ê¸°ë°˜ìœ¼ë¡œ ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ìƒì„±
    this.participantList = sortedList.map(s => ({
        name: s.name,
        count: 0,
        selected: true
    }));
},

            addParticipant() { 
                this.participantList.push({ name: '', count: 1, selected: false }); 
                this.$nextTick(() => { 
                    const grid = document.querySelector('.card-grid-10'); 
                    if(grid) grid.scrollTop = grid.scrollHeight; 
                }); 
            },

            toggleSelection(item) { item.selected = !item.selected; this.updateSelectAllState(); },
            toggleSelectAll() { this.participantList.forEach(p => p.selected = this.isSelectAll); },
            updateSelectAllState() { this.isSelectAll = this.participantList.every(p => p.selected); },
            bulkAdjust(delta) { this.participantList.forEach(p => { if(p.selected) p.count = Math.max(0, p.count + delta); }); },
            startSetupResize(e) { e.preventDefault(); const sx = e.clientX, sy = e.clientY, w = this.setupW, h = this.setupH; const mv = (ev) => { this.setupW = Math.max(500, w + (ev.clientX - sx)); this.setupH = Math.max(400, h + (ev.clientY - sy)); }; document.addEventListener('mousemove', mv); document.addEventListener('mouseup', () => document.removeEventListener('mousemove', mv), { once: true }); },
            
            async startRaceSequence() {
    const activeParticipants = this.participantList.filter(p => p.name.trim() !== '' && p.count > 0 && p.selected);
    if (activeParticipants.length === 0) return alert('ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤!');
    
    this.activeSkillNames.clear(); 
    this.showRaceSetup = false; 
    this.showRaceCountdown = true; 
    this.initGameData(activeParticipants);

    // [ì†Œë¦¬ ì¶”ê°€] ì¹´ìš´íŠ¸ë‹¤ìš´
    for (const item of ['3', '2', '1', 'ëŒ êµ´ëŸ¬ê°€ìœ ~']) { 
        this.countdownNum = item;
        if(item === 'ëŒ êµ´ëŸ¬ê°€ìœ ~') this.playSound('whistle', false, 0.7);
        else this.playSound('beep', false, 0.6);
        
        const waitTime = (item === 'ëŒ êµ´ëŸ¬ê°€ìœ ~') ? 1200 : 700;
        await new Promise(r => setTimeout(r, waitTime)); 
    }

    this.showRaceCountdown = false; 
    this.playSound('bgm_rock', true, 0.3); // [ì†Œë¦¬ ì¶”ê°€] BGM ì‹œì‘
    this.startGameLoop();
},

            initGameData(participants) {
                // 1. ë³€ìˆ˜ ë° ë°°ì—´ ì´ˆê¸°í™”
                this.rockRunners = []; 
                this.obstacles = []; 
                this.mysteryBoxes = []; 
                this.projectiles = []; 
                this.finalRanking = [];
                this.cameraX = 0; 
                this.timeScale = 1.0; 
                this.slowMoTimer = 0; 
                this.flashTimer = 0; 
                this.firstWinner = null;
                this.activeSkillNames.clear();

                const laneCount = 12;
                const laneHeight = (window.innerHeight - 200) / laneCount;
                const lanes = Array.from({length: laneCount}, (_, i) => 150 + i * laneHeight);

                let idCounter = 0; 
                let obsId = 0; 
                let boxIdCounter = 0;

                // [A] ì„ ìˆ˜ ìƒì„± (ì´ ë¶€ë¶„ì´ ì—†ìœ¼ë©´ ê²½ê¸°ê°€ ì‹œì‘ë˜ì–´ë„ ì•„ë¬´ë„ ì—†ìŠµë‹ˆë‹¤!)
                participants.forEach(p => {
                    for(let i=0; i<p.count; i++) {
                        const randomAvatar = ROCK_AVATARS[Math.floor(Math.random() * ROCK_AVATARS.length)];
                        const myLaneY = lanes[Math.floor(Math.random() * laneCount)];
                        this.rockRunners.push({
    id: idCounter++,
    name: p.name,
    x: 0,
    y: myLaneY,
    speed: 0,
    baseSpeed: (3 + Math.random() * 2) * 0.75,
    state: 'run',
    stateTimer: 0,
    finished: false,
    finishTime: 0,
    finishRank: 0,
    rotation: 0,
    cooldown: 0,
    avatar: randomAvatar,
    isGold: false,
    hitObstacles: [],
    hitBoxIds: [],
    isBurning: false,
    burnTimer: 0,
    hasUsedBoost: false,
    hitCount: 0,
    itemIcon: null,
    isInvincible: false,
    hasShield: false,
    localTimeScale: 1.0,
    slowMoTimer: 0,
    carryingShell: false,
    currentRank: 1  
});
                    }
                });

                // [B] ì¥ì• ë¬¼ ë° ë°•ìŠ¤ ë°°ì¹˜
                lanes.forEach(laneY => {
                    // 1. ë¯¸ìŠ¤í„°ë¦¬ ë°•ìŠ¤ (ìˆ˜ëŸ‰ 1/2ë¡œ ê°ì†Œ: ë ˆì¸ë‹¹ 1ê°œ)
                    // 50% í™•ë¥ ë¡œ ì´ˆë°˜(30% ì§€ì ) ë˜ëŠ” í›„ë°˜(65% ì§€ì ) ë°°ì¹˜
                    const isEarly = Math.random() < 0.5;
                    const posFactor = isEarly ? (0.3 + Math.random() * 0.15) : (0.65 + Math.random() * 0.15);
                    const boxX = this.finishLineX * posFactor;

                    this.mysteryBoxes.push({ 
                        id: `box-${boxIdCounter++}`, 
                        x: boxX, 
                        y: laneY, 
                        active: true,      
                        jumpTimer: 0,      
                        respawnTimer: 0    
                    });

                    // 2. ì¼ë°˜ ì¥ì• ë¬¼ ë°°ì¹˜
                    // 2. ì¼ë°˜ ì¥ì• ë¬¼ ë°°ì¹˜
                    let currentX = 500;
                    
                    while(currentX < this.finishLineX - 100) {
                        const nearBox = Math.abs(currentX - boxX) < 150;
                        
                        if (!nearBox) {
                            const progress = currentX / this.finishLineX;
                            let spawnChance = 0.2 + (progress * 0.5); 
                            
                            if (Math.random() < spawnChance) {
                                const type = ['hurdle', 'ice', 'banana'][Math.floor(Math.random() * 3)];
                                
                                // [ìˆ˜ì • 1] ì¥ì• ë¬¼ì´ ì¢Œìš°(Xì¶•)ë¡œ ë” ë„“ê²Œ í©ì–´ì§€ë„ë¡ ë²”ìœ„ ì¦ê°€
                                // (ê¸°ì¡´: -50~50 -> ë³€ê²½: -120~120)
                                const driftX = (Math.random() * 240) - 120;
                                const driftY = (Math.random() * 40) - 20;
                                
                                this.obstacles.push({ id: obsId++, x: currentX + driftX, y: laneY + driftY, type });
                            }
                        }
                        
                        // [ìˆ˜ì • 2] ì¥ì• ë¬¼ ìƒì„± ê°„ê²© ë„“í˜ (ì „ì²´ ê°œìˆ˜ ê°ì†Œ = ë ‰ ê°ì†Œ!)
                        // ê¸°ì¡´: 100 / 200 -> ë³€ê²½: 180 / 350
                        // ê²°ìŠ¹ì„  ê·¼ì²˜(80%)ë„ ë„ˆë¬´ ë¹½ë¹½í•˜ì§€ ì•Šê²Œ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.
                        if (currentX / this.finishLineX > 0.8) {
                            currentX += 180; // í›„ë°˜ë¶€ ê°„ê²©
                        } else {
                            currentX += 350; // ì´ˆì¤‘ë°˜ ê°„ê²©
                        }
                    }

                }); // lanes.forEach ë‹«ê¸° (ì´ ê´„í˜¸ í•„ìˆ˜!)
            }, // initGameData ë‹«ê¸° (ì´ ê´„í˜¸ í•„ìˆ˜!)
            startGameLoop() { this.isGameRunning = true; this.$nextTick(() => { this.canvas = document.getElementById('raceCanvas'); if (this.canvas) { this.ctx = this.canvas.getContext('2d'); this.startTime = Date.now(); this.resizeCanvas(); window.addEventListener('resize', this.resizeCanvas); this.loop(); } }); },
            resizeCanvas() { if(this.canvas && this.$refs.canvasContainer) { this.canvas.width = this.$refs.canvasContainer.clientWidth; this.canvas.height = this.$refs.canvasContainer.clientHeight; } },
// [NEW] ì•„ì´í…œ ë°œë™ ë¡œì§ (í™•ë¥  ì¡°ì ˆ)
            triggerItem(runner, rank, totalRunners) {
                const rand = Math.random();
                const ratio = rank / totalRunners;
                let itemType = '';
                let icon = '';

              // ğŸ¥‡ ìƒìœ„ê¶Œ (ìƒìœ„ 30%): ë°©ì–´ë§‰ ìœ„ì£¼ + ìì„
                if (ratio <= 0.3) { 
                    if (rand < 0.8) { itemType = 'shield'; icon = 'ğŸ›¡ï¸'; } // 80% ë°©ì–´ë§‰ (1ë“± ìˆ˜ì„±)
                    else { itemType = 'magnet'; icon = 'ğŸ§²'; }            // 20% ìì„
                } 
                // ğŸ¥ˆ ì¤‘ìœ„ê¶Œ (30% ~ 70%): ìì„ ìœ„ì£¼ + ê±°ë¶ì´ + ë¡œì¼“
                else if (ratio <= 0.7) { 
                    if (rand < 0.5) { itemType = 'magnet'; icon = 'ğŸ§²'; } // 50% ìì„ (ì¶”ê²©)
                    else if (rand < 0.75) { itemType = 'turtle'; icon = 'ğŸ¢'; } // 25% ê±°ë¶ì´ (ê²¬ì œ)
                    else { itemType = 'rocket'; icon = 'ğŸ”¥'; }            // 25% ë¡œì¼“ (ì—­ì „)
                } 
                // ğŸ¥‰ í•˜ìœ„ê¶Œ (í•˜ìœ„ 30%): ë²ˆê°œ ìœ„ì£¼ + ê±°ë¶ì´ + ë¡œì¼“
                else { 
                    if (rand < 0.5) { itemType = 'lightning'; icon = 'âš¡'; } // 50% ë²ˆê°œ (íŒ ë’¤ì§‘ê¸°)
                    else if (rand < 0.75) { itemType = 'turtle'; icon = 'ğŸ¢'; } // 25% ê±°ë¶ì´
                    else { itemType = 'rocket'; icon = 'ğŸ”¥'; }            // 25% ë¡œì¼“
                }

                // [ë§¤ë„ˆ ëª¨ë“œ] í˜„ì¬ 1ë“±ì´ ê³µê²© ì•„ì´í…œì„ ë½‘ìœ¼ë©´ ë°©ì–´ë§‰ìœ¼ë¡œ ìë™ ë³€ê²½
                if (rank === 1 && (itemType === 'turtle' || itemType === 'lightning' || itemType === 'magnet')) {
                    itemType = 'shield'; icon = 'ğŸ›¡ï¸';
                }

                runner.itemIcon = icon;
                setTimeout(() => { runner.itemIcon = null; }, 2000);

                // 2. ì•„ì´í…œë³„ íš¨ê³¼ ì‹¤í–‰
               if (itemType === 'rocket') {
                    runner.isBurning = true;     
                    runner.burnTimer = 150; // 2.5ì´ˆ (60í”„ë ˆì„ * 2.5)
                    runner.isInvincible = false; 
                    runner.state = 'run';
                }
                else if (itemType === 'shield') {
                    runner.hasShield = true; 
                }
                else if (itemType === 'lightning') {
                    this.flashTimer = 20;
                    const topFive = this.rockRunners
                        .filter(r => !r.finished)
                        .sort((a, b) => b.x - a.x)
                        .slice(0, 5);
                    topFive.forEach(r => {
                        if (r.id !== runner.id && !r.isInvincible) {
                            if (r.hasShield) { r.hasShield = false; } 
                            else { r.state = 'stunned'; r.stateTimer = 150; }
                        }
                    });
                }
                else if (itemType === 'turtle') {
                    const target = this.rockRunners
                        .filter(r => !r.finished && r.x > runner.x && !r.isInvincible)
                        .sort((a, b) => b.x - a.x)[0];
                    if (target) {
                        if (target.hasShield) { target.hasShield = false; } 
                        else {
                            target.state = 'isTurtle';
                            target.stateTimer = 120;
                            target.speed = target.baseSpeed * 0.1; // ê±°ë¶ì´ ì†ë„ ì¡°ì ˆ
                        }
                    }
                }
                else if (itemType === 'magnet') {
                    const leader = this.rockRunners
                        .filter(r => !r.finished && r.id !== runner.id)
                        .sort((a, b) => b.x - a.x)[0];
                    if (leader) {
                        leader.speed *= 0.5;
                        leader.itemIcon = 'ğŸ§²';
                        leader.iconType = 'pulled'; // ë‹¹ê²¨ì§€ëŠ” ì‚¬ëŒ (â†)
                        
                        runner.speed *= 2;
                        runner.itemIcon = 'ğŸ§²';
                        runner.iconType = 'pulling'; // ë‹¹ê¸°ëŠ” ì‚¬ëŒ (â†’)

                        setTimeout(() => {
                            leader.itemIcon = null; leader.iconType = null;
                            runner.itemIcon = null; runner.iconType = null;
                        }, 3000);
                    }
                }
            },

          loop() {
                if(!this.isGameRunning) return;

                if (!this.frameCounter) this.frameCounter = 0;
                this.frameCounter++;

                // [ìµœì í™”] ë­í‚¹ ê°±ì‹  (0.5ì´ˆë§ˆë‹¤)
                if (this.frameCounter % 30 === 0) { 
                    const activeRunners = this.rockRunners.filter(r => !r.finished);
                    activeRunners.sort((a, b) => b.x - a.x);
                    activeRunners.forEach((r, index) => { r.currentRank = index + 1; });
                }

                // [ìµœì í™”] ì§€ë‚˜ê°„ ì¥ì• ë¬¼ ì‚­ì œ (1ì´ˆë§ˆë‹¤)
                if (this.frameCounter % 60 === 0) {
                    this.obstacles = this.obstacles.filter(obs => obs.x > this.cameraX - 600);
                    this.mysteryBoxes = this.mysteryBoxes.filter(box => box.x > this.cameraX - 600);
                }

                // â˜… [í•µì‹¬ ìˆ˜ì •] ì´ ë³€ìˆ˜ê°€ ì—†ì–´ì„œ ê²Œì„ì´ ë©ˆì·„ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì™„ë£Œ!
                const currentTotalRunners = this.rockRunners.length; 

                // ìŠ¬ë¡œìš° ëª¨ì…˜ ë¡œì§ ì‚­ì œ (ì •ì† ì£¼í–‰)
                this.timeScale = 1.0; 
                this.slowMoTimer = 0;

                const ctx = this.ctx; 
                const width = this.canvas.width; 
                const height = this.canvas.height;
                
                ctx.fillStyle = "#a7f3d0"; 
                ctx.fillRect(0, 0, width, height); 
                
                if (this.flashTimer > 0) this.flashTimer--;
                ctx.strokeStyle = "rgba(255,255,255,0.4)"; 
                ctx.lineWidth = 2;

                // [íˆ¬ì‚¬ì²´ ê·¸ë¦¬ê¸°]
                for (let i = this.projectiles.length - 1; i >= 0; i--) {
                    const p = this.projectiles[i];
                    const target = this.rockRunners.find(r => r.id === p.targetId);
                    if (!target || target.finished) { this.projectiles.splice(i, 1); continue; }
                    p.y += p.speed * this.timeScale * 5; 
                    const drawX = p.x - this.cameraX;
                    if (drawX > -100 && drawX < width + 100) {
                        ctx.save(); ctx.translate(drawX, p.y); ctx.rotate(Date.now() / 50);
                        ctx.font = "100px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ¢", 0, 0); ctx.restore();
                    }
                    if (p.y >= target.y) {
                        if (target.hasShield) target.hasShield = false;
                        else if (!target.isInvincible) { target.state = 'isTurtle'; target.stateTimer = 90; target.speed = target.baseSpeed * 0.1; }
                        this.projectiles.splice(i, 1);
                    }
                }

                // [ë¼ì¸ ê·¸ë¦¬ê¸°]
                const paddingTop = 160; const lineCount = 12; const lineGap = (height - paddingTop) / lineCount;
                for(let i=0; i<=lineCount; i++) { const y = paddingTop + i * lineGap; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke(); }
                const relativeFinishX = this.finishLineX - this.cameraX;
                if(relativeFinishX > -200 && relativeFinishX < width + 200) this.drawFinishLine(ctx, relativeFinishX, height);

                // [ë°•ìŠ¤ ê·¸ë¦¬ê¸°]
                this.mysteryBoxes.forEach(box => {
                    if (!box.active) { box.respawnTimer--; if (box.respawnTimer <= 0) box.active = true; }
                    if (box.active || box.jumpTimer > 0) {
                        const drawX = box.x - this.cameraX;
                        if (drawX > -100 && drawX < width + 100) {
                            ctx.save();
                            let boxYOffset = 0;
                            if (box.jumpTimer > 0) { boxYOffset = -Math.sin((box.jumpTimer / 20) * Math.PI) * 40; box.jumpTimer--; }
                            ctx.translate(drawX, box.y + boxYOffset); ctx.globalAlpha = box.active ? 1.0 : box.jumpTimer / 20; 
                            const boxFloatY = Math.sin(Date.now() / 200) * 8; 
                            ctx.font = "70px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ", 0, boxFloatY); ctx.restore();
                        }
                    }
                });
                
                // [ì¥ì• ë¬¼ ê·¸ë¦¬ê¸°]
                this.obstacles.forEach(obs => { 
                    const dx = obs.x - this.cameraX; 
                    if(dx > -100 && dx < width + 100) { 
                        ctx.save(); ctx.translate(dx, obs.y + 25); ctx.scale(1.5, 1.5); 
                        ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(0, 0, 25, 8, 0, 0, Math.PI*2); ctx.fill(); 
                        ctx.textAlign = "center"; ctx.fillStyle = "#000"; ctx.globalAlpha = 1.0; ctx.font = "50px Arial";
                        let icon = obs.type==='hurdle'?'ğŸš§':(obs.type==='ice'?'ğŸ§Š':'ğŸŒ');
                        ctx.fillText(icon, 0, -5); ctx.restore();
                    }
                });

                // [ì„ ìˆ˜ ì´ë™ ë° ê·¸ë¦¬ê¸°]
                let leaderX = 0; 
                let finishedCount = 0;
                
                this.rockRunners.forEach(r => {
                    // ... (ì„ ìˆ˜ ìƒíƒœ ê´€ë¦¬ ë° ì´ë™ ë¡œì§) ...
                    if (typeof r.localTimeScale === 'undefined') r.localTimeScale = 1.0;
                    if (typeof r.slowMoTimer === 'undefined') r.slowMoTimer = 0;
                    if (typeof r.isBurning === 'undefined') r.isBurning = false;
                    if (typeof r.burnTimer === 'undefined') r.burnTimer = 0;

                    if(!r.finished) {
                        if (r.slowMoTimer > 0) { r.localTimeScale = 0.2; r.slowMoTimer--; } else { r.localTimeScale = 1.0; }
                        if (r.isBurning) { r.burnTimer -= (this.timeScale * r.localTimeScale); if (r.burnTimer <= 0) { r.isBurning = false; r.isInvincible = false; r.state = 'run'; } } 
                        
                        if (['stunned', 'jump', 'spin', 'slip', 'tired', 'isTurtle'].includes(r.state)) {
                            r.stateTimer -= (this.timeScale * r.localTimeScale);
                            if (r.stateTimer <= 0) {
                                if (r.state === 'stunned') r.speed = r.baseSpeed; 
                                if (r.state === 'isTurtle') { r.speed = r.baseSpeed; }
                                r.state = 'run'; if (r.speed < 0) r.speed = 0;
                            }
                        }
                        if (r.state === 'stunned' || r.state === 'spin') { 
                            r.speed = 0; if (r.state === 'spin') r.rotation += 0.4; 
                        } else {
                            if(r.cooldown > 0) r.cooldown -= (this.timeScale * r.localTimeScale);
                            if (r.speed < r.baseSpeed) { if (r.state !== 'isTurtle') r.speed += 0.0285; }
                            let moveSpeed = r.speed * this.timeScale * r.localTimeScale;
                            if (r.isBurning) moveSpeed *= 3.0; 

                            // ì¶©ëŒ 1: ë°•ìŠ¤
                            let approachesBox = false;
                            for (let box of this.mysteryBoxes) {
                                if (!box.active) continue;
                                if (box.x < r.x - 100 || box.x > r.x + 300) continue;
                                const distY = Math.abs(r.y - box.y); const distX = box.x - r.x; 
                                if (distY < 30 && distX > -20 && distX < 180) { approachesBox = true; if (r.speed > 2.0) r.speed *= 0.95; if (r.state === 'run' && distX < 150) { r.state = 'jump'; r.stateTimer = 60; } }
                                if (distY < 30 && Math.abs(distX) < 60) {
                                    if (!r.hitBoxIds.includes(box.id)) {
                                        r.hitBoxIds.push(box.id); box.active = false; box.respawnTimer = 60; box.jumpTimer = 20; 
                                        // â˜… ìˆ˜ì •: ì´ì œ currentTotalRunnersê°€ ì¡´ì¬í•˜ë¯€ë¡œ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                        this.triggerItem(r, r.currentRank || 1, currentTotalRunners); 
                                    }
                                    break; 
                                }
                            }
                            
                            // ì¶©ëŒ 2: ì¥ì• ë¬¼
                            if (!approachesBox && r.cooldown <= 0 && r.state !== 'jump') {
                                for (let obs of this.obstacles) {
                                    if (obs.x < r.x - 50 || obs.x > r.x + 100) continue;
                                    if (Math.abs(r.y - obs.y) < 20 && Math.abs(r.x - obs.x) < 50) {
                                        if (r.hitObstacles.includes(obs.id)) continue;
                                        if (r.isBurning) { r.isBurning = false; r.burnTimer = 0; r.speed = 0; }
                                        if (r.state === 'isTurtle') { r.state = 'run'; r.stateTimer = 0; r.speed = r.baseSpeed; }
                                        if (r.hasShield) {
                                            r.hasShield = false; r.cooldown = 60; r.hitObstacles.push(obs.id);
                                            r.itemIcon = 'ğŸ›¡ï¸'; setTimeout(() => { if (r.itemIcon === 'ğŸ›¡ï¸') r.itemIcon = null; }, 1000);
                                            break; 
                                        }
                                        r.cooldown = 30; r.hitObstacles.push(obs.id); r.hitCount++;
                                        if (obs.type === 'hurdle') { r.state = 'jump'; r.stateTimer = 50; } 
                                        else if (obs.type === 'ice') { r.state = 'spin'; r.stateTimer = 90; } 
                                        else { r.state = 'slip'; r.stateTimer = 90; r.speed = -4; }
                                        break; 
                                    }
                                }
                            }
                            
                            // ì†ë„ ì €í•­
                            let finalMoveSpeed = (r.state === 'slip' ? r.speed : moveSpeed);
                            if (r.state === 'jump') finalMoveSpeed *= 0.5;
                            r.x += finalMoveSpeed;

                            if (r.state === 'slip') { r.speed += 0.1; if (r.speed > 0) r.speed = 0; }
                            if (r.state !== 'sleep') r.rotation += finalMoveSpeed * 0.05;

                            if (r.x >= this.finishLineX && !r.finished) {
                                r.finished = true; r.finishTime = Date.now() - this.startTime; r.finishRank = this.finalRanking.length + 1; 
                                this.finalRanking.push(r); r.speed = 0;
                                if (r.finishRank === 1) { this.firstWinner = r; } 
                                if (r.finishRank <= 3) r.isGold = true; 
                                if (this.finalRanking.length === this.rockRunners.length) { r.state = 'sleep'; r.speed = 0; }
                            }
                        }
                    } else {
                        if (r.state !== 'sleep') { if (r.x < this.finishLineX + 250) r.x += 2 * this.timeScale; }
                        finishedCount++;
                    }
                    if(r.x > leaderX && !r.finished) leaderX = r.x;
                    
                    // [ìµœì í™”] í™”ë©´ ë°– ê·¸ë¦¬ê¸° ì œì™¸
                    const drawX = r.x - this.cameraX; 
                    if (drawX > -150 && drawX < width + 150) {
                        let yOffset = 0; if(r.state === 'jump') { yOffset = -Math.sin((r.stateTimer/50) * Math.PI) * 60; } 
                        this.drawRock(ctx, drawX, r.y + yOffset, r);
                    }
                });

                let targetCamX = leaderX - width * 0.5;
                const maxCamX = this.finishLineX - width * 0.6; targetCamX = Math.max(this.cameraX, Math.min(targetCamX, maxCamX)); this.cameraX += (targetCamX - this.cameraX) * 0.0475;
                
                if (finishedCount === this.rockRunners.length) {
                    if (!this.showRaceResult) {
                        this.isGameRunning = false; 
                        setTimeout(() => { this.applyWinnerDeduction(); this.showRaceResult = true; this.startConfetti(); }, 1000);
                    }
                } else {
                    this.animationId = requestAnimationFrame(this.loop);
                }
            },
            drawSpotlight(ctx, w, h) { if (!this.firstWinner) return; const wx = this.firstWinner.x - this.cameraX; const wy = this.firstWinner.y; ctx.save(); const grd = ctx.createRadialGradient(wx, wy, 50, wx, wy, 400); grd.addColorStop(0, "rgba(0,0,0,0)"); grd.addColorStop(1, "rgba(0,0,0,0.6)"); ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h); ctx.restore(); },
            drawRock(ctx, x, y, r) {
                ctx.save(); ctx.translate(x, y); ctx.scale(1.5, 1.5); ctx.font = "24px 'Jua'";
                
                // [ìµœì í™”] ì•„ì´í…œ ì•„ì´ì½˜: ê·¸ë¦¼ì ì œê±°, ê·¸ë¦¬ê¸° ë‹¨ìˆœí™”
               if (r.itemIcon) {
    ctx.save();
    let iconX = 0; 
    let iconY = -70 + Math.sin(Date.now() / 100) * 10;

    // ìì„ ì•„ì´ì½˜ íŠ¹ìˆ˜ íšŒì „ ë¡œì§
    if (r.itemIcon === 'ğŸ§²' && r.iconType) {
        if (r.iconType === 'pulled') { 
            iconX = -60; iconY = 0; 
            ctx.translate(iconX, iconY); 
            // ê¸°ì¡´ -90ë„ì—ì„œ -90ë„ ë” íšŒì „ = -180ë„ (Math.PI)
            ctx.rotate(-Math.PI); 
        } 
        else if (r.iconType === 'pulling') { 
            iconX = 60; iconY = 0; 
            ctx.translate(iconX, iconY); 
            // ê¸°ì¡´ 90ë„ì—ì„œ -90ë„ ë” íšŒì „ = 0ë„
            ctx.rotate(0); 
        }
    } else { 
        // ì¼ë°˜ ì•„ì´í…œì€ ìœ„ìª½(iconY)ì— í‘œì‹œ
        ctx.translate(iconX, iconY); 
    }

    // ê³µí†µ ê·¸ë¦¬ê¸° ì„¤ì •
    ctx.font = "bold 60px 'Noto Color Emoji', Arial"; // ì´ëª¨ì§€ í°íŠ¸ ì¶”ê°€ ê¶Œì¥
    ctx.textAlign = "center"; 
    ctx.textBaseline = "middle";
    ctx.fillText(r.itemIcon, 0, 0); 
    ctx.restore();
}

                // ëŒë©©ì´ ê·¸ë¦¬ê¸°
                if (r.state === 'isTurtle') {
                    ctx.font = "75px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ğŸ¢", 0, -3);
                } else {
                    if (r.state === 'flattened') { ctx.scale(1.3, 0.7); }
                    if (r.isBurning) { 
                        ctx.fillStyle = "#ef4444"; 
                    } else {
                        ctx.fillStyle = "rgba(0,0,0,0.15)"; ctx.beginPath(); ctx.ellipse(0, 20, 25, 8, 0, 0, Math.PI*2); ctx.fill(); 
                        if (r.state !== 'sleep' && r.state !== 'stunned' && r.state !== 'flattened') { ctx.rotate(r.rotation); }
                        ctx.fillStyle = r.isGold ? "#fbbf24" : "#6b7280"; 
                    }
                    ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0, -30); ctx.quadraticCurveTo(27, -22, 30, 0); ctx.quadraticCurveTo(22, 30, 0, 33); ctx.quadraticCurveTo(-27, 27, -30, 0); ctx.quadraticCurveTo(-22, -30, 0, -30); ctx.fill(); ctx.stroke();
                    
                    // í‘œì • (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
                    if (r.state === 'flattened') {
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 4;
                        ctx.beginPath(); ctx.moveTo(-12, -5); ctx.lineTo(-4, 0); ctx.lineTo(-12, 5); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(12, -5); ctx.lineTo(4, 0); ctx.lineTo(12, 5); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(-8, 15); ctx.lineTo(-4, 10); ctx.lineTo(0, 15); ctx.lineTo(4, 10); ctx.lineTo(8, 15); ctx.stroke();
                    } else if (r.state === 'sleep') {
                        ctx.strokeStyle = "#4b5563"; ctx.lineWidth = 3; ctx.lineJoin = "round"; ctx.lineCap = "round";
                        ctx.beginPath(); ctx.moveTo(-14, -8); ctx.lineTo(-6, -8); ctx.lineTo(-14, -2); ctx.lineTo(-6, -2); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(6, -8); ctx.lineTo(14, -8); ctx.lineTo(6, -2); ctx.lineTo(14, -2); ctx.stroke();
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.moveTo(-8, 10); ctx.lineTo(8, 10); ctx.stroke();
                    } else if(r.isBurning) {
                        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(-9, -3, 5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(9, -3, 5, 0, Math.PI*2); ctx.fill(); 
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-15, -10); ctx.lineTo(-5, -2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(15, -10); ctx.lineTo(5, -2); ctx.stroke(); 
                    } else if (r.state === 'stunned') {
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 2.5;
                        ctx.beginPath(); ctx.moveTo(-13, -7); ctx.lineTo(-5, 1); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-5, -7); ctx.lineTo(-13, 1); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(5, -7); ctx.lineTo(13, 1); ctx.stroke(); ctx.beginPath(); ctx.moveTo(13, -7); ctx.lineTo(5, 1); ctx.stroke();
                        ctx.fillStyle = "#000"; ctx.beginPath(); ctx.ellipse(0, 8, 4, 6, 0, 0, Math.PI*2); ctx.fill();
                    } else {
                        ctx.fillStyle = "rgba(0,0,0,0.1)"; ctx.beginPath(); ctx.arc(-12, -12, 4, 0, Math.PI*2); ctx.fill(); 
                        ctx.fillStyle = "#000"; ctx.beginPath(); ctx.arc(-9, -3, 3.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(9, -3, 3.5, 0, Math.PI*2); ctx.fill(); 
                        ctx.fillStyle = "#fca5a5"; ctx.beginPath(); ctx.ellipse(-13, 7, 4, 2, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(13, 7, 4, 2, 0, 0, Math.PI*2); ctx.fill(); 
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.arc(0, 3, 4, 0, Math.PI); ctx.stroke(); 
                    }
                }
                
                // ë²ˆê°œ ë° ì™•ê´€, Z ì´í™íŠ¸
                if (r.state === 'stunned') {
                    ctx.save(); ctx.font = "bold 50px Arial"; ctx.textAlign = "center";
                    const jitterY = -75 + Math.sin(Date.now() / 50) * 5; 
                    ctx.fillText("âš¡", 0, jitterY); ctx.restore();
                }
                if (r.finished && r.isGold) {
                    ctx.save(); ctx.textAlign = "center"; const bounce = Math.sin(Date.now() / 100) * 5; ctx.font = "50px Arial"; ctx.fillText("ğŸ‘‘", 0, -55 + bounce); ctx.restore();
                }
                if (r.state === 'sleep') {
                    ctx.save(); ctx.font = "bold 30px Arial"; ctx.fillStyle = "#3b82f6"; ctx.fillText("Z", 35, -40); ctx.restore();
                }
                ctx.restore();

                // [ìµœì í™”] ì´ë¦„í‘œ ê·¸ë¦¬ê¸° (measureText ì œê±° ë° ë‹¨ìˆœí™”)
                ctx.save(); ctx.translate(x, y); ctx.scale(1.5, 1.5); 
ctx.font = "24px 'Jua', sans-serif";
                // const tw = ctx.measureText(r.name).width; <--- [ì œê±°ë¨] ë§¤ í”„ë ˆì„ ê³„ì‚°í•˜ëŠ” ë¬´ê±°ìš´ ì‘ì—…
                const estimatedWidth = r.name.length * 15 + 20; // [ëŒ€ì²´] ê¸€ììˆ˜ë¡œ ëŒ€ì¶© ê³„ì‚° (í›¨ì”¬ ë¹ ë¦„)
                
                ctx.fillStyle = "rgba(255, 255, 255, 0.95)"; ctx.strokeStyle = "#10b981"; ctx.lineWidth = 2;
ctx.lineJoin = "round";                ctx.beginPath(); 
ctx.roundRect(-estimatedWidth/2, 32, estimatedWidth, 30, 8); ctx.fill(); ctx.stroke();
                ctx.fillStyle = "#064e3b"; ctx.textAlign = "center"; ctx.fillText(r.name, 0, 55); ctx.restore();
            },

            drawSpiralAt(ctx, x, y) { ctx.save(); ctx.translate(x, y); ctx.beginPath(); for (let i = 0; i < 20; i++) { const angle = 0.5 * i; const r = 0.3 * i; const dx = r * Math.cos(angle); const dy = r * Math.sin(angle); if (i === 0) ctx.moveTo(dx, dy); else ctx.lineTo(dx, dy); } ctx.stroke(); ctx.restore(); },
            drawFinishLine(ctx, x, h) { ctx.fillStyle = "#475569"; ctx.fillRect(x, 0, 30, h); ctx.fillStyle = "#fff"; ctx.fillRect(x, 0, 60, h); ctx.fillStyle = "#000"; for(let i=0; i<h; i+=60) { ctx.fillRect(x, i, 30, 30); ctx.fillRect(x+30, i+30, 30, 30); } ctx.save(); ctx.translate(x - 30, h/2); ctx.rotate(-Math.PI/2); ctx.font = "900 80px 'Black Han Sans'"; ctx.fillStyle = "rgba(0,0,0,0.1)"; ctx.textAlign = "center"; ctx.fillText("FINISH LINE", 0, 0); ctx.restore(); },
            fullResetRace() { this.showRaceResult = false; this.isGameRunning = false; this.showRaceSetup = true; this.finalRanking = []; },
            startConfetti() {
                const canvas = document.getElementById('confettiCanvas'); if (!canvas) return;
                const ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                const p = Array.from({length: 150}, () => ({ x: Math.random() * canvas.width, y: Math.random() * -canvas.height, c: ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)], s: Math.random() * 5 + 5, d: Math.random() * 5 + 2 }));
                const draw = () => { if(!this.showRaceResult) return; ctx.clearRect(0,0,canvas.width,canvas.height); p.forEach(i => { ctx.fillStyle = i.c; ctx.fillRect(i.x, i.y+=i.d, i.s, i.s); if(i.y>canvas.height) i.y = -20; }); requestAnimationFrame(draw); }; draw();
            },
 // [ì¶”ê°€] ê±°ê¾¸ë¡œ íƒ€ê¸° (ì•„ë˜ -> ìœ„) ë¡œì§
// [ìˆ˜ì •ë¨] ê±°ê¾¸ë¡œ íƒ€ê¸° ë¡œì§ (ì•„ë˜ -> ìœ„)
startReverseLadderGame(endColIdx) {
    if (this.isLadderAnimating) return;
    this.isLadderAnimating = true;
    this.playSound('move', true);

    if (this.ballHideTimeout) clearTimeout(this.ballHideTimeout);
    
    // ê²°ê³¼ ë¯¸ë¦¬ ê³µê°œ ë°©ì§€
    if (!this.revealedResults.includes(endColIdx)) {
        this.revealedResults.push(endColIdx);
    }

    this.activePolyline = '';
    let pathPoints = [];
    let currentCol = endColIdx;
    let currentY = 950; // ë°”ë‹¥ì—ì„œ ì‹œì‘

    // ì‹œì‘ì 
    pathPoints.push({ x: this.getLadderX(currentCol), y: currentY });

    // ì²œì¥ì— ë‹¿ì„ ë•Œê¹Œì§€ ë°˜ë³µ
    while (currentY > 120) {
        const possibleBridges = this.ladderLines.filter(line => 
            line.col === currentCol || line.col === currentCol - 1
        );

        let validBridge = null;
        let minDist = Infinity;

        possibleBridges.forEach(line => {
            let entryY;
            // Case 1: ë‚˜ëŠ” ì™¼ìª½, ë‹¤ë¦¬ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë»—ì–´ ìˆìŒ -> ì§„ì…ì ì€ line.y
            // Case 2: ë‚˜ëŠ” ì˜¤ë¥¸ìª½, ë‹¤ë¦¬ëŠ” ì™¼ìª½ì—ì„œ ì˜´ -> ì§„ì…ì ì€ line.y + line.slant
            if (line.col === currentCol) {
                entryY = line.y; 
            } else {
                entryY = line.y + line.slant; 
            }

            // â˜… í˜„ì¬ ë†’ì´ë³´ë‹¤ 'í™•ì‹¤íˆ ìœ„'ì— ìˆëŠ” ë‹¤ë¦¬ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒ ì°¾ê¸°
            if (entryY < currentY - 1) { 
                const dist = currentY - entryY;
                if (dist < minDist) {
                    minDist = dist;
                    validBridge = { line, entryY };
                }
            }
        });

        if (!validBridge) {
            pathPoints.push({ x: this.getLadderX(currentCol), y: 50 });
            break;
        }

        const { line, entryY } = validBridge;

        // 1. ìˆ˜ì§ ì´ë™ (ìœ„ë¡œ)
        pathPoints.push({ x: this.getLadderX(currentCol), y: entryY });
        currentY = entryY;

        // 2. ìˆ˜í‰ ì´ë™ (ë‹¤ë¦¬ ê±´ë„ˆê¸°)
        if (line.col === currentCol) {
            // ì™¼ìª½ -> ì˜¤ë¥¸ìª½ (ê±´ë„ˆê°€ë©´ slantê°€ ë”í•´ì§)
            currentCol++;
            const exitY = line.y + line.slant;
            pathPoints.push({ x: this.getLadderX(currentCol), y: exitY });
            currentY = exitY;
        } else {
            // ì˜¤ë¥¸ìª½ -> ì™¼ìª½ (ê±´ë„ˆê°€ë©´ slantê°€ ì—†ì–´ì§)
            currentCol--;
            const exitY = line.y;
            pathPoints.push({ x: this.getLadderX(currentCol), y: exitY });
            currentY = exitY;
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ë„ì°© ì‹œ ìƒë‹¨ ë²ˆí˜¸ currentCol ì „ë‹¬)
    this.runSVGAnimation(pathPoints, null, currentCol); 
}
},
        mounted() { 
    // 1. ì„œë²„ ë°ì´í„° ë¡œë“œ
    this.loadFromFirebase(); 

    // 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('keydown', this.handleEscKey);
    window.addEventListener('resize', () => { 
        this.resizeLadderCanvas(); 
        this.winW = window.innerWidth; 
        this.winH = window.innerHeight; 
    });
    this.updateClock(); 
    this.clockInterval = setInterval(() => this.updateClock(), 1000);

    // [ë²„íŠ¼ íš¨ê³¼ìŒ í†µì¼] ëª¨ë“  ë²„íŠ¼ í´ë¦­ ì‹œ 'ë”¸ê¹' ì†Œë¦¬ ì¬ìƒ
    document.addEventListener('mouseover', (e) => {
        if (e.target.closest('button') || e.target.closest('.clickable')) {
            this.playSound('hover', false, 0.2); 
        }
    });

    document.addEventListener('click', (e) => {
        // (-) ë²„íŠ¼ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ëª¨ë“  ë²„íŠ¼ì€ 'í´ë¦­ìŒ'ìœ¼ë¡œ í†µì¼
        const btn = e.target.closest('button') || e.target.closest('.clickable');
        if (btn) {
            this.playSound('click', false, 0.3);
        }
    });

    // 3. íƒ€ì´ë¨¸ ì´ˆê¸° ìœ„ì¹˜ ì•ˆì „ì¥ì¹˜
    setTimeout(() => {
        const ww = window.innerWidth;
        const wh = window.innerHeight;
        const boxW = this.timerSize || 400;
        const boxH = boxW * 0.633;

        if (this.timerX === null || isNaN(this.timerX) || this.timerY === null || isNaN(this.timerY)) {
            this.timerX = (ww / 2) - (boxW / 2);
            this.timerY = (wh / 2) - (boxH / 2);
        } 
        
        if (this.noiseX === null) this.noiseX = 100;
        if (this.noiseY === null) this.noiseY = 100;
        
    }, 1000);
}
    }).mount('#app')
</script>
</body>
</html>
